This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

<additional_info>

</additional_info>

</file_summary>

<directory_structure>
.cache/
  Microsoft/
    DeveloperTools/
      deviceid
  replit/
    env/
      latest
      latest.json
    modules/
      nodejs-20.res
      postgresql-16.res
      replit.res
      web.res
    nix/
      env.json
    toolchain.json
  typescript/
    5.5/
      package.json
.local/
  state/
    replit/
      agent/
        .latest.json
        repl_state.json
.upm/
  store.json
attached_assets/
  Pasted--vite-connecting-vite-connected-Fetching-user-data-User-not-authenticated-Auth-respons-1735233080711.txt
  Pasted--vite-connecting-vite-connected-Fetching-user-data-User-not-authenticated-vite-hot-u-1736264164732.txt
client/
  src/
    components/
      ui/
        accordion.tsx
        alert-dialog.tsx
        alert.tsx
        aspect-ratio.tsx
        avatar.tsx
        badge.tsx
        breadcrumb.tsx
        button.tsx
        calendar.tsx
        card.tsx
        carousel.tsx
        chart.tsx
        checkbox.tsx
        collapsible.tsx
        command.tsx
        context-menu.tsx
        dialog.tsx
        drawer.tsx
        dropdown-menu.tsx
        form.tsx
        hover-card.tsx
        input-otp.tsx
        input.tsx
        label.tsx
        menubar.tsx
        navigation-menu.tsx
        pagination.tsx
        popover.tsx
        progress.tsx
        radio-group.tsx
        resizable.tsx
        scroll-area.tsx
        select.tsx
        separator.tsx
        sheet.tsx
        sidebar.tsx
        skeleton.tsx
        slider.tsx
        switch.tsx
        table.tsx
        tabs.tsx
        textarea.tsx
        toast.tsx
        toaster.tsx
        toggle-group.tsx
        toggle.tsx
        tooltip.tsx
      ChatMessage.tsx
      ChatWindow.module.css
      ChatWindow.tsx
      ConnectionStatus.module.css
      ConnectionStatus.tsx
      CreateMatchWizard.tsx
      GraphControls.module.css
      GraphControls.tsx
      InterestTagger.tsx
      match-requests.tsx
      MatchCard.tsx
      MatchInsightTooltip.tsx
      MessageBubble.module.css
      MessageBubble.tsx
      Navigation.tsx
      NetworkGraph.module.css
      NetworkGraph.tsx
      NodeTooltip.module.css
      NodeTooltip.tsx
      ProfileProgress.tsx
      QuizQuestion.tsx
      theme-provider.tsx
      ThemeToggle.tsx
      TypingIndicator.module.css
      TypingIndicator.tsx
    hooks/
      use-achievements.ts
      use-chat.ts
      use-matches.ts
      use-mobile.tsx
      use-toast.ts
      use-user.ts
    lib/
      queryClient.ts
      utils.ts
    pages/
      AuthPage.tsx
      Chat.tsx
      CreateMatch.tsx
      Home.tsx
      InterestsPage.tsx
      Matches.tsx
      Profile.tsx
      Quiz.tsx
    styles/
      globals.css
      theme.ts
    utils/
      auth.ts
      colorUtils.ts
      stripe.ts
    App.tsx
    index.css
    main.tsx
  index.html
db/
  migrations/
    0001_add_avatar_column.sql
    achievements.sql
    add_potential_status.ts
  index.ts
  migrate.ts
  schema.ts
server/
  middleware/
    auth.ts
  utils/
    matching.ts
    openai.ts
    suggestions.ts
  auth.ts
  copilotkit.ts
  index.ts
  routes.ts
  stripe.ts
  vite.ts
  websocket.ts
.gitignore
.replit
drizzle.config.ts
package.json
Pasted--vite-connecting-vite-connected-Fetching-user-data-User-not-authenticated-Login-succes-1734629553793.txt
Pasted--vite-connecting-vite-connected-User-not-authenticated-Login-successful-Object-message-1734526486400.txt
Pasted--vite-connecting-vite-connected-Warning-validateDOMNesting-a-cannot-appear-as-a-de-1734309041676.txt
Pasted-Based-on-the-error-message-and-code-provided-the-issue-appears-to-be-related-to-an-invalid-user-ID--1734549888789.txt
Pasted-Based-on-the-error-message-and-code-provided-the-issue-appears-to-be-related-to-an-invalid-user-ID--1734552032945.txt
Pasted-Login-successful-message-Login-successful-user-message-Login-successful-user--1734524971073.txt
Pasted-Match-connection-error-Error-at-t-value-https-7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29-1734627791561.txt
Pasted-No-auth-token-found-Matches-response-4-Match-connection-error-Object--1734628291230.txt
Pasted-User-data-fetched-Object-id-1-username-jmartens10-gmail-com-password-f97f581dcb23d3cd9b9-1734628410219.txt
Pasted-vite-connecting-vite-connected-Fetching-user-data-User-data-fetched-Object-id-1-u-1734653429020.txt
postcss.config.js
replit.nix
tailwind.config.ts
theme.json
tsconfig.json
vite.config.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".cache/Microsoft/DeveloperTools/deviceid">
f1afc3cf-6f55-431c-83f4-9aca4705affc
</file>

<file path=".cache/replit/env/latest">
declare -gx NIX_PS1='\[\033[01;34m\]\w\[\033[00m\]\$ '
declare -gx mesonFlags=''
declare -gx CONFIG_SHELL=/nix/store/306znyj77fv49kwnkpxmb0j2znqpa8bj-bash-5.2p26/bin/bash
declare -gx GIT_EDITOR=replit-git-editor
declare -gx LANG=en_US.UTF-8
declare -gx XDG_CACHE_HOME=/home/runner/workspace/.cache
declare -gx READELF=readelf
declare -gx depsBuildBuildPropagated=''
declare -gx REPLIT_SUBCLUSTER=paid
declare -gx RANLIB=ranlib
declare -gx SOURCE_DATE_EPOCH=315532800
declare -gx doInstallCheck=''
declare -gx depsTargetTargetPropagated=''
declare -gx depsBuildBuild=''
declare -gx REPLIT_RIPPKGS_INDICES=/nix/store/l5gcmdp908sji4wchfp8csflhjcgnmm3-rippkgs-indices
declare -gx NM=nm
declare -gx REPLIT_PID1_FLAG_REPLIT_RTLD_LOADER=1
declare -gx REPLIT_NIX_CHANNEL=stable-24_05
declare -gx patches=''
declare -gx REPLIT_LD_AUDIT=/nix/store/n5x1kgbz8zjh63ymsijbislyi1n1hir6-replit_rtld_loader-1/rtld_loader.so
declare -gx USER=runner
declare -gx CXX=g++
declare -gx REPLIT_BASHRC=/nix/store/0izq9daf9j0zj8ww8apwwk74i9xv7y1n-replit-bashrc/bashrc
declare -gx depsHostHostPropagated=''
declare -gx shell=/nix/store/306znyj77fv49kwnkpxmb0j2znqpa8bj-bash-5.2p26/bin/bash
declare -gx NIX_HARDENING_ENABLE='bindnow format fortify fortify3 pic relro stackprotector strictoverflow'
declare -gx propagatedBuildInputs=''
declare -gx OBJDUMP=objdump
declare -gx NIX_BINTOOLS=/nix/store/kln7kinji3b7sz8r50h4gn9yy6k1js9a-binutils-wrapper-2.41
declare -gx REPL_ID=7975dfb1-a3db-4ca1-95e5-67899b0ac80d
declare -gx STRINGS=strings
declare -gx NIX_BUILD_TOP=/tmp
declare -gx depsTargetTarget=''
declare -gx NIX_PATH=nixpkgs=/home/runner/.nix-defexpr/channels/nixpkgs-stable-24_05:/home/runner/.nix-defexpr/channels
declare -gx XDG_DATA_HOME=/home/runner/workspace/.local/share
declare -gx NIX_BINTOOLS_WRAPPER_TARGET_HOST_x86_64_unknown_linux_gnu=1
declare -gx builder=/nix/store/306znyj77fv49kwnkpxmb0j2znqpa8bj-bash-5.2p26/bin/bash
declare -gx REPL_OWNER_ID=23170032
declare -gx out=/nix/store/yf3p5xmdpdvjjsa0c5g63q3jhhgwrryp-nix-shell
declare -gx configureFlags=''
declare -gx REPL_SLUG=workspace
declare -gx REPLIT_ENVIRONMENT=production
declare -gx REPLIT_RTLD_LOADER=1
declare -gx OBJCOPY=objcopy
declare -gx REPLIT_LD_LIBRARY_PATH=/nix/store/xb4h083j02mr2ix7pgj7iawxh2hk100l-postgresql-15.7-lib/lib:/nix/store/hggpnywm6l7cfh2ml1ynm50ap9x4f9rn-mesa-24.0.7-drivers/lib:/nix/store/jz3vvf4nsyirb25rh9dbhksm4gq6wybb-libglvnd-1.7.0/lib:/nix/store/pn9glkalcj7i5p549dpsl1c46pkb13xr-pulseaudio-17.0/lib
declare -gx __EGL_VENDOR_LIBRARY_FILENAMES=/nix/store/hggpnywm6l7cfh2ml1ynm50ap9x4f9rn-mesa-24.0.7-drivers/share/glvnd/egl_vendor.d/50_mesa.json
declare -gx NIX_CFLAGS_COMPILE=' -frandom-seed=yf3p5xmdpd -isystem /nix/store/07s64wxjzk6z1glwxvl3yq81vdn42k40-postgresql-15.7/include -isystem /nix/store/smacbfb82wp7ncz2rwac68jd50qxr70a-libglvnd-1.7.0-dev/include -isystem /nix/store/a83znbrflv30lvhww0d2rljbyd5mw0c0-pulseaudio-17.0-dev/include -isystem /nix/store/xslrgzkvciny0m0cqbgq4bnvydvpdkgx-libcap-2.69-dev/include -isystem /nix/store/nn78wg4rgns62w5sfzyxashxizd0lfva-attr-2.5.2-dev/include -isystem /nix/store/07s64wxjzk6z1glwxvl3yq81vdn42k40-postgresql-15.7/include -isystem /nix/store/smacbfb82wp7ncz2rwac68jd50qxr70a-libglvnd-1.7.0-dev/include -isystem /nix/store/a83znbrflv30lvhww0d2rljbyd5mw0c0-pulseaudio-17.0-dev/include -isystem /nix/store/xslrgzkvciny0m0cqbgq4bnvydvpdkgx-libcap-2.69-dev/include -isystem /nix/store/nn78wg4rgns62w5sfzyxashxizd0lfva-attr-2.5.2-dev/include'
declare -gx HOST_PATH=/nix/store/07s64wxjzk6z1glwxvl3yq81vdn42k40-postgresql-15.7/bin:/nix/store/ha8rh8jg19r8418baa8ps9b9kvd6szcf-attr-2.5.2-bin/bin:/nix/store/cnnmb3axmv43lj22gny3m4hj06i1nc7c-libcap-2.69/bin:/nix/store/pn9glkalcj7i5p549dpsl1c46pkb13xr-pulseaudio-17.0/bin:/nix/store/php4qidg2bxzmm79vpri025bqi0fa889-coreutils-9.5/bin:/nix/store/jjcsr5gs4qanf7ln5c6wgcq4sn75a978-findutils-4.9.0/bin:/nix/store/i34mknsjgrfyy71k2h79gda0bvagzc2j-diffutils-3.10/bin:/nix/store/5zjms21vpxlkbc0qyl5pmj2sidfmzmd7-gnused-4.9/bin:/nix/store/28gpmx3z6ss3znd7fhmrzmvk3x5lnfbk-gnugrep-3.11/bin:/nix/store/8vvkbgmnin1x2jkp7wcb2zg1p0vc4ks9-gawk-5.2.2/bin:/nix/store/rik7p68cq7yzlj5pmfpf4yv6jnrpvlgf-gnutar-1.35/bin:/nix/store/j5chw7v1x3vlmf3wmdpdb5gwh9hl0b80-gzip-1.13/bin:/nix/store/mxcq77rlan82dzpv3cgj0fh6qvv8ncil-bzip2-1.0.8-bin/bin:/nix/store/cdzpn0rdq810aknww3w9fy3wmw9ixr66-gnumake-4.4.1/bin:/nix/store/306znyj77fv49kwnkpxmb0j2znqpa8bj-bash-5.2p26/bin:/nix/store/0lfxbmchigx9vs9qmrlbahcy6nxwfnj1-patch-2.7.6/bin:/nix/store/6i4xxaa812vsbli9jkq4mksdddrk27lw-xz-5.4.6-bin/bin:/nix/store/xx7x1dwybpssfhq8yikvzz38bh3yrq97-file-5.45/bin
declare -gx NIX_BUILD_CORES=4
declare -gx PROMPT_DIRTRIM=2
declare -gx REPL_IDENTITY=v2.public.Q2lRM09UYzFaR1ppTVMxaE0yUmlMVFJqWVRFdE9UVmxOUzAyTnpnNU9XSXdZV000TUdRU0MyZGhaSE5rWlc1amIyUmxHZ2hXZVdKbFEyaGxlQ0lrTnprM05XUm1ZakV0WVROa1lpMDBZMkV4TFRrMVpUVXROamM0T1RsaU1HRmpPREJrT1BDWGhndGFEUW9GY21sclpYSVNCSEJoYVdRPf49UmuhHJqV3lMEynYPg0fXkDTfA1wjCJ5Zizoxq-YateS_cA6BXU1BRmkGaBNzxvW3HWuPMVNHyFelDbDMsQs.R0FFaUJtTnZibTFoYmhLTENIWXlMbkIxWW14cFl5NVJNbVF6VTFSb01FNTZiREprTVd4U1pHcFJlV0ZxWkZKU1ZrNUZVVmR3UTAxRVVsbFJWVXB2VVRJMWNsTXhRakJSVmtwMlVUQmtRbFpYUmt0YU1qbHlWRzV3Y2swd05WaFZiVEZhWVd0V01GZFdVazloTVd4d1RVUkNXazFyVmpSVVJsSnlUVlp3VlZaWVVrOWhiVTB3VkRGU2MyRlZNVWhTYlhCUVVrVktjbEl5WTNkVk1FMTVXa2RvWVZORk5YSlhiR014WVcxSmVWVnRlRWhhTVZVd1QwVndiRkl3VGpSaU1HaEtXakZhTlZsV1pEQmlSMDV2WWpCa1RGb3hTak5YVm1SellUQnNjVlp1U2s1aFZGWXpXa1prUzJNeVJsaFVXRlpzVWpCd1lWVjZSa3BPUjBwMFZXcEdWMDFXV2s1YVJsWkxaR3MwZVUxRVFrNVRSa3BXV2xWWk5WSkdTbkpoUlZwVVRXdHJlRmw2UWtkaGJGcEZZa1JPVkZKV1dUQlVWVnBoVFRGR1VsQlVNbnBCTldkelgzQjFiMVpEWVRod2MyTXRkbkJ3ZEdjMlJYazBhR3AxT0ZobFp6aHNOVzFMYlROMmNrOWlWVTVhTUZGV09GSlBkMlEzWWxSeGJYbHNiMlZ6WjJob0xVRk9Tak5LVUZjMlZ6TnNlVVpLTkVndVVqQkdSbUZWU25SVWJscHBZbFJHYjFsdGFFMVphMFoxVjFoc1RXSnJTWGhYVnpFMFkwWnNOVTVXU2s1aVZra3lWbFJHYTAxSFZuUlRiRnBVWW01Q1YxWnRNVFJWTVZKeVZXMUdUbFp1UWxkVk1uUlBWa1phV1dGRlZsWmxhMHB5VldwQk1WTldSbkpUYkZwT1VteHdVMVp0Y0U5WlYxSlhZak5vVTJKWGFGTldha3B2WkZaV1dHUkhkR2xpUlRWWVdXdFdUMVp0U2xWaVJWWldZV3RLU0ZwSGVITldiRXAxVW14S1YxWllRa3BXTW5CRFl6RmtjMUpzYUdoVFJuQlRWRlZrVTFFeFdrZGFSV1JTWWxWYVNWZHJWWGhWTURGMFZXdDBWMDFXV2xSVlZFcEtaREZTY21GR1NsZGhNWEIyVmxaYWEySXlTbk5VYmtwcFUwVmFXRmx0ZEhkVU1XeFhWV3hrVGsxWVFraFhhMVl3WVdzeGNsZHNiRmRTYldoWVZrUkdZV1JIVmtsalJtUlhZbFpLU1ZaR1VrdFVNazE1VTJwYVZtRjZiRmhVVjNoTFlqRlplVTFVVWxSTmExcEhWRlpXYTFaSFNrWlhiRnBhVm5wRk1GZFdXbk5PYkVaVlVtMXdhVkpZUWpaV1JFWlhXVmRGZVZOc2JGWldSVnBYV1d0YVlXTnNjRWhsUlZwc1VtNUNSbFl5TVhkaFIwVjRZMGM1VjJGcldsUlZla1pPWlVaYWMxTnNSbGRTUlVvelZqSjBZVmR0VG5SalJURlFWMFUwZWxwRlZscE9WbkJGVWxoU2FXSlVWbEZVTUdSaFZXMUtXR0ZFU2xSU1ZuQjRWbXRXY21SSFVrVmhSWEJwWWxad1VWZEVTWGhXVlRGMFdYcFNhbGRJUWtaVmEyUldUa1phUldKR1VtaE5Wa28yVjIxNGIySlhWbkppZWtKWVZsVXhObGR0YzNkbGJHUldUbGhLVkZaSFVsbFhWMnQzVGxaS2NsVnRPVTloVkVaTVZHcEpOVkpGZUhOVFdHUlRZVEZ3YjFac1ZuZE5SbHBJVGxkR2FGWXdjRlpWYlRBMVYyMUtXRlZxU2xaaGEzQlFWVEZhVDJSV1pIUlNiRTVUWlcxbk1BPT0
declare -gx REPL_OWNER=gadsdencode
declare -gx REPLIT_DB_URL=https://kv.replit.com/v0/eyJhbGciOiJIUzUxMiIsImlzcyI6ImNvbm1hbiIsImtpZCI6InByb2Q6MSIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJjb25tYW4iLCJleHAiOjE3NDQ5MDUwNzMsImlhdCI6MTc0NDc5MzQ3MywiZGF0YWJhc2VfaWQiOiI3OTc1ZGZiMS1hM2RiLTRjYTEtOTVlNS02Nzg5OWIwYWM4MGQifQ.8iW4J3i6cW-XopsdvLH9YDAGrDjg5-G2sKhRvRJ95j4JW2dckt0CatGzr_eOlPU432HqD3n4NSqjWZY13nxz6w
declare -gx phases=buildPhase
declare -gx shellHook=''
declare -gx REPLIT_PID1_VERSION=0.0.0-016c47a
declare -gx REPL_HOME=/home/runner/workspace
declare -gx nativeBuildInputs=''
declare -gx AR=ar
declare -gx HOSTNAME=df0f38885481
declare -gx XDG_CONFIG_HOME=/home/runner/workspace/.config
declare -gx LD=ld
declare -gx depsBuildTargetPropagated=''
declare -gx NIX_ENFORCE_NO_NATIVE=1
declare -gx REPL_LANGUAGE=nix
declare -gx HOME=/home/runner
declare -gx REPLIT_DOMAINS=7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev
declare -gx depsBuildTarget=''
declare -gx NIX_CC_WRAPPER_TARGET_HOST_x86_64_unknown_linux_gnu=1
declare -gx system=x86_64-linux
declare -gx stdenv=/nix/store/xfhkjnpqjwlf6hlk1ysmq3aaq80f3bjj-stdenv-linux
declare -gx npm_config_prefix=/home/runner/workspace/.config/npm/node_global
declare -gx REPLIT_CLI=/nix/store/mb249m51d32xm5dprdy7jkkmn6s2h22i-pid1-0.0.1/bin/replit
declare -gx __structuredAttrs=''
declare -gx depsHostHost=''
declare -gx NIX_LDFLAGS='-rpath /nix/store/yf3p5xmdpdvjjsa0c5g63q3jhhgwrryp-nix-shell/lib  -L/nix/store/07s64wxjzk6z1glwxvl3yq81vdn42k40-postgresql-15.7/lib -L/nix/store/xb4h083j02mr2ix7pgj7iawxh2hk100l-postgresql-15.7-lib/lib -L/nix/store/hggpnywm6l7cfh2ml1ynm50ap9x4f9rn-mesa-24.0.7-drivers/lib -L/nix/store/jz3vvf4nsyirb25rh9dbhksm4gq6wybb-libglvnd-1.7.0/lib -L/nix/store/5nk2ga7i2f030am4qpcdsd8qlk6i3z83-attr-2.5.2/lib -L/nix/store/yvhyhcfhc98wm86pw4ygk5jdr804iwrw-libcap-2.69-lib/lib -L/nix/store/pn9glkalcj7i5p549dpsl1c46pkb13xr-pulseaudio-17.0/lib -L/nix/store/07s64wxjzk6z1glwxvl3yq81vdn42k40-postgresql-15.7/lib -L/nix/store/xb4h083j02mr2ix7pgj7iawxh2hk100l-postgresql-15.7-lib/lib -L/nix/store/hggpnywm6l7cfh2ml1ynm50ap9x4f9rn-mesa-24.0.7-drivers/lib -L/nix/store/jz3vvf4nsyirb25rh9dbhksm4gq6wybb-libglvnd-1.7.0/lib -L/nix/store/5nk2ga7i2f030am4qpcdsd8qlk6i3z83-attr-2.5.2/lib -L/nix/store/yvhyhcfhc98wm86pw4ygk5jdr804iwrw-libcap-2.69-lib/lib -L/nix/store/pn9glkalcj7i5p549dpsl1c46pkb13xr-pulseaudio-17.0/lib'
declare -gx DOCKER_CONFIG=/home/runner/workspace/.config/docker
declare -gx GIT_ASKPASS=replit-git-askpass
declare -gx NIX_CC=/nix/store/9bv7dcvmfcjnmg5mnqwqlq2wxfn8d7yi-gcc-wrapper-13.2.0
declare -gx STRIP=strip
declare -gx outputs=out
read -r _new_path <<< "/nix/store/0z5iwcvalafm3j2c5pfhllsfbxrbyzf4-postgresql-16.5/bin:/nix/store/r2wrscmjzn4f2f7wk7q2ms2h96mjwzv7-npx/bin:/home/runner/workspace/.config/npm/node_global/bin:/home/runner/workspace/node_modules/.bin:/nix/store/rrz8cqhldyl17bbs60g7d8vbaadkxc40-nodejs-20.18.1-wrapped/bin:/nix/store/7zaapw8wkywsw9z5lkkk5k608xpn7wfl-bun-1.2.3/bin:/nix/store/z8s3r4vwf4r26g2d7shnw5lva6ihim8f-pnpm-9.15.0/bin:/nix/store/jcgdksj946l5l42c2y9ks2l4g6n74h3f-yarn-1.22.22/bin:/nix/store/2s17mrby0ph00z22rkabfs9vzpzx1r70-prettier-3.3.3/bin:/nix/store/rdd4pnr4x9rqc9wgbibhngv217w2xvxl-bash-interactive-5.2p26/bin:/nix/store/nbad47q0m0m9c5xid7zh05hiknwircbp-patchelf-0.15.0/bin:/nix/store/9bv7dcvmfcjnmg5mnqwqlq2wxfn8d7yi-gcc-wrapper-13.2.0/bin:/nix/store/14c6s4xzhy14i2b05s00rjns2j93gzz4-gcc-13.2.0/bin:/nix/store/c2i631h8i5vcs1sqifwxfsazhwrg6wr5-glibc-2.39-52-bin/bin:/nix/store/php4qidg2bxzmm79vpri025bqi0fa889-coreutils-9.5/bin:/nix/store/kln7kinji3b7sz8r50h4gn9yy6k1js9a-binutils-wrapper-2.41/bin:/nix/store/bgcaxhhxswzvmxjbbgvvaximm5hwghz1-binutils-2.41/bin:/nix/store/07s64wxjzk6z1glwxvl3yq81vdn42k40-postgresql-15.7/bin:/nix/store/ha8rh8jg19r8418baa8ps9b9kvd6szcf-attr-2.5.2-bin/bin:/nix/store/cnnmb3axmv43lj22gny3m4hj06i1nc7c-libcap-2.69/bin:/nix/store/pn9glkalcj7i5p549dpsl1c46pkb13xr-pulseaudio-17.0/bin:/nix/store/jjcsr5gs4qanf7ln5c6wgcq4sn75a978-findutils-4.9.0/bin:/nix/store/i34mknsjgrfyy71k2h79gda0bvagzc2j-diffutils-3.10/bin:/nix/store/5zjms21vpxlkbc0qyl5pmj2sidfmzmd7-gnused-4.9/bin:/nix/store/28gpmx3z6ss3znd7fhmrzmvk3x5lnfbk-gnugrep-3.11/bin:/nix/store/8vvkbgmnin1x2jkp7wcb2zg1p0vc4ks9-gawk-5.2.2/bin:/nix/store/rik7p68cq7yzlj5pmfpf4yv6jnrpvlgf-gnutar-1.35/bin:/nix/store/j5chw7v1x3vlmf3wmdpdb5gwh9hl0b80-gzip-1.13/bin:/nix/store/mxcq77rlan82dzpv3cgj0fh6qvv8ncil-bzip2-1.0.8-bin/bin:/nix/store/cdzpn0rdq810aknww3w9fy3wmw9ixr66-gnumake-4.4.1/bin:/nix/store/306znyj77fv49kwnkpxmb0j2znqpa8bj-bash-5.2p26/bin:/nix/store/0lfxbmchigx9vs9qmrlbahcy6nxwfnj1-patch-2.7.6/bin:/nix/store/6i4xxaa812vsbli9jkq4mksdddrk27lw-xz-5.4.6-bin/bin:/nix/store/xx7x1dwybpssfhq8yikvzz38bh3yrq97-file-5.45/bin:/nix/store/qq3yz6h7hy129z1zvhvf33i96fk8p5xs-pid1/bin:/nix/store/ikaf2i4slwdr9a0h2h74abssgxn9ky23-replit-runtime-path/bin:/home/runner/.nix-profile/bin:/home/runner/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
#PATH=/nix/store/0z5iwcvalafm3j2c5pfhllsfbxrbyzf4-postgresql-16.5/bin:/nix/store/r2wrscmjzn4f2f7wk7q2ms2h96mjwzv7-npx/bin:/home/runner/workspace/.config/npm/node_global/bin:/home/runner/workspace/node_modules/.bin:/nix/store/rrz8cqhldyl17bbs60g7d8vbaadkxc40-nodejs-20.18.1-wrapped/bin:/nix/store/7zaapw8wkywsw9z5lkkk5k608xpn7wfl-bun-1.2.3/bin:/nix/store/z8s3r4vwf4r26g2d7shnw5lva6ihim8f-pnpm-9.15.0/bin:/nix/store/jcgdksj946l5l42c2y9ks2l4g6n74h3f-yarn-1.22.22/bin:/nix/store/2s17mrby0ph00z22rkabfs9vzpzx1r70-prettier-3.3.3/bin:/nix/store/rdd4pnr4x9rqc9wgbibhngv217w2xvxl-bash-interactive-5.2p26/bin:/nix/store/nbad47q0m0m9c5xid7zh05hiknwircbp-patchelf-0.15.0/bin:/nix/store/9bv7dcvmfcjnmg5mnqwqlq2wxfn8d7yi-gcc-wrapper-13.2.0/bin:/nix/store/14c6s4xzhy14i2b05s00rjns2j93gzz4-gcc-13.2.0/bin:/nix/store/c2i631h8i5vcs1sqifwxfsazhwrg6wr5-glibc-2.39-52-bin/bin:/nix/store/php4qidg2bxzmm79vpri025bqi0fa889-coreutils-9.5/bin:/nix/store/kln7kinji3b7sz8r50h4gn9yy6k1js9a-binutils-wrapper-2.41/bin:/nix/store/bgcaxhhxswzvmxjbbgvvaximm5hwghz1-binutils-2.41/bin:/nix/store/07s64wxjzk6z1glwxvl3yq81vdn42k40-postgresql-15.7/bin:/nix/store/ha8rh8jg19r8418baa8ps9b9kvd6szcf-attr-2.5.2-bin/bin:/nix/store/cnnmb3axmv43lj22gny3m4hj06i1nc7c-libcap-2.69/bin:/nix/store/pn9glkalcj7i5p549dpsl1c46pkb13xr-pulseaudio-17.0/bin:/nix/store/jjcsr5gs4qanf7ln5c6wgcq4sn75a978-findutils-4.9.0/bin:/nix/store/i34mknsjgrfyy71k2h79gda0bvagzc2j-diffutils-3.10/bin:/nix/store/5zjms21vpxlkbc0qyl5pmj2sidfmzmd7-gnused-4.9/bin:/nix/store/28gpmx3z6ss3znd7fhmrzmvk3x5lnfbk-gnugrep-3.11/bin:/nix/store/8vvkbgmnin1x2jkp7wcb2zg1p0vc4ks9-gawk-5.2.2/bin:/nix/store/rik7p68cq7yzlj5pmfpf4yv6jnrpvlgf-gnutar-1.35/bin:/nix/store/j5chw7v1x3vlmf3wmdpdb5gwh9hl0b80-gzip-1.13/bin:/nix/store/mxcq77rlan82dzpv3cgj0fh6qvv8ncil-bzip2-1.0.8-bin/bin:/nix/store/cdzpn0rdq810aknww3w9fy3wmw9ixr66-gnumake-4.4.1/bin:/nix/store/306znyj77fv49kwnkpxmb0j2znqpa8bj-bash-5.2p26/bin:/nix/store/0lfxbmchigx9vs9qmrlbahcy6nxwfnj1-patch-2.7.6/bin:/nix/store/6i4xxaa812vsbli9jkq4mksdddrk27lw-xz-5.4.6-bin/bin:/nix/store/xx7x1dwybpssfhq8yikvzz38bh3yrq97-file-5.45/bin:/nix/store/qq3yz6h7hy129z1zvhvf33i96fk8p5xs-pid1/bin:/nix/store/ikaf2i4slwdr9a0h2h74abssgxn9ky23-replit-runtime-path/bin:/home/runner/.nix-profile/bin:/home/runner/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
if [ -e "/run/replit/env/last" ]; then read -r _last_path < <(\grep '^#PATH=' /run/replit/env/last | cut -f 2 -d =); fi
_user_components="$(\tr : $'\n' <<< "${PATH:-}" |\grep -xv -f <(\tr : $'\n' <<< "${_last_path}") |\tr $'\n' :)"
declare -gx PATH="${_user_components}${_new_path}"
declare -gx doCheck=''
declare -gx XDG_DATA_DIRS=/nix/store/nbad47q0m0m9c5xid7zh05hiknwircbp-patchelf-0.15.0/share:/nix/store/ikaf2i4slwdr9a0h2h74abssgxn9ky23-replit-runtime-path/share
declare -gx REPLIT_PID1_FLAG_NIXMODULES_BEFORE_REPLIT_NIX=1
declare -gx COLORTERM=truecolor
declare -gx preferLocalBuild=1
declare -gx cmakeFlags=''
declare -gx REPLIT_CLUSTER=riker
declare -gx buildInputs='/nix/store/07s64wxjzk6z1glwxvl3yq81vdn42k40-postgresql-15.7 /nix/store/hggpnywm6l7cfh2ml1ynm50ap9x4f9rn-mesa-24.0.7-drivers /nix/store/smacbfb82wp7ncz2rwac68jd50qxr70a-libglvnd-1.7.0-dev /nix/store/a83znbrflv30lvhww0d2rljbyd5mw0c0-pulseaudio-17.0-dev'
declare -gx propagatedNativeBuildInputs=''
declare -gx LIBGL_DRIVERS_PATH=/nix/store/hggpnywm6l7cfh2ml1ynm50ap9x4f9rn-mesa-24.0.7-drivers/lib/dri
declare -gx strictDeps=''
declare -gx REPL_PUBKEYS='{"crosis-ci":"7YlpcYh82oR9NSTtSYtR5jDL4onNzCGJGq6b+9CuZII=","crosis-ci:1":"7YlpcYh82oR9NSTtSYtR5jDL4onNzCGJGq6b+9CuZII=","crosis-ci:latest":"7YlpcYh82oR9NSTtSYtR5jDL4onNzCGJGq6b+9CuZII=","prod":"tGsjlu/BJvWTgvMaX7acuUb7AO1dXOrRiuk7y083RFE=","prod:1":"tGsjlu/BJvWTgvMaX7acuUb7AO1dXOrRiuk7y083RFE=","prod:2":"8uGN+vfszlnV93/HCSHlVLG0xddMlPkir1Ni4JKT4+w=","prod:3":"9+MCOSHQSQlcodXoot8dC8NLhc862nLkx1/VMsbY2h8=","prod:4":"8uGN+vfszlnV93/HCSHlVLG0xddMlPkir1Ni4JKT4+w=","prod:5":"9+MCOSHQSQlcodXoot8dC8NLhc862nLkx1/VMsbY2h8=","prod:latest":"tGsjlu/BJvWTgvMaX7acuUb7AO1dXOrRiuk7y083RFE=","vault-goval-token":"D5jJoMx1Ml54HM92NLgXl+MzptwDqbSsfyFG6f52g9E=","vault-goval-token:1":"D5jJoMx1Ml54HM92NLgXl+MzptwDqbSsfyFG6f52g9E=","vault-goval-token:latest":"D5jJoMx1Ml54HM92NLgXl+MzptwDqbSsfyFG6f52g9E="}'
declare -gx LOCALE_ARCHIVE=/usr/lib/locale/locale-archive
declare -gx REPL_IDENTITY_KEY=k2.secret.05-Au_uWQVZaivk0nEsKzPFwnHl9p1kBx5k8NxpqUJnFtgpHyd25ZQu4GjubjS1PH8IUcQpvmwBxP3AcTHRXAA
declare -gx __ETC_PROFILE_SOURCED=1
declare -gx AS=as
declare -gx NIX_STORE=/nix/store
declare -gx DIRENV_CONFIG=/etc/direnv
declare -gx REPLIT_DEV_DOMAIN=7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev
declare -gx NIXPKGS_ALLOW_UNFREE=1
declare -gx REPL_IMAGE=gcr.io/marine-cycle-160323/nix:bf8590a3e2f0a8b70b7ca175eeed9074dffbfca9
declare -gx SIZE=size
declare -gx _=/nix/store/php4qidg2bxzmm79vpri025bqi0fa889-coreutils-9.5/bin/env
declare -gx buildPhase='{ echo "------------------------------------------------------------";
  echo " WARNING: the existence of this path is not guaranteed.";
  echo " It is an internal implementation detail for pkgs.mkShell.";
  echo "------------------------------------------------------------";
  echo;
  # Record all build inputs as runtime dependencies
  export;
} >> "$out"
'
declare -gx NIX_PROFILES='/nix/var/nix/profiles/default /home/runner/.nix-profile'
declare -gx CC=gcc
declare -gx DISPLAY=:0
</file>

<file path=".cache/replit/env/latest.json">
{"environment":{"AR":"ar","AS":"as","CC":"gcc","COLORTERM":"truecolor","CONFIG_SHELL":"/nix/store/306znyj77fv49kwnkpxmb0j2znqpa8bj-bash-5.2p26/bin/bash","CXX":"g++","DIRENV_CONFIG":"/etc/direnv","DISPLAY":":0","DOCKER_CONFIG":"/home/runner/workspace/.config/docker","GIT_ASKPASS":"replit-git-askpass","GIT_EDITOR":"replit-git-editor","HOME":"/home/runner","HOSTNAME":"df0f38885481","HOST_PATH":"/nix/store/07s64wxjzk6z1glwxvl3yq81vdn42k40-postgresql-15.7/bin:/nix/store/ha8rh8jg19r8418baa8ps9b9kvd6szcf-attr-2.5.2-bin/bin:/nix/store/cnnmb3axmv43lj22gny3m4hj06i1nc7c-libcap-2.69/bin:/nix/store/pn9glkalcj7i5p549dpsl1c46pkb13xr-pulseaudio-17.0/bin:/nix/store/php4qidg2bxzmm79vpri025bqi0fa889-coreutils-9.5/bin:/nix/store/jjcsr5gs4qanf7ln5c6wgcq4sn75a978-findutils-4.9.0/bin:/nix/store/i34mknsjgrfyy71k2h79gda0bvagzc2j-diffutils-3.10/bin:/nix/store/5zjms21vpxlkbc0qyl5pmj2sidfmzmd7-gnused-4.9/bin:/nix/store/28gpmx3z6ss3znd7fhmrzmvk3x5lnfbk-gnugrep-3.11/bin:/nix/store/8vvkbgmnin1x2jkp7wcb2zg1p0vc4ks9-gawk-5.2.2/bin:/nix/store/rik7p68cq7yzlj5pmfpf4yv6jnrpvlgf-gnutar-1.35/bin:/nix/store/j5chw7v1x3vlmf3wmdpdb5gwh9hl0b80-gzip-1.13/bin:/nix/store/mxcq77rlan82dzpv3cgj0fh6qvv8ncil-bzip2-1.0.8-bin/bin:/nix/store/cdzpn0rdq810aknww3w9fy3wmw9ixr66-gnumake-4.4.1/bin:/nix/store/306znyj77fv49kwnkpxmb0j2znqpa8bj-bash-5.2p26/bin:/nix/store/0lfxbmchigx9vs9qmrlbahcy6nxwfnj1-patch-2.7.6/bin:/nix/store/6i4xxaa812vsbli9jkq4mksdddrk27lw-xz-5.4.6-bin/bin:/nix/store/xx7x1dwybpssfhq8yikvzz38bh3yrq97-file-5.45/bin","LANG":"en_US.UTF-8","LD":"ld","LIBGL_DRIVERS_PATH":"/nix/store/hggpnywm6l7cfh2ml1ynm50ap9x4f9rn-mesa-24.0.7-drivers/lib/dri","LOCALE_ARCHIVE":"/usr/lib/locale/locale-archive","NIXPKGS_ALLOW_UNFREE":"1","NIX_BINTOOLS":"/nix/store/kln7kinji3b7sz8r50h4gn9yy6k1js9a-binutils-wrapper-2.41","NIX_BINTOOLS_WRAPPER_TARGET_HOST_x86_64_unknown_linux_gnu":"1","NIX_BUILD_CORES":"4","NIX_BUILD_TOP":"/tmp","NIX_CC":"/nix/store/9bv7dcvmfcjnmg5mnqwqlq2wxfn8d7yi-gcc-wrapper-13.2.0","NIX_CC_WRAPPER_TARGET_HOST_x86_64_unknown_linux_gnu":"1","NIX_CFLAGS_COMPILE":" -frandom-seed=yf3p5xmdpd -isystem /nix/store/07s64wxjzk6z1glwxvl3yq81vdn42k40-postgresql-15.7/include -isystem /nix/store/smacbfb82wp7ncz2rwac68jd50qxr70a-libglvnd-1.7.0-dev/include -isystem /nix/store/a83znbrflv30lvhww0d2rljbyd5mw0c0-pulseaudio-17.0-dev/include -isystem /nix/store/xslrgzkvciny0m0cqbgq4bnvydvpdkgx-libcap-2.69-dev/include -isystem /nix/store/nn78wg4rgns62w5sfzyxashxizd0lfva-attr-2.5.2-dev/include -isystem /nix/store/07s64wxjzk6z1glwxvl3yq81vdn42k40-postgresql-15.7/include -isystem /nix/store/smacbfb82wp7ncz2rwac68jd50qxr70a-libglvnd-1.7.0-dev/include -isystem /nix/store/a83znbrflv30lvhww0d2rljbyd5mw0c0-pulseaudio-17.0-dev/include -isystem /nix/store/xslrgzkvciny0m0cqbgq4bnvydvpdkgx-libcap-2.69-dev/include -isystem /nix/store/nn78wg4rgns62w5sfzyxashxizd0lfva-attr-2.5.2-dev/include","NIX_ENFORCE_NO_NATIVE":"1","NIX_HARDENING_ENABLE":"bindnow format fortify fortify3 pic relro stackprotector strictoverflow","NIX_LDFLAGS":"-rpath /nix/store/yf3p5xmdpdvjjsa0c5g63q3jhhgwrryp-nix-shell/lib  -L/nix/store/07s64wxjzk6z1glwxvl3yq81vdn42k40-postgresql-15.7/lib -L/nix/store/xb4h083j02mr2ix7pgj7iawxh2hk100l-postgresql-15.7-lib/lib -L/nix/store/hggpnywm6l7cfh2ml1ynm50ap9x4f9rn-mesa-24.0.7-drivers/lib -L/nix/store/jz3vvf4nsyirb25rh9dbhksm4gq6wybb-libglvnd-1.7.0/lib -L/nix/store/5nk2ga7i2f030am4qpcdsd8qlk6i3z83-attr-2.5.2/lib -L/nix/store/yvhyhcfhc98wm86pw4ygk5jdr804iwrw-libcap-2.69-lib/lib -L/nix/store/pn9glkalcj7i5p549dpsl1c46pkb13xr-pulseaudio-17.0/lib -L/nix/store/07s64wxjzk6z1glwxvl3yq81vdn42k40-postgresql-15.7/lib -L/nix/store/xb4h083j02mr2ix7pgj7iawxh2hk100l-postgresql-15.7-lib/lib -L/nix/store/hggpnywm6l7cfh2ml1ynm50ap9x4f9rn-mesa-24.0.7-drivers/lib -L/nix/store/jz3vvf4nsyirb25rh9dbhksm4gq6wybb-libglvnd-1.7.0/lib -L/nix/store/5nk2ga7i2f030am4qpcdsd8qlk6i3z83-attr-2.5.2/lib -L/nix/store/yvhyhcfhc98wm86pw4ygk5jdr804iwrw-libcap-2.69-lib/lib -L/nix/store/pn9glkalcj7i5p549dpsl1c46pkb13xr-pulseaudio-17.0/lib","NIX_PATH":"nixpkgs=/home/runner/.nix-defexpr/channels/nixpkgs-stable-24_05:/home/runner/.nix-defexpr/channels","NIX_PROFILES":"/nix/var/nix/profiles/default /home/runner/.nix-profile","NIX_PS1":"\\[\\033[01;34m\\]\\w\\[\\033[00m\\]\\$ ","NIX_STORE":"/nix/store","NM":"nm","OBJCOPY":"objcopy","OBJDUMP":"objdump","PATH":"/nix/store/0z5iwcvalafm3j2c5pfhllsfbxrbyzf4-postgresql-16.5/bin:/nix/store/r2wrscmjzn4f2f7wk7q2ms2h96mjwzv7-npx/bin:/home/runner/workspace/.config/npm/node_global/bin:/home/runner/workspace/node_modules/.bin:/nix/store/rrz8cqhldyl17bbs60g7d8vbaadkxc40-nodejs-20.18.1-wrapped/bin:/nix/store/7zaapw8wkywsw9z5lkkk5k608xpn7wfl-bun-1.2.3/bin:/nix/store/z8s3r4vwf4r26g2d7shnw5lva6ihim8f-pnpm-9.15.0/bin:/nix/store/jcgdksj946l5l42c2y9ks2l4g6n74h3f-yarn-1.22.22/bin:/nix/store/2s17mrby0ph00z22rkabfs9vzpzx1r70-prettier-3.3.3/bin:/nix/store/rdd4pnr4x9rqc9wgbibhngv217w2xvxl-bash-interactive-5.2p26/bin:/nix/store/nbad47q0m0m9c5xid7zh05hiknwircbp-patchelf-0.15.0/bin:/nix/store/9bv7dcvmfcjnmg5mnqwqlq2wxfn8d7yi-gcc-wrapper-13.2.0/bin:/nix/store/14c6s4xzhy14i2b05s00rjns2j93gzz4-gcc-13.2.0/bin:/nix/store/c2i631h8i5vcs1sqifwxfsazhwrg6wr5-glibc-2.39-52-bin/bin:/nix/store/php4qidg2bxzmm79vpri025bqi0fa889-coreutils-9.5/bin:/nix/store/kln7kinji3b7sz8r50h4gn9yy6k1js9a-binutils-wrapper-2.41/bin:/nix/store/bgcaxhhxswzvmxjbbgvvaximm5hwghz1-binutils-2.41/bin:/nix/store/07s64wxjzk6z1glwxvl3yq81vdn42k40-postgresql-15.7/bin:/nix/store/ha8rh8jg19r8418baa8ps9b9kvd6szcf-attr-2.5.2-bin/bin:/nix/store/cnnmb3axmv43lj22gny3m4hj06i1nc7c-libcap-2.69/bin:/nix/store/pn9glkalcj7i5p549dpsl1c46pkb13xr-pulseaudio-17.0/bin:/nix/store/jjcsr5gs4qanf7ln5c6wgcq4sn75a978-findutils-4.9.0/bin:/nix/store/i34mknsjgrfyy71k2h79gda0bvagzc2j-diffutils-3.10/bin:/nix/store/5zjms21vpxlkbc0qyl5pmj2sidfmzmd7-gnused-4.9/bin:/nix/store/28gpmx3z6ss3znd7fhmrzmvk3x5lnfbk-gnugrep-3.11/bin:/nix/store/8vvkbgmnin1x2jkp7wcb2zg1p0vc4ks9-gawk-5.2.2/bin:/nix/store/rik7p68cq7yzlj5pmfpf4yv6jnrpvlgf-gnutar-1.35/bin:/nix/store/j5chw7v1x3vlmf3wmdpdb5gwh9hl0b80-gzip-1.13/bin:/nix/store/mxcq77rlan82dzpv3cgj0fh6qvv8ncil-bzip2-1.0.8-bin/bin:/nix/store/cdzpn0rdq810aknww3w9fy3wmw9ixr66-gnumake-4.4.1/bin:/nix/store/306znyj77fv49kwnkpxmb0j2znqpa8bj-bash-5.2p26/bin:/nix/store/0lfxbmchigx9vs9qmrlbahcy6nxwfnj1-patch-2.7.6/bin:/nix/store/6i4xxaa812vsbli9jkq4mksdddrk27lw-xz-5.4.6-bin/bin:/nix/store/xx7x1dwybpssfhq8yikvzz38bh3yrq97-file-5.45/bin:/nix/store/qq3yz6h7hy129z1zvhvf33i96fk8p5xs-pid1/bin:/nix/store/ikaf2i4slwdr9a0h2h74abssgxn9ky23-replit-runtime-path/bin:/home/runner/.nix-profile/bin:/home/runner/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin","PROMPT_DIRTRIM":"2","RANLIB":"ranlib","READELF":"readelf","REPLIT_BASHRC":"/nix/store/0izq9daf9j0zj8ww8apwwk74i9xv7y1n-replit-bashrc/bashrc","REPLIT_CLI":"/nix/store/mb249m51d32xm5dprdy7jkkmn6s2h22i-pid1-0.0.1/bin/replit","REPLIT_CLUSTER":"riker","REPLIT_DB_URL":"https://kv.replit.com/v0/eyJhbGciOiJIUzUxMiIsImlzcyI6ImNvbm1hbiIsImtpZCI6InByb2Q6MSIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJjb25tYW4iLCJleHAiOjE3NDQ5MDUwNzMsImlhdCI6MTc0NDc5MzQ3MywiZGF0YWJhc2VfaWQiOiI3OTc1ZGZiMS1hM2RiLTRjYTEtOTVlNS02Nzg5OWIwYWM4MGQifQ.8iW4J3i6cW-XopsdvLH9YDAGrDjg5-G2sKhRvRJ95j4JW2dckt0CatGzr_eOlPU432HqD3n4NSqjWZY13nxz6w","REPLIT_DEV_DOMAIN":"7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev","REPLIT_DOMAINS":"7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev","REPLIT_ENVIRONMENT":"production","REPLIT_LD_AUDIT":"/nix/store/n5x1kgbz8zjh63ymsijbislyi1n1hir6-replit_rtld_loader-1/rtld_loader.so","REPLIT_LD_LIBRARY_PATH":"/nix/store/xb4h083j02mr2ix7pgj7iawxh2hk100l-postgresql-15.7-lib/lib:/nix/store/hggpnywm6l7cfh2ml1ynm50ap9x4f9rn-mesa-24.0.7-drivers/lib:/nix/store/jz3vvf4nsyirb25rh9dbhksm4gq6wybb-libglvnd-1.7.0/lib:/nix/store/pn9glkalcj7i5p549dpsl1c46pkb13xr-pulseaudio-17.0/lib","REPLIT_NIX_CHANNEL":"stable-24_05","REPLIT_PID1_FLAG_NIXMODULES_BEFORE_REPLIT_NIX":"1","REPLIT_PID1_FLAG_REPLIT_RTLD_LOADER":"1","REPLIT_PID1_VERSION":"0.0.0-016c47a","REPLIT_RIPPKGS_INDICES":"/nix/store/l5gcmdp908sji4wchfp8csflhjcgnmm3-rippkgs-indices","REPLIT_RTLD_LOADER":"1","REPLIT_SUBCLUSTER":"paid","REPL_HOME":"/home/runner/workspace","REPL_ID":"7975dfb1-a3db-4ca1-95e5-67899b0ac80d","REPL_IDENTITY":"v2.public.Q2lRM09UYzFaR1ppTVMxaE0yUmlMVFJqWVRFdE9UVmxOUzAyTnpnNU9XSXdZV000TUdRU0MyZGhaSE5rWlc1amIyUmxHZ2hXZVdKbFEyaGxlQ0lrTnprM05XUm1ZakV0WVROa1lpMDBZMkV4TFRrMVpUVXROamM0T1RsaU1HRmpPREJrT1BDWGhndGFEUW9GY21sclpYSVNCSEJoYVdRPf49UmuhHJqV3lMEynYPg0fXkDTfA1wjCJ5Zizoxq-YateS_cA6BXU1BRmkGaBNzxvW3HWuPMVNHyFelDbDMsQs.R0FFaUJtTnZibTFoYmhLTENIWXlMbkIxWW14cFl5NVJNbVF6VTFSb01FNTZiREprTVd4U1pHcFJlV0ZxWkZKU1ZrNUZVVmR3UTAxRVVsbFJWVXB2VVRJMWNsTXhRakJSVmtwMlVUQmtRbFpYUmt0YU1qbHlWRzV3Y2swd05WaFZiVEZhWVd0V01GZFdVazloTVd4d1RVUkNXazFyVmpSVVJsSnlUVlp3VlZaWVVrOWhiVTB3VkRGU2MyRlZNVWhTYlhCUVVrVktjbEl5WTNkVk1FMTVXa2RvWVZORk5YSlhiR014WVcxSmVWVnRlRWhhTVZVd1QwVndiRkl3VGpSaU1HaEtXakZhTlZsV1pEQmlSMDV2WWpCa1RGb3hTak5YVm1SellUQnNjVlp1U2s1aFZGWXpXa1prUzJNeVJsaFVXRlpzVWpCd1lWVjZSa3BPUjBwMFZXcEdWMDFXV2s1YVJsWkxaR3MwZVUxRVFrNVRSa3BXV2xWWk5WSkdTbkpoUlZwVVRXdHJlRmw2UWtkaGJGcEZZa1JPVkZKV1dUQlVWVnBoVFRGR1VsQlVNbnBCTldkelgzQjFiMVpEWVRod2MyTXRkbkJ3ZEdjMlJYazBhR3AxT0ZobFp6aHNOVzFMYlROMmNrOWlWVTVhTUZGV09GSlBkMlEzWWxSeGJYbHNiMlZ6WjJob0xVRk9Tak5LVUZjMlZ6TnNlVVpLTkVndVVqQkdSbUZWU25SVWJscHBZbFJHYjFsdGFFMVphMFoxVjFoc1RXSnJTWGhYVnpFMFkwWnNOVTVXU2s1aVZra3lWbFJHYTAxSFZuUlRiRnBVWW01Q1YxWnRNVFJWTVZKeVZXMUdUbFp1UWxkVk1uUlBWa1phV1dGRlZsWmxhMHB5VldwQk1WTldSbkpUYkZwT1VteHdVMVp0Y0U5WlYxSlhZak5vVTJKWGFGTldha3B2WkZaV1dHUkhkR2xpUlRWWVdXdFdUMVp0U2xWaVJWWldZV3RLU0ZwSGVITldiRXAxVW14S1YxWllRa3BXTW5CRFl6RmtjMUpzYUdoVFJuQlRWRlZrVTFFeFdrZGFSV1JTWWxWYVNWZHJWWGhWTURGMFZXdDBWMDFXV2xSVlZFcEtaREZTY21GR1NsZGhNWEIyVmxaYWEySXlTbk5VYmtwcFUwVmFXRmx0ZEhkVU1XeFhWV3hrVGsxWVFraFhhMVl3WVdzeGNsZHNiRmRTYldoWVZrUkdZV1JIVmtsalJtUlhZbFpLU1ZaR1VrdFVNazE1VTJwYVZtRjZiRmhVVjNoTFlqRlplVTFVVWxSTmExcEhWRlpXYTFaSFNrWlhiRnBhVm5wRk1GZFdXbk5PYkVaVlVtMXdhVkpZUWpaV1JFWlhXVmRGZVZOc2JGWldSVnBYV1d0YVlXTnNjRWhsUlZwc1VtNUNSbFl5TVhkaFIwVjRZMGM1VjJGcldsUlZla1pPWlVaYWMxTnNSbGRTUlVvelZqSjBZVmR0VG5SalJURlFWMFUwZWxwRlZscE9WbkJGVWxoU2FXSlVWbEZVTUdSaFZXMUtXR0ZFU2xSU1ZuQjRWbXRXY21SSFVrVmhSWEJwWWxad1VWZEVTWGhXVlRGMFdYcFNhbGRJUWtaVmEyUldUa1phUldKR1VtaE5Wa28yVjIxNGIySlhWbkppZWtKWVZsVXhObGR0YzNkbGJHUldUbGhLVkZaSFVsbFhWMnQzVGxaS2NsVnRPVTloVkVaTVZHcEpOVkpGZUhOVFdHUlRZVEZ3YjFac1ZuZE5SbHBJVGxkR2FGWXdjRlpWYlRBMVYyMUtXRlZxU2xaaGEzQlFWVEZhVDJSV1pIUlNiRTVUWlcxbk1BPT0","REPL_IDENTITY_KEY":"k2.secret.05-Au_uWQVZaivk0nEsKzPFwnHl9p1kBx5k8NxpqUJnFtgpHyd25ZQu4GjubjS1PH8IUcQpvmwBxP3AcTHRXAA","REPL_IMAGE":"gcr.io/marine-cycle-160323/nix:bf8590a3e2f0a8b70b7ca175eeed9074dffbfca9","REPL_LANGUAGE":"nix","REPL_OWNER":"gadsdencode","REPL_OWNER_ID":"23170032","REPL_PUBKEYS":"{\"crosis-ci\":\"7YlpcYh82oR9NSTtSYtR5jDL4onNzCGJGq6b+9CuZII=\",\"crosis-ci:1\":\"7YlpcYh82oR9NSTtSYtR5jDL4onNzCGJGq6b+9CuZII=\",\"crosis-ci:latest\":\"7YlpcYh82oR9NSTtSYtR5jDL4onNzCGJGq6b+9CuZII=\",\"prod\":\"tGsjlu/BJvWTgvMaX7acuUb7AO1dXOrRiuk7y083RFE=\",\"prod:1\":\"tGsjlu/BJvWTgvMaX7acuUb7AO1dXOrRiuk7y083RFE=\",\"prod:2\":\"8uGN+vfszlnV93/HCSHlVLG0xddMlPkir1Ni4JKT4+w=\",\"prod:3\":\"9+MCOSHQSQlcodXoot8dC8NLhc862nLkx1/VMsbY2h8=\",\"prod:4\":\"8uGN+vfszlnV93/HCSHlVLG0xddMlPkir1Ni4JKT4+w=\",\"prod:5\":\"9+MCOSHQSQlcodXoot8dC8NLhc862nLkx1/VMsbY2h8=\",\"prod:latest\":\"tGsjlu/BJvWTgvMaX7acuUb7AO1dXOrRiuk7y083RFE=\",\"vault-goval-token\":\"D5jJoMx1Ml54HM92NLgXl+MzptwDqbSsfyFG6f52g9E=\",\"vault-goval-token:1\":\"D5jJoMx1Ml54HM92NLgXl+MzptwDqbSsfyFG6f52g9E=\",\"vault-goval-token:latest\":\"D5jJoMx1Ml54HM92NLgXl+MzptwDqbSsfyFG6f52g9E=\"}","REPL_SLUG":"workspace","SIZE":"size","SOURCE_DATE_EPOCH":"315532800","STRINGS":"strings","STRIP":"strip","USER":"runner","XDG_CACHE_HOME":"/home/runner/workspace/.cache","XDG_CONFIG_HOME":"/home/runner/workspace/.config","XDG_DATA_DIRS":"/nix/store/nbad47q0m0m9c5xid7zh05hiknwircbp-patchelf-0.15.0/share:/nix/store/ikaf2i4slwdr9a0h2h74abssgxn9ky23-replit-runtime-path/share","XDG_DATA_HOME":"/home/runner/workspace/.local/share","_":"/nix/store/php4qidg2bxzmm79vpri025bqi0fa889-coreutils-9.5/bin/env","__EGL_VENDOR_LIBRARY_FILENAMES":"/nix/store/hggpnywm6l7cfh2ml1ynm50ap9x4f9rn-mesa-24.0.7-drivers/share/glvnd/egl_vendor.d/50_mesa.json","__ETC_PROFILE_SOURCED":"1","__structuredAttrs":"","buildInputs":"/nix/store/07s64wxjzk6z1glwxvl3yq81vdn42k40-postgresql-15.7 /nix/store/hggpnywm6l7cfh2ml1ynm50ap9x4f9rn-mesa-24.0.7-drivers /nix/store/smacbfb82wp7ncz2rwac68jd50qxr70a-libglvnd-1.7.0-dev /nix/store/a83znbrflv30lvhww0d2rljbyd5mw0c0-pulseaudio-17.0-dev","buildPhase":"{ echo \"------------------------------------------------------------\";\n  echo \" WARNING: the existence of this path is not guaranteed.\";\n  echo \" It is an internal implementation detail for pkgs.mkShell.\";\n  echo \"------------------------------------------------------------\";\n  echo;\n  # Record all build inputs as runtime dependencies\n  export;\n} \u003e\u003e \"$out\"\n","builder":"/nix/store/306znyj77fv49kwnkpxmb0j2znqpa8bj-bash-5.2p26/bin/bash","cmakeFlags":"","configureFlags":"","depsBuildBuild":"","depsBuildBuildPropagated":"","depsBuildTarget":"","depsBuildTargetPropagated":"","depsHostHost":"","depsHostHostPropagated":"","depsTargetTarget":"","depsTargetTargetPropagated":"","doCheck":"","doInstallCheck":"","mesonFlags":"","nativeBuildInputs":"","npm_config_prefix":"/home/runner/workspace/.config/npm/node_global","out":"/nix/store/yf3p5xmdpdvjjsa0c5g63q3jhhgwrryp-nix-shell","outputs":"out","patches":"","phases":"buildPhase","preferLocalBuild":"1","propagatedBuildInputs":"","propagatedNativeBuildInputs":"","shell":"/nix/store/306znyj77fv49kwnkpxmb0j2znqpa8bj-bash-5.2p26/bin/bash","shellHook":"","stdenv":"/nix/store/xfhkjnpqjwlf6hlk1ysmq3aaq80f3bjj-stdenv-linux","strictDeps":"","system":"x86_64-linux"}}
</file>

<file path=".cache/replit/modules/nodejs-20.res">
{"type":"resolve","resolvedModuleId":"nodejs-20","inputHash":"","resolutionPath":["nodejs-20"],"error":"","Changed":true}
</file>

<file path=".cache/replit/modules/postgresql-16.res">
{"type":"resolve","resolvedModuleId":"postgresql-16","inputHash":"","resolutionPath":["postgresql-16"],"error":"","Changed":true}
</file>

<file path=".cache/replit/modules/replit.res">
{"type":"resolve","resolvedModuleId":"replit","inputHash":"","resolutionPath":["replit"],"error":"","Changed":true}
</file>

<file path=".cache/replit/modules/web.res">
{"type":"resolve","resolvedModuleId":"web","inputHash":"","resolutionPath":["web"],"error":"","Changed":true}
</file>

<file path=".cache/replit/nix/env.json">
{"entries":{"replit.nix":{"env":{"AR":"ar","AS":"as","CC":"gcc","CONFIG_SHELL":"/nix/store/306znyj77fv49kwnkpxmb0j2znqpa8bj-bash-5.2p26/bin/bash","CXX":"g++","HOST_PATH":"/nix/store/07s64wxjzk6z1glwxvl3yq81vdn42k40-postgresql-15.7/bin:/nix/store/ha8rh8jg19r8418baa8ps9b9kvd6szcf-attr-2.5.2-bin/bin:/nix/store/cnnmb3axmv43lj22gny3m4hj06i1nc7c-libcap-2.69/bin:/nix/store/pn9glkalcj7i5p549dpsl1c46pkb13xr-pulseaudio-17.0/bin:/nix/store/php4qidg2bxzmm79vpri025bqi0fa889-coreutils-9.5/bin:/nix/store/jjcsr5gs4qanf7ln5c6wgcq4sn75a978-findutils-4.9.0/bin:/nix/store/i34mknsjgrfyy71k2h79gda0bvagzc2j-diffutils-3.10/bin:/nix/store/5zjms21vpxlkbc0qyl5pmj2sidfmzmd7-gnused-4.9/bin:/nix/store/28gpmx3z6ss3znd7fhmrzmvk3x5lnfbk-gnugrep-3.11/bin:/nix/store/8vvkbgmnin1x2jkp7wcb2zg1p0vc4ks9-gawk-5.2.2/bin:/nix/store/rik7p68cq7yzlj5pmfpf4yv6jnrpvlgf-gnutar-1.35/bin:/nix/store/j5chw7v1x3vlmf3wmdpdb5gwh9hl0b80-gzip-1.13/bin:/nix/store/mxcq77rlan82dzpv3cgj0fh6qvv8ncil-bzip2-1.0.8-bin/bin:/nix/store/cdzpn0rdq810aknww3w9fy3wmw9ixr66-gnumake-4.4.1/bin:/nix/store/306znyj77fv49kwnkpxmb0j2znqpa8bj-bash-5.2p26/bin:/nix/store/0lfxbmchigx9vs9qmrlbahcy6nxwfnj1-patch-2.7.6/bin:/nix/store/6i4xxaa812vsbli9jkq4mksdddrk27lw-xz-5.4.6-bin/bin:/nix/store/xx7x1dwybpssfhq8yikvzz38bh3yrq97-file-5.45/bin","LD":"ld","LIBGL_DRIVERS_PATH":"/nix/store/hggpnywm6l7cfh2ml1ynm50ap9x4f9rn-mesa-24.0.7-drivers/lib/dri","LOCALE_ARCHIVE":"/usr/lib/locale/locale-archive","NIX_BINTOOLS":"/nix/store/kln7kinji3b7sz8r50h4gn9yy6k1js9a-binutils-wrapper-2.41","NIX_BINTOOLS_WRAPPER_TARGET_HOST_x86_64_unknown_linux_gnu":"1","NIX_BUILD_CORES":"4","NIX_BUILD_TOP":"/tmp","NIX_CC":"/nix/store/9bv7dcvmfcjnmg5mnqwqlq2wxfn8d7yi-gcc-wrapper-13.2.0","NIX_CC_WRAPPER_TARGET_HOST_x86_64_unknown_linux_gnu":"1","NIX_CFLAGS_COMPILE":" -frandom-seed=yf3p5xmdpd -isystem /nix/store/07s64wxjzk6z1glwxvl3yq81vdn42k40-postgresql-15.7/include -isystem /nix/store/smacbfb82wp7ncz2rwac68jd50qxr70a-libglvnd-1.7.0-dev/include -isystem /nix/store/a83znbrflv30lvhww0d2rljbyd5mw0c0-pulseaudio-17.0-dev/include -isystem /nix/store/xslrgzkvciny0m0cqbgq4bnvydvpdkgx-libcap-2.69-dev/include -isystem /nix/store/nn78wg4rgns62w5sfzyxashxizd0lfva-attr-2.5.2-dev/include -isystem /nix/store/07s64wxjzk6z1glwxvl3yq81vdn42k40-postgresql-15.7/include -isystem /nix/store/smacbfb82wp7ncz2rwac68jd50qxr70a-libglvnd-1.7.0-dev/include -isystem /nix/store/a83znbrflv30lvhww0d2rljbyd5mw0c0-pulseaudio-17.0-dev/include -isystem /nix/store/xslrgzkvciny0m0cqbgq4bnvydvpdkgx-libcap-2.69-dev/include -isystem /nix/store/nn78wg4rgns62w5sfzyxashxizd0lfva-attr-2.5.2-dev/include","NIX_ENFORCE_NO_NATIVE":"1","NIX_HARDENING_ENABLE":"bindnow format fortify fortify3 pic relro stackprotector strictoverflow","NIX_LDFLAGS":"-rpath /nix/store/yf3p5xmdpdvjjsa0c5g63q3jhhgwrryp-nix-shell/lib  -L/nix/store/07s64wxjzk6z1glwxvl3yq81vdn42k40-postgresql-15.7/lib -L/nix/store/xb4h083j02mr2ix7pgj7iawxh2hk100l-postgresql-15.7-lib/lib -L/nix/store/hggpnywm6l7cfh2ml1ynm50ap9x4f9rn-mesa-24.0.7-drivers/lib -L/nix/store/jz3vvf4nsyirb25rh9dbhksm4gq6wybb-libglvnd-1.7.0/lib -L/nix/store/5nk2ga7i2f030am4qpcdsd8qlk6i3z83-attr-2.5.2/lib -L/nix/store/yvhyhcfhc98wm86pw4ygk5jdr804iwrw-libcap-2.69-lib/lib -L/nix/store/pn9glkalcj7i5p549dpsl1c46pkb13xr-pulseaudio-17.0/lib -L/nix/store/07s64wxjzk6z1glwxvl3yq81vdn42k40-postgresql-15.7/lib -L/nix/store/xb4h083j02mr2ix7pgj7iawxh2hk100l-postgresql-15.7-lib/lib -L/nix/store/hggpnywm6l7cfh2ml1ynm50ap9x4f9rn-mesa-24.0.7-drivers/lib -L/nix/store/jz3vvf4nsyirb25rh9dbhksm4gq6wybb-libglvnd-1.7.0/lib -L/nix/store/5nk2ga7i2f030am4qpcdsd8qlk6i3z83-attr-2.5.2/lib -L/nix/store/yvhyhcfhc98wm86pw4ygk5jdr804iwrw-libcap-2.69-lib/lib -L/nix/store/pn9glkalcj7i5p549dpsl1c46pkb13xr-pulseaudio-17.0/lib","NIX_STORE":"/nix/store","NM":"nm","OBJCOPY":"objcopy","OBJDUMP":"objdump","PATH":"/nix/store/rdd4pnr4x9rqc9wgbibhngv217w2xvxl-bash-interactive-5.2p26/bin:/nix/store/nbad47q0m0m9c5xid7zh05hiknwircbp-patchelf-0.15.0/bin:/nix/store/9bv7dcvmfcjnmg5mnqwqlq2wxfn8d7yi-gcc-wrapper-13.2.0/bin:/nix/store/14c6s4xzhy14i2b05s00rjns2j93gzz4-gcc-13.2.0/bin:/nix/store/c2i631h8i5vcs1sqifwxfsazhwrg6wr5-glibc-2.39-52-bin/bin:/nix/store/php4qidg2bxzmm79vpri025bqi0fa889-coreutils-9.5/bin:/nix/store/kln7kinji3b7sz8r50h4gn9yy6k1js9a-binutils-wrapper-2.41/bin:/nix/store/bgcaxhhxswzvmxjbbgvvaximm5hwghz1-binutils-2.41/bin:/nix/store/07s64wxjzk6z1glwxvl3yq81vdn42k40-postgresql-15.7/bin:/nix/store/ha8rh8jg19r8418baa8ps9b9kvd6szcf-attr-2.5.2-bin/bin:/nix/store/cnnmb3axmv43lj22gny3m4hj06i1nc7c-libcap-2.69/bin:/nix/store/pn9glkalcj7i5p549dpsl1c46pkb13xr-pulseaudio-17.0/bin:/nix/store/php4qidg2bxzmm79vpri025bqi0fa889-coreutils-9.5/bin:/nix/store/jjcsr5gs4qanf7ln5c6wgcq4sn75a978-findutils-4.9.0/bin:/nix/store/i34mknsjgrfyy71k2h79gda0bvagzc2j-diffutils-3.10/bin:/nix/store/5zjms21vpxlkbc0qyl5pmj2sidfmzmd7-gnused-4.9/bin:/nix/store/28gpmx3z6ss3znd7fhmrzmvk3x5lnfbk-gnugrep-3.11/bin:/nix/store/8vvkbgmnin1x2jkp7wcb2zg1p0vc4ks9-gawk-5.2.2/bin:/nix/store/rik7p68cq7yzlj5pmfpf4yv6jnrpvlgf-gnutar-1.35/bin:/nix/store/j5chw7v1x3vlmf3wmdpdb5gwh9hl0b80-gzip-1.13/bin:/nix/store/mxcq77rlan82dzpv3cgj0fh6qvv8ncil-bzip2-1.0.8-bin/bin:/nix/store/cdzpn0rdq810aknww3w9fy3wmw9ixr66-gnumake-4.4.1/bin:/nix/store/306znyj77fv49kwnkpxmb0j2znqpa8bj-bash-5.2p26/bin:/nix/store/0lfxbmchigx9vs9qmrlbahcy6nxwfnj1-patch-2.7.6/bin:/nix/store/6i4xxaa812vsbli9jkq4mksdddrk27lw-xz-5.4.6-bin/bin:/nix/store/xx7x1dwybpssfhq8yikvzz38bh3yrq97-file-5.45/bin","RANLIB":"ranlib","READELF":"readelf","REPLIT_LD_LIBRARY_PATH":"/nix/store/xb4h083j02mr2ix7pgj7iawxh2hk100l-postgresql-15.7-lib/lib:/nix/store/hggpnywm6l7cfh2ml1ynm50ap9x4f9rn-mesa-24.0.7-drivers/lib:/nix/store/jz3vvf4nsyirb25rh9dbhksm4gq6wybb-libglvnd-1.7.0/lib:/nix/store/pn9glkalcj7i5p549dpsl1c46pkb13xr-pulseaudio-17.0/lib","SIZE":"size","SOURCE_DATE_EPOCH":"315532800","STRINGS":"strings","STRIP":"strip","XDG_DATA_DIRS":"/nix/store/nbad47q0m0m9c5xid7zh05hiknwircbp-patchelf-0.15.0/share","_":"/nix/store/php4qidg2bxzmm79vpri025bqi0fa889-coreutils-9.5/bin/env","__EGL_VENDOR_LIBRARY_FILENAMES":"/nix/store/hggpnywm6l7cfh2ml1ynm50ap9x4f9rn-mesa-24.0.7-drivers/share/glvnd/egl_vendor.d/50_mesa.json","__ETC_PROFILE_SOURCED":"1","__structuredAttrs":"","buildInputs":"/nix/store/07s64wxjzk6z1glwxvl3yq81vdn42k40-postgresql-15.7 /nix/store/hggpnywm6l7cfh2ml1ynm50ap9x4f9rn-mesa-24.0.7-drivers /nix/store/smacbfb82wp7ncz2rwac68jd50qxr70a-libglvnd-1.7.0-dev /nix/store/a83znbrflv30lvhww0d2rljbyd5mw0c0-pulseaudio-17.0-dev","buildPhase":"{ echo \"------------------------------------------------------------\";\n  echo \" WARNING: the existence of this path is not guaranteed.\";\n  echo \" It is an internal implementation detail for pkgs.mkShell.\";\n  echo \"------------------------------------------------------------\";\n  echo;\n  # Record all build inputs as runtime dependencies\n  export;\n} \u003e\u003e \"$out\"\n","builder":"/nix/store/306znyj77fv49kwnkpxmb0j2znqpa8bj-bash-5.2p26/bin/bash","cmakeFlags":"","configureFlags":"","depsBuildBuild":"","depsBuildBuildPropagated":"","depsBuildTarget":"","depsBuildTargetPropagated":"","depsHostHost":"","depsHostHostPropagated":"","depsTargetTarget":"","depsTargetTargetPropagated":"","doCheck":"","doInstallCheck":"","mesonFlags":"","nativeBuildInputs":"","out":"/nix/store/yf3p5xmdpdvjjsa0c5g63q3jhhgwrryp-nix-shell","outputs":"out","patches":"","phases":"buildPhase","preferLocalBuild":"1","propagatedBuildInputs":"","propagatedNativeBuildInputs":"","shell":"/nix/store/306znyj77fv49kwnkpxmb0j2znqpa8bj-bash-5.2p26/bin/bash","shellHook":"","stdenv":"/nix/store/xfhkjnpqjwlf6hlk1ysmq3aaq80f3bjj-stdenv-linux","strictDeps":"","system":"x86_64-linux"},"dependencies":[{"path":"replit.nix","mod_time":"2024-12-16T00:35:46.627975127Z"}],"closure":["/nix/store/1q9vc0lq7qjlfjz47mfmlzdf86c543jy-xgcc-13.2.0-libgcc","/nix/store/yfp7dr8m7zi7kxk49wd714gwvhb105hf-libunistring-1.1","/nix/store/ic63ay0py10fyryaw7345k4ps32da33w-libidn2-2.3.7","/nix/store/k7zgvzp2r31zkg9xqgjim7mbknryv6bs-glibc-2.39-52","/nix/store/lv6nackqis28gg7l2ic43f6nk52hb39g-zlib-1.3.1","/nix/store/y5p181lnbh8rrwd3ljp83k0cn3xklyk2-sqlite-3.45.3","/nix/store/05n35k0p8l969kfskxqhbqhy8il3a3cq-util-linux-minimal-2.40.1-lib","/nix/store/gp504m4dvw5k2pdx6pccf1km79fkcwgf-openssl-3.0.13","/nix/store/306znyj77fv49kwnkpxmb0j2znqpa8bj-bash-5.2p26","/nix/store/qannz09m66qpcy3ny1f4nkl4ql0g71ks-openssl-3.0.13-bin","/nix/store/191vca5vdxdlr32k2hpzd66mic98930f-openssl-3.0.13-dev","/nix/store/af9bsxhqip4jpf6qb3g99vxb23f3abik-ncurses-6.4-man","/nix/store/j4m3lwhh4x0bzilvi77d512ahry775nq-ncurses-6.4","/nix/store/1c9jq1csrx42g5vqynlfl0x63k2nx1x9-ncurses-6.4-dev","/nix/store/g222zncwmspvsj2cfwcl74f6hbfal0cz-find-xml-catalogs-hook","/nix/store/kf7fzax0av9him9m4zcmbqmihh5108wq-libxml2-2.12.7","/nix/store/p3109b71w6xbc9zdj2gdmdy1iri50311-libxml2-2.12.7-bin","/nix/store/qj9byzfvh7dd61kk0aglj7cwqj1xqg6l-zlib-1.3.1-dev","/nix/store/37979sqc7yw9ps0c4xl9jjkhq0w1hw8b-libxml2-2.12.7-dev","/nix/store/4n8fsrg6kslmnq5g2xsrs6vmpqfbyz2m-readline-8.2p10","/nix/store/0vcrqaqf5sk158xy77mcl52374c1dlbi-keyutils-1.6.3-lib","/nix/store/5pcy995yarjy7bfdswgkfggbzg48dlq0-libkrb5-1.21.2","/nix/store/193fnfad15rgch01xxg7vf81rmmfwp8w-libgpg-error-1.48","/nix/store/59q5nl573y3znmwqqaw91m0crrss2vgd-npth-1.7","/nix/store/6c947fh1y2ln5cr8kpcl14b3hfnni0av-libgcrypt-1.10.3","/nix/store/vwzyblmr6md6jimsb4lfhig0qmr9j991-libassuan-2.5.7","/nix/store/0vjmplyvp26dc08j6bfff8y4ajmwmnlc-gnupg-2.4.5","/nix/store/bqznkfzv8dy1c4ngp6nnhrcxsprdsbh0-publicsuffix-list-0-unstable-2024-01-07","/nix/store/2vqgx0si98m8c3yd2fhspmikavf3nvmd-libpsl-0.21.5","/nix/store/0rxb3ixzk4zaqivc9s795m0a3679wbw2-gcc-13.2.0-libgcc","/nix/store/xvzz97yk73hw03v5dhhz3j47ggwf1yq1-gcc-13.2.0-lib","/nix/store/by853zqacqy647v0z7l70xm77xl9ifal-zstd-1.5.6","/nix/store/jpjmh2325b6k3svvsmhj57wqlph9srdx-brotli-1.1.0-lib","/nix/store/kw1nc4sg6hp550z8g8pdjb3d3ixz4m3l-nghttp2-1.61.0-lib","/nix/store/vrqy1mn0nw6g6y0w22gipbspknnwr9q5-libssh2-1.11.0","/nix/store/36kr91f8s509z2r8hqvpayw5bqyqgyzr-curl-8.7.1","/nix/store/ggsvk22xykxpsqznqipvr6lfl31qzslg-glibc-2.39-52-getent","/nix/store/5ln5j8ix4fxzvs4f21pkkp3ky56wk7rh-getent-glibc-2.39-52","/nix/store/5xynf9c9ml7d97q70kpq9rpqqmx13xl8-libxcrypt-4.4.36","/nix/store/d857vkjzr4rf68ycyfkcpdiax6v4d3c0-libtasn1-4.19.0","/nix/store/kbg5m7fyi1w23fyfmxjhhzcbd577rpg0-libffi-3.4.6","/nix/store/771mz0x86qzhlphd22awf3s601mhwpkv-p11-kit-0.25.3","/nix/store/83jfjv2b6cc33jv7q1lvvd846crkd0wh-libseccomp-2.5.5-lib","/nix/store/8anib06b270c8k62fglw6dimnwivrcvy-db-4.8.30","/nix/store/cz3qp4hxqxcwcyx04cajvjhy388dhw2q-audit-3.1.2","/nix/store/b6bgs55kyriqndagqzck1v7w8ip9dzzn-linux-pam-1.6.1","/nix/store/iia4qvk02272cvfq4lfww1a48fpk08ml-cracklib-2.9.11","/nix/store/86gmcmapjs9kdkpxvxcimq0aq8ha921q-libpwquality-1.4.5-lib","/nix/store/lphbn1va4i43fj7f3m9xskf9y86khzf3-xz-5.4.6","/nix/store/9amlz11vfaczjwjqbmsyql7kvd2bns9w-kmod-31","/nix/store/9wkzjgwdzivacwi50s6xvg6wxd1rc0s4-lz4-1.9.4","/nix/store/6i4xxaa812vsbli9jkq4mksdddrk27lw-xz-5.4.6-bin","/nix/store/g3vi60zgyjsvij7xkk6dxky1hkwh0ynd-pcre2-10.43","/nix/store/28gpmx3z6ss3znd7fhmrzmvk3x5lnfbk-gnugrep-3.11","/nix/store/hxhdhc0zddbhmqvv99nldq2gfmy9983x-zstd-1.5.6-bin","/nix/store/j5chw7v1x3vlmf3wmdpdb5gwh9hl0b80-gzip-1.13","/nix/store/xwcf1rw3ackqp2vxms9myf9jq2ny6ynv-bzip2-1.0.8","/nix/store/mxcq77rlan82dzpv3cgj0fh6qvv8ncil-bzip2-1.0.8-bin","/nix/store/5nk2ga7i2f030am4qpcdsd8qlk6i3z83-attr-2.5.2","/nix/store/7ivacs3m2fm19hyxdmrs05xisj82v6y5-gmp-with-cxx-6.3.0","/nix/store/mjgi65m3hgzqqvqcix848gskkw5zzwi9-acl-2.3.2","/nix/store/php4qidg2bxzmm79vpri025bqi0fa889-coreutils-9.5","/nix/store/c834fr2k0c3g8a3s97qilfc5q8z0mxxz-kbd-2.6.4","/nix/store/cibpmwf213v9adwh09pg2kk92xzgp39l-kexec-tools-2.0.28","/nix/store/g1iia7k8ahhmg8590cy5dm13gdg7mrz4-qrencode-4.1.1","/nix/store/wj863gr3vmxmm2ln6n52nkqmrwx75jg3-json-c-0.17","/nix/store/hw6nhpg3n3wwbvlraw40y3af5dkwl1l1-tpm2-tss-4.1.1","/nix/store/br26gam6kclf8yydzbj1wna2assyx3dm-libmnl-1.0.5","/nix/store/brm3iyn8hzixjh7rfhdqm6n2sy9kxnjd-libnftnl-1.2.6","/nix/store/whbs2x9f2nrxbzcrcla5a7pr5mvdqf98-libnl-3.8.0","/nix/store/dc36aapzjrqiyh4zzsh6ilwidcfs5xga-libpcap-1.10.4","/nix/store/x49fq9q91icvhs7drn92isz3lir2ybxs-libnfnetlink-1.0.2","/nix/store/zli13vajyx4a3vjnja0pd0irhdk7a34k-libnetfilter_conntrack-1.0.9","/nix/store/isqrn21fmha9dxf1bbl4mm7j6irpw1x8-iptables-1.8.10","/nix/store/r20kl3djvc3r5w5a0gwy4d896mn6b22a-elfutils-0.191","/nix/store/m8dz4ij709536xzxn8prgg2a3jc0s3j6-libbpf-1.4.2","/nix/store/rx6nkd40819acppajq29g1hxa4d9r35f-gmp-with-cxx-6.3.0","/nix/store/cfgpxq64il1sfsjqbblghds82jf2a185-nettle-3.9.1","/nix/store/qr0d05pw8cpznhrq4kfyz64pcm6xppcq-libevent-2.1.12","/nix/store/6ff9abnxvgpii09zrjbrv5vcjgbhqk61-unbound-1.20.0-lib","/nix/store/v0d8k5by479gzc9yfdnvw63m0jzcppjk-dns-root-data-2023-11-27","/nix/store/wf7w1vbis4fphasyn4z3vad6336rxc64-gnutls-3.8.5","/nix/store/n7nbsn0d6w5m60hqnr7af8gzshnynx5y-libmicrohttpd-0.9.77","/nix/store/yvhyhcfhc98wm86pw4ygk5jdr804iwrw-libcap-2.69-lib","/nix/store/7j8mbhf7c3sigq7lwl5vc5h7lhx34m6d-systemd-minimal-libs-255.6","/nix/store/jjzrf6hcd65vf9kpqbri6dlmsv7yj199-libcbor-0.11.0","/nix/store/y418s044ij61yx03rpnc0hja07snbp2h-pcsclite-2.1.0-lib","/nix/store/nkg8ikby80sv07z4qcag77w0h8zl24s0-libfido2-1.14.0","/nix/store/r2q8hr14sxaijryjc2xw5gqvfyhcfhpq-kmod-31-lib","/nix/store/rdd4pnr4x9rqc9wgbibhngv217w2xvxl-bash-interactive-5.2p26","/nix/store/rik7p68cq7yzlj5pmfpf4yv6jnrpvlgf-gnutar-1.35","/nix/store/s0vz12hrphzlc45sj1fp6cc45c75kr8x-util-linux-minimal-2.40.1-swap","/nix/store/s3i30zgs08s2a5azm8jzimyvl4yhpw1n-util-linux-minimal-2.40.1-mount","/nix/store/y2ds7vvhg0fsy8gf55q4x1hxjw3xkjp6-libapparmor-3.1.7","/nix/store/ygmngxklhr4iw8myam49ld30mfansylv-util-linux-minimal-2.40.1-login","/nix/store/4ccjj4v7vc782xc3ljjq2zfqj3d3l276-lvm2-2.03.23-lib","/nix/store/kflbjsv5gk1vimv0z54damzsqxrrkbf5-libargon2-20190702","/nix/store/yi5kdmy956hbvqrvmsi2qxykks4fhnad-cryptsetup-2.7.1","/nix/store/xjiifrz7ha6s29gp0p0j3w0155phxmia-systemd-255.6","/nix/store/8jwrkvi3r40a2fh56qk6bippnhzxcv03-systemd-255.6-dev","/nix/store/9ynakmwsf7nqhlv3phl05yybc5ad754l-zstd-1.5.6-dev","/nix/store/c2i631h8i5vcs1sqifwxfsazhwrg6wr5-glibc-2.39-52-bin","/nix/store/wfnfsglf5zw13slpplsg3nqqlazri1vk-lz4-1.9.4-bin","/nix/store/ks2x6si7bkxb6ay1s80ld1s5997qllpa-lz4-1.9.4-dev","/nix/store/lvq4hib247ayxib31hp7gryx444m1l3a-icu4c-73.2","/nix/store/qhzjjjcb0svqrvps9vv5hhihcs7r610x-readline-8.2p10-dev","/nix/store/x4z4n4270bqh5549b78xb5yzik9c77xi-libossp-uuid-1.6.2","/nix/store/xb4h083j02mr2ix7pgj7iawxh2hk100l-postgresql-15.7-lib","/nix/store/xfasa18vkp6pkld7wr9svjd75yz1ib8b-libkrb5-1.21.2-dev","/nix/store/y6hmqbmbwq0rmx1fzix5c5jszla2pzmp-tzdata-2024a","/nix/store/zfi1y943q15js1ysgl4vk6lp2bzrngn2-icu4c-73.2-dev","/nix/store/07s64wxjzk6z1glwxvl3yq81vdn42k40-postgresql-15.7","/nix/store/0bm4z6dh3v6nnr539xzsak0pn4wccb5l-expat-2.6.2","/nix/store/k3rllmlx64awzszan2d17kyl9mb8p3pr-alsa-topology-conf-1.2.5.1","/nix/store/xdb66yb8cqghrrc8j8rgpr31mhdmyp0m-alsa-ucm-conf-1.2.11","/nix/store/0g7r7krqiz6g3nb3651sfa5myd9gqkzf-alsa-lib-1.2.11","/nix/store/1sffjkg6c6ff16fz5yr0pnz3j7vja42h-ed-1.20.2","/nix/store/0lfxbmchigx9vs9qmrlbahcy6nxwfnj1-patch-2.7.6","/nix/store/ls108c83hxrwzj922hhxf88rq53z10vq-gmp-6.3.0","/nix/store/hhr2s52vw5wdhlwcc60imbc85pi31121-mpfr-4.2.1","/nix/store/cya37dqm7s6jg5alb77n8y3c421k0xbi-libmpc-1.3.1","/nix/store/xz8mzas29lck99m79q211n0v5h1cmd40-linux-headers-6.7","/nix/store/fwh4fxd747m0py3ib3s5abamia9nrf90-glibc-2.39-52-dev","/nix/store/x8l5i68xcy2iyr0gwy71s1f0mh8s5c33-isl-0.20","/nix/store/14c6s4xzhy14i2b05s00rjns2j93gzz4-gcc-13.2.0","/nix/store/8n7i76nx0k6b0zz752lvd3rv8gym39da-libXau-1.0.11","/nix/store/m7v406dmjc4pzd0qgbhw58d5gswcv412-libXdmcp-1.1.5","/nix/store/18kar5zwp16xyppfmigq92xzm1pkcqf1-libxcb-1.17.0","/nix/store/1iscdpbd3x9x3s3s25jd5ppl7yra0b77-perl-5.38.2","/nix/store/x9fw7rbdb34gq0f8q750kw344lbv9nk1-libX11-1.8.9","/nix/store/1jjjvxa4v0qqjhlc9ig3j6ljdlskm2kr-libXfixes-6.0.1","/nix/store/3bsk1131lgpvp0amxml4adnb8m5p18nk-fftw-single-3.3.10","/nix/store/4i0j14zymvlngyyhq2254f4g9m9my98y-gnu-config-2024-01-01","/nix/store/5frkz5kp1p3i6wfgcjgbba38pypg4app-libselinux-3.6","/nix/store/5yzw0vhkyszf2d179m0qfkgxmp5wjjx4-move-docs.sh","/nix/store/5zjms21vpxlkbc0qyl5pmj2sidfmzmd7-gnused-4.9","/nix/store/79fnxa6j0ylcx8xjmgxhjlskbmz4wnxq-hwdata-0.382","/nix/store/bsv4wkwiqgns5w83hayd8n9msclr7qgb-mpdecimal-4.0.0","/nix/store/ncqv9zy0avac3698klhzqk6v68jk1ldp-gdbm-1.23","/nix/store/zk9ybjjixdwyv3jmpg2i7s8p7iqi5vhh-mailcap-2.1.53","/nix/store/7hnr99nxrd2aw6lghybqdmkckq60j6l9-python3-3.11.9","/nix/store/7qzq8wm0z1mqrg8b4j2ibh3rgc5s8shp-lm-sensors-3.6.0","/nix/store/7rnc20sb0h5zxqm5vims6mvi6gr3iy27-wayland-1.22.0","/nix/store/84zsh6pcqi8qvl598lksrf10hmk8f8pq-sbc-2.0","/nix/store/8vvkbgmnin1x2jkp7wcb2zg1p0vc4ks9-gawk-5.2.2","/nix/store/j3svbki41ax01mhd0bax91y1q8gvc5c4-binutils-2.41-lib","/nix/store/bgcaxhhxswzvmxjbbgvvaximm5hwghz1-binutils-2.41","/nix/store/pqajcwpmpr0jspa4z8xhxxnnfqfy5al4-expand-response-params","/nix/store/kln7kinji3b7sz8r50h4gn9yy6k1js9a-binutils-wrapper-2.41","/nix/store/9bv7dcvmfcjnmg5mnqwqlq2wxfn8d7yi-gcc-wrapper-13.2.0","/nix/store/c2v6ycn0sjcpx9ww8x7j4ima6xnpssry-glib-2.80.2","/nix/store/d32cfv8wml1cgbkqj54khlhgdaca409d-webrtc-audio-processing-1.3","/nix/store/g19314860ijffhbksw25pl2rcagk7wcx-dconf-0.40.0-lib","/nix/store/gsxhddisz2211yzih47vskgabv0ry51x-libtool-2.4.7-lib","/nix/store/bp74x3bkh8979gxz72wc9hq3jb0hdaq7-systemd-minimal-255.6","/nix/store/jd41k79l3nxq4b7b7yvc0kmcjd3lq7sa-dbus-1.14.10-lib","/nix/store/jqzfi4vsxvkdcr52frs1qgiawbp9vpqg-libasyncns-0.8","/nix/store/q1fsrgy54qq6shp6hrrjxgvn06mphs32-speexdsp-1.2.1","/nix/store/lfpszg9pqbl4g5gwif16kq5sshv1qcd2-libogg-1.3.5","/nix/store/a1vdbxij9xn9i2qs695rlcn3jkwpldd2-flac-1.4.3","/nix/store/d1g6mz24zwx4pcl1wfwja6lgbf8x0m8d-libvorbis-1.3.7","/nix/store/ds2h2v0frms447yhg9cgyk78mrp5240a-libmpg123-1.32.6","/nix/store/l738rl0x75xhna5qy2g2nww6i8nwzacf-lame-3.100-lib","/nix/store/mxg79hhk4dgv0lnifhj6k9jgk7xrkcsd-libopus-1.5.2","/nix/store/rv8x9609d5nh5z8v7v9gmhy6z1wnrhkk-libsndfile-1.2.2","/nix/store/wws29jxqkf3zwg2i97jdgfcwk8mdxld0-soxr-0.1.3","/nix/store/pn9glkalcj7i5p549dpsl1c46pkb13xr-pulseaudio-17.0","/nix/store/cnnmb3axmv43lj22gny3m4hj06i1nc7c-libcap-2.69","/nix/store/ha8rh8jg19r8418baa8ps9b9kvd6szcf-attr-2.5.2-bin","/nix/store/nn78wg4rgns62w5sfzyxashxizd0lfva-attr-2.5.2-dev","/nix/store/xslrgzkvciny0m0cqbgq4bnvydvpdkgx-libcap-2.69-dev","/nix/store/a83znbrflv30lvhww0d2rljbyd5mw0c0-pulseaudio-17.0-dev","/nix/store/ax9wbqknwawnl21kvkp8l6jn2r6q0l90-llvm-17.0.6-lib","/nix/store/vz0rlaa0i7r61ivhvpyjcrbianai35yp-libpciaccess-0.18.1","/nix/store/y31zz9k1v2gqlzrs7p50llx8db6m2gdr-libdrm-2.4.120","/nix/store/f3bmrmcdxxgxzsh8pgwg49z2zhfs9qfq-mesa-24.0.7","/nix/store/gbjygp4wz7b5rgayckmqfc00hy34dqfn-libXext-1.3.6","/nix/store/hzwxpkddjfp13ghbbl4bn7zvqvkp7hpl-libxshmfence-1.3.2","/nix/store/iywcnxgdigcjq4skkdpnvqqxqalh3k20-libXxf86vm-1.1.5","/nix/store/yhqxq6b64s489xibfdrhq351k0rhsr1y-vulkan-loader-1.3.283.0","/nix/store/hggpnywm6l7cfh2ml1ynm50ap9x4f9rn-mesa-24.0.7-drivers","/nix/store/jz3vvf4nsyirb25rh9dbhksm4gq6wybb-libglvnd-1.7.0","/nix/store/smacbfb82wp7ncz2rwac68jd50qxr70a-libglvnd-1.7.0-dev","/nix/store/v6x3cs394jgqfbi0a42pam708flxaphh-default-builder.sh","/nix/store/bq6xbl9cq6hkcn65mz2fzc2k38xiv87h-update-autotools-gnu-config-scripts-hook","/nix/store/cdzpn0rdq810aknww3w9fy3wmw9ixr66-gnumake-4.4.1","/nix/store/cickvswrvann041nqxb0rxilc46svw1n-prune-libtool-files.sh","/nix/store/fyaryjvghbkpfnsyw97hb3lyb37s1pd6-move-lib64.sh","/nix/store/h9lc1dpi14z7is86ffhl3ld569138595-audit-tmpdir.sh","/nix/store/i34mknsjgrfyy71k2h79gda0bvagzc2j-diffutils-3.10","/nix/store/ilaf1w22bxi6jsi45alhmvvdgy4ly3zs-patch-shebangs.sh","/nix/store/jivxp510zxakaaic7qkrb7v1dd2rdbw9-multiple-outputs.sh","/nix/store/jjcsr5gs4qanf7ln5c6wgcq4sn75a978-findutils-4.9.0","/nix/store/kd4xwxjpjxi71jkm6ka0np72if9rm3y0-move-sbin.sh","/nix/store/m54bmrhj6fqz8nds5zcj97w9s9bckc9v-compress-man-pages.sh","/nix/store/nbad47q0m0m9c5xid7zh05hiknwircbp-patchelf-0.15.0","/nix/store/ngg1cv31c8c7bcm2n8ww4g06nq7s4zhm-set-source-date-epoch-to-latest.sh","/nix/store/pag6l61paj1dc9sv15l7bm5c17xn5kyk-move-systemd-user-units.sh","/nix/store/wgrbkkaldkrlrni33ccvm3b6vbxzb656-make-symlinks-relative.sh","/nix/store/wmknncrif06fqxa16hpdldhixk95nds0-strip.sh","/nix/store/xx7x1dwybpssfhq8yikvzz38bh3yrq97-file-5.45","/nix/store/xyff06pkhki3qy1ls77w10s0v79c9il0-reproducible-builds.sh","/nix/store/xfhkjnpqjwlf6hlk1ysmq3aaq80f3bjj-stdenv-linux","/nix/store/9yw614l0qvmx093i68cqyfy8lpsvzf3i-nix-shell"],"channel":"stable-24_05","channel_nix_path":"/nix/store/r9dxa39mzcwfm6qp398j3wkms3vwiqcd-nixpkgs-stable-24_05-24.05.tar.gz/nixpkgs-stable-24_05","production":null}}}
</file>

<file path=".cache/replit/toolchain.json">
{"runs":[{"id":".replit/run","name":"sh -c 'npm run dev'","fileTypeAttrs":{},"run":{"command":{"args":["sh","-c","npm run dev"]}}},{"id":"module:nodejs-20/runner:nodeJS","name":"Node.js","fileParam":true,"language":"javascript","fileTypeAttrs":{},"displayVersion":"20.18.1","run":{"command":{"args":["sh","-c","/nix/store/rrz8cqhldyl17bbs60g7d8vbaadkxc40-nodejs-20.18.1-wrapped/bin/node $file"]}},"defaultEntrypoints":["index.js","main.js"]}],"debuggers":[{"id":"module:nodejs-20/debugger:nodeDAP","name":"Node DAP","fileParam":true,"language":"javascript","fileTypeAttrs":{}}],"languageServers":[{"id":"module:replit/languageServer:dotreplit-lsp","name":".replit LSP","language":"dotreplit","fileTypeAttrs":{},"config":{"startCommand":{"args":["sh","-c","/nix/store/bz8k1njgmm249fr5krhaq1jsi7jrhx5k-taplo-0.patched/bin/taplo lsp -c /nix/store/2zhz6va20gizdlqmvryab9b7pn6dp0v1-taplo-config.toml stdio"]}}},{"id":"module:web/languageServer:css","name":"CSS Language Server","language":"css","fileTypeAttrs":{"extensions":[".css",".less",".scss"]},"config":{"startCommand":{"args":["sh","-c","/nix/store/ydkb3d7r0zs7wd7jcwnk1v24qmzjqnkh-vscode-langservers-extracted-4.10.0/bin/vscode-css-language-server --stdio"]},"configurationJson":"{\"css\":{\"completion\":{\"completePropertyWithSemicolon\":true,\"triggerPropertyValueCompletion\":true},\"hover\":{\"documentation\":true,\"references\":true},\"lint\":{\"argumentsInColorFunction\":\"error\",\"boxModel\":\"ignore\",\"compatibleVendorPrefixes\":\"ignore\",\"duplicateProperties\":\"warning\",\"emptyRules\":\"warning\",\"float\":\"ignore\",\"fontFaceProperties\":\"warning\",\"hexColorLength\":\"error\",\"idSelector\":\"ignore\",\"ieHack\":\"ignore\",\"importStatement\":\"ignore\",\"important\":\"ignore\",\"propertyIgnoredDueToDisplay\":\"warning\",\"universalSelector\":\"ignore\",\"unknownAtRules\":\"warning\",\"unknownProperties\":\"warning\",\"unknownVendorSpecificProperties\":\"ignore\",\"validProperties\":[],\"vendorPrefix\":\"warning\",\"zeroUnits\":\"ignore\"},\"trace\":{\"server\":\"off\"}},\"less\":{\"completion\":{\"completePropertyWithSemicolon\":true,\"triggerPropertyValueCompletion\":true},\"hover\":{\"documentation\":true,\"references\":true},\"lint\":{\"argumentsInColorFunction\":\"error\",\"boxModel\":\"ignore\",\"compatibleVendorPrefixes\":\"ignore\",\"duplicateProperties\":\"warning\",\"emptyRules\":\"warning\",\"float\":\"ignore\",\"fontFaceProperties\":\"warning\",\"hexColorLength\":\"error\",\"idSelector\":\"ignore\",\"ieHack\":\"ignore\",\"importStatement\":\"ignore\",\"important\":\"ignore\",\"propertyIgnoredDueToDisplay\":\"warning\",\"universalSelector\":\"ignore\",\"unknownAtRules\":\"warning\",\"unknownProperties\":\"warning\",\"unknownVendorSpecificProperties\":\"ignore\",\"validProperties\":[],\"vendorPrefix\":\"warning\",\"zeroUnits\":\"ignore\"},\"trace\":{\"server\":\"off\"}},\"scss\":{\"completion\":{\"completePropertyWithSemicolon\":true,\"triggerPropertyValueCompletion\":true},\"hover\":{\"documentation\":true,\"references\":true},\"lint\":{\"argumentsInColorFunction\":\"error\",\"boxModel\":\"ignore\",\"compatibleVendorPrefixes\":\"ignore\",\"duplicateProperties\":\"warning\",\"emptyRules\":\"warning\",\"float\":\"ignore\",\"fontFaceProperties\":\"warning\",\"hexColorLength\":\"error\",\"idSelector\":\"ignore\",\"ieHack\":\"ignore\",\"importStatement\":\"ignore\",\"important\":\"ignore\",\"propertyIgnoredDueToDisplay\":\"warning\",\"universalSelector\":\"ignore\",\"unknownAtRules\":\"warning\",\"unknownProperties\":\"warning\",\"unknownVendorSpecificProperties\":\"ignore\",\"validProperties\":[],\"vendorPrefix\":\"warning\",\"zeroUnits\":\"ignore\"},\"trace\":{\"server\":\"off\"}}}","initializationOptionsJson":"{\"provideFormatter\":true}"}},{"id":"module:web/languageServer:html","name":"HTML Language Server","language":"html","fileTypeAttrs":{"extensions":[".html"]},"config":{"startCommand":{"args":["sh","-c","/nix/store/ydkb3d7r0zs7wd7jcwnk1v24qmzjqnkh-vscode-langservers-extracted-4.10.0/bin/vscode-html-language-server --stdio"]},"configurationJson":"{\"html\":{\"autoClosingTags\":true,\"autoCreateQuotes\":true,\"completion\":{\"attributeDefaultValue\":\"doublequotes\"},\"customData\":[],\"format\":{\"contentUnformatted\":\"pre,code,textarea\",\"enable\":true,\"endWithNewline\":false,\"extraLiners\":\"head, body, /html\",\"indentHandlebars\":false,\"indentInnerHtml\":false,\"preserveNewLines\":true,\"templating\":false,\"unformatted\":\"wbr\",\"unformattedContentDelimiter\":\"\",\"wrapAttributes\":\"auto\",\"wrapLineLength\":120},\"hover\":{\"documentation\":true,\"references\":true},\"mirrorCursorOnMatchingTag\":false,\"suggest\":{\"html5\":true},\"trace\":{\"server\":\"off\"},\"validate\":{\"scripts\":true,\"styles\":true}}}","initializationOptionsJson":"{\"enable\":true,\"provideFormatter\":true}"}},{"id":"module:web/languageServer:typescript-language-server","name":"TypeScript Language Server","language":"javascript","fileTypeAttrs":{"extensions":[".js",".jsx",".ts",".tsx",".mjs",".mts",".cjs",".cts",".es6",".json"]},"config":{"startCommand":{"args":["sh","-c","/nix/store/9cd76kqpml5gkw8jjnjx0flwdf0a1gv1-typescript-language-server-4.3.3/bin/typescript-language-server --stdio"]},"initializationOptionsJson":"{\"tsserver\":{\"fallbackPath\":\"/nix/store/g6ns6m42fvybfzb2xjppcsfmb6k0jv5x-typescript-5.6.3/lib/node_modules/typescript/lib\"}}"},"displayVersion":"4.3.3"}],"packagers":[{"id":"module:nodejs-20/packager:upmNodejs","name":"Node.js packager (npm, yarn, pnpm, bun)","language":"nodejs","packageSearch":true,"guessImports":true}],"formatters":[{"id":"module:nodejs-20/formatter:prettier","name":"Prettier","startCommand":{"args":["/nix/store/070ycjyhpfv8n895zq7yz6z0pp57g0q9-run-prettier/bin/run-prettier"],"lifecycle":"STDIN","splitStderr":true},"fileTypeAttrs":{"extensions":[".js",".jsx",".ts",".tsx",".json",".html"]},"displayVersion":"3.3.3","supportsRangeFormatting":true},{"id":"module:replit/languageServer:dotreplit-lsp","name":".replit LSP","fileTypeAttrs":{}},{"id":"module:web/languageServer:css","name":"CSS Language Server","fileTypeAttrs":{"extensions":[".css",".less",".scss"]}},{"id":"module:web/languageServer:html","name":"HTML Language Server","fileTypeAttrs":{"extensions":[".html"]}},{"id":"module:web/languageServer:typescript-language-server","name":"TypeScript Language Server","fileTypeAttrs":{"extensions":[".js",".jsx",".ts",".tsx",".mjs",".mts",".cjs",".cts",".es6",".json"]},"displayVersion":"4.3.3"}]}
</file>

<file path=".cache/typescript/5.5/package.json">
{"private":true,"dependencies":{"types-registry":"^0.1.700"}}
</file>

<file path=".local/state/replit/agent/.latest.json">
{"latest": "main"}
</file>

<file path=".local/state/replit/agent/repl_state.json">
{"repl_description":"An advanced AI-driven social matching platform that provides intelligent, context-aware personal connections with robust error handling and communication strategies.\n\nThe application focuses on creating reliable match connections through sophisticated machine learning algorithms and comprehensive network resilience. Key technical components include real-time WebSocket communication, advanced authentication, and intelligent matching systems that prioritize user experience and system reliability.\n\nTech Stack:\n- React with TypeScript\n- Vite build tooling\n- Machine Learning matching algorithms\n- WebSocket real-time communication\n- PostgreSQL with Drizzle ORM\n- Shadcn UI components\n- Advanced authentication mechanisms\n- Network graph visualization","repl_description_state":"DESCRIPTION_APPROVED","repl_stack":"FULLSTACK_JS","stack_rules":{"name":"fullstack_js","display_name":"Full-stack JavaScript Website","tarball":"https://storage.googleapis.com/replit-dev-public/fullstack_js/bbcda9580d937093ca88c81f54e4db21a72e75e6.tar.gz","directory_structure":" client\n    index.html\n    src\n        App.tsx\n        components\n           ui\n               accordion.tsx\n               alert-dialog.tsx\n               alert.tsx\n               aspect-ratio.tsx\n               avatar.tsx\n               badge.tsx\n               breadcrumb.tsx\n               button.tsx\n               calendar.tsx\n               card.tsx\n               carousel.tsx\n               chart.tsx\n               checkbox.tsx\n               collapsible.tsx\n               command.tsx\n               context-menu.tsx\n               dialog.tsx\n               drawer.tsx\n               dropdown-menu.tsx\n               form.tsx\n               hover-card.tsx\n               input-otp.tsx\n               input.tsx\n               label.tsx\n               menubar.tsx\n               navigation-menu.tsx\n               pagination.tsx\n               popover.tsx\n               progress.tsx\n               radio-group.tsx\n               resizable.tsx\n               scroll-area.tsx\n               select.tsx\n               separator.tsx\n               sheet.tsx\n               sidebar.tsx\n               skeleton.tsx\n               slider.tsx\n               switch.tsx\n               table.tsx\n               tabs.tsx\n               textarea.tsx\n               toast.tsx\n               toaster.tsx\n               toggle-group.tsx\n               toggle.tsx\n               tooltip.tsx\n        hooks\n           use-mobile.tsx\n           use-toast.ts\n        index.css\n        lib\n           queryClient.ts\n           utils.ts\n        main.tsx\n        pages\n db\n    index.ts\n    schema.ts\n drizzle.config.ts\n package-lock.json\n package.json\n postcss.config.js\n server\n    index.ts\n    routes.ts\n    vite.ts\n tailwind.config.ts\n theme.json\n tsconfig.json\n vite.config.ts\n","description":"Always follow these guidelines when building a full-stack JavaScript application:\n\nArchitecture\n- Follow modern web application patterns and best-practices.\n- Put as much of the app in the frontend as possible. The backend should only be responsible for data persistence and making API calls.\n- If the app is complex and requires functionality that can't be done in a single request, it is okay to stub out the backend and implement the frontend first.\n- Always think through and generate the schema/data first to ensure consistency between frontend and backend. Keep the data model as simple as possible.\n\nFrontend\n- Use `wouter` for routing on the frontend.\n  - Minimize the number of routes and pages in the app. If a page can be a modal or a dialog, make it so.\n  - If you need to add a new page, add them to the `client/src/pages` directory and register them in `client/src/App.tsx`.\n  - If there are multiple pages, create either a navbar or a sidebar for navigation. Use the `Link` component or the `useLocation` hook from `wouter` instead of modifying the window directly.\n- For forms, always use shadcn's `useForm` hook and `Form` component from `@/components/ui/form` which wraps `react-hook-form`.\n  - Remember that the form component is controlled, ensure you pass default values to the `useForm` hook.\n- Always use `@tanstack/react-query` when fetching data.\n  - Show a loading or skeleton state while queries or mutations are being made.\n  - For hierarchical or variable query keys use an array for cache segments so invalidation works properly. That is, do queryKey: ['/api/recipes', id] instead of queryKey: [`/api/recipes/${id}`].\n  - Remember to invalidate queries when it makes sense to.\n- Common pitfalls to avoid:\n  - The `useToast` hook is exported from `@/hooks/use-toast`.\n  - You do not need to explicitly import React as Vite has a JSX transformer that does it automatically.\n  - If a form is failing to submit, try logging out `form.formState.errors` to see if there are form validation errors for fields that might not have associated form fields.\n  - Use `import.meta.env.<ENV_VAR>` to access environment variables on the frontend instead of `process.env.<ENV_VAR>`. Note that variables must be prefixed with `VITE_` in order for the env vars to be available on the frontend.\n\nStyling and Theming\n- Overwrite `theme.json` to match the specified design instead of specifying colors in `index.css`\n  - `theme.json` has a schema of the type `{ primary: string, variant: 'professional' | 'tint' | 'vibrant', appearance: 'light' | 'dark' | 'system', radius: number }`\n  - `primary` should be the primary color to use throughout the app.\n- Use the existing shadcn + Tailwind CSS setup wherever possible instead of writing custom components.\n  - Use the `@`-prefixed paths to import shadcn components and hooks.\n- Create a beautiful, functional, and production-ready design.\n  - Create a responsive grid-based design that looks good on mobile, tablet, and desktop.\n  - Use icons from `lucide-react` to signify actions and provide visual cues. Use `react-icons/si` for company logos.\n  - Never use stock images as background images for large page sections like hero areas or full-width divs as they create accessibility and readability issues. Instead, stock images should only be used as foreground content in smaller, contained elements like cards, thumbnails, or article previews where the image directly relates to and enhances the specific content being presented.\n\nBackend\n- When writing backend API routes, add them to the `server/routes.ts` file.\n- Common pitfalls to avoid:\n  - If you add a WebSocket server, make sure that your custom upgrade handler ignores requests with `sec-websocket-protocol` as `vite-hmr`.\n  - Use `import.meta.env.<ENV_VAR>` instead of `process.env.<ENV_VAR>` to access environment variables on the backend.\n\nDatabase and auth (if applicable)\n- For applications that require a database, use Drizzle as the database ORM with Postgres as the database.\n  - Put all Drizzle models and relations in `db/schema.ts`. Import from the alias `@db/schema`.\n    - Don't forget to explicitly model relations via the `relations` operator from `drizzle-orm`.\n  - Design your data models and relationships to not require user auth unless explicitly requested.\n  - ALWAYS remember to push the schema changes after editing the data model with `npm run db:push`. NEVER manually write SQL migrations.\n  - When writing API routes that require database access, use `drizzle-orm`. For example, `import { db } from \"db\";` and `import { users } from \"@db/schema\";`.\n    - Remember that filter and order operators like `eq`, `and`, `or`, `asc`, `desc` etc. are available in the Drizzle query API as top-level functions rather than methods on the query object. For example, `db.query.notes.findMany({ orderBy: desc(notes.updatedAt) })` or `db.query.notes.findMany({ where: eq(user.id, 1) })`.\n\nRunning the project\n- The workflow named 'Start application' is already setup and runs `npm run dev` which starts an Express server for the backend and a Vite server for the frontend.\n- After making edits, the workflow will automatically be restarted for you.\n\nForbidden changes\n- NEVER modify the existing Vite setup (`server/vite.ts` and `vite.config.ts`)\n  - It is already configured to serve the frontend and backend on the same port and handles all the necessary setup for you. Don't add a proxy to the Vite server.\n  - All the aliases are already set up for you to import, don't modify them.\n- NEVER edit `package.json`:\n  - If you find yourself stuck and need to modify the scripts, ask the user before doing so.\n  - If you need to install packages, use the packager_install_tool.\n","files":[{"file_name":"drizzle.config.ts","content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./db/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n"},{"file_name":"package.json","content":"{\n  \"name\": \"rest-express\",\n  \"version\": \"1.0.0\",\n  \"type\": \"module\",\n  \"license\": \"MIT\",\n  \"scripts\": {\n    \"dev\": \"tsx server/index.ts\",\n    \"build\": \"vite build && esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outdir=dist\",\n    \"start\": \"NODE_ENV=production node dist/index.js\",\n    \"check\": \"tsc\",\n    \"db:push\": \"drizzle-kit push\"\n  },\n  \"dependencies\": {\n    \"@hookform/resolvers\": \"^3.9.1\",\n    \"@jridgewell/trace-mapping\": \"^0.3.25\",\n    \"@radix-ui/react-accordion\": \"^1.2.1\",\n    \"@radix-ui/react-alert-dialog\": \"^1.1.2\",\n    \"@radix-ui/react-aspect-ratio\": \"^1.1.0\",\n    \"@radix-ui/react-avatar\": \"^1.1.1\",\n    \"@radix-ui/react-checkbox\": \"^1.1.2\",\n    \"@radix-ui/react-collapsible\": \"^1.1.1\",\n    \"@radix-ui/react-context-menu\": \"^2.2.2\",\n    \"@radix-ui/react-dialog\": \"^1.1.2\",\n    \"@radix-ui/react-dropdown-menu\": \"^2.1.2\",\n    \"@radix-ui/react-hover-card\": \"^1.1.2\",\n    \"@radix-ui/react-label\": \"^2.1.0\",\n    \"@radix-ui/react-menubar\": \"^1.1.2\",\n    \"@radix-ui/react-navigation-menu\": \"^1.2.1\",\n    \"@radix-ui/react-popover\": \"^1.1.2\",\n    \"@radix-ui/react-progress\": \"^1.1.0\",\n    \"@radix-ui/react-radio-group\": \"^1.2.1\",\n    \"@radix-ui/react-scroll-area\": \"^1.2.0\",\n    \"@radix-ui/react-select\": \"^2.1.2\",\n    \"@radix-ui/react-separator\": \"^1.1.0\",\n    \"@radix-ui/react-slider\": \"^1.2.1\",\n    \"@radix-ui/react-slot\": \"^1.1.0\",\n    \"@radix-ui/react-switch\": \"^1.1.1\",\n    \"@radix-ui/react-tabs\": \"^1.1.1\",\n    \"@radix-ui/react-toast\": \"^1.2.2\",\n    \"@radix-ui/react-toggle\": \"^1.1.0\",\n    \"@radix-ui/react-toggle-group\": \"^1.1.0\",\n    \"@radix-ui/react-tooltip\": \"^1.1.3\",\n    \"@replit/vite-plugin-shadcn-theme-json\": \"^0.0.4\",\n    \"@tanstack/react-query\": \"^5.60.5\",\n    \"class-variance-authority\": \"^0.7.0\",\n    \"clsx\": \"^2.1.1\",\n    \"cmdk\": \"^1.0.0\",\n    \"date-fns\": \"^3.6.0\",\n    \"drizzle-orm\": \"^0.38.2\",\n    \"drizzle-zod\": \"^0.6.0\",\n    \"embla-carousel-react\": \"^8.3.0\",\n    \"express\": \"^4.21.2\",\n    \"express-session\": \"^1.18.1\",\n    \"framer-motion\": \"^11.13.1\",\n    \"input-otp\": \"^1.2.4\",\n    \"lucide-react\": \"^0.453.0\",\n    \"memorystore\": \"^1.6.7\",\n    \"passport\": \"^0.7.0\",\n    \"passport-local\": \"^1.0.0\",\n    \"react\": \"^18.3.1\",\n    \"react-day-picker\": \"^8.10.1\",\n    \"react-dom\": \"^18.3.1\",\n    \"react-hook-form\": \"^7.53.1\",\n    \"react-icons\": \"^5.4.0\",\n    \"react-resizable-panels\": \"^2.1.4\",\n    \"recharts\": \"^2.13.0\",\n    \"tailwind-merge\": \"^2.5.4\",\n    \"tailwindcss-animate\": \"^1.0.7\",\n    \"vaul\": \"^1.1.0\",\n    \"wouter\": \"^3.3.5\",\n    \"ws\": \"^8.18.0\",\n    \"zod\": \"^3.23.8\"\n  },\n  \"devDependencies\": {\n    \"@replit/vite-plugin-runtime-error-modal\": \"^0.0.3\",\n    \"@tailwindcss/typography\": \"^0.5.15\",\n    \"@types/express\": \"4.17.21\",\n    \"@types/express-session\": \"^1.18.0\",\n    \"@types/node\": \"20.16.11\",\n    \"@types/passport\": \"^1.0.16\",\n    \"@types/passport-local\": \"^1.0.38\",\n    \"@types/react\": \"^18.3.11\",\n    \"@types/react-dom\": \"^18.3.1\",\n    \"@types/ws\": \"^8.5.13\",\n    \"@vitejs/plugin-react\": \"^4.3.2\",\n    \"autoprefixer\": \"^10.4.20\",\n    \"drizzle-kit\": \"^0.27.1\",\n    \"esbuild\": \"^0.24.0\",\n    \"postcss\": \"^8.4.47\",\n    \"tailwindcss\": \"^3.4.14\",\n    \"tsx\": \"^4.19.1\",\n    \"typescript\": \"5.6.3\",\n    \"vite\": \"^5.4.9\"\n  },\n  \"optionalDependencies\": {\n    \"bufferutil\": \"^4.0.8\"\n  }\n}\n"},{"file_name":"postcss.config.js","content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n"},{"file_name":"tailwind.config.ts","content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \"var(--radius)\",\n        md: \"calc(var(--radius) - 2px)\",\n        sm: \"calc(var(--radius) - 4px)\",\n      },\n      colors: {\n        background: \"hsl(var(--background))\",\n        foreground: \"hsl(var(--foreground))\",\n        card: {\n          DEFAULT: \"hsl(var(--card))\",\n          foreground: \"hsl(var(--card-foreground))\",\n        },\n        popover: {\n          DEFAULT: \"hsl(var(--popover))\",\n          foreground: \"hsl(var(--popover-foreground))\",\n        },\n        primary: {\n          DEFAULT: \"hsl(var(--primary))\",\n          foreground: \"hsl(var(--primary-foreground))\",\n        },\n        secondary: {\n          DEFAULT: \"hsl(var(--secondary))\",\n          foreground: \"hsl(var(--secondary-foreground))\",\n        },\n        muted: {\n          DEFAULT: \"hsl(var(--muted))\",\n          foreground: \"hsl(var(--muted-foreground))\",\n        },\n        accent: {\n          DEFAULT: \"hsl(var(--accent))\",\n          foreground: \"hsl(var(--accent-foreground))\",\n        },\n        destructive: {\n          DEFAULT: \"hsl(var(--destructive))\",\n          foreground: \"hsl(var(--destructive-foreground))\",\n        },\n        border: \"hsl(var(--border))\",\n        input: \"hsl(var(--input))\",\n        ring: \"hsl(var(--ring))\",\n        chart: {\n          \"1\": \"hsl(var(--chart-1))\",\n          \"2\": \"hsl(var(--chart-2))\",\n          \"3\": \"hsl(var(--chart-3))\",\n          \"4\": \"hsl(var(--chart-4))\",\n          \"5\": \"hsl(var(--chart-5))\",\n        },\n        sidebar: {\n          DEFAULT: \"hsl(var(--sidebar-background))\",\n          foreground: \"hsl(var(--sidebar-foreground))\",\n          primary: \"hsl(var(--sidebar-primary))\",\n          \"primary-foreground\": \"hsl(var(--sidebar-primary-foreground))\",\n          accent: \"hsl(var(--sidebar-accent))\",\n          \"accent-foreground\": \"hsl(var(--sidebar-accent-foreground))\",\n          border: \"hsl(var(--sidebar-border))\",\n          ring: \"hsl(var(--sidebar-ring))\",\n        },\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: {\n            height: \"0\",\n          },\n          to: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n        },\n        \"accordion-up\": {\n          from: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n          to: {\n            height: \"0\",\n          },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n"},{"file_name":"theme.json","content":"{\n  \"variant\": \"professional\",\n  \"primary\": \"hsl(222.2 47.4% 11.2%)\",\n  \"appearance\": \"light\",\n  \"radius\": 0.5\n}\n"},{"file_name":"tsconfig.json","content":"{\n  \"include\": [\"client/src/**/*\", \"db/**/*\", \"server/**/*\"],\n  \"exclude\": [\"node_modules\", \"build\", \"dist\", \"**/*.test.ts\"],\n  \"compilerOptions\": {\n    \"incremental\": true,\n    \"tsBuildInfoFile\": \"./node_modules/typescript/tsbuildinfo\",\n    \"noEmit\": true,\n    \"module\": \"ESNext\",\n    \"strict\": true,\n    \"lib\": [\"esnext\", \"dom\", \"dom.iterable\"],\n    \"jsx\": \"preserve\",\n    \"esModuleInterop\": true,\n    \"skipLibCheck\": true,\n    \"allowImportingTsExtensions\": true,\n    \"moduleResolution\": \"bundler\",\n    \"baseUrl\": \".\",\n    \"types\": [\"node\", \"vite/client\"],\n    \"paths\": {\n      \"@db\": [\"./db/index.ts\"],\n      \"@db/*\": [\"./db/*\"],\n      \"@/*\": [\"./client/src/*\"]\n    }\n  }\n}\n"},{"file_name":"vite.config.ts","content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport themePlugin from \"@replit/vite-plugin-shadcn-theme-json\";\nimport path, { dirname } from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\nimport { fileURLToPath } from \"url\";\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = dirname(__filename);\nexport default defineConfig({\n  plugins: [react(), runtimeErrorOverlay(), themePlugin()],\n  resolve: {\n    alias: {\n      \"@db\": path.resolve(__dirname, \"db\"),\n      \"@\": path.resolve(__dirname, \"client\", \"src\"),\n    },\n  },\n  root: path.resolve(__dirname, \"client\"),\n  build: {\n    outDir: path.resolve(__dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n});\n"},{"file_name":"client/src/App.tsx","content":"import { Switch, Route } from \"wouter\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nfunction App() {\n  return (\n    <Switch>\n      {/* Add pages below */}\n      {/* <Route path=\"/\" component={Home}/> */}\n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\n// fallback 404 not found page\nfunction NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\nexport default App;\n"},{"file_name":"client/src/index.css","content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n}"},{"file_name":"client/src/main.tsx","content":"import { StrictMode } from \"react\";\nimport { createRoot } from \"react-dom/client\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport App from './App';\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(\n  <StrictMode>\n    <QueryClientProvider client={queryClient}>\n      <App />\n      <Toaster />\n    </QueryClientProvider>\n  </StrictMode>,\n);\n"},{"file_name":"client/src/lib/queryClient.ts","content":"import { QueryClient } from \"@tanstack/react-query\";\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: async ({ queryKey }) => {\n        const res = await fetch(queryKey[0] as string, {\n          credentials: \"include\",\n        });\n\n        if (!res.ok) {\n          if (res.status >= 500) {\n            throw new Error(`${res.status}: ${res.statusText}`);\n          }\n\n          throw new Error(`${res.status}: ${await res.text()}`);\n        }\n\n        return res.json();\n      },\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    }\n  },\n});\n"},{"file_name":"db/index.ts","content":"import { drizzle } from \"drizzle-orm/neon-serverless\";\nimport ws from \"ws\";\nimport * as schema from \"@db/schema\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nexport const db = drizzle({\n  connection: process.env.DATABASE_URL,\n  schema,\n  ws: ws,\n});\n"},{"file_name":"db/schema.ts","content":"import { pgTable, text, serial, integer, boolean } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema, createSelectSchema } from \"drizzle-zod\";\n\nexport const users = pgTable(\"users\", {\n  id: serial(\"id\").primaryKey(),\n  username: text(\"username\").unique().notNull(),\n  password: text(\"password\").notNull(),\n});\n\nexport const insertUserSchema = createInsertSchema(users);\nexport const selectUserSchema = createSelectSchema(users);\nexport type InsertUser = typeof users.$inferInsert;\nexport type SelectUser = typeof users.$inferSelect;\n"},{"file_name":"server/index.ts","content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\n\nconst app = express();\napp.use(express.json());\napp.use(express.urlencoded({ extended: false }));\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  const server = registerRoutes(app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (app.get(\"env\") === \"development\") {\n    await setupVite(app, server);\n  } else {\n    serveStatic(app);\n  }\n\n  // ALWAYS serve the app on port 5000\n  // this serves both the API and the client\n  const PORT = 5000;\n  server.listen(PORT, \"0.0.0.0\", () => {\n    log(`serving on port ${PORT}`);\n  });\n})();\n"},{"file_name":"server/routes.ts","content":"import type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\n\nexport function registerRoutes(app: Express): Server {\n  // put application routes here\n  // prefix all routes with /api\n\n  const httpServer = createServer(app);\n\n  return httpServer;\n}\n"},{"file_name":"server/vite.ts","content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path, { dirname } from \"path\";\nimport { fileURLToPath } from \"url\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = dirname(__filename);\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        if (\n          msg.includes(\"[TypeScript] Found 0 errors. Watching for file changes\")\n        ) {\n          log(\"no errors found\", \"tsc\");\n          return;\n        }\n\n        if (msg.includes(\"[TypeScript] \")) {\n          const [errors, summary] = msg.split(\"[TypeScript] \", 2);\n          log(`${summary} ${errors}\\u001b[0m`, \"tsc\");\n          return;\n        } else {\n          viteLogger.error(msg, options);\n          process.exit(1);\n        }\n      },\n    },\n    server: {\n      middlewareMode: true,\n      hmr: { server },\n    },\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        __dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      const template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(__dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n"}],"setup_steps":[{"description":"Install the project dependencies","tool":"packager_install_tool","args":{"programming_language":"nodejs","dependency_list":[]}},{"description":"Set the run configuration for the project","tool":"workflows_set_run_config_tool","args":{"name":"Start application","command":"npm run dev","wait_for_port":5000}},{"description":"Setup the database, if needed","tool":"execute_command","args":{"command":"[[ -z \"$DATABASE_URL\" ]] || npm run db:push\n"}}],"compatible_selected_stacks":["FULLSTACK_JS"],"questions":[],"secrets":[],"category":"stack","flag":null}}
</file>

<file path=".upm/store.json">
{"version":2,"languages":{"nodejs-npm":{"specfileHash":"09d8ae9af2ec21afcebbc8cd20af4c27","lockfileHash":"ee3d301d3d19f82cf39eb526aae43f5d"}}}
</file>

<file path="client/src/components/ui/accordion.tsx">
import * as React from "react"
import * as AccordionPrimitive from "@radix-ui/react-accordion"
import { ChevronDown } from "lucide-react"

import { cn } from "@/lib/utils"

const Accordion = AccordionPrimitive.Root

const AccordionItem = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>
>(({ className, ...props }, ref) => (
  <AccordionPrimitive.Item
    ref={ref}
    className={cn("border-b", className)}
    {...props}
  />
))
AccordionItem.displayName = "AccordionItem"

const AccordionTrigger = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Header className="flex">
    <AccordionPrimitive.Trigger
      ref={ref}
      className={cn(
        "flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180",
        className
      )}
      {...props}
    >
      {children}
      <ChevronDown className="h-4 w-4 shrink-0 transition-transform duration-200" />
    </AccordionPrimitive.Trigger>
  </AccordionPrimitive.Header>
))
AccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName

const AccordionContent = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Content
    ref={ref}
    className="overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down"
    {...props}
  >
    <div className={cn("pb-4 pt-0", className)}>{children}</div>
  </AccordionPrimitive.Content>
))

AccordionContent.displayName = AccordionPrimitive.Content.displayName

export { Accordion, AccordionItem, AccordionTrigger, AccordionContent }
</file>

<file path="client/src/components/ui/alert-dialog.tsx">
import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

const AlertDialog = AlertDialogPrimitive.Root

const AlertDialogTrigger = AlertDialogPrimitive.Trigger

const AlertDialogPortal = AlertDialogPrimitive.Portal

const AlertDialogOverlay = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
))
AlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName

const AlertDialogContent = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>
>(({ className, ...props }, ref) => (
  <AlertDialogPortal>
    <AlertDialogOverlay />
    <AlertDialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    />
  </AlertDialogPortal>
))
AlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName

const AlertDialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
AlertDialogHeader.displayName = "AlertDialogHeader"

const AlertDialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
AlertDialogFooter.displayName = "AlertDialogFooter"

const AlertDialogTitle = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold", className)}
    {...props}
  />
))
AlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName

const AlertDialogDescription = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
AlertDialogDescription.displayName =
  AlertDialogPrimitive.Description.displayName

const AlertDialogAction = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Action>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Action
    ref={ref}
    className={cn(buttonVariants(), className)}
    {...props}
  />
))
AlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName

const AlertDialogCancel = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Cancel
    ref={ref}
    className={cn(
      buttonVariants({ variant: "outline" }),
      "mt-2 sm:mt-0",
      className
    )}
    {...props}
  />
))
AlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}
</file>

<file path="client/src/components/ui/alert.tsx">
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",
  {
    variants: {
      variant: {
        default: "bg-background text-foreground",
        destructive:
          "border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

const Alert = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>
>(({ className, variant, ...props }, ref) => (
  <div
    ref={ref}
    role="alert"
    className={cn(alertVariants({ variant }), className)}
    {...props}
  />
))
Alert.displayName = "Alert"

const AlertTitle = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
  <h5
    ref={ref}
    className={cn("mb-1 font-medium leading-none tracking-tight", className)}
    {...props}
  />
))
AlertTitle.displayName = "AlertTitle"

const AlertDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm [&_p]:leading-relaxed", className)}
    {...props}
  />
))
AlertDescription.displayName = "AlertDescription"

export { Alert, AlertTitle, AlertDescription }
</file>

<file path="client/src/components/ui/aspect-ratio.tsx">
import * as AspectRatioPrimitive from "@radix-ui/react-aspect-ratio"

const AspectRatio = AspectRatioPrimitive.Root

export { AspectRatio }
</file>

<file path="client/src/components/ui/avatar.tsx">
import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

const Avatar = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",
      className
    )}
    {...props}
  />
))
Avatar.displayName = AvatarPrimitive.Root.displayName

const AvatarImage = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Image>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Image
    ref={ref}
    className={cn("aspect-square h-full w-full", className)}
    {...props}
  />
))
AvatarImage.displayName = AvatarPrimitive.Image.displayName

const AvatarFallback = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Fallback>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Fallback
    ref={ref}
    className={cn(
      "flex h-full w-full items-center justify-center rounded-full bg-muted",
      className
    )}
    {...props}
  />
))
AvatarFallback.displayName = AvatarPrimitive.Fallback.displayName

export { Avatar, AvatarImage, AvatarFallback }
</file>

<file path="client/src/components/ui/badge.tsx">
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground hover:bg-primary/80",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
        destructive:
          "border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",
        outline: "text-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

export interface BadgeProps
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof badgeVariants> {}

function Badge({ className, variant, ...props }: BadgeProps) {
  return (
    <div className={cn(badgeVariants({ variant }), className)} {...props} />
  )
}

export { Badge, badgeVariants }
</file>

<file path="client/src/components/ui/breadcrumb.tsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { ChevronRight, MoreHorizontal } from "lucide-react"

import { cn } from "@/lib/utils"

const Breadcrumb = React.forwardRef<
  HTMLElement,
  React.ComponentPropsWithoutRef<"nav"> & {
    separator?: React.ReactNode
  }
>(({ ...props }, ref) => <nav ref={ref} aria-label="breadcrumb" {...props} />)
Breadcrumb.displayName = "Breadcrumb"

const BreadcrumbList = React.forwardRef<
  HTMLOListElement,
  React.ComponentPropsWithoutRef<"ol">
>(({ className, ...props }, ref) => (
  <ol
    ref={ref}
    className={cn(
      "flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5",
      className
    )}
    {...props}
  />
))
BreadcrumbList.displayName = "BreadcrumbList"

const BreadcrumbItem = React.forwardRef<
  HTMLLIElement,
  React.ComponentPropsWithoutRef<"li">
>(({ className, ...props }, ref) => (
  <li
    ref={ref}
    className={cn("inline-flex items-center gap-1.5", className)}
    {...props}
  />
))
BreadcrumbItem.displayName = "BreadcrumbItem"

const BreadcrumbLink = React.forwardRef<
  HTMLAnchorElement,
  React.ComponentPropsWithoutRef<"a"> & {
    asChild?: boolean
  }
>(({ asChild, className, ...props }, ref) => {
  const Comp = asChild ? Slot : "a"

  return (
    <Comp
      ref={ref}
      className={cn("transition-colors hover:text-foreground", className)}
      {...props}
    />
  )
})
BreadcrumbLink.displayName = "BreadcrumbLink"

const BreadcrumbPage = React.forwardRef<
  HTMLSpanElement,
  React.ComponentPropsWithoutRef<"span">
>(({ className, ...props }, ref) => (
  <span
    ref={ref}
    role="link"
    aria-disabled="true"
    aria-current="page"
    className={cn("font-normal text-foreground", className)}
    {...props}
  />
))
BreadcrumbPage.displayName = "BreadcrumbPage"

const BreadcrumbSeparator = ({
  children,
  className,
  ...props
}: React.ComponentProps<"li">) => (
  <li
    role="presentation"
    aria-hidden="true"
    className={cn("[&>svg]:w-3.5 [&>svg]:h-3.5", className)}
    {...props}
  >
    {children ?? <ChevronRight />}
  </li>
)
BreadcrumbSeparator.displayName = "BreadcrumbSeparator"

const BreadcrumbEllipsis = ({
  className,
  ...props
}: React.ComponentProps<"span">) => (
  <span
    role="presentation"
    aria-hidden="true"
    className={cn("flex h-9 w-9 items-center justify-center", className)}
    {...props}
  >
    <MoreHorizontal className="h-4 w-4" />
    <span className="sr-only">More</span>
  </span>
)
BreadcrumbEllipsis.displayName = "BreadcrumbElipssis"

export {
  Breadcrumb,
  BreadcrumbList,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbPage,
  BreadcrumbSeparator,
  BreadcrumbEllipsis,
}
</file>

<file path="client/src/components/ui/button.tsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive:
          "bg-destructive text-destructive-foreground hover:bg-destructive/90",
        outline:
          "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
        secondary:
          "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-10 px-4 py-2",
        sm: "h-9 rounded-md px-3",
        lg: "h-11 rounded-md px-8",
        icon: "h-10 w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button"
    return (
      <Comp
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    )
  }
)
Button.displayName = "Button"

export { Button, buttonVariants }
</file>

<file path="client/src/components/ui/calendar.tsx">
import * as React from "react"
import { ChevronLeft, ChevronRight } from "lucide-react"
import { DayPicker } from "react-day-picker"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

export type CalendarProps = React.ComponentProps<typeof DayPicker>

function Calendar({
  className,
  classNames,
  showOutsideDays = true,
  ...props
}: CalendarProps) {
  return (
    <DayPicker
      showOutsideDays={showOutsideDays}
      className={cn("p-3", className)}
      classNames={{
        months: "flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",
        month: "space-y-4",
        caption: "flex justify-center pt-1 relative items-center",
        caption_label: "text-sm font-medium",
        nav: "space-x-1 flex items-center",
        nav_button: cn(
          buttonVariants({ variant: "outline" }),
          "h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100"
        ),
        nav_button_previous: "absolute left-1",
        nav_button_next: "absolute right-1",
        table: "w-full border-collapse space-y-1",
        head_row: "flex",
        head_cell:
          "text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]",
        row: "flex w-full mt-2",
        cell: "h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20",
        day: cn(
          buttonVariants({ variant: "ghost" }),
          "h-9 w-9 p-0 font-normal aria-selected:opacity-100"
        ),
        day_range_end: "day-range-end",
        day_selected:
          "bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",
        day_today: "bg-accent text-accent-foreground",
        day_outside:
          "day-outside text-muted-foreground opacity-50 aria-selected:bg-accent/50 aria-selected:text-muted-foreground aria-selected:opacity-30",
        day_disabled: "text-muted-foreground opacity-50",
        day_range_middle:
          "aria-selected:bg-accent aria-selected:text-accent-foreground",
        day_hidden: "invisible",
        ...classNames,
      }}
      components={{
        IconLeft: ({ ...props }) => <ChevronLeft className="h-4 w-4" />,
        IconRight: ({ ...props }) => <ChevronRight className="h-4 w-4" />,
      }}
      {...props}
    />
  )
}
Calendar.displayName = "Calendar"

export { Calendar }
</file>

<file path="client/src/components/ui/card.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "rounded-lg border bg-card text-card-foreground shadow-sm",
      className
    )}
    {...props}
  />
))
Card.displayName = "Card"

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
))
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
  <h3
    ref={ref}
    className={cn(
      "text-2xl font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
CardTitle.displayName = "CardTitle"

const CardDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
  <p
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
CardDescription.displayName = "CardDescription"

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props}
  />
))
CardFooter.displayName = "CardFooter"

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }
</file>

<file path="client/src/components/ui/carousel.tsx">
import * as React from "react"
import useEmblaCarousel, {
  type UseEmblaCarouselType,
} from "embla-carousel-react"
import { ArrowLeft, ArrowRight } from "lucide-react"

import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"

type CarouselApi = UseEmblaCarouselType[1]
type UseCarouselParameters = Parameters<typeof useEmblaCarousel>
type CarouselOptions = UseCarouselParameters[0]
type CarouselPlugin = UseCarouselParameters[1]

type CarouselProps = {
  opts?: CarouselOptions
  plugins?: CarouselPlugin
  orientation?: "horizontal" | "vertical"
  setApi?: (api: CarouselApi) => void
}

type CarouselContextProps = {
  carouselRef: ReturnType<typeof useEmblaCarousel>[0]
  api: ReturnType<typeof useEmblaCarousel>[1]
  scrollPrev: () => void
  scrollNext: () => void
  canScrollPrev: boolean
  canScrollNext: boolean
} & CarouselProps

const CarouselContext = React.createContext<CarouselContextProps | null>(null)

function useCarousel() {
  const context = React.useContext(CarouselContext)

  if (!context) {
    throw new Error("useCarousel must be used within a <Carousel />")
  }

  return context
}

const Carousel = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & CarouselProps
>(
  (
    {
      orientation = "horizontal",
      opts,
      setApi,
      plugins,
      className,
      children,
      ...props
    },
    ref
  ) => {
    const [carouselRef, api] = useEmblaCarousel(
      {
        ...opts,
        axis: orientation === "horizontal" ? "x" : "y",
      },
      plugins
    )
    const [canScrollPrev, setCanScrollPrev] = React.useState(false)
    const [canScrollNext, setCanScrollNext] = React.useState(false)

    const onSelect = React.useCallback((api: CarouselApi) => {
      if (!api) {
        return
      }

      setCanScrollPrev(api.canScrollPrev())
      setCanScrollNext(api.canScrollNext())
    }, [])

    const scrollPrev = React.useCallback(() => {
      api?.scrollPrev()
    }, [api])

    const scrollNext = React.useCallback(() => {
      api?.scrollNext()
    }, [api])

    const handleKeyDown = React.useCallback(
      (event: React.KeyboardEvent<HTMLDivElement>) => {
        if (event.key === "ArrowLeft") {
          event.preventDefault()
          scrollPrev()
        } else if (event.key === "ArrowRight") {
          event.preventDefault()
          scrollNext()
        }
      },
      [scrollPrev, scrollNext]
    )

    React.useEffect(() => {
      if (!api || !setApi) {
        return
      }

      setApi(api)
    }, [api, setApi])

    React.useEffect(() => {
      if (!api) {
        return
      }

      onSelect(api)
      api.on("reInit", onSelect)
      api.on("select", onSelect)

      return () => {
        api?.off("select", onSelect)
      }
    }, [api, onSelect])

    return (
      <CarouselContext.Provider
        value={{
          carouselRef,
          api: api,
          opts,
          orientation:
            orientation || (opts?.axis === "y" ? "vertical" : "horizontal"),
          scrollPrev,
          scrollNext,
          canScrollPrev,
          canScrollNext,
        }}
      >
        <div
          ref={ref}
          onKeyDownCapture={handleKeyDown}
          className={cn("relative", className)}
          role="region"
          aria-roledescription="carousel"
          {...props}
        >
          {children}
        </div>
      </CarouselContext.Provider>
    )
  }
)
Carousel.displayName = "Carousel"

const CarouselContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const { carouselRef, orientation } = useCarousel()

  return (
    <div ref={carouselRef} className="overflow-hidden">
      <div
        ref={ref}
        className={cn(
          "flex",
          orientation === "horizontal" ? "-ml-4" : "-mt-4 flex-col",
          className
        )}
        {...props}
      />
    </div>
  )
})
CarouselContent.displayName = "CarouselContent"

const CarouselItem = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const { orientation } = useCarousel()

  return (
    <div
      ref={ref}
      role="group"
      aria-roledescription="slide"
      className={cn(
        "min-w-0 shrink-0 grow-0 basis-full",
        orientation === "horizontal" ? "pl-4" : "pt-4",
        className
      )}
      {...props}
    />
  )
})
CarouselItem.displayName = "CarouselItem"

const CarouselPrevious = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<typeof Button>
>(({ className, variant = "outline", size = "icon", ...props }, ref) => {
  const { orientation, scrollPrev, canScrollPrev } = useCarousel()

  return (
    <Button
      ref={ref}
      variant={variant}
      size={size}
      className={cn(
        "absolute  h-8 w-8 rounded-full",
        orientation === "horizontal"
          ? "-left-12 top-1/2 -translate-y-1/2"
          : "-top-12 left-1/2 -translate-x-1/2 rotate-90",
        className
      )}
      disabled={!canScrollPrev}
      onClick={scrollPrev}
      {...props}
    >
      <ArrowLeft className="h-4 w-4" />
      <span className="sr-only">Previous slide</span>
    </Button>
  )
})
CarouselPrevious.displayName = "CarouselPrevious"

const CarouselNext = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<typeof Button>
>(({ className, variant = "outline", size = "icon", ...props }, ref) => {
  const { orientation, scrollNext, canScrollNext } = useCarousel()

  return (
    <Button
      ref={ref}
      variant={variant}
      size={size}
      className={cn(
        "absolute h-8 w-8 rounded-full",
        orientation === "horizontal"
          ? "-right-12 top-1/2 -translate-y-1/2"
          : "-bottom-12 left-1/2 -translate-x-1/2 rotate-90",
        className
      )}
      disabled={!canScrollNext}
      onClick={scrollNext}
      {...props}
    >
      <ArrowRight className="h-4 w-4" />
      <span className="sr-only">Next slide</span>
    </Button>
  )
})
CarouselNext.displayName = "CarouselNext"

export {
  type CarouselApi,
  Carousel,
  CarouselContent,
  CarouselItem,
  CarouselPrevious,
  CarouselNext,
}
</file>

<file path="client/src/components/ui/chart.tsx">
import * as React from "react"
import * as RechartsPrimitive from "recharts"

import { cn } from "@/lib/utils"

// Format: { THEME_NAME: CSS_SELECTOR }
const THEMES = { light: "", dark: ".dark" } as const

export type ChartConfig = {
  [k in string]: {
    label?: React.ReactNode
    icon?: React.ComponentType
  } & (
    | { color?: string; theme?: never }
    | { color?: never; theme: Record<keyof typeof THEMES, string> }
  )
}

type ChartContextProps = {
  config: ChartConfig
}

const ChartContext = React.createContext<ChartContextProps | null>(null)

function useChart() {
  const context = React.useContext(ChartContext)

  if (!context) {
    throw new Error("useChart must be used within a <ChartContainer />")
  }

  return context
}

const ChartContainer = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    config: ChartConfig
    children: React.ComponentProps<
      typeof RechartsPrimitive.ResponsiveContainer
    >["children"]
  }
>(({ id, className, children, config, ...props }, ref) => {
  const uniqueId = React.useId()
  const chartId = `chart-${id || uniqueId.replace(/:/g, "")}`

  return (
    <ChartContext.Provider value={{ config }}>
      <div
        data-chart={chartId}
        ref={ref}
        className={cn(
          "flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none",
          className
        )}
        {...props}
      >
        <ChartStyle id={chartId} config={config} />
        <RechartsPrimitive.ResponsiveContainer>
          {children}
        </RechartsPrimitive.ResponsiveContainer>
      </div>
    </ChartContext.Provider>
  )
})
ChartContainer.displayName = "Chart"

const ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {
  const colorConfig = Object.entries(config).filter(
    ([_, config]) => config.theme || config.color
  )

  if (!colorConfig.length) {
    return null
  }

  return (
    <style
      dangerouslySetInnerHTML={{
        __html: Object.entries(THEMES)
          .map(
            ([theme, prefix]) => `
${prefix} [data-chart=${id}] {
${colorConfig
  .map(([key, itemConfig]) => {
    const color =
      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||
      itemConfig.color
    return color ? `  --color-${key}: ${color};` : null
  })
  .join("\n")}
}
`
          )
          .join("\n"),
      }}
    />
  )
}

const ChartTooltip = RechartsPrimitive.Tooltip

const ChartTooltipContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &
    React.ComponentProps<"div"> & {
      hideLabel?: boolean
      hideIndicator?: boolean
      indicator?: "line" | "dot" | "dashed"
      nameKey?: string
      labelKey?: string
    }
>(
  (
    {
      active,
      payload,
      className,
      indicator = "dot",
      hideLabel = false,
      hideIndicator = false,
      label,
      labelFormatter,
      labelClassName,
      formatter,
      color,
      nameKey,
      labelKey,
    },
    ref
  ) => {
    const { config } = useChart()

    const tooltipLabel = React.useMemo(() => {
      if (hideLabel || !payload?.length) {
        return null
      }

      const [item] = payload
      const key = `${labelKey || item.dataKey || item.name || "value"}`
      const itemConfig = getPayloadConfigFromPayload(config, item, key)
      const value =
        !labelKey && typeof label === "string"
          ? config[label as keyof typeof config]?.label || label
          : itemConfig?.label

      if (labelFormatter) {
        return (
          <div className={cn("font-medium", labelClassName)}>
            {labelFormatter(value, payload)}
          </div>
        )
      }

      if (!value) {
        return null
      }

      return <div className={cn("font-medium", labelClassName)}>{value}</div>
    }, [
      label,
      labelFormatter,
      payload,
      hideLabel,
      labelClassName,
      config,
      labelKey,
    ])

    if (!active || !payload?.length) {
      return null
    }

    const nestLabel = payload.length === 1 && indicator !== "dot"

    return (
      <div
        ref={ref}
        className={cn(
          "grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl",
          className
        )}
      >
        {!nestLabel ? tooltipLabel : null}
        <div className="grid gap-1.5">
          {payload.map((item, index) => {
            const key = `${nameKey || item.name || item.dataKey || "value"}`
            const itemConfig = getPayloadConfigFromPayload(config, item, key)
            const indicatorColor = color || item.payload.fill || item.color

            return (
              <div
                key={item.dataKey}
                className={cn(
                  "flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground",
                  indicator === "dot" && "items-center"
                )}
              >
                {formatter && item?.value !== undefined && item.name ? (
                  formatter(item.value, item.name, item, index, item.payload)
                ) : (
                  <>
                    {itemConfig?.icon ? (
                      <itemConfig.icon />
                    ) : (
                      !hideIndicator && (
                        <div
                          className={cn(
                            "shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]",
                            {
                              "h-2.5 w-2.5": indicator === "dot",
                              "w-1": indicator === "line",
                              "w-0 border-[1.5px] border-dashed bg-transparent":
                                indicator === "dashed",
                              "my-0.5": nestLabel && indicator === "dashed",
                            }
                          )}
                          style={
                            {
                              "--color-bg": indicatorColor,
                              "--color-border": indicatorColor,
                            } as React.CSSProperties
                          }
                        />
                      )
                    )}
                    <div
                      className={cn(
                        "flex flex-1 justify-between leading-none",
                        nestLabel ? "items-end" : "items-center"
                      )}
                    >
                      <div className="grid gap-1.5">
                        {nestLabel ? tooltipLabel : null}
                        <span className="text-muted-foreground">
                          {itemConfig?.label || item.name}
                        </span>
                      </div>
                      {item.value && (
                        <span className="font-mono font-medium tabular-nums text-foreground">
                          {item.value.toLocaleString()}
                        </span>
                      )}
                    </div>
                  </>
                )}
              </div>
            )
          })}
        </div>
      </div>
    )
  }
)
ChartTooltipContent.displayName = "ChartTooltip"

const ChartLegend = RechartsPrimitive.Legend

const ChartLegendContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> &
    Pick<RechartsPrimitive.LegendProps, "payload" | "verticalAlign"> & {
      hideIcon?: boolean
      nameKey?: string
    }
>(
  (
    { className, hideIcon = false, payload, verticalAlign = "bottom", nameKey },
    ref
  ) => {
    const { config } = useChart()

    if (!payload?.length) {
      return null
    }

    return (
      <div
        ref={ref}
        className={cn(
          "flex items-center justify-center gap-4",
          verticalAlign === "top" ? "pb-3" : "pt-3",
          className
        )}
      >
        {payload.map((item) => {
          const key = `${nameKey || item.dataKey || "value"}`
          const itemConfig = getPayloadConfigFromPayload(config, item, key)

          return (
            <div
              key={item.value}
              className={cn(
                "flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground"
              )}
            >
              {itemConfig?.icon && !hideIcon ? (
                <itemConfig.icon />
              ) : (
                <div
                  className="h-2 w-2 shrink-0 rounded-[2px]"
                  style={{
                    backgroundColor: item.color,
                  }}
                />
              )}
              {itemConfig?.label}
            </div>
          )
        })}
      </div>
    )
  }
)
ChartLegendContent.displayName = "ChartLegend"

// Helper to extract item config from a payload.
function getPayloadConfigFromPayload(
  config: ChartConfig,
  payload: unknown,
  key: string
) {
  if (typeof payload !== "object" || payload === null) {
    return undefined
  }

  const payloadPayload =
    "payload" in payload &&
    typeof payload.payload === "object" &&
    payload.payload !== null
      ? payload.payload
      : undefined

  let configLabelKey: string = key

  if (
    key in payload &&
    typeof payload[key as keyof typeof payload] === "string"
  ) {
    configLabelKey = payload[key as keyof typeof payload] as string
  } else if (
    payloadPayload &&
    key in payloadPayload &&
    typeof payloadPayload[key as keyof typeof payloadPayload] === "string"
  ) {
    configLabelKey = payloadPayload[
      key as keyof typeof payloadPayload
    ] as string
  }

  return configLabelKey in config
    ? config[configLabelKey]
    : config[key as keyof typeof config]
}

export {
  ChartContainer,
  ChartTooltip,
  ChartTooltipContent,
  ChartLegend,
  ChartLegendContent,
  ChartStyle,
}
</file>

<file path="client/src/components/ui/checkbox.tsx">
import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { Check } from "lucide-react"

import { cn } from "@/lib/utils"

const Checkbox = React.forwardRef<
  React.ElementRef<typeof CheckboxPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>
>(({ className, ...props }, ref) => (
  <CheckboxPrimitive.Root
    ref={ref}
    className={cn(
      "peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",
      className
    )}
    {...props}
  >
    <CheckboxPrimitive.Indicator
      className={cn("flex items-center justify-center text-current")}
    >
      <Check className="h-4 w-4" />
    </CheckboxPrimitive.Indicator>
  </CheckboxPrimitive.Root>
))
Checkbox.displayName = CheckboxPrimitive.Root.displayName

export { Checkbox }
</file>

<file path="client/src/components/ui/collapsible.tsx">
import * as CollapsiblePrimitive from "@radix-ui/react-collapsible"

const Collapsible = CollapsiblePrimitive.Root

const CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger

const CollapsibleContent = CollapsiblePrimitive.CollapsibleContent

export { Collapsible, CollapsibleTrigger, CollapsibleContent }
</file>

<file path="client/src/components/ui/command.tsx">
import * as React from "react"
import { type DialogProps } from "@radix-ui/react-dialog"
import { Command as CommandPrimitive } from "cmdk"
import { Search } from "lucide-react"

import { cn } from "@/lib/utils"
import { Dialog, DialogContent } from "@/components/ui/dialog"

const Command = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive>
>(({ className, ...props }, ref) => (
  <CommandPrimitive
    ref={ref}
    className={cn(
      "flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",
      className
    )}
    {...props}
  />
))
Command.displayName = CommandPrimitive.displayName

interface CommandDialogProps extends DialogProps {}

const CommandDialog = ({ children, ...props }: CommandDialogProps) => {
  return (
    <Dialog {...props}>
      <DialogContent className="overflow-hidden p-0 shadow-lg">
        <Command className="[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5">
          {children}
        </Command>
      </DialogContent>
    </Dialog>
  )
}

const CommandInput = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Input>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>
>(({ className, ...props }, ref) => (
  <div className="flex items-center border-b px-3" cmdk-input-wrapper="">
    <Search className="mr-2 h-4 w-4 shrink-0 opacity-50" />
    <CommandPrimitive.Input
      ref={ref}
      className={cn(
        "flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    />
  </div>
))

CommandInput.displayName = CommandPrimitive.Input.displayName

const CommandList = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.List
    ref={ref}
    className={cn("max-h-[300px] overflow-y-auto overflow-x-hidden", className)}
    {...props}
  />
))

CommandList.displayName = CommandPrimitive.List.displayName

const CommandEmpty = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Empty>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>
>((props, ref) => (
  <CommandPrimitive.Empty
    ref={ref}
    className="py-6 text-center text-sm"
    {...props}
  />
))

CommandEmpty.displayName = CommandPrimitive.Empty.displayName

const CommandGroup = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Group>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Group
    ref={ref}
    className={cn(
      "overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",
      className
    )}
    {...props}
  />
))

CommandGroup.displayName = CommandPrimitive.Group.displayName

const CommandSeparator = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 h-px bg-border", className)}
    {...props}
  />
))
CommandSeparator.displayName = CommandPrimitive.Separator.displayName

const CommandItem = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50",
      className
    )}
    {...props}
  />
))

CommandItem.displayName = CommandPrimitive.Item.displayName

const CommandShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn(
        "ml-auto text-xs tracking-widest text-muted-foreground",
        className
      )}
      {...props}
    />
  )
}
CommandShortcut.displayName = "CommandShortcut"

export {
  Command,
  CommandDialog,
  CommandInput,
  CommandList,
  CommandEmpty,
  CommandGroup,
  CommandItem,
  CommandShortcut,
  CommandSeparator,
}
</file>

<file path="client/src/components/ui/context-menu.tsx">
import * as React from "react"
import * as ContextMenuPrimitive from "@radix-ui/react-context-menu"
import { Check, ChevronRight, Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const ContextMenu = ContextMenuPrimitive.Root

const ContextMenuTrigger = ContextMenuPrimitive.Trigger

const ContextMenuGroup = ContextMenuPrimitive.Group

const ContextMenuPortal = ContextMenuPrimitive.Portal

const ContextMenuSub = ContextMenuPrimitive.Sub

const ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup

const ContextMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {
    inset?: boolean
  }
>(({ className, inset, children, ...props }, ref) => (
  <ContextMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",
      inset && "pl-8",
      className
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto h-4 w-4" />
  </ContextMenuPrimitive.SubTrigger>
))
ContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName

const ContextMenuSubContent = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <ContextMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
))
ContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName

const ContextMenuContent = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>
>(({ className, ...props }, ref) => (
  <ContextMenuPrimitive.Portal>
    <ContextMenuPrimitive.Content
      ref={ref}
      className={cn(
        "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props}
    />
  </ContextMenuPrimitive.Portal>
))
ContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName

const ContextMenuItem = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <ContextMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
ContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName

const ContextMenuCheckboxItem = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <ContextMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <ContextMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </ContextMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </ContextMenuPrimitive.CheckboxItem>
))
ContextMenuCheckboxItem.displayName =
  ContextMenuPrimitive.CheckboxItem.displayName

const ContextMenuRadioItem = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <ContextMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <ContextMenuPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </ContextMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </ContextMenuPrimitive.RadioItem>
))
ContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName

const ContextMenuLabel = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <ContextMenuPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold text-foreground",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
ContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName

const ContextMenuSeparator = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <ContextMenuPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-border", className)}
    {...props}
  />
))
ContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName

const ContextMenuShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn(
        "ml-auto text-xs tracking-widest text-muted-foreground",
        className
      )}
      {...props}
    />
  )
}
ContextMenuShortcut.displayName = "ContextMenuShortcut"

export {
  ContextMenu,
  ContextMenuTrigger,
  ContextMenuContent,
  ContextMenuItem,
  ContextMenuCheckboxItem,
  ContextMenuRadioItem,
  ContextMenuLabel,
  ContextMenuSeparator,
  ContextMenuShortcut,
  ContextMenuGroup,
  ContextMenuPortal,
  ContextMenuSub,
  ContextMenuSubContent,
  ContextMenuSubTrigger,
  ContextMenuRadioGroup,
}
</file>

<file path="client/src/components/ui/dialog.tsx">
import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Dialog = DialogPrimitive.Root

const DialogTrigger = DialogPrimitive.Trigger

const DialogPortal = DialogPrimitive.Portal

const DialogClose = DialogPrimitive.Close

const DialogOverlay = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
  />
))
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName

const DialogContent = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DialogPortal>
    <DialogOverlay />
    <DialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    >
      {children}
      <DialogPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </DialogPrimitive.Close>
    </DialogPrimitive.Content>
  </DialogPortal>
))
DialogContent.displayName = DialogPrimitive.Content.displayName

const DialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-1.5 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
DialogHeader.displayName = "DialogHeader"

const DialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
DialogFooter.displayName = "DialogFooter"

const DialogTitle = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Title
    ref={ref}
    className={cn(
      "text-lg font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
DialogTitle.displayName = DialogPrimitive.Title.displayName

const DialogDescription = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
DialogDescription.displayName = DialogPrimitive.Description.displayName

export {
  Dialog,
  DialogPortal,
  DialogOverlay,
  DialogClose,
  DialogTrigger,
  DialogContent,
  DialogHeader,
  DialogFooter,
  DialogTitle,
  DialogDescription,
}
</file>

<file path="client/src/components/ui/drawer.tsx">
import * as React from "react"
import { Drawer as DrawerPrimitive } from "vaul"

import { cn } from "@/lib/utils"

const Drawer = ({
  shouldScaleBackground = true,
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (
  <DrawerPrimitive.Root
    shouldScaleBackground={shouldScaleBackground}
    {...props}
  />
)
Drawer.displayName = "Drawer"

const DrawerTrigger = DrawerPrimitive.Trigger

const DrawerPortal = DrawerPrimitive.Portal

const DrawerClose = DrawerPrimitive.Close

const DrawerOverlay = React.forwardRef<
  React.ElementRef<typeof DrawerPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DrawerPrimitive.Overlay
    ref={ref}
    className={cn("fixed inset-0 z-50 bg-black/80", className)}
    {...props}
  />
))
DrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName

const DrawerContent = React.forwardRef<
  React.ElementRef<typeof DrawerPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DrawerPortal>
    <DrawerOverlay />
    <DrawerPrimitive.Content
      ref={ref}
      className={cn(
        "fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background",
        className
      )}
      {...props}
    >
      <div className="mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted" />
      {children}
    </DrawerPrimitive.Content>
  </DrawerPortal>
))
DrawerContent.displayName = "DrawerContent"

const DrawerHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn("grid gap-1.5 p-4 text-center sm:text-left", className)}
    {...props}
  />
)
DrawerHeader.displayName = "DrawerHeader"

const DrawerFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn("mt-auto flex flex-col gap-2 p-4", className)}
    {...props}
  />
)
DrawerFooter.displayName = "DrawerFooter"

const DrawerTitle = React.forwardRef<
  React.ElementRef<typeof DrawerPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DrawerPrimitive.Title
    ref={ref}
    className={cn(
      "text-lg font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
DrawerTitle.displayName = DrawerPrimitive.Title.displayName

const DrawerDescription = React.forwardRef<
  React.ElementRef<typeof DrawerPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DrawerPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
DrawerDescription.displayName = DrawerPrimitive.Description.displayName

export {
  Drawer,
  DrawerPortal,
  DrawerOverlay,
  DrawerTrigger,
  DrawerClose,
  DrawerContent,
  DrawerHeader,
  DrawerFooter,
  DrawerTitle,
  DrawerDescription,
}
</file>

<file path="client/src/components/ui/dropdown-menu.tsx">
import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { Check, ChevronRight, Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const DropdownMenu = DropdownMenuPrimitive.Root

const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger

const DropdownMenuGroup = DropdownMenuPrimitive.Group

const DropdownMenuPortal = DropdownMenuPrimitive.Portal

const DropdownMenuSub = DropdownMenuPrimitive.Sub

const DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup

const DropdownMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {
    inset?: boolean
  }
>(({ className, inset, children, ...props }, ref) => (
  <DropdownMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent",
      inset && "pl-8",
      className
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto h-4 w-4" />
  </DropdownMenuPrimitive.SubTrigger>
))
DropdownMenuSubTrigger.displayName =
  DropdownMenuPrimitive.SubTrigger.displayName

const DropdownMenuSubContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
))
DropdownMenuSubContent.displayName =
  DropdownMenuPrimitive.SubContent.displayName

const DropdownMenuContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <DropdownMenuPrimitive.Portal>
    <DropdownMenuPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props}
    />
  </DropdownMenuPrimitive.Portal>
))
DropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName

const DropdownMenuItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName

const DropdownMenuCheckboxItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <DropdownMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.CheckboxItem>
))
DropdownMenuCheckboxItem.displayName =
  DropdownMenuPrimitive.CheckboxItem.displayName

const DropdownMenuRadioItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <DropdownMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.RadioItem>
))
DropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName

const DropdownMenuLabel = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
DropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName

const DropdownMenuSeparator = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
DropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName

const DropdownMenuShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn("ml-auto text-xs tracking-widest opacity-60", className)}
      {...props}
    />
  )
}
DropdownMenuShortcut.displayName = "DropdownMenuShortcut"

export {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuGroup,
  DropdownMenuPortal,
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
  DropdownMenuRadioGroup,
}
</file>

<file path="client/src/components/ui/form.tsx">
import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { Slot } from "@radix-ui/react-slot"
import {
  Controller,
  ControllerProps,
  FieldPath,
  FieldValues,
  FormProvider,
  useFormContext,
} from "react-hook-form"

import { cn } from "@/lib/utils"
import { Label } from "@/components/ui/label"

const Form = FormProvider

type FormFieldContextValue<
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
> = {
  name: TName
}

const FormFieldContext = React.createContext<FormFieldContextValue>(
  {} as FormFieldContextValue
)

const FormField = <
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
>({
  ...props
}: ControllerProps<TFieldValues, TName>) => {
  return (
    <FormFieldContext.Provider value={{ name: props.name }}>
      <Controller {...props} />
    </FormFieldContext.Provider>
  )
}

const useFormField = () => {
  const fieldContext = React.useContext(FormFieldContext)
  const itemContext = React.useContext(FormItemContext)
  const { getFieldState, formState } = useFormContext()

  const fieldState = getFieldState(fieldContext.name, formState)

  if (!fieldContext) {
    throw new Error("useFormField should be used within <FormField>")
  }

  const { id } = itemContext

  return {
    id,
    name: fieldContext.name,
    formItemId: `${id}-form-item`,
    formDescriptionId: `${id}-form-item-description`,
    formMessageId: `${id}-form-item-message`,
    ...fieldState,
  }
}

type FormItemContextValue = {
  id: string
}

const FormItemContext = React.createContext<FormItemContextValue>(
  {} as FormItemContextValue
)

const FormItem = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const id = React.useId()

  return (
    <FormItemContext.Provider value={{ id }}>
      <div ref={ref} className={cn("space-y-2", className)} {...props} />
    </FormItemContext.Provider>
  )
})
FormItem.displayName = "FormItem"

const FormLabel = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>
>(({ className, ...props }, ref) => {
  const { error, formItemId } = useFormField()

  return (
    <Label
      ref={ref}
      className={cn(error && "text-destructive", className)}
      htmlFor={formItemId}
      {...props}
    />
  )
})
FormLabel.displayName = "FormLabel"

const FormControl = React.forwardRef<
  React.ElementRef<typeof Slot>,
  React.ComponentPropsWithoutRef<typeof Slot>
>(({ ...props }, ref) => {
  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()

  return (
    <Slot
      ref={ref}
      id={formItemId}
      aria-describedby={
        !error
          ? `${formDescriptionId}`
          : `${formDescriptionId} ${formMessageId}`
      }
      aria-invalid={!!error}
      {...props}
    />
  )
})
FormControl.displayName = "FormControl"

const FormDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => {
  const { formDescriptionId } = useFormField()

  return (
    <p
      ref={ref}
      id={formDescriptionId}
      className={cn("text-sm text-muted-foreground", className)}
      {...props}
    />
  )
})
FormDescription.displayName = "FormDescription"

const FormMessage = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, children, ...props }, ref) => {
  const { error, formMessageId } = useFormField()
  const body = error ? String(error?.message) : children

  if (!body) {
    return null
  }

  return (
    <p
      ref={ref}
      id={formMessageId}
      className={cn("text-sm font-medium text-destructive", className)}
      {...props}
    >
      {body}
    </p>
  )
})
FormMessage.displayName = "FormMessage"

export {
  useFormField,
  Form,
  FormItem,
  FormLabel,
  FormControl,
  FormDescription,
  FormMessage,
  FormField,
}
</file>

<file path="client/src/components/ui/hover-card.tsx">
import * as React from "react"
import * as HoverCardPrimitive from "@radix-ui/react-hover-card"

import { cn } from "@/lib/utils"

const HoverCard = HoverCardPrimitive.Root

const HoverCardTrigger = HoverCardPrimitive.Trigger

const HoverCardContent = React.forwardRef<
  React.ElementRef<typeof HoverCardPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>
>(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
  <HoverCardPrimitive.Content
    ref={ref}
    align={align}
    sideOffset={sideOffset}
    className={cn(
      "z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
))
HoverCardContent.displayName = HoverCardPrimitive.Content.displayName

export { HoverCard, HoverCardTrigger, HoverCardContent }
</file>

<file path="client/src/components/ui/input-otp.tsx">
import * as React from "react"
import { OTPInput, OTPInputContext } from "input-otp"
import { Dot } from "lucide-react"

import { cn } from "@/lib/utils"

const InputOTP = React.forwardRef<
  React.ElementRef<typeof OTPInput>,
  React.ComponentPropsWithoutRef<typeof OTPInput>
>(({ className, containerClassName, ...props }, ref) => (
  <OTPInput
    ref={ref}
    containerClassName={cn(
      "flex items-center gap-2 has-[:disabled]:opacity-50",
      containerClassName
    )}
    className={cn("disabled:cursor-not-allowed", className)}
    {...props}
  />
))
InputOTP.displayName = "InputOTP"

const InputOTPGroup = React.forwardRef<
  React.ElementRef<"div">,
  React.ComponentPropsWithoutRef<"div">
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("flex items-center", className)} {...props} />
))
InputOTPGroup.displayName = "InputOTPGroup"

const InputOTPSlot = React.forwardRef<
  React.ElementRef<"div">,
  React.ComponentPropsWithoutRef<"div"> & { index: number }
>(({ index, className, ...props }, ref) => {
  const inputOTPContext = React.useContext(OTPInputContext)
  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]

  return (
    <div
      ref={ref}
      className={cn(
        "relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md",
        isActive && "z-10 ring-2 ring-ring ring-offset-background",
        className
      )}
      {...props}
    >
      {char}
      {hasFakeCaret && (
        <div className="pointer-events-none absolute inset-0 flex items-center justify-center">
          <div className="h-4 w-px animate-caret-blink bg-foreground duration-1000" />
        </div>
      )}
    </div>
  )
})
InputOTPSlot.displayName = "InputOTPSlot"

const InputOTPSeparator = React.forwardRef<
  React.ElementRef<"div">,
  React.ComponentPropsWithoutRef<"div">
>(({ ...props }, ref) => (
  <div ref={ref} role="separator" {...props}>
    <Dot />
  </div>
))
InputOTPSeparator.displayName = "InputOTPSeparator"

export { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }
</file>

<file path="client/src/components/ui/input.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

export interface InputProps
  extends React.InputHTMLAttributes<HTMLInputElement> {}

const Input = React.forwardRef<HTMLInputElement, InputProps>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Input.displayName = "Input"

export { Input }
</file>

<file path="client/src/components/ui/label.tsx">
import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const labelVariants = cva(
  "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
)

const Label = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &
    VariantProps<typeof labelVariants>
>(({ className, ...props }, ref) => (
  <LabelPrimitive.Root
    ref={ref}
    className={cn(labelVariants(), className)}
    {...props}
  />
))
Label.displayName = LabelPrimitive.Root.displayName

export { Label }
</file>

<file path="client/src/components/ui/menubar.tsx">
import * as React from "react"
import * as MenubarPrimitive from "@radix-ui/react-menubar"
import { Check, ChevronRight, Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const MenubarMenu = MenubarPrimitive.Menu

const MenubarGroup = MenubarPrimitive.Group

const MenubarPortal = MenubarPrimitive.Portal

const MenubarSub = MenubarPrimitive.Sub

const MenubarRadioGroup = MenubarPrimitive.RadioGroup

const Menubar = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.Root
    ref={ref}
    className={cn(
      "flex h-10 items-center space-x-1 rounded-md border bg-background p-1",
      className
    )}
    {...props}
  />
))
Menubar.displayName = MenubarPrimitive.Root.displayName

const MenubarTrigger = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",
      className
    )}
    {...props}
  />
))
MenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName

const MenubarSubTrigger = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {
    inset?: boolean
  }
>(({ className, inset, children, ...props }, ref) => (
  <MenubarPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",
      inset && "pl-8",
      className
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto h-4 w-4" />
  </MenubarPrimitive.SubTrigger>
))
MenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName

const MenubarSubContent = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
))
MenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName

const MenubarContent = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>
>(
  (
    { className, align = "start", alignOffset = -4, sideOffset = 8, ...props },
    ref
  ) => (
    <MenubarPrimitive.Portal>
      <MenubarPrimitive.Content
        ref={ref}
        align={align}
        alignOffset={alignOffset}
        sideOffset={sideOffset}
        className={cn(
          "z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          className
        )}
        {...props}
      />
    </MenubarPrimitive.Portal>
  )
)
MenubarContent.displayName = MenubarPrimitive.Content.displayName

const MenubarItem = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <MenubarPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
MenubarItem.displayName = MenubarPrimitive.Item.displayName

const MenubarCheckboxItem = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <MenubarPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <MenubarPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </MenubarPrimitive.ItemIndicator>
    </span>
    {children}
  </MenubarPrimitive.CheckboxItem>
))
MenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName

const MenubarRadioItem = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <MenubarPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <MenubarPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </MenubarPrimitive.ItemIndicator>
    </span>
    {children}
  </MenubarPrimitive.RadioItem>
))
MenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName

const MenubarLabel = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <MenubarPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
MenubarLabel.displayName = MenubarPrimitive.Label.displayName

const MenubarSeparator = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
MenubarSeparator.displayName = MenubarPrimitive.Separator.displayName

const MenubarShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn(
        "ml-auto text-xs tracking-widest text-muted-foreground",
        className
      )}
      {...props}
    />
  )
}
MenubarShortcut.displayname = "MenubarShortcut"

export {
  Menubar,
  MenubarMenu,
  MenubarTrigger,
  MenubarContent,
  MenubarItem,
  MenubarSeparator,
  MenubarLabel,
  MenubarCheckboxItem,
  MenubarRadioGroup,
  MenubarRadioItem,
  MenubarPortal,
  MenubarSubContent,
  MenubarSubTrigger,
  MenubarGroup,
  MenubarSub,
  MenubarShortcut,
}
</file>

<file path="client/src/components/ui/navigation-menu.tsx">
import * as React from "react"
import * as NavigationMenuPrimitive from "@radix-ui/react-navigation-menu"
import { cva } from "class-variance-authority"
import { ChevronDown } from "lucide-react"

import { cn } from "@/lib/utils"

const NavigationMenu = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>
>(({ className, children, ...props }, ref) => (
  <NavigationMenuPrimitive.Root
    ref={ref}
    className={cn(
      "relative z-10 flex max-w-max flex-1 items-center justify-center",
      className
    )}
    {...props}
  >
    {children}
    <NavigationMenuViewport />
  </NavigationMenuPrimitive.Root>
))
NavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName

const NavigationMenuList = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>
>(({ className, ...props }, ref) => (
  <NavigationMenuPrimitive.List
    ref={ref}
    className={cn(
      "group flex flex-1 list-none items-center justify-center space-x-1",
      className
    )}
    {...props}
  />
))
NavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName

const NavigationMenuItem = NavigationMenuPrimitive.Item

const navigationMenuTriggerStyle = cva(
  "group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[active]:bg-accent/50 data-[state=open]:bg-accent/50"
)

const NavigationMenuTrigger = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <NavigationMenuPrimitive.Trigger
    ref={ref}
    className={cn(navigationMenuTriggerStyle(), "group", className)}
    {...props}
  >
    {children}{" "}
    <ChevronDown
      className="relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180"
      aria-hidden="true"
    />
  </NavigationMenuPrimitive.Trigger>
))
NavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName

const NavigationMenuContent = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>
>(({ className, ...props }, ref) => (
  <NavigationMenuPrimitive.Content
    ref={ref}
    className={cn(
      "left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto ",
      className
    )}
    {...props}
  />
))
NavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName

const NavigationMenuLink = NavigationMenuPrimitive.Link

const NavigationMenuViewport = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>
>(({ className, ...props }, ref) => (
  <div className={cn("absolute left-0 top-full flex justify-center")}>
    <NavigationMenuPrimitive.Viewport
      className={cn(
        "origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]",
        className
      )}
      ref={ref}
      {...props}
    />
  </div>
))
NavigationMenuViewport.displayName =
  NavigationMenuPrimitive.Viewport.displayName

const NavigationMenuIndicator = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>
>(({ className, ...props }, ref) => (
  <NavigationMenuPrimitive.Indicator
    ref={ref}
    className={cn(
      "top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in",
      className
    )}
    {...props}
  >
    <div className="relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md" />
  </NavigationMenuPrimitive.Indicator>
))
NavigationMenuIndicator.displayName =
  NavigationMenuPrimitive.Indicator.displayName

export {
  navigationMenuTriggerStyle,
  NavigationMenu,
  NavigationMenuList,
  NavigationMenuItem,
  NavigationMenuContent,
  NavigationMenuTrigger,
  NavigationMenuLink,
  NavigationMenuIndicator,
  NavigationMenuViewport,
}
</file>

<file path="client/src/components/ui/pagination.tsx">
import * as React from "react"
import { ChevronLeft, ChevronRight, MoreHorizontal } from "lucide-react"

import { cn } from "@/lib/utils"
import { ButtonProps, buttonVariants } from "@/components/ui/button"

const Pagination = ({ className, ...props }: React.ComponentProps<"nav">) => (
  <nav
    role="navigation"
    aria-label="pagination"
    className={cn("mx-auto flex w-full justify-center", className)}
    {...props}
  />
)
Pagination.displayName = "Pagination"

const PaginationContent = React.forwardRef<
  HTMLUListElement,
  React.ComponentProps<"ul">
>(({ className, ...props }, ref) => (
  <ul
    ref={ref}
    className={cn("flex flex-row items-center gap-1", className)}
    {...props}
  />
))
PaginationContent.displayName = "PaginationContent"

const PaginationItem = React.forwardRef<
  HTMLLIElement,
  React.ComponentProps<"li">
>(({ className, ...props }, ref) => (
  <li ref={ref} className={cn("", className)} {...props} />
))
PaginationItem.displayName = "PaginationItem"

type PaginationLinkProps = {
  isActive?: boolean
} & Pick<ButtonProps, "size"> &
  React.ComponentProps<"a">

const PaginationLink = ({
  className,
  isActive,
  size = "icon",
  ...props
}: PaginationLinkProps) => (
  <a
    aria-current={isActive ? "page" : undefined}
    className={cn(
      buttonVariants({
        variant: isActive ? "outline" : "ghost",
        size,
      }),
      className
    )}
    {...props}
  />
)
PaginationLink.displayName = "PaginationLink"

const PaginationPrevious = ({
  className,
  ...props
}: React.ComponentProps<typeof PaginationLink>) => (
  <PaginationLink
    aria-label="Go to previous page"
    size="default"
    className={cn("gap-1 pl-2.5", className)}
    {...props}
  >
    <ChevronLeft className="h-4 w-4" />
    <span>Previous</span>
  </PaginationLink>
)
PaginationPrevious.displayName = "PaginationPrevious"

const PaginationNext = ({
  className,
  ...props
}: React.ComponentProps<typeof PaginationLink>) => (
  <PaginationLink
    aria-label="Go to next page"
    size="default"
    className={cn("gap-1 pr-2.5", className)}
    {...props}
  >
    <span>Next</span>
    <ChevronRight className="h-4 w-4" />
  </PaginationLink>
)
PaginationNext.displayName = "PaginationNext"

const PaginationEllipsis = ({
  className,
  ...props
}: React.ComponentProps<"span">) => (
  <span
    aria-hidden
    className={cn("flex h-9 w-9 items-center justify-center", className)}
    {...props}
  >
    <MoreHorizontal className="h-4 w-4" />
    <span className="sr-only">More pages</span>
  </span>
)
PaginationEllipsis.displayName = "PaginationEllipsis"

export {
  Pagination,
  PaginationContent,
  PaginationEllipsis,
  PaginationItem,
  PaginationLink,
  PaginationNext,
  PaginationPrevious,
}
</file>

<file path="client/src/components/ui/popover.tsx">
import * as React from "react"
import * as PopoverPrimitive from "@radix-ui/react-popover"

import { cn } from "@/lib/utils"

const Popover = PopoverPrimitive.Root

const PopoverTrigger = PopoverPrimitive.Trigger

const PopoverContent = React.forwardRef<
  React.ElementRef<typeof PopoverPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>
>(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
  <PopoverPrimitive.Portal>
    <PopoverPrimitive.Content
      ref={ref}
      align={align}
      sideOffset={sideOffset}
      className={cn(
        "z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props}
    />
  </PopoverPrimitive.Portal>
))
PopoverContent.displayName = PopoverPrimitive.Content.displayName

export { Popover, PopoverTrigger, PopoverContent }
</file>

<file path="client/src/components/ui/progress.tsx">
import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"

import { cn } from "@/lib/utils"

const Progress = React.forwardRef<
  React.ElementRef<typeof ProgressPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>
>(({ className, value, ...props }, ref) => (
  <ProgressPrimitive.Root
    ref={ref}
    className={cn(
      "relative h-4 w-full overflow-hidden rounded-full bg-secondary",
      className
    )}
    {...props}
  >
    <ProgressPrimitive.Indicator
      className="h-full w-full flex-1 bg-primary transition-all"
      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
    />
  </ProgressPrimitive.Root>
))
Progress.displayName = ProgressPrimitive.Root.displayName

export { Progress }
</file>

<file path="client/src/components/ui/radio-group.tsx">
import * as React from "react"
import * as RadioGroupPrimitive from "@radix-ui/react-radio-group"
import { Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const RadioGroup = React.forwardRef<
  React.ElementRef<typeof RadioGroupPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>
>(({ className, ...props }, ref) => {
  return (
    <RadioGroupPrimitive.Root
      className={cn("grid gap-2", className)}
      {...props}
      ref={ref}
    />
  )
})
RadioGroup.displayName = RadioGroupPrimitive.Root.displayName

const RadioGroupItem = React.forwardRef<
  React.ElementRef<typeof RadioGroupPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>
>(({ className, ...props }, ref) => {
  return (
    <RadioGroupPrimitive.Item
      ref={ref}
      className={cn(
        "aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <RadioGroupPrimitive.Indicator className="flex items-center justify-center">
        <Circle className="h-2.5 w-2.5 fill-current text-current" />
      </RadioGroupPrimitive.Indicator>
    </RadioGroupPrimitive.Item>
  )
})
RadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName

export { RadioGroup, RadioGroupItem }
</file>

<file path="client/src/components/ui/resizable.tsx">
import { GripVertical } from "lucide-react"
import * as ResizablePrimitive from "react-resizable-panels"

import { cn } from "@/lib/utils"

const ResizablePanelGroup = ({
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (
  <ResizablePrimitive.PanelGroup
    className={cn(
      "flex h-full w-full data-[panel-group-direction=vertical]:flex-col",
      className
    )}
    {...props}
  />
)

const ResizablePanel = ResizablePrimitive.Panel

const ResizableHandle = ({
  withHandle,
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {
  withHandle?: boolean
}) => (
  <ResizablePrimitive.PanelResizeHandle
    className={cn(
      "relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90",
      className
    )}
    {...props}
  >
    {withHandle && (
      <div className="z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border">
        <GripVertical className="h-2.5 w-2.5" />
      </div>
    )}
  </ResizablePrimitive.PanelResizeHandle>
)

export { ResizablePanelGroup, ResizablePanel, ResizableHandle }
</file>

<file path="client/src/components/ui/scroll-area.tsx">
import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"

import { cn } from "@/lib/utils"

const ScrollArea = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>
>(({ className, children, ...props }, ref) => (
  <ScrollAreaPrimitive.Root
    ref={ref}
    className={cn("relative overflow-hidden", className)}
    {...props}
  >
    <ScrollAreaPrimitive.Viewport className="h-full w-full rounded-[inherit]">
      {children}
    </ScrollAreaPrimitive.Viewport>
    <ScrollBar />
    <ScrollAreaPrimitive.Corner />
  </ScrollAreaPrimitive.Root>
))
ScrollArea.displayName = ScrollAreaPrimitive.Root.displayName

const ScrollBar = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>
>(({ className, orientation = "vertical", ...props }, ref) => (
  <ScrollAreaPrimitive.ScrollAreaScrollbar
    ref={ref}
    orientation={orientation}
    className={cn(
      "flex touch-none select-none transition-colors",
      orientation === "vertical" &&
        "h-full w-2.5 border-l border-l-transparent p-[1px]",
      orientation === "horizontal" &&
        "h-2.5 flex-col border-t border-t-transparent p-[1px]",
      className
    )}
    {...props}
  >
    <ScrollAreaPrimitive.ScrollAreaThumb className="relative flex-1 rounded-full bg-border" />
  </ScrollAreaPrimitive.ScrollAreaScrollbar>
))
ScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName

export { ScrollArea, ScrollBar }
</file>

<file path="client/src/components/ui/select.tsx">
import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { Check, ChevronDown, ChevronUp } from "lucide-react"

import { cn } from "@/lib/utils"

const Select = SelectPrimitive.Root

const SelectGroup = SelectPrimitive.Group

const SelectValue = SelectPrimitive.Value

const SelectTrigger = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",
      className
    )}
    {...props}
  >
    {children}
    <SelectPrimitive.Icon asChild>
      <ChevronDown className="h-4 w-4 opacity-50" />
    </SelectPrimitive.Icon>
  </SelectPrimitive.Trigger>
))
SelectTrigger.displayName = SelectPrimitive.Trigger.displayName

const SelectScrollUpButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollUpButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronUp className="h-4 w-4" />
  </SelectPrimitive.ScrollUpButton>
))
SelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName

const SelectScrollDownButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollDownButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronDown className="h-4 w-4" />
  </SelectPrimitive.ScrollDownButton>
))
SelectScrollDownButton.displayName =
  SelectPrimitive.ScrollDownButton.displayName

const SelectContent = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>
>(({ className, children, position = "popper", ...props }, ref) => (
  <SelectPrimitive.Portal>
    <SelectPrimitive.Content
      ref={ref}
      className={cn(
        "relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        position === "popper" &&
          "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
        className
      )}
      position={position}
      {...props}
    >
      <SelectScrollUpButton />
      <SelectPrimitive.Viewport
        className={cn(
          "p-1",
          position === "popper" &&
            "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
        )}
      >
        {children}
      </SelectPrimitive.Viewport>
      <SelectScrollDownButton />
    </SelectPrimitive.Content>
  </SelectPrimitive.Portal>
))
SelectContent.displayName = SelectPrimitive.Content.displayName

const SelectLabel = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Label
    ref={ref}
    className={cn("py-1.5 pl-8 pr-2 text-sm font-semibold", className)}
    {...props}
  />
))
SelectLabel.displayName = SelectPrimitive.Label.displayName

const SelectItem = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <SelectPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </SelectPrimitive.ItemIndicator>
    </span>

    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
  </SelectPrimitive.Item>
))
SelectItem.displayName = SelectPrimitive.Item.displayName

const SelectSeparator = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
SelectSeparator.displayName = SelectPrimitive.Separator.displayName

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
  SelectScrollUpButton,
  SelectScrollDownButton,
}
</file>

<file path="client/src/components/ui/separator.tsx">
import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

const Separator = React.forwardRef<
  React.ElementRef<typeof SeparatorPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>
>(
  (
    { className, orientation = "horizontal", decorative = true, ...props },
    ref
  ) => (
    <SeparatorPrimitive.Root
      ref={ref}
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "shrink-0 bg-border",
        orientation === "horizontal" ? "h-[1px] w-full" : "h-full w-[1px]",
        className
      )}
      {...props}
    />
  )
)
Separator.displayName = SeparatorPrimitive.Root.displayName

export { Separator }
</file>

<file path="client/src/components/ui/sheet.tsx">
import * as React from "react"
import * as SheetPrimitive from "@radix-ui/react-dialog"
import { cva, type VariantProps } from "class-variance-authority"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Sheet = SheetPrimitive.Root

const SheetTrigger = SheetPrimitive.Trigger

const SheetClose = SheetPrimitive.Close

const SheetPortal = SheetPrimitive.Portal

const SheetOverlay = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
))
SheetOverlay.displayName = SheetPrimitive.Overlay.displayName

const sheetVariants = cva(
  "fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500",
  {
    variants: {
      side: {
        top: "inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",
        bottom:
          "inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",
        left: "inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",
        right:
          "inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm",
      },
    },
    defaultVariants: {
      side: "right",
    },
  }
)

interface SheetContentProps
  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,
    VariantProps<typeof sheetVariants> {}

const SheetContent = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Content>,
  SheetContentProps
>(({ side = "right", className, children, ...props }, ref) => (
  <SheetPortal>
    <SheetOverlay />
    <SheetPrimitive.Content
      ref={ref}
      className={cn(sheetVariants({ side }), className)}
      {...props}
    >
      {children}
      <SheetPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </SheetPrimitive.Close>
    </SheetPrimitive.Content>
  </SheetPortal>
))
SheetContent.displayName = SheetPrimitive.Content.displayName

const SheetHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
SheetHeader.displayName = "SheetHeader"

const SheetFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
SheetFooter.displayName = "SheetFooter"

const SheetTitle = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold text-foreground", className)}
    {...props}
  />
))
SheetTitle.displayName = SheetPrimitive.Title.displayName

const SheetDescription = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
SheetDescription.displayName = SheetPrimitive.Description.displayName

export {
  Sheet,
  SheetPortal,
  SheetOverlay,
  SheetTrigger,
  SheetClose,
  SheetContent,
  SheetHeader,
  SheetFooter,
  SheetTitle,
  SheetDescription,
}
</file>

<file path="client/src/components/ui/sidebar.tsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { VariantProps, cva } from "class-variance-authority"
import { PanelLeft } from "lucide-react"

import { useIsMobile } from "@/hooks/use-mobile"
import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Separator } from "@/components/ui/separator"
import { Sheet, SheetContent } from "@/components/ui/sheet"
import { Skeleton } from "@/components/ui/skeleton"
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip"

const SIDEBAR_COOKIE_NAME = "sidebar:state"
const SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7
const SIDEBAR_WIDTH = "16rem"
const SIDEBAR_WIDTH_MOBILE = "18rem"
const SIDEBAR_WIDTH_ICON = "3rem"
const SIDEBAR_KEYBOARD_SHORTCUT = "b"

type SidebarContext = {
  state: "expanded" | "collapsed"
  open: boolean
  setOpen: (open: boolean) => void
  openMobile: boolean
  setOpenMobile: (open: boolean) => void
  isMobile: boolean
  toggleSidebar: () => void
}

const SidebarContext = React.createContext<SidebarContext | null>(null)

function useSidebar() {
  const context = React.useContext(SidebarContext)
  if (!context) {
    throw new Error("useSidebar must be used within a SidebarProvider.")
  }

  return context
}

const SidebarProvider = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    defaultOpen?: boolean
    open?: boolean
    onOpenChange?: (open: boolean) => void
  }
>(
  (
    {
      defaultOpen = true,
      open: openProp,
      onOpenChange: setOpenProp,
      className,
      style,
      children,
      ...props
    },
    ref
  ) => {
    const isMobile = useIsMobile()
    const [openMobile, setOpenMobile] = React.useState(false)

    // This is the internal state of the sidebar.
    // We use openProp and setOpenProp for control from outside the component.
    const [_open, _setOpen] = React.useState(defaultOpen)
    const open = openProp ?? _open
    const setOpen = React.useCallback(
      (value: boolean | ((value: boolean) => boolean)) => {
        if (setOpenProp) {
          return setOpenProp?.(
            typeof value === "function" ? value(open) : value
          )
        }

        _setOpen(value)

        // This sets the cookie to keep the sidebar state.
        document.cookie = `${SIDEBAR_COOKIE_NAME}=${open}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`
      },
      [setOpenProp, open]
    )

    // Helper to toggle the sidebar.
    const toggleSidebar = React.useCallback(() => {
      return isMobile
        ? setOpenMobile((open) => !open)
        : setOpen((open) => !open)
    }, [isMobile, setOpen, setOpenMobile])

    // Adds a keyboard shortcut to toggle the sidebar.
    React.useEffect(() => {
      const handleKeyDown = (event: KeyboardEvent) => {
        if (
          event.key === SIDEBAR_KEYBOARD_SHORTCUT &&
          (event.metaKey || event.ctrlKey)
        ) {
          event.preventDefault()
          toggleSidebar()
        }
      }

      window.addEventListener("keydown", handleKeyDown)
      return () => window.removeEventListener("keydown", handleKeyDown)
    }, [toggleSidebar])

    // We add a state so that we can do data-state="expanded" or "collapsed".
    // This makes it easier to style the sidebar with Tailwind classes.
    const state = open ? "expanded" : "collapsed"

    const contextValue = React.useMemo<SidebarContext>(
      () => ({
        state,
        open,
        setOpen,
        isMobile,
        openMobile,
        setOpenMobile,
        toggleSidebar,
      }),
      [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]
    )

    return (
      <SidebarContext.Provider value={contextValue}>
        <TooltipProvider delayDuration={0}>
          <div
            style={
              {
                "--sidebar-width": SIDEBAR_WIDTH,
                "--sidebar-width-icon": SIDEBAR_WIDTH_ICON,
                ...style,
              } as React.CSSProperties
            }
            className={cn(
              "group/sidebar-wrapper flex min-h-svh w-full text-sidebar-foreground has-[[data-variant=inset]]:bg-sidebar",
              className
            )}
            ref={ref}
            {...props}
          >
            {children}
          </div>
        </TooltipProvider>
      </SidebarContext.Provider>
    )
  }
)
SidebarProvider.displayName = "SidebarProvider"

const Sidebar = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    side?: "left" | "right"
    variant?: "sidebar" | "floating" | "inset"
    collapsible?: "offcanvas" | "icon" | "none"
  }
>(
  (
    {
      side = "left",
      variant = "sidebar",
      collapsible = "offcanvas",
      className,
      children,
      ...props
    },
    ref
  ) => {
    const { isMobile, state, openMobile, setOpenMobile } = useSidebar()

    if (collapsible === "none") {
      return (
        <div
          className={cn(
            "flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground",
            className
          )}
          ref={ref}
          {...props}
        >
          {children}
        </div>
      )
    }

    if (isMobile) {
      return (
        <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>
          <SheetContent
            data-sidebar="sidebar"
            data-mobile="true"
            className="w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden"
            style={
              {
                "--sidebar-width": SIDEBAR_WIDTH_MOBILE,
              } as React.CSSProperties
            }
            side={side}
          >
            <div className="flex h-full w-full flex-col">{children}</div>
          </SheetContent>
        </Sheet>
      )
    }

    return (
      <div
        ref={ref}
        className="group peer hidden md:block"
        data-state={state}
        data-collapsible={state === "collapsed" ? collapsible : ""}
        data-variant={variant}
        data-side={side}
      >
        {/* This is what handles the sidebar gap on desktop */}
        <div
          className={cn(
            "duration-200 relative h-svh w-[--sidebar-width] bg-transparent transition-[width] ease-linear",
            "group-data-[collapsible=offcanvas]:w-0",
            "group-data-[side=right]:rotate-180",
            variant === "floating" || variant === "inset"
              ? "group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]"
              : "group-data-[collapsible=icon]:w-[--sidebar-width-icon]"
          )}
        />
        <div
          className={cn(
            "duration-200 fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] ease-linear md:flex",
            side === "left"
              ? "left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]"
              : "right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]",
            // Adjust the padding for floating and inset variants.
            variant === "floating" || variant === "inset"
              ? "p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]"
              : "group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l",
            className
          )}
          {...props}
        >
          <div
            data-sidebar="sidebar"
            className="flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow"
          >
            {children}
          </div>
        </div>
      </div>
    )
  }
)
Sidebar.displayName = "Sidebar"

const SidebarTrigger = React.forwardRef<
  React.ElementRef<typeof Button>,
  React.ComponentProps<typeof Button>
>(({ className, onClick, ...props }, ref) => {
  const { toggleSidebar } = useSidebar()

  return (
    <Button
      ref={ref}
      data-sidebar="trigger"
      variant="ghost"
      size="icon"
      className={cn("h-7 w-7", className)}
      onClick={(event) => {
        onClick?.(event)
        toggleSidebar()
      }}
      {...props}
    >
      <PanelLeft />
      <span className="sr-only">Toggle Sidebar</span>
    </Button>
  )
})
SidebarTrigger.displayName = "SidebarTrigger"

const SidebarRail = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button">
>(({ className, ...props }, ref) => {
  const { toggleSidebar } = useSidebar()

  return (
    <button
      ref={ref}
      data-sidebar="rail"
      aria-label="Toggle Sidebar"
      tabIndex={-1}
      onClick={toggleSidebar}
      title="Toggle Sidebar"
      className={cn(
        "absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex",
        "[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize",
        "[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize",
        "group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar",
        "[[data-side=left][data-collapsible=offcanvas]_&]:-right-2",
        "[[data-side=right][data-collapsible=offcanvas]_&]:-left-2",
        className
      )}
      {...props}
    />
  )
})
SidebarRail.displayName = "SidebarRail"

const SidebarInset = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"main">
>(({ className, ...props }, ref) => {
  return (
    <main
      ref={ref}
      className={cn(
        "relative flex min-h-svh flex-1 flex-col bg-background",
        "peer-data-[variant=inset]:min-h-[calc(100svh-theme(spacing.4))] md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow",
        className
      )}
      {...props}
    />
  )
})
SidebarInset.displayName = "SidebarInset"

const SidebarInput = React.forwardRef<
  React.ElementRef<typeof Input>,
  React.ComponentProps<typeof Input>
>(({ className, ...props }, ref) => {
  return (
    <Input
      ref={ref}
      data-sidebar="input"
      className={cn(
        "h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring",
        className
      )}
      {...props}
    />
  )
})
SidebarInput.displayName = "SidebarInput"

const SidebarHeader = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      data-sidebar="header"
      className={cn("flex flex-col gap-2 p-2", className)}
      {...props}
    />
  )
})
SidebarHeader.displayName = "SidebarHeader"

const SidebarFooter = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      data-sidebar="footer"
      className={cn("flex flex-col gap-2 p-2", className)}
      {...props}
    />
  )
})
SidebarFooter.displayName = "SidebarFooter"

const SidebarSeparator = React.forwardRef<
  React.ElementRef<typeof Separator>,
  React.ComponentProps<typeof Separator>
>(({ className, ...props }, ref) => {
  return (
    <Separator
      ref={ref}
      data-sidebar="separator"
      className={cn("mx-2 w-auto bg-sidebar-border", className)}
      {...props}
    />
  )
})
SidebarSeparator.displayName = "SidebarSeparator"

const SidebarContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      data-sidebar="content"
      className={cn(
        "flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden",
        className
      )}
      {...props}
    />
  )
})
SidebarContent.displayName = "SidebarContent"

const SidebarGroup = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      data-sidebar="group"
      className={cn("relative flex w-full min-w-0 flex-col p-2", className)}
      {...props}
    />
  )
})
SidebarGroup.displayName = "SidebarGroup"

const SidebarGroupLabel = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & { asChild?: boolean }
>(({ className, asChild = false, ...props }, ref) => {
  const Comp = asChild ? Slot : "div"

  return (
    <Comp
      ref={ref}
      data-sidebar="group-label"
      className={cn(
        "duration-200 flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opa] ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        "group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0",
        className
      )}
      {...props}
    />
  )
})
SidebarGroupLabel.displayName = "SidebarGroupLabel"

const SidebarGroupAction = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button"> & { asChild?: boolean }
>(({ className, asChild = false, ...props }, ref) => {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      ref={ref}
      data-sidebar="group-action"
      className={cn(
        "absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        // Increases the hit area of the button on mobile.
        "after:absolute after:-inset-2 after:md:hidden",
        "group-data-[collapsible=icon]:hidden",
        className
      )}
      {...props}
    />
  )
})
SidebarGroupAction.displayName = "SidebarGroupAction"

const SidebarGroupContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    data-sidebar="group-content"
    className={cn("w-full text-sm", className)}
    {...props}
  />
))
SidebarGroupContent.displayName = "SidebarGroupContent"

const SidebarMenu = React.forwardRef<
  HTMLUListElement,
  React.ComponentProps<"ul">
>(({ className, ...props }, ref) => (
  <ul
    ref={ref}
    data-sidebar="menu"
    className={cn("flex w-full min-w-0 flex-col gap-1", className)}
    {...props}
  />
))
SidebarMenu.displayName = "SidebarMenu"

const SidebarMenuItem = React.forwardRef<
  HTMLLIElement,
  React.ComponentProps<"li">
>(({ className, ...props }, ref) => (
  <li
    ref={ref}
    data-sidebar="menu-item"
    className={cn("group/menu-item relative", className)}
    {...props}
  />
))
SidebarMenuItem.displayName = "SidebarMenuItem"

const sidebarMenuButtonVariants = cva(
  "peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "hover:bg-sidebar-accent hover:text-sidebar-accent-foreground",
        outline:
          "bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]",
      },
      size: {
        default: "h-8 text-sm",
        sm: "h-7 text-xs",
        lg: "h-12 text-sm group-data-[collapsible=icon]:!p-0",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

const SidebarMenuButton = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button"> & {
    asChild?: boolean
    isActive?: boolean
    tooltip?: string | React.ComponentProps<typeof TooltipContent>
  } & VariantProps<typeof sidebarMenuButtonVariants>
>(
  (
    {
      asChild = false,
      isActive = false,
      variant = "default",
      size = "default",
      tooltip,
      className,
      ...props
    },
    ref
  ) => {
    const Comp = asChild ? Slot : "button"
    const { isMobile, state } = useSidebar()

    const button = (
      <Comp
        ref={ref}
        data-sidebar="menu-button"
        data-size={size}
        data-active={isActive}
        className={cn(sidebarMenuButtonVariants({ variant, size }), className)}
        {...props}
      />
    )

    if (!tooltip) {
      return button
    }

    if (typeof tooltip === "string") {
      tooltip = {
        children: tooltip,
      }
    }

    return (
      <Tooltip>
        <TooltipTrigger asChild>{button}</TooltipTrigger>
        <TooltipContent
          side="right"
          align="center"
          hidden={state !== "collapsed" || isMobile}
          {...tooltip}
        />
      </Tooltip>
    )
  }
)
SidebarMenuButton.displayName = "SidebarMenuButton"

const SidebarMenuAction = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button"> & {
    asChild?: boolean
    showOnHover?: boolean
  }
>(({ className, asChild = false, showOnHover = false, ...props }, ref) => {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      ref={ref}
      data-sidebar="menu-action"
      className={cn(
        "absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0",
        // Increases the hit area of the button on mobile.
        "after:absolute after:-inset-2 after:md:hidden",
        "peer-data-[size=sm]/menu-button:top-1",
        "peer-data-[size=default]/menu-button:top-1.5",
        "peer-data-[size=lg]/menu-button:top-2.5",
        "group-data-[collapsible=icon]:hidden",
        showOnHover &&
          "group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0",
        className
      )}
      {...props}
    />
  )
})
SidebarMenuAction.displayName = "SidebarMenuAction"

const SidebarMenuBadge = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    data-sidebar="menu-badge"
    className={cn(
      "absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground select-none pointer-events-none",
      "peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground",
      "peer-data-[size=sm]/menu-button:top-1",
      "peer-data-[size=default]/menu-button:top-1.5",
      "peer-data-[size=lg]/menu-button:top-2.5",
      "group-data-[collapsible=icon]:hidden",
      className
    )}
    {...props}
  />
))
SidebarMenuBadge.displayName = "SidebarMenuBadge"

const SidebarMenuSkeleton = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    showIcon?: boolean
  }
>(({ className, showIcon = false, ...props }, ref) => {
  // Random width between 50 to 90%.
  const width = React.useMemo(() => {
    return `${Math.floor(Math.random() * 40) + 50}%`
  }, [])

  return (
    <div
      ref={ref}
      data-sidebar="menu-skeleton"
      className={cn("rounded-md h-8 flex gap-2 px-2 items-center", className)}
      {...props}
    >
      {showIcon && (
        <Skeleton
          className="size-4 rounded-md"
          data-sidebar="menu-skeleton-icon"
        />
      )}
      <Skeleton
        className="h-4 flex-1 max-w-[--skeleton-width]"
        data-sidebar="menu-skeleton-text"
        style={
          {
            "--skeleton-width": width,
          } as React.CSSProperties
        }
      />
    </div>
  )
})
SidebarMenuSkeleton.displayName = "SidebarMenuSkeleton"

const SidebarMenuSub = React.forwardRef<
  HTMLUListElement,
  React.ComponentProps<"ul">
>(({ className, ...props }, ref) => (
  <ul
    ref={ref}
    data-sidebar="menu-sub"
    className={cn(
      "mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5",
      "group-data-[collapsible=icon]:hidden",
      className
    )}
    {...props}
  />
))
SidebarMenuSub.displayName = "SidebarMenuSub"

const SidebarMenuSubItem = React.forwardRef<
  HTMLLIElement,
  React.ComponentProps<"li">
>(({ ...props }, ref) => <li ref={ref} {...props} />)
SidebarMenuSubItem.displayName = "SidebarMenuSubItem"

const SidebarMenuSubButton = React.forwardRef<
  HTMLAnchorElement,
  React.ComponentProps<"a"> & {
    asChild?: boolean
    size?: "sm" | "md"
    isActive?: boolean
  }
>(({ asChild = false, size = "md", isActive, className, ...props }, ref) => {
  const Comp = asChild ? Slot : "a"

  return (
    <Comp
      ref={ref}
      data-sidebar="menu-sub-button"
      data-size={size}
      data-active={isActive}
      className={cn(
        "flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground",
        "data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground",
        size === "sm" && "text-xs",
        size === "md" && "text-sm",
        "group-data-[collapsible=icon]:hidden",
        className
      )}
      {...props}
    />
  )
})
SidebarMenuSubButton.displayName = "SidebarMenuSubButton"

export {
  Sidebar,
  SidebarContent,
  SidebarFooter,
  SidebarGroup,
  SidebarGroupAction,
  SidebarGroupContent,
  SidebarGroupLabel,
  SidebarHeader,
  SidebarInput,
  SidebarInset,
  SidebarMenu,
  SidebarMenuAction,
  SidebarMenuBadge,
  SidebarMenuButton,
  SidebarMenuItem,
  SidebarMenuSkeleton,
  SidebarMenuSub,
  SidebarMenuSubButton,
  SidebarMenuSubItem,
  SidebarProvider,
  SidebarRail,
  SidebarSeparator,
  SidebarTrigger,
  useSidebar,
}
</file>

<file path="client/src/components/ui/skeleton.tsx">
import { cn } from "@/lib/utils"

function Skeleton({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) {
  return (
    <div
      className={cn("animate-pulse rounded-md bg-muted", className)}
      {...props}
    />
  )
}

export { Skeleton }
</file>

<file path="client/src/components/ui/slider.tsx">
import * as React from "react"
import * as SliderPrimitive from "@radix-ui/react-slider"

import { cn } from "@/lib/utils"

const Slider = React.forwardRef<
  React.ElementRef<typeof SliderPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>
>(({ className, ...props }, ref) => (
  <SliderPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex w-full touch-none select-none items-center",
      className
    )}
    {...props}
  >
    <SliderPrimitive.Track className="relative h-2 w-full grow overflow-hidden rounded-full bg-secondary">
      <SliderPrimitive.Range className="absolute h-full bg-primary" />
    </SliderPrimitive.Track>
    <SliderPrimitive.Thumb className="block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50" />
  </SliderPrimitive.Root>
))
Slider.displayName = SliderPrimitive.Root.displayName

export { Slider }
</file>

<file path="client/src/components/ui/switch.tsx">
import * as React from "react"
import * as SwitchPrimitives from "@radix-ui/react-switch"

import { cn } from "@/lib/utils"

const Switch = React.forwardRef<
  React.ElementRef<typeof SwitchPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>
>(({ className, ...props }, ref) => (
  <SwitchPrimitives.Root
    className={cn(
      "peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",
      className
    )}
    {...props}
    ref={ref}
  >
    <SwitchPrimitives.Thumb
      className={cn(
        "pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0"
      )}
    />
  </SwitchPrimitives.Root>
))
Switch.displayName = SwitchPrimitives.Root.displayName

export { Switch }
</file>

<file path="client/src/components/ui/table.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

const Table = React.forwardRef<
  HTMLTableElement,
  React.HTMLAttributes<HTMLTableElement>
>(({ className, ...props }, ref) => (
  <div className="relative w-full overflow-auto">
    <table
      ref={ref}
      className={cn("w-full caption-bottom text-sm", className)}
      {...props}
    />
  </div>
))
Table.displayName = "Table"

const TableHeader = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <thead ref={ref} className={cn("[&_tr]:border-b", className)} {...props} />
))
TableHeader.displayName = "TableHeader"

const TableBody = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tbody
    ref={ref}
    className={cn("[&_tr:last-child]:border-0", className)}
    {...props}
  />
))
TableBody.displayName = "TableBody"

const TableFooter = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tfoot
    ref={ref}
    className={cn(
      "border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",
      className
    )}
    {...props}
  />
))
TableFooter.displayName = "TableFooter"

const TableRow = React.forwardRef<
  HTMLTableRowElement,
  React.HTMLAttributes<HTMLTableRowElement>
>(({ className, ...props }, ref) => (
  <tr
    ref={ref}
    className={cn(
      "border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",
      className
    )}
    {...props}
  />
))
TableRow.displayName = "TableRow"

const TableHead = React.forwardRef<
  HTMLTableCellElement,
  React.ThHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <th
    ref={ref}
    className={cn(
      "h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",
      className
    )}
    {...props}
  />
))
TableHead.displayName = "TableHead"

const TableCell = React.forwardRef<
  HTMLTableCellElement,
  React.TdHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <td
    ref={ref}
    className={cn("p-4 align-middle [&:has([role=checkbox])]:pr-0", className)}
    {...props}
  />
))
TableCell.displayName = "TableCell"

const TableCaption = React.forwardRef<
  HTMLTableCaptionElement,
  React.HTMLAttributes<HTMLTableCaptionElement>
>(({ className, ...props }, ref) => (
  <caption
    ref={ref}
    className={cn("mt-4 text-sm text-muted-foreground", className)}
    {...props}
  />
))
TableCaption.displayName = "TableCaption"

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}
</file>

<file path="client/src/components/ui/tabs.tsx">
import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"

import { cn } from "@/lib/utils"

const Tabs = TabsPrimitive.Root

const TabsList = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.List
    ref={ref}
    className={cn(
      "inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",
      className
    )}
    {...props}
  />
))
TabsList.displayName = TabsPrimitive.List.displayName

const TabsTrigger = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Trigger
    ref={ref}
    className={cn(
      "inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",
      className
    )}
    {...props}
  />
))
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName

const TabsContent = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Content
    ref={ref}
    className={cn(
      "mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
      className
    )}
    {...props}
  />
))
TabsContent.displayName = TabsPrimitive.Content.displayName

export { Tabs, TabsList, TabsTrigger, TabsContent }
</file>

<file path="client/src/components/ui/textarea.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

export interface TextareaProps
  extends React.TextareaHTMLAttributes<HTMLTextAreaElement> {}

const Textarea = React.forwardRef<HTMLTextAreaElement, TextareaProps>(
  ({ className, ...props }, ref) => {
    return (
      <textarea
        className={cn(
          "flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Textarea.displayName = "Textarea"

export { Textarea }
</file>

<file path="client/src/components/ui/toast.tsx">
import * as React from "react"
import * as ToastPrimitives from "@radix-ui/react-toast"
import { cva, type VariantProps } from "class-variance-authority"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const ToastProvider = ToastPrimitives.Provider

const ToastViewport = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Viewport>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Viewport
    ref={ref}
    className={cn(
      "fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]",
      className
    )}
    {...props}
  />
))
ToastViewport.displayName = ToastPrimitives.Viewport.displayName

const toastVariants = cva(
  "group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full",
  {
    variants: {
      variant: {
        default: "border bg-background text-foreground",
        destructive:
          "destructive group border-destructive bg-destructive text-destructive-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

const Toast = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &
    VariantProps<typeof toastVariants>
>(({ className, variant, ...props }, ref) => {
  return (
    <ToastPrimitives.Root
      ref={ref}
      className={cn(toastVariants({ variant }), className)}
      {...props}
    />
  )
})
Toast.displayName = ToastPrimitives.Root.displayName

const ToastAction = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Action>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Action
    ref={ref}
    className={cn(
      "inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive",
      className
    )}
    {...props}
  />
))
ToastAction.displayName = ToastPrimitives.Action.displayName

const ToastClose = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Close>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Close
    ref={ref}
    className={cn(
      "absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600",
      className
    )}
    toast-close=""
    {...props}
  >
    <X className="h-4 w-4" />
  </ToastPrimitives.Close>
))
ToastClose.displayName = ToastPrimitives.Close.displayName

const ToastTitle = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Title>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Title
    ref={ref}
    className={cn("text-sm font-semibold", className)}
    {...props}
  />
))
ToastTitle.displayName = ToastPrimitives.Title.displayName

const ToastDescription = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Description>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Description
    ref={ref}
    className={cn("text-sm opacity-90", className)}
    {...props}
  />
))
ToastDescription.displayName = ToastPrimitives.Description.displayName

type ToastProps = React.ComponentPropsWithoutRef<typeof Toast>

type ToastActionElement = React.ReactElement<typeof ToastAction>

export {
  type ToastProps,
  type ToastActionElement,
  ToastProvider,
  ToastViewport,
  Toast,
  ToastTitle,
  ToastDescription,
  ToastClose,
  ToastAction,
}
</file>

<file path="client/src/components/ui/toaster.tsx">
import { useToast } from "@/hooks/use-toast"
import {
  Toast,
  ToastClose,
  ToastDescription,
  ToastProvider,
  ToastTitle,
  ToastViewport,
} from "@/components/ui/toast"

export function Toaster() {
  const { toasts } = useToast()

  return (
    <ToastProvider>
      {toasts.map(function ({ id, title, description, action, ...props }) {
        return (
          <Toast key={id} {...props}>
            <div className="grid gap-1">
              {title && <ToastTitle>{title}</ToastTitle>}
              {description && (
                <ToastDescription>{description}</ToastDescription>
              )}
            </div>
            {action}
            <ToastClose />
          </Toast>
        )
      })}
      <ToastViewport />
    </ToastProvider>
  )
}
</file>

<file path="client/src/components/ui/toggle-group.tsx">
import * as React from "react"
import * as ToggleGroupPrimitive from "@radix-ui/react-toggle-group"
import { type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"
import { toggleVariants } from "@/components/ui/toggle"

const ToggleGroupContext = React.createContext<
  VariantProps<typeof toggleVariants>
>({
  size: "default",
  variant: "default",
})

const ToggleGroup = React.forwardRef<
  React.ElementRef<typeof ToggleGroupPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &
    VariantProps<typeof toggleVariants>
>(({ className, variant, size, children, ...props }, ref) => (
  <ToggleGroupPrimitive.Root
    ref={ref}
    className={cn("flex items-center justify-center gap-1", className)}
    {...props}
  >
    <ToggleGroupContext.Provider value={{ variant, size }}>
      {children}
    </ToggleGroupContext.Provider>
  </ToggleGroupPrimitive.Root>
))

ToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName

const ToggleGroupItem = React.forwardRef<
  React.ElementRef<typeof ToggleGroupPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &
    VariantProps<typeof toggleVariants>
>(({ className, children, variant, size, ...props }, ref) => {
  const context = React.useContext(ToggleGroupContext)

  return (
    <ToggleGroupPrimitive.Item
      ref={ref}
      className={cn(
        toggleVariants({
          variant: context.variant || variant,
          size: context.size || size,
        }),
        className
      )}
      {...props}
    >
      {children}
    </ToggleGroupPrimitive.Item>
  )
})

ToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName

export { ToggleGroup, ToggleGroupItem }
</file>

<file path="client/src/components/ui/toggle.tsx">
import * as React from "react"
import * as TogglePrimitive from "@radix-ui/react-toggle"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const toggleVariants = cva(
  "inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground",
  {
    variants: {
      variant: {
        default: "bg-transparent",
        outline:
          "border border-input bg-transparent hover:bg-accent hover:text-accent-foreground",
      },
      size: {
        default: "h-10 px-3",
        sm: "h-9 px-2.5",
        lg: "h-11 px-5",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

const Toggle = React.forwardRef<
  React.ElementRef<typeof TogglePrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &
    VariantProps<typeof toggleVariants>
>(({ className, variant, size, ...props }, ref) => (
  <TogglePrimitive.Root
    ref={ref}
    className={cn(toggleVariants({ variant, size, className }))}
    {...props}
  />
))

Toggle.displayName = TogglePrimitive.Root.displayName

export { Toggle, toggleVariants }
</file>

<file path="client/src/components/ui/tooltip.tsx">
import * as React from "react"
import * as TooltipPrimitive from "@radix-ui/react-tooltip"

import { cn } from "@/lib/utils"

const TooltipProvider = TooltipPrimitive.Provider

const Tooltip = TooltipPrimitive.Root

const TooltipTrigger = TooltipPrimitive.Trigger

const TooltipContent = React.forwardRef<
  React.ElementRef<typeof TooltipPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <TooltipPrimitive.Content
    ref={ref}
    sideOffset={sideOffset}
    className={cn(
      "z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
))
TooltipContent.displayName = TooltipPrimitive.Content.displayName

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }
</file>

<file path="client/src/components/ChatMessage.tsx">
import { Card } from "@/components/ui/card";
import { cn } from "@/lib/utils";
import { format } from "date-fns";
import type { Message, User } from "@db/schema";

interface ChatMessageProps {
  message: Message;
  currentUser: User;
  className?: string;
}

export function ChatMessage({ message, currentUser, className }: ChatMessageProps) {
  const isCurrentUser = message.senderId === currentUser.id;
  
  return (
    <div
      className={cn(
        "flex",
        isCurrentUser ? "justify-end" : "justify-start",
        className
      )}
    >
      <Card
        className={cn(
          "max-w-[80%] p-4",
          isCurrentUser
            ? "bg-primary text-primary-foreground"
            : "bg-card text-card-foreground",
        )}
      >
        <div className="space-y-1">
          <p className="text-sm break-words">{message.content}</p>
          <p className="text-xs opacity-70">
            {format(new Date(message.createdAt), "HH:mm")}
          </p>
        </div>
      </Card>
    </div>
  );
}
</file>

<file path="client/src/components/QuizQuestion.tsx">
import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";
import { Progress } from "@/components/ui/progress";

interface QuizQuestionProps {
  question: {
    id: number;
    text: string;
    options: string[];
  };
  onAnswer: (questionId: number, answerIndex: number) => void;
  progress: number;
}

export function QuizQuestion({ question, onAnswer, progress }: QuizQuestionProps) {
  return (
    <div className="space-y-6">
      <Progress value={progress} className="w-full h-2" />
      
      <Card className="p-6">
        <h2 className="text-xl font-semibold mb-6 text-card-foreground">
          {question.text}
        </h2>
        
        <div className="grid gap-4">
          {question.options.map((option, index) => (
            <Button
              key={index}
              variant="outline"
              className="justify-start h-auto py-4 px-6 text-left hover:bg-primary/10 transition-colors"
              onClick={() => onAnswer(question.id, index)}
            >
              {option}
            </Button>
          ))}
        </div>
      </Card>
    </div>
  );
}
</file>

<file path="client/src/components/theme-provider.tsx">
import { createContext, useContext, useEffect, useState } from "react";

type Theme = "dark" | "light" | "system";

type ThemeProviderProps = {
  children: React.ReactNode;
  defaultTheme?: Theme;
  storageKey?: string;
};

type ThemeProviderState = {
  theme: Theme;
  setTheme: (theme: Theme) => void;
};

const initialState: ThemeProviderState = {
  theme: "system",
  setTheme: () => null,
};

const ThemeProviderContext = createContext<ThemeProviderState>(initialState);

export function ThemeProvider({
  children,
  defaultTheme = "system",
  storageKey = "vibe-ui-theme",
  ...props
}: ThemeProviderProps) {
  const [theme, setTheme] = useState<Theme>(
    () => (localStorage.getItem(storageKey) as Theme) || defaultTheme
  );

  useEffect(() => {
    const root = window.document.documentElement;
    root.classList.remove("light", "dark");

    if (theme === "system") {
      const systemTheme = window.matchMedia("(prefers-color-scheme: dark)")
        .matches
        ? "dark"
        : "light";

      root.classList.add(systemTheme);
      return;
    }

    root.classList.add(theme);
  }, [theme]);

  const value = {
    theme,
    setTheme: (theme: Theme) => {
      localStorage.setItem(storageKey, theme);
      setTheme(theme);
    },
  };

  return (
    <ThemeProviderContext.Provider {...props} value={value}>
      {children}
    </ThemeProviderContext.Provider>
  );
}

export const useTheme = () => {
  const context = useContext(ThemeProviderContext);

  if (context === undefined)
    throw new Error("useTheme must be used within a ThemeProvider");

  return context;
};
</file>

<file path="client/src/components/ThemeToggle.tsx">
import { Moon, Sun } from "lucide-react";
import { Button } from "@/components/ui/button";
import { useTheme } from "@/components/theme-provider";

export function ThemeToggle() {
  const { theme, setTheme } = useTheme();

  return (
    <Button
      variant="ghost"
      size="icon"
      onClick={() => setTheme(theme === "light" ? "dark" : "light")}
      className="w-9 h-9 px-0"
    >
      <Sun className="h-[1.2rem] w-[1.2rem] rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0" />
      <Moon className="absolute h-[1.2rem] w-[1.2rem] rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100" />
      <span className="sr-only">Toggle theme</span>
    </Button>
  );
}
</file>

<file path="client/src/hooks/use-mobile.tsx">
import * as React from "react"

const MOBILE_BREAKPOINT = 768

export function useIsMobile() {
  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)

  React.useEffect(() => {
    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)
    const onChange = () => {
      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
    }
    mql.addEventListener("change", onChange)
    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
    return () => mql.removeEventListener("change", onChange)
  }, [])

  return !!isMobile
}
</file>

<file path="client/src/hooks/use-toast.ts">
import * as React from "react"

import type {
  ToastActionElement,
  ToastProps,
} from "@/components/ui/toast"

const TOAST_LIMIT = 1
const TOAST_REMOVE_DELAY = 1000000

type ToasterToast = ToastProps & {
  id: string
  title?: React.ReactNode
  description?: React.ReactNode
  action?: ToastActionElement
}

const actionTypes = {
  ADD_TOAST: "ADD_TOAST",
  UPDATE_TOAST: "UPDATE_TOAST",
  DISMISS_TOAST: "DISMISS_TOAST",
  REMOVE_TOAST: "REMOVE_TOAST",
} as const

let count = 0

function genId() {
  count = (count + 1) % Number.MAX_SAFE_INTEGER
  return count.toString()
}

type ActionType = typeof actionTypes

type Action =
  | {
      type: ActionType["ADD_TOAST"]
      toast: ToasterToast
    }
  | {
      type: ActionType["UPDATE_TOAST"]
      toast: Partial<ToasterToast>
    }
  | {
      type: ActionType["DISMISS_TOAST"]
      toastId?: ToasterToast["id"]
    }
  | {
      type: ActionType["REMOVE_TOAST"]
      toastId?: ToasterToast["id"]
    }

interface State {
  toasts: ToasterToast[]
}

const toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()

const addToRemoveQueue = (toastId: string) => {
  if (toastTimeouts.has(toastId)) {
    return
  }

  const timeout = setTimeout(() => {
    toastTimeouts.delete(toastId)
    dispatch({
      type: "REMOVE_TOAST",
      toastId: toastId,
    })
  }, TOAST_REMOVE_DELAY)

  toastTimeouts.set(toastId, timeout)
}

export const reducer = (state: State, action: Action): State => {
  switch (action.type) {
    case "ADD_TOAST":
      return {
        ...state,
        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),
      }

    case "UPDATE_TOAST":
      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === action.toast.id ? { ...t, ...action.toast } : t
        ),
      }

    case "DISMISS_TOAST": {
      const { toastId } = action

      // ! Side effects ! - This could be extracted into a dismissToast() action,
      // but I'll keep it here for simplicity
      if (toastId) {
        addToRemoveQueue(toastId)
      } else {
        state.toasts.forEach((toast) => {
          addToRemoveQueue(toast.id)
        })
      }

      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === toastId || toastId === undefined
            ? {
                ...t,
                open: false,
              }
            : t
        ),
      }
    }
    case "REMOVE_TOAST":
      if (action.toastId === undefined) {
        return {
          ...state,
          toasts: [],
        }
      }
      return {
        ...state,
        toasts: state.toasts.filter((t) => t.id !== action.toastId),
      }
  }
}

const listeners: Array<(state: State) => void> = []

let memoryState: State = { toasts: [] }

function dispatch(action: Action) {
  memoryState = reducer(memoryState, action)
  listeners.forEach((listener) => {
    listener(memoryState)
  })
}

type Toast = Omit<ToasterToast, "id">

function toast({ ...props }: Toast) {
  const id = genId()

  const update = (props: ToasterToast) =>
    dispatch({
      type: "UPDATE_TOAST",
      toast: { ...props, id },
    })
  const dismiss = () => dispatch({ type: "DISMISS_TOAST", toastId: id })

  dispatch({
    type: "ADD_TOAST",
    toast: {
      ...props,
      id,
      open: true,
      onOpenChange: (open) => {
        if (!open) dismiss()
      },
    },
  })

  return {
    id: id,
    dismiss,
    update,
  }
}

function useToast() {
  const [state, setState] = React.useState<State>(memoryState)

  React.useEffect(() => {
    listeners.push(setState)
    return () => {
      const index = listeners.indexOf(setState)
      if (index > -1) {
        listeners.splice(index, 1)
      }
    }
  }, [state])

  return {
    ...state,
    toast,
    dismiss: (toastId?: string) => dispatch({ type: "DISMISS_TOAST", toastId }),
  }
}

export { useToast, toast }
</file>

<file path="client/src/lib/queryClient.ts">
import { QueryClient } from "@tanstack/react-query";

export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      queryFn: async ({ queryKey }) => {
        const res = await fetch(queryKey[0] as string, {
          credentials: "include",
        });

        if (!res.ok) {
          if (res.status >= 500) {
            throw new Error(`${res.status}: ${res.statusText}`);
          }

          throw new Error(`${res.status}: ${await res.text()}`);
        }

        return res.json();
      },
      refetchInterval: false,
      refetchOnWindowFocus: false,
      staleTime: Infinity,
      retry: false,
    },
    mutations: {
      retry: false,
    }
  },
});
</file>

<file path="client/src/lib/utils.ts">
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}
</file>

<file path="client/src/pages/Home.tsx">
'use client'

import { useLayoutEffect, useRef, FC } from "react";
import { Link } from "wouter";
import { Button } from "@/components/ui/button";
import { useUser } from "../hooks/use-user";
import gsap from "gsap";
import { ScrollTrigger } from "gsap/ScrollTrigger";

gsap.registerPlugin(ScrollTrigger);

interface User {
  quizCompleted: boolean;
}

interface UseUserHook {
  user: User | null;
}

const Home: FC = () => {
  const { user } = useUser() as UseUserHook;
  const heroRef = useRef<HTMLElement | null>(null);
  const imageGridRef = useRef<HTMLElement | null>(null);
  const ctaRef = useRef<HTMLElement | null>(null);

  useLayoutEffect(() => {
    const heroElement = heroRef.current;
    const imageGridElement = imageGridRef.current;
    const ctaElement = ctaRef.current;

    const ctx = gsap.context(() => {
      gsap.fromTo(
        heroElement,
        { opacity: 0, y: 50 },
        { opacity: 1, y: 0, duration: 1, ease: "power3.out" }
      );

      if (imageGridElement) {
        gsap.fromTo(
          imageGridElement.children,
          { opacity: 0, scale: 0.8 },
          {
            opacity: 1,
            scale: 1,
            duration: 0.8,
            stagger: 0.2,
            ease: "back.out(1.7)",
            scrollTrigger: {
              trigger: imageGridElement,
              start: "top bottom-=100",
            },
          }
        );
      }

      gsap.fromTo(
        ctaElement,
        { opacity: 0, y: 30 },
        {
          opacity: 1,
          y: 0,
          duration: 0.8,
          scrollTrigger: {
            trigger: ctaElement,
            start: "top bottom-=50",
          },
        }
      );
    });

    return () => ctx.revert(); // This will clean up the GSAP animations on unmount
  }, []);

  return (
    <main className="flex flex-col items-center text-center max-w-6xl mx-auto px-4 py-12">
      <section ref={heroRef} className="mb-16 relative overflow-hidden rounded-lg p-5 m-5">
        <h1 className="text-5xl md:text-7xl font-extrabold mb-6 bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent animate-gradient relative z-10">
          Welcome to VybeChex
        </h1>
        <p className="text-xl md:text-2xl text-muted-foreground max-w-3xl mx-auto relative z-10">
          Discover meaningful connections through our AI-powered matching system.
        </p>
        <div className="absolute inset-0 bg-gradient-to-r from-primary/10 to-secondary/10 filter blur-3xl transform scale-110 z-0" aria-hidden="true"></div>
      </section>

      <section
        ref={imageGridRef}
        className="grid grid-cols-1 md:grid-cols-3 gap-8 mb-16"
        aria-label="Feature highlights"
      >
        {[
          { src: "https://images.unsplash.com/photo-1511632765486-a01980e01a18", alt: "Friends enjoying time together", text: "Create Memories" },
          { src: "https://images.unsplash.com/photo-1529156069898-49953e39b3ac", alt: "Group of diverse friends", text: "Escape From Loneliness" },
          { src: "https://images.unsplash.com/photo-1506869640319-fe1a24fd76dc", alt: "Friends hanging out", text: "Build Connections" },
        ].map((item, index) => (
          <div key={index} className="relative overflow-hidden rounded-lg shadow-lg group">
            <img
              src={item.src}
              alt={item.alt}
              className="w-full h-64 object-cover transition-transform duration-300 group-hover:scale-110"
            />
            <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
              <p className="absolute bottom-4 left-4 text-white text-lg font-semibold">
                {item.text}
              </p>
            </div>
          </div>
        ))}
      </section>

      <section ref={ctaRef} className="mb-16 relative">
        <div className="prose prose-lg max-w-3xl mb-8 relative z-10">
          <p className="text-xl leading-relaxed">
            Embark on a journey of self-discovery and meaningful connections.
            Our AI-powered personality quiz matches you with like-minded
            individuals, opening doors to lasting friendships.
          </p>
        </div>

        <div className="flex flex-col sm:flex-row gap-4 justify-center relative z-10">
          <Button
            size="lg"
            className="bg-gradient-to-r from-primary to-secondary hover:from-primary/80 hover:to-secondary/80 text-white font-semibold py-3 px-6 rounded-full transition-all duration-300 transform hover:scale-105 hover:shadow-lg"
            asChild
          >
            <Link href="/quiz">
              {user?.quizCompleted ? "Retake Quiz" : "Take the Personality Quiz"}
            </Link>
          </Button>
          {user?.quizCompleted && (
            <Button
              size="lg"
              variant="outline"
              className="bg-background text-foreground border-2 border-primary hover:bg-primary/10 font-semibold py-3 px-6 rounded-full transition-all duration-300 transform hover:scale-105 hover:shadow-lg"
              asChild
            >
              <Link href="/matches">Find Matches</Link>
            </Button>
          )}
        </div>
        <div className="absolute inset-0 bg-gradient-to-b from-transparent to-background/50 filter blur-2xl transform scale-110 z-0" aria-hidden="true"></div>
      </section>
    </main>
  );
}

export default Home;
</file>

<file path="client/src/index.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  * {
    @apply border-border;
  }

  body {
    @apply font-sans antialiased bg-background text-foreground;
  }
}
</file>

<file path="client/index.html">
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
</file>

<file path="db/migrations/0001_add_avatar_column.sql">
-- Add avatar column to users table
ALTER TABLE users ADD COLUMN IF NOT EXISTS avatar text;

-- Set default avatar for existing users
UPDATE users SET avatar = '/default-avatar.png' WHERE avatar IS NULL;
</file>

<file path="db/migrations/achievements.sql">
-- Migration: create_achievements
-- Up
BEGIN;

-- Clear existing data
TRUNCATE TABLE user_achievements CASCADE;
TRUNCATE TABLE achievements CASCADE;

-- Reset sequence
ALTER SEQUENCE achievements_id_seq RESTART WITH 1;

-- Insert Profile Achievements
INSERT INTO achievements (name, description, category, points, icon, criteria)
VALUES
  ('Welcome Aboard!', 'Create your account and join the community', 'profile', 100, '', 
   '{"type": "profile", "condition": "registration"}'::jsonb),
  ('Identity Established', 'Complete your profile with all information', 'profile', 200, '',
   '{"type": "profile", "condition": "profileComplete"}'::jsonb),
  ('Face in the Crowd', 'Upload your first profile picture', 'profile', 150, '',
   '{"type": "profile", "condition": "avatarUploaded"}'::jsonb),
  ('Wordsmith', 'Write a bio that truly captures who you are', 'profile', 100, '',
   '{"type": "profile", "condition": "bioAdded"}'::jsonb),
  ('Passion Finder', 'Add at least 5 interests to your profile', 'profile', 150, '',
   '{"type": "profile", "condition": "interestsAdded", "threshold": 5}'::jsonb),

  -- Streak Achievements
  ('First Steps', 'Log in for the first time', 'streak', 50, '',
   '{"type": "login", "condition": "first_login"}'::jsonb),
  ('Regular Visitor', 'Log in 3 days in a row', 'streak', 150, '',
   '{"type": "streak", "condition": "daily", "threshold": 3}'::jsonb),
  ('Week Warrior', 'Log in 7 days in a row', 'streak', 300, '',
   '{"type": "streak", "condition": "daily", "threshold": 7}'::jsonb),
  ('Monthly Master', 'Log in 30 days in a row', 'streak', 1000, '',
   '{"type": "streak", "condition": "daily", "threshold": 30}'::jsonb),
  ('Centurion', 'Maintain a 100-day login streak', 'streak', 5000, '',
   '{"type": "streak", "condition": "daily", "threshold": 100}'::jsonb),
  ('Weekend Warrior', 'Log in every weekend for a month', 'streak', 500, '',
   '{"type": "streak", "condition": "weekly_weekend", "threshold": 4}'::jsonb),

  -- Engagement Achievements
  ('Triple Dipper', 'Visit 3 times in one day', 'engagement', 100, '',
   '{"type": "count", "condition": "login", "threshold": 3, "timeframe": "daily"}'::jsonb),
  ('High Five', 'Visit 5 times in one day', 'engagement', 200, '',
   '{"type": "count", "condition": "login", "threshold": 5, "timeframe": "daily"}'::jsonb),
  ('Weekly Wonder', 'Visit 20 times in one week', 'engagement', 400, '',
   '{"type": "count", "condition": "login", "threshold": 20, "timeframe": "weekly"}'::jsonb),
  ('Time Well Spent', 'Spend 5 hours actively using the app', 'engagement', 300, '',
   '{"type": "count", "condition": "active_time", "threshold": 5, "timeframe": "all_time"}'::jsonb),
  ('Night Owl', 'Log in after midnight 5 times', 'engagement', 250, '',
   '{"type": "count", "condition": "night_login", "threshold": 5, "timeframe": "all_time"}'::jsonb),
  ('Early Bird', 'Log in before 7 AM 5 times', 'engagement', 250, '',
   '{"type": "count", "condition": "morning_login", "threshold": 5, "timeframe": "all_time"}'::jsonb),

  -- Milestone Achievements
  ('Century Club', 'Visit the app 100 times total', 'milestone', 500, '',
   '{"type": "milestone", "condition": "login", "threshold": 100}'::jsonb),
  ('Dedicated Fan', 'Visit the app 500 times total', 'milestone', 1500, '',
   '{"type": "milestone", "condition": "login", "threshold": 500}'::jsonb),
  ('True Devotee', 'Visit the app 1,000 times total', 'milestone', 3000, '',
   '{"type": "milestone", "condition": "login", "threshold": 1000}'::jsonb),
  ('Rising Star', 'Reach level 5', 'milestone', 500, '',
   '{"type": "milestone", "condition": "level", "threshold": 5}'::jsonb),
  ('Power Player', 'Reach level 10', 'milestone', 1000, '',
   '{"type": "milestone", "condition": "level", "threshold": 10}'::jsonb),
  ('Elite Status', 'Reach level 20', 'milestone', 2000, '',
   '{"type": "milestone", "condition": "level", "threshold": 20}'::jsonb),

  -- Social Achievements
  ('Ice Breaker', 'Send your first message', 'social', 100, '',
   '{"type": "milestone", "condition": "first_message"}'::jsonb),
  ('Chatty Cathy', 'Send 100 messages', 'social', 300, '',
   '{"type": "milestone", "condition": "messages", "threshold": 100}'::jsonb),
  ('Message Master', 'Send 1,000 messages', 'social', 1000, '',
   '{"type": "milestone", "condition": "messages", "threshold": 1000}'::jsonb),
  ('Perfect Match', 'Get your first connection match', 'social', 200, '',
   '{"type": "milestone", "condition": "first_match"}'::jsonb),
  ('Social Butterfly', 'Connect with 5 different people', 'social', 500, '',
   '{"type": "milestone", "condition": "matches", "threshold": 5}'::jsonb),
  ('Networking Pro', 'Connect with 20 different people', 'social', 1000, '',
   '{"type": "milestone", "condition": "matches", "threshold": 20}'::jsonb),
  ('Conversation Starter', 'Start 10 conversations in one day', 'social', 300, '',
   '{"type": "count", "condition": "conversations_started", "threshold": 10, "timeframe": "daily"}'::jsonb),
  ('Quick Draw', 'Respond to 5 messages within 5 minutes', 'social', 250, '',
   '{"type": "count", "condition": "quick_responses", "threshold": 5, "timeframe": "all_time"}'::jsonb),
  ('Marathon Runner', 'Maintain a conversation for over an hour', 'social', 400, '',
   '{"type": "milestone", "condition": "long_conversation", "threshold": 60}'::jsonb);

COMMIT;

-- Down
BEGIN;
TRUNCATE TABLE user_achievements CASCADE;
TRUNCATE TABLE achievements CASCADE;
COMMIT;
</file>

<file path="db/index.ts">
import { drizzle } from "drizzle-orm/node-postgres";
import pg from "pg";
import * as schema from "@db/schema";

const { Pool } = pg;

// Validate environment variables early
if (!process.env.DATABASE_URL?.trim()) {
  throw new Error(
    "DATABASE_URL environment variable is missing or empty. Ensure the database is properly provisioned.",
  );
}

// Configure pool settings
const poolConfig = {
  connectionString: process.env.DATABASE_URL,
  max: 10,
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 5000,
};

// Initialize pool with singleton pattern
let poolInstance: Pool | null = null;

// Initialize database connection with retries and exponential backoff
async function createPool(retries = 3, backoffMs = 1000): Promise<Pool> {
  if (poolInstance) {
    return poolInstance;
  }

  let lastError = null;
  
  for (let i = 0; i < retries; i++) {
    try {
      const pool = new Pool(poolConfig);
      
      // Test the connection with a simple query
      const client = await pool.connect();
      await client.query('SELECT 1');
      client.release();
      
      console.log(`Successfully connected to database after ${i + 1} attempt(s)`);
      
      // Set up event handlers
      pool.on('error', (err) => {
        console.error('Unexpected database pool error:', err);
      });

      poolInstance = pool;
      return pool;
    } catch (error) {
      lastError = error;
      console.error(`Database connection attempt ${i + 1} failed:`, error);
      
      if (i < retries - 1) {
        const delay = backoffMs * Math.pow(2, i);
        console.log(`Retrying in ${delay}ms...`);
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
  }

  throw new Error(`Failed to connect to database after ${retries} attempts. Last error: ${lastError}`);
}

// Create and initialize the pool
const pool = new Pool(poolConfig);

// Export the database instance
export const db = drizzle(pool, { schema });

// Health check function
export async function checkDatabaseHealth() {
  let client;
  try {
    client = await pool.connect();
    
    const result = await client.query(`
      SELECT 
        current_timestamp as now,
        current_database() as database,
        version() as version
    `);

    const row = result.rows[0];
    
    return {
      ok: true,
      timestamp: row.now,
      database: row.database,
      version: row.version
    };
  } catch (error) {
    console.error('Database health check failed:', error);
    return {
      ok: false,
      error: error instanceof Error ? error.message : 'Unknown database error',
      timestamp: new Date().toISOString()
    };
  } finally {
    if (client) {
      client.release();
    }
  }
}

// Graceful shutdown handler
export async function closeDatabaseConnection() {
  try {
    if (poolInstance) {
      await poolInstance.end();
      poolInstance = null;
      console.log('Database pool has been closed');
    }
  } catch (error) {
    console.error('Error closing database pool:', error);
    throw error;
  }
}

// Export the initialization function for explicit initialization when needed
export const initializeDatabase = createPool;
</file>

<file path="db/migrate.ts">
import { drizzle } from 'drizzle-orm/postgres-js';
import { migrate } from 'drizzle-orm/postgres-js/migrator';
import postgres from 'postgres';
import * as dotenv from 'dotenv';
import path from 'path';

// Load environment variables
dotenv.config();

const runMigration = async () => {
  const connectionString = process.env.DATABASE_URL;
  if (!connectionString) {
    throw new Error('DATABASE_URL environment variable is not set');
  }

  // Create the database connection
  const sql = postgres(connectionString, { 
    max: 10, // Increase connection pool size
    idle_timeout: 20, // Close idle connections after 20 seconds
    connect_timeout: 10, // Connection timeout after 10 seconds
  });
  const db = drizzle(sql);

  try {
    // Run migrations
    console.log('Running migrations...');
    await migrate(db, {
      migrationsFolder: path.join(__dirname, 'migrations'),
    });
    console.log('Migrations completed successfully');
  } catch (err) {
    console.error('Migration failed:', err);
    throw err;
  } finally {
    // Close the connection
    await sql.end();
  }
};

runMigration().catch((err) => {
  console.error('Migration failed:', err);
  process.exit(1);
});
</file>

<file path=".gitignore">
node_modules
dist
.DS_Store
server/public
vite.config.ts.*
*.tar.gz
</file>

<file path="drizzle.config.ts">
import { defineConfig } from "drizzle-kit";

if (!process.env.DATABASE_URL) {
  throw new Error("DATABASE_URL, ensure the database is provisioned");
}

export default defineConfig({
  out: "./migrations",
  schema: "./db/schema.ts",
  dialect: "postgresql",
  dbCredentials: {
    url: process.env.DATABASE_URL,
  },
});
</file>

<file path="Pasted--vite-connecting-vite-connected-User-not-authenticated-Login-successful-Object-message-1734526486400.txt">
[vite] connecting...
[vite] connected.
User not authenticated
Login successful: 
Object {message: "Login successful", user: {}}
User data fetched: 
Object {id: 1, username: "jmartens10@gmail.com", password: "f97f581dcb23d3cd9b98c1f24b2ed95fe4cad17a5e982f3fa234bb184e857e90d0222f28c9d34fd41ceae7471c8ca9f1a26", name: null, bio: null, }
Matches response: 
(4) [{}, {}, {}, {}]
Invalid user ID format 
Object {success: false, message: "Invalid user ID format"}

Match request error: 
Error {}

Failed to Load Match Requests: 
Error {}

Invalid user ID format 
Object {success: false, message: "Invalid user ID format"}

Match request error: 
Error {}

Failed to Load Match Requests: 
Error {}

Invalid user ID format 
Object {success: false, message: "Invalid user ID format"}

Match request error: 
Error {}
message: "Invalid user ID format"
stack: "Error: Invalid user ID format at queryFn (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/src/hooks/use-matches.ts:66:19)"
get stack:  ()
set stack:  ()
[[Prototype]]: Object

Failed to Load Match Requests: 
Error {}

Invalid user ID format 
Object {success: false, message: "Invalid user ID format"}

Match request error: 
Error {}
message: "Invalid user ID format"
stack: "Error: Invalid user ID format at queryFn (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/src/hooks/use-matches.ts:66:19)"
get stack:  ()
set stack:  ()
[[Prototype]]: Object

Failed to Load Match Requests: 
Error {}
message: "Invalid user ID format"
stack: "Error: Invalid user ID format at queryFn (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/src/hooks/use-matches.ts:66:19)"
get stack:  ()
set stack:  ()
[[Prototype]]: Object

Invalid user ID format 
Object {success: false, message: "Invalid user ID format"}
message: "Invalid user ID format"
success: false
[[Prototype]]: Object

Match request error: 
Error {}
message: "Invalid user ID format"
stack: "Error: Invalid user ID format at queryFn (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/src/hooks/use-matches.ts:66:19)"
get stack:  ()
set stack:  ()
[[Prototype]]: Object
</file>

<file path="Pasted--vite-connecting-vite-connected-Warning-validateDOMNesting-a-cannot-appear-as-a-de-1734309041676.txt">
[vite] connecting...
[vite] connected.
Warning: validateDOMNesting(...): <a> cannot appear as a descendant of &lt;a&gt;.
    at a
    at a
    at https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/@fs/home/runner/workspace/node_modules/.vite/deps/wouter.js?v=ff87ac33:337:18
    at div
    at div
    at div
    at nav
    at Navigation (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/src/components/Navigation.tsx:24:22)
    at div
    at App (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/src/App.tsx:29:31)
    at QueryClientProvider (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/@fs/home/runner/workspace/node_modules/.vite/deps/@tanstack_react-query.js?v=ff87ac33:2805:3)
at a
at a
at https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/@fs/home/runner/workspace/node_modules/.vite/deps/wouter.js?v=ff87ac33:337:18
at div
at div
at div
at nav
at Navigation (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/src/components/Navigation.tsx:24:22)
at div
at App (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/src/App.tsx:29:31)
at QueryClientProvider (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/@fs/home/runner/workspace/node_modules/.vite/deps/@tanstack_react-query.js?v=ff87ac33:2805:3)
at t.value (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:17465)
at new t (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:12630)
at t.value (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:32766)
at https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:34400
</file>

<file path="Pasted-Based-on-the-error-message-and-code-provided-the-issue-appears-to-be-related-to-an-invalid-user-ID--1734549888789.txt">
Based on the error message and code provided, the issue appears to be related to an invalid user ID format when handling match requests. Let's analyze and fix this:

## The Issue
The error `Invalid user ID format` occurs when the API endpoint receives an incorrectly formatted user ID[1]. This typically happens when:
- The ID is not in the expected format (e.g., string instead of number)
- The ID is missing or undefined
- The ID contains invalid characters

## Solution

**1. Check ID Type Handling**
```typescript
// In your useMatches hook, modify the respondToMatch function:
const respondToMatch = async ({ matchId, status }: { 
  matchId: number; 
  status: 'accepted' | 'rejected' 
}) => {
  if (!matchId || typeof matchId !== 'number') {
    throw new Error('Invalid match ID format');
  }

  try {
    const response = await fetch(`/api/matches/${matchId}/respond`, {
      method: 'POST',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${getAuthToken()}`
      },
      body: JSON.stringify({ status })
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.message || 'Failed to respond to match request');
    }
    
    return response.json();
  } catch (error) {
    console.error('Match response error:', error);
    throw error;
  }
}
```

**2. Update MatchRequests Component**
```typescript
// In your MatchRequests component, ensure proper type conversion:
<Button
  variant="default"
  disabled={isResponding}
  onClick={() => onRespond(Number(request.id), 'accepted')}
>
  Accept
</Button>
```

**3. Type Validation**
Add proper type validation for the Match interface:

```typescript
interface Match {
  id: number;
  requester?: {
    id: number;
    username: string;
    name: string;
    avatar: string;
    personalityTraits: Record<string, number>;
    createdAt: string;
  };
  status: 'requested' | 'accepted' | 'rejected';
  createdAt: string;
  score?: number;
  compatibilityScore?: number;
}
```

Make sure that when handling the match request, you're passing the correct ID format as expected by your API. The error suggests that the API is expecting a specific format for the user ID, so ensure that the ID is properly formatted before making the request[6].

Also, verify that your authentication token is valid and properly included in the request headers, as this can sometimes cause similar errors[8].

Citations:
[1] https://ppl-ai-file-upload.s3.amazonaws.com/web/direct-files/1865482/a4c4574b-8273-4a18-a1ef-c6874a7e45e6/paste.txt
[2] https://learn.microsoft.com/en-us/microsoft-365/troubleshoot/active-directory/this-doesnt-look-like-valid-user-id-error
[3] https://www.dropboxforum.com/discussions/101000014/usersget-current-account-invalid-select-user-id-format-error-/627564
[4] https://ux.stackexchange.com/questions/58302/error-message-for-invalid-username
[5] https://www.reddit.com/r/GenshinImpactTips/comments/qypllx/invalid_account_format/
[6] https://apidog.com/blog/invalid-api-response/
[7] https://success.clarizen.com/hc/en-us/community/posts/115001091748-Invalid-username-when-logging-in-via-the-REST-API
[8] https://helpx.adobe.com/sign/kb/Getting-an-error-while-sending-agreement-from-Salesforce.html
</file>

<file path="Pasted-Based-on-the-error-message-and-code-provided-the-issue-appears-to-be-related-to-an-invalid-user-ID--1734552032945.txt">
Based on the error message and code provided, the issue appears to be related to an invalid user ID format when handling match requests. Let's analyze and fix this:

## The Issue
The error `Invalid user ID format` occurs when the API endpoint receives an incorrectly formatted user ID[1]. This typically happens when:
- The ID is not in the expected format (e.g., string instead of number)
- The ID is missing or undefined
- The ID contains invalid characters

## Solution

**1. Check ID Type Handling**
```typescript
// In your useMatches hook, modify the respondToMatch function:
const respondToMatch = async ({ matchId, status }: { 
  matchId: number; 
  status: 'accepted' | 'rejected' 
}) => {
  if (!matchId || typeof matchId !== 'number') {
    throw new Error('Invalid match ID format');
  }

  try {
    const response = await fetch(`/api/matches/${matchId}/respond`, {
      method: 'POST',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${getAuthToken()}`
      },
      body: JSON.stringify({ status })
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.message || 'Failed to respond to match request');
    }
    
    return response.json();
  } catch (error) {
    console.error('Match response error:', error);
    throw error;
  }
}
```

**2. Update MatchRequests Component**
```typescript
// In your MatchRequests component, ensure proper type conversion:
<Button
  variant="default"
  disabled={isResponding}
  onClick={() => onRespond(Number(request.id), 'accepted')}
>
  Accept
</Button>
```

**3. Type Validation**
Add proper type validation for the Match interface:

```typescript
interface Match {
  id: number;
  requester?: {
    id: number;
    username: string;
    name: string;
    avatar: string;
    personalityTraits: Record<string, number>;
    createdAt: string;
  };
  status: 'requested' | 'accepted' | 'rejected';
  createdAt: string;
  score?: number;
  compatibilityScore?: number;
}
```

Make sure that when handling the match request, you're passing the correct ID format as expected by your API. The error suggests that the API is expecting a specific format for the user ID, so ensure that the ID is properly formatted before making the request[6].

Also, verify that your authentication token is valid and properly included in the request headers, as this can sometimes cause similar errors[8].

Citations:
[1] https://ppl-ai-file-upload.s3.amazonaws.com/web/direct-files/1865482/a4c4574b-8273-4a18-a1ef-c6874a7e45e6/paste.txt
[2] https://learn.microsoft.com/en-us/microsoft-365/troubleshoot/active-directory/this-doesnt-look-like-valid-user-id-error
[3] https://www.dropboxforum.com/discussions/101000014/usersget-current-account-invalid-select-user-id-format-error-/627564
[4] https://ux.stackexchange.com/questions/58302/error-message-for-invalid-username
[5] https://www.reddit.com/r/GenshinImpactTips/comments/qypllx/invalid_account_format/
[6] https://apidog.com/blog/invalid-api-response/
[7] https://success.clarizen.com/hc/en-us/community/posts/115001091748-Invalid-username-when-logging-in-via-the-REST-API
[8] https://helpx.adobe.com/sign/kb/Getting-an-error-while-sending-agreement-from-Salesforce.html
</file>

<file path="Pasted-Login-successful-message-Login-successful-user-message-Login-successful-user--1734524971073.txt">
Login successful: 
{message: 'Login successful', user: {}}
message
: 
"Login successful"
user
: 
avatar
: 
"/default-avatar.png"
id
: 
1
isGroupCreator
: 
true
name
: 
null
quizCompleted
: 
true
username
: 
"jmartens10@gmail.com"
[[Prototype]]
: 
Object
[[Prototype]]
: 
Object
use-user.ts:74 User data fetched: 
{id: 1, username: 'jmartens10@gmail.com', password: 'f97f581dcb23d3cd9b98c1f24b2ed95fe4cad17a5e982f3fa23c044b6cc8d11b64.28f0dffd3234bd76bec9172ef8e6181c', name: null, bio: null, }
avatar
: 
"/default-avatar.png"
bio
: 
null
createdAt
: 
"2024-12-16T00:19:54.704Z"
id
: 
1
isGroupCreator
: 
true
name
: 
null
password
: 
"f97f581dcb23d3cd9b98c1f24b2ed95fe4cad17a5e982f3fa234bb184e857e90d0222f28c9d34fd41ceae7471c8ca9f1a26f432200c1b55b3c044b6cc8d11b64.28f0dffd3234bd76bec9172ef8e6181c"
personalityTraits
: 
{values: 0.3333333333333333, openness: 0.3333333333333333, planning: 0, sociability: 0.6666666666666666, extraversion: 1, }
quizCompleted
: 
true
username
: 
"jmartens10@gmail.com"
[[Prototype]]
: 
Object
use-matches.ts:139 
 
 GET http://localhost:5000/api/matches/requests 400 (Bad Request)
queryFn	@	use-matches.ts:139
use-matches.ts:154 
 Invalid user ID format 
{success: false, message: 'Invalid user ID format'}
message
: 
"Invalid user ID format"
success
: 
false
[[Prototype]]
: 
Object
queryFn	@	use-matches.ts:154
use-matches.ts:197 
 Match request error: Error: Invalid user ID format
    at queryFn (use-matches.ts:155:19)
queryFn	@	use-matches.ts:197
use-matches.ts:94 
 Failed to Load Match Requests: Error: Invalid user ID format
    at queryFn (use-matches.ts:155:19)
handleApiError	@	use-matches.ts:94
queryFn	@	use-matches.ts:198
use-matches.ts:118 Matches response: 
(4) [{}, {}, {}, {}]
0
: 
avatar
: 
"/default-avatar.png"
compatibilityScore
: 
78
createdAt
: 
"2024-12-17T13:40:22.279Z"
id
: 
5
interests
: 
[]
name
: 
"jordan.martens@osscontact.com"
personalityTraits
: 
{values: 0.3333333333333333, openness: 0, planning: 0.3333333333333333, sociability: 1, extraversion: 1, }
status
: 
"accepted"
username
: 
"jordan.martens@osscontact.com"
[[Prototype]]
: 
Object
1
: 
{id: 2, username: 'test_user1', name: 'Alex Johnson', personalityTraits: {}, avatar: '/default-avatar.png', }
2
: 
{id: 4, username: 'test_user3', name: 'Jordan Lee', personalityTraits: {}, avatar: '/default-avatar.png', }
3
: 
{id: 3, username: 'test_user2', name: 'Sam Wilson', personalityTraits: {}, avatar: '/default-avatar.png', }
length
: 
4
[[Prototype]]
: 
Array(0)
</file>

<file path="postcss.config.js">
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
</file>

<file path="replit.nix">
{pkgs}: {
  deps = [
    pkgs.postgresql
  ];
}
</file>

<file path="tailwind.config.ts">
import type { Config } from "tailwindcss";

export default {
  darkMode: ["class"],
  content: ["./client/index.html", "./client/src/**/*.{js,jsx,ts,tsx}"],
  theme: {
    extend: {
      borderRadius: {
        lg: "var(--radius)",
        md: "calc(var(--radius) - 2px)",
        sm: "calc(var(--radius) - 4px)",
      },
      colors: {
        background: "hsl(var(--background))",
        foreground: "hsl(var(--foreground))",
        card: {
          DEFAULT: "hsl(var(--card))",
          foreground: "hsl(var(--card-foreground))",
        },
        popover: {
          DEFAULT: "hsl(var(--popover))",
          foreground: "hsl(var(--popover-foreground))",
        },
        primary: {
          DEFAULT: "hsl(var(--primary))",
          foreground: "hsl(var(--primary-foreground))",
        },
        secondary: {
          DEFAULT: "hsl(var(--secondary))",
          foreground: "hsl(var(--secondary-foreground))",
        },
        muted: {
          DEFAULT: "hsl(var(--muted))",
          foreground: "hsl(var(--muted-foreground))",
        },
        accent: {
          DEFAULT: "hsl(var(--accent))",
          foreground: "hsl(var(--accent-foreground))",
        },
        destructive: {
          DEFAULT: "hsl(var(--destructive))",
          foreground: "hsl(var(--destructive-foreground))",
        },
        border: "hsl(var(--border))",
        input: "hsl(var(--input))",
        ring: "hsl(var(--ring))",
        chart: {
          "1": "hsl(var(--chart-1))",
          "2": "hsl(var(--chart-2))",
          "3": "hsl(var(--chart-3))",
          "4": "hsl(var(--chart-4))",
          "5": "hsl(var(--chart-5))",
        },
        sidebar: {
          DEFAULT: "hsl(var(--sidebar-background))",
          foreground: "hsl(var(--sidebar-foreground))",
          primary: "hsl(var(--sidebar-primary))",
          "primary-foreground": "hsl(var(--sidebar-primary-foreground))",
          accent: "hsl(var(--sidebar-accent))",
          "accent-foreground": "hsl(var(--sidebar-accent-foreground))",
          border: "hsl(var(--sidebar-border))",
          ring: "hsl(var(--sidebar-ring))",
        },
      },
      keyframes: {
        "accordion-down": {
          from: {
            height: "0",
          },
          to: {
            height: "var(--radix-accordion-content-height)",
          },
        },
        "accordion-up": {
          from: {
            height: "var(--radix-accordion-content-height)",
          },
          to: {
            height: "0",
          },
        },
      },
      animation: {
        "accordion-down": "accordion-down 0.2s ease-out",
        "accordion-up": "accordion-up 0.2s ease-out",
      },
    },
  },
  plugins: [require("tailwindcss-animate"), require("@tailwindcss/typography")],
} satisfies Config;
</file>

<file path="theme.json">
{
  "variant": "vibrant",
  "primary": "hsl(22, 85%, 57%)",
  "appearance": "light",
  "radius": 0.75
}
</file>

<file path="tsconfig.json">
{
  "include": ["client/src/**/*", "db/**/*", "server/**/*"],
  "exclude": ["node_modules", "build", "dist", "**/*.test.ts"],
  "compilerOptions": {
    "incremental": true,
    "tsBuildInfoFile": "./node_modules/typescript/tsbuildinfo",
    "noEmit": true,
    "module": "ESNext",
    "strict": true,
    "lib": ["esnext", "dom", "dom.iterable"],
    "jsx": "preserve",
    "esModuleInterop": true,
    "skipLibCheck": true,
    "allowImportingTsExtensions": true,
    "moduleResolution": "bundler",
    "baseUrl": ".",
    "types": ["node", "vite/client"],
    "paths": {
      "@db": ["./db/index.ts"],
      "@db/*": ["./db/*"],
      "@/*": ["./client/src/*"]
    }
  }
}
</file>

<file path="vite.config.ts">
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";
import themePlugin from "@replit/vite-plugin-shadcn-theme-json";
import path, { dirname } from "path";
import runtimeErrorOverlay from "@replit/vite-plugin-runtime-error-modal";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
export default defineConfig({
  plugins: [react(), runtimeErrorOverlay(), themePlugin()],
  resolve: {
    alias: {
      "@db": path.resolve(__dirname, "db"),
      "@": path.resolve(__dirname, "client", "src"),
    },
  },
  root: path.resolve(__dirname, "client"),
  build: {
    outDir: path.resolve(__dirname, "dist/public"),
    emptyOutDir: true,
  },
});
</file>

<file path="attached_assets/Pasted--vite-connecting-vite-connected-Fetching-user-data-User-not-authenticated-Auth-respons-1735233080711.txt">
[vite] connecting...
[vite] connected.
Fetching user data...
User not authenticated
Auth response: 
Object {error: "stripe is not defined", stack: "ReferenceError: stripe is not defined    at <anonymous>"}
error: "stripe is not defined"
stack: "ReferenceError: stripe is not defined at <anonymous> (/home/runner/workspace/server/auth.ts:287:24)"
[[Prototype]]: Object
Auth request failed (500): stripe is not defined
at t.value (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:17465)
at new t (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:12630)
at t.value (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:32766)
at https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:34400
Auth request error: 
Error {}

at t.value (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:17465)
at new t (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:12630)
at t.value (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:32766)
at https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:34400
Registration error: 
Error {}
message: "stripe is not defined"
stack: "Error: stripe is not defined at handleAuthRequest (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/src/hooks/use-user.ts:24:13) at async Object.mutationFn (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/src/hooks/use-user.ts:135:24)"
get stack:  ()
set stack:  ()
[[Prototype]]: Object
</file>

<file path="attached_assets/Pasted--vite-connecting-vite-connected-Fetching-user-data-User-not-authenticated-vite-hot-u-1736264164732.txt">
[vite] connecting...
[vite] connected.
Fetching user data...
User not authenticated
[vite] hot updated: /src/pages/Profile.tsx
[vite] hot updated: /src/styles/globals.css
Fetching user data...
[vite] hot updated: /src/App.tsx
[vite] hot updated: /src/styles/globals.css
[vite] hot updated: /src/components/Navigation.tsx
[vite] hot updated: /src/pages/Home.tsx
[vite] hot updated: /src/pages/AuthPage.tsx
[vite] hot updated: /src/pages/Profile.tsx
[vite] hot updated: /src/pages/Matches.tsx
[vite] hot updated: /src/pages/Chat.tsx
[vite] hot updated: /src/components/NetworkGraph.tsx
[vite] hot updated: /src/components/CreateMatchWizard.tsx
User not authenticated
Auth response: 
Object {success: true, message: "Login successful", user: {}}
Login successful: 
Object {success: true, message: "Login successful", user: {}}
Fetching user data...
Login successful: 
Object {ok: true, user: {}}
ok: true
user: Object
id: 5
username: "jordan.martens@osscontact.com"
[[Prototype]]: Object
[[Prototype]]: Object
User data fetched: 
Object {success: true, user: {}}
success: true
user: Object
avatar: "https://replit-objstore-42ba1808-b6bc-4955-a490-87bc85fa3955.replit.dev/avatars/5-0d818197-6b8f-42cb-9be3-ac7b64850e8d.jpeg"
bio: "AI dev"
createdAt: "2025-01-06T00:02:05.326Z"
id: 5
isGroupCreator: false
lastRewardClaimed: null
level: 1
name: "Jordan Martens"
password: "478c40b48c167e7cf07460b6811b7b125052f466565a28503fdc45fdbf6005a99adb81033486eb618e73035b2de703196561fe38346d0ae2b7e89d59456ddf6f.b475c905fb8179a4916f4d0bc19885e2"
personalityTraits: Object
quizCompleted: true
username: "jordan.martens@osscontact.com"
xp: 0
[[Prototype]]: Object
[[Prototype]]: Object
Failed to load avatar: https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/api/storage/avatars/https://replit-objstore-42ba1808-b6bc-4955-a490-87bc85fa3955.replit.dev/avatars/5-0d818197-6b8f-42cb-9be3-ac7b64850e8d.jpeg
at t.value (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:17465)
at new t (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:12630)
at t.value (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:32766)
at https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:34400
</file>

<file path="client/src/components/ChatWindow.module.css">
.chatWindow {
    display: flex;
    flex-direction: column;
    height: 600px;
    background: var(--chat-bg);
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
  }
  
  .chatWindow.light {
    --chat-bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    --header-bg: rgba(255, 255, 255, 0.8);
    --input-bg: rgba(255, 255, 255, 0.9);
    --text-color: #333;
    --muted-color: #666;
  }
  
  .chatWindow.dark {
    --chat-bg: linear-gradient(135deg, #2c3e50 0%, #1a1a2e 100%);
    --header-bg: rgba(0, 0, 0, 0.4);
    --input-bg: rgba(0, 0, 0, 0.3);
    --text-color: #fff;
    --muted-color: #ccc;
  }
  
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    background: var(--header-bg);
    backdrop-filter: blur(10px);
  }
  
  .title {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--text-color);
  }
  
  .themeToggle {
    background: transparent;
    color: var(--text-color);
  }
  
  .loadingOverlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    z-index: 10;
  }
  
  .loadingSpinner {
    width: 40px;
    height: 40px;
    color: #fff;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .loadingText {
    margin-top: 1rem;
    color: #fff;
  }
  
  .messageArea {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
  }
  
  .messageList {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  
  .inputArea {
    display: flex;
    gap: 0.5rem;
    padding: 1rem;
    background: var(--input-bg);
    backdrop-filter: blur(10px);
  }
  
  .messageInput {
    flex: 1;
    background: transparent;
    border: none;
    color: var(--text-color);
    font-size: 1rem;
  }
  
  .messageInput::placeholder {
    color: var(--muted-color);
  }
  
  .sendButton {
    background: var(--primary-color, #3498db);
    color: #fff;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }
  
  .sendButton:hover {
    transform: scale(1.1);
  }
  
  .sendButton:active {
    transform: scale(0.9);
  }
</file>

<file path="client/src/components/ConnectionStatus.module.css">
.connectionStatus {
    position: absolute;
    top: 8px;
    right: 8px;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
    transition: all 0.3s ease;
  }
  
  .connected {
    background-color: var(--success);
    color: var(--success-foreground);
  }
  
  .disconnected {
    background-color: var(--destructive);
    color: var(--destructive-foreground);
  }
</file>

<file path="client/src/components/ConnectionStatus.tsx">
import { motion } from "framer-motion";
import styles from "./ConnectionStatus.module.css";

interface ConnectionStatusProps {
  isConnected: boolean;
}

export function ConnectionStatus({ isConnected }: ConnectionStatusProps) {
  return (
    <motion.div
      initial={{ opacity: 0, y: -20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.3 }}
      className={`${styles.connectionStatus} ${
        isConnected ? styles.connected : styles.disconnected
      }`}
    >
      {isConnected ? "Connected" : "Disconnected"}
    </motion.div>
  );
}
</file>

<file path="client/src/components/CreateMatchWizard.tsx">
import { useState, useEffect, useMemo } from "react";
import { useQuery } from "@tanstack/react-query";
import { useUser } from "@/hooks/use-user";
import { useMatches, type Match } from "@/hooks/use-matches";
import type { User } from "@db/schema";
import { Button } from "@/components/ui/button";
import {
  Card,
  CardContent,
  CardDescription,
  CardFooter,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Slider } from "@/components/ui/slider";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { useToast } from "@/hooks/use-toast";
import { Progress } from "@/components/ui/progress";
import { ArrowLeft, ArrowRight, Heart } from "lucide-react";
import { Avatar, AvatarImage, AvatarFallback } from "@/components/ui/avatar";
import { Loader2 } from "lucide-react";
import { Alert, AlertTitle, AlertDescription } from "@/components/ui/alert";
import { useLocation } from "wouter";

const interestFields = [
  'extraversion',
  'communication',
  'openness',
  'values',
  'planning',
  'sociability',
] as const;

const wizardSchema = z.object({
  interests: z.object(
    interestFields.reduce(
      (acc, field) => ({ ...acc, [field]: z.number().min(0).max(1) }),
      {} as Record<typeof interestFields[number], z.ZodNumber>
    )
  ),
});

type WizardFormData = z.infer<typeof wizardSchema>;
type InterestField = typeof interestFields[number];

interface CreateMatchWizardProps {
  initialMatchId: string | null;
  onComplete: () => void;
  onCancel: () => void;
}

type PersonalityTraits = {
  extraversion: number;
  communication: number;
  openness: number;
  values: number;
  planning: number;
  sociability: number;
};

export default function CreateMatchWizard({ initialMatchId, onComplete, onCancel }: CreateMatchWizardProps) {
  const [step, setStep] = useState(1);
  const [selectedMatchId, setSelectedMatchId] = useState<number | null>(
    initialMatchId ? parseInt(initialMatchId, 10) : null
  );
  const { user } = useUser();
  const { connect } = useMatches();
  const { toast } = useToast();
  const [, setLocation] = useLocation();
  const totalSteps = 3;

  // Validate initialMatchId when it changes
  useEffect(() => {
    if (initialMatchId) {
      const parsedId = parseInt(initialMatchId, 10);
      if (!isNaN(parsedId) && parsedId > 0) {
        setSelectedMatchId(parsedId);
      } else {
        console.error('Invalid initial match ID:', initialMatchId);
        setSelectedMatchId(null);
      }
    }
  }, [initialMatchId]);

  // Query for all potential matches
  const { data: potentialMatches, isLoading: loadingMatches, error: matchesError } = useQuery({
    queryKey: ['potential-matches'],
    queryFn: async () => {
      console.log('Fetching potential matches...');
      const response = await fetch('/api/matches/potential', {
        credentials: 'include',
        headers: {
          'Accept': 'application/json',
          'Cache-Control': 'no-cache'
        }
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        console.error('Failed to fetch potential matches:', errorData);
        throw new Error(errorData.message || 'Failed to fetch potential matches');
      }

      const data = await response.json();
      console.log('Potential matches response:', data);

      if (!data.success) {
        throw new Error(data.message || 'Failed to fetch potential matches');
      }

      return data.matches || [];
    },
    enabled: step === 2 && !!user?.quizCompleted,
    staleTime: 30000,
    retry: 1,
    gcTime: 0,
    meta: {
      errorMessage: "Failed to load potential matches"
    }
  });

  // Handle potential matches error
  useEffect(() => {
    if (matchesError) {
      console.error('Error fetching potential matches:', matchesError);
      toast({
        title: "Error",
        description: matchesError instanceof Error ? matchesError.message : "Failed to load potential matches",
        variant: "destructive"
      });
    }
  }, [matchesError, toast]);

  // Query for specific match details if editing
  const { data: potentialMatch, error: potentialMatchError } = useQuery({
    queryKey: ['potential-match', initialMatchId],
    queryFn: async () => {
      const response = await fetch(`/api/users/${initialMatchId}`, {
        credentials: 'include',
        headers: {
          'Accept': 'application/json',
          'Cache-Control': 'no-cache'
        }
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.message || 'Failed to fetch potential match');
      }

      const data = await response.json();
      if (!data.success) {
        throw new Error(data.message || 'Failed to fetch potential match');
      }

      return data.user || null;
    },
    enabled: !!initialMatchId && step > 1,
    staleTime: 30000,
    retry: 1,
    gcTime: 0
  });

  // Handle potential match error
  useEffect(() => {
    if (potentialMatchError) {
      console.error('Error fetching potential match:', potentialMatchError);
      toast({
        title: "Error",
        description: potentialMatchError instanceof Error ? potentialMatchError.message : "Failed to load match details",
        variant: "destructive"
      });
    }
  }, [potentialMatchError, toast]);

  // Get the current match being previewed
  const currentMatch = useMemo(() => {
    if (potentialMatch) return potentialMatch;
    if (!selectedMatchId || !potentialMatches) return null;
    return potentialMatches.find((m: Match) => m.id === selectedMatchId);
  }, [potentialMatch, selectedMatchId, potentialMatches]);

  useEffect(() => {
    // Check if user has completed the quiz when entering step 2
    if (step === 2 && !user?.quizCompleted) {
      toast({
        title: "Quiz Required",
        description: "Please complete your personality quiz before matching.",
        variant: "destructive"
      });
      setStep(1);
    }
  }, [step, user?.quizCompleted]);

  // Form setup with default values
  const form = useForm<WizardFormData>({
    resolver: zodResolver(wizardSchema),
    defaultValues: {
      interests: interestFields.reduce(
        (acc, field) => ({ ...acc, [field]: 0.5 }),
        {} as Record<InterestField, number>
      )
    }
  });

  const progress = (step / totalSteps) * 100;

  const calculateCompatibility = () => {
    if (!currentMatch?.personalityTraits || !form.getValues().interests) {
      return 0;
    }

    const userTraits = form.getValues().interests;
    const matchTraits = currentMatch.personalityTraits;
    let score = 0;
    let count = 0;

    const traits = Object.keys(userTraits) as Array<keyof PersonalityTraits>;
    for (const trait of traits) {
      if (matchTraits[trait] !== undefined) {
        const similarity = 1 - Math.abs(userTraits[trait] - matchTraits[trait]);
        score += similarity;
        count++;
      }
    }

    return Math.round((score / count) * 100);
  };

  const handleNavigateNext = (e: React.MouseEvent<HTMLButtonElement>) => {
    e.preventDefault();
    if (step < totalSteps) {
      setStep(prev => prev + 1);
    }
  };

  const handleNavigateBack = (e: React.MouseEvent<HTMLButtonElement>) => {
    e.preventDefault();
    if (step > 1) {
      setStep(prev => prev - 1);
    }
  };

  const handleMatchSelect = (match: Match) => {
    if (!match.id || isNaN(match.id) || match.id <= 0) {
      console.error('Invalid match ID:', match.id);
      toast({
        title: "Error",
        description: "Invalid match selection",
        variant: "destructive"
      });
      return;
    }
    
    setSelectedMatchId(match.id);
  };

  const handleFormSubmit = async (data: WizardFormData) => {
    if (step !== totalSteps) {
      return;
    }

    try {
      if (!user) {
        throw new Error("You must be logged in to create a match");
      }

      if (!selectedMatchId || isNaN(selectedMatchId) || selectedMatchId <= 0) {
        throw new Error("Please select a valid match");
      }

      // Create the match
      const match = await connect(selectedMatchId);

      toast({
        title: "Match Request Sent",
        description: "Your match request has been sent successfully!"
      });

      if (match.status === 'accepted') {
        setLocation(`/chat/${match.id}`);
      }

      onComplete();
    } catch (error) {
      console.error('Error creating match:', error);
      
      if (error instanceof Error) {
        if (error.message.includes('already exists')) {
          toast({
            title: "Match Exists",
            description: "You already have a match with this user.",
            variant: "default",
          });
          setLocation(`/chat/${selectedMatchId}`);
          onComplete();
        } else if (error.message.includes('not found')) {
          toast({
            title: "User Not Found",
            description: "This user is no longer available for matching.",
            variant: "destructive",
          });
          onCancel();
        } else {
          toast({
            title: "Error",
            description: error.message,
            variant: "destructive"
          });
        }
      } else {
        toast({
          title: "Error",
          description: "An unexpected error occurred",
          variant: "destructive"
        });
      }
    }
  };

  return (
    <Card className="w-full max-w-2xl mx-auto">
      <CardHeader>
        <CardTitle>Create New Match</CardTitle>
        <CardDescription>
          Step {step} of {totalSteps}: {getStepDescription(step)}
        </CardDescription>
        <Progress value={progress} className="mt-2" />
      </CardHeader>

      <Form {...form}>
        <form onSubmit={form.handleSubmit(handleFormSubmit)}>
          <CardContent>
            {step === 1 && (
              <div className="space-y-4">
                <h3 className="text-lg font-medium">What are you looking for?</h3>
                {interestFields.map((trait) => (
                  <FormField
                    key={trait}
                    control={form.control}
                    name={`interests.${trait}` as const}
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>{formatTrait(trait)}</FormLabel>
                        <FormControl>
                          <Slider
                            min={0}
                            max={1}
                            step={0.1}
                            value={[field.value]}
                            onValueChange={([newValue]) => {
                              if (typeof newValue === 'number' && !Number.isNaN(newValue)) {
                                field.onChange(newValue);
                              }
                            }}
                          />
                        </FormControl>
                        <FormDescription>
                          {getTraitDescription(trait, field.value)}
                        </FormDescription>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                ))}
              </div>
            )}

            {step === 2 && (
              <div className="space-y-6">
                <h3 className="text-lg font-medium">Choose Your Potential Match</h3>
                {loadingMatches ? (
                  <div className="flex items-center justify-center h-40">
                    <Loader2 className="h-8 w-8 animate-spin text-primary" />
                  </div>
                ) : matchesError ? (
                  <Alert variant="destructive">
                    <AlertTitle>Error</AlertTitle>
                    <AlertDescription>
                      {matchesError instanceof Error ? matchesError.message : 'Failed to load potential matches'}
                    </AlertDescription>
                  </Alert>
                ) : !user?.quizCompleted ? (
                  <Alert>
                    <AlertTitle>Quiz Required</AlertTitle>
                    <AlertDescription>
                      Please complete your personality quiz before viewing potential matches.
                    </AlertDescription>
                  </Alert>
                ) : potentialMatches?.length ? (
                  <div className="space-y-4">
                    {potentialMatches.map((match: any) => (
                      <div
                        key={match.id}
                        className={`p-4 rounded-lg border cursor-pointer transition-colors ${
                          selectedMatchId === match.id
                            ? 'border-primary bg-primary/5'
                            : 'border-border hover:border-primary/50'
                        }`}
                        onClick={() => setSelectedMatchId(match.id)}
                      >
                        <div className="flex items-center space-x-4">
                          <Avatar className="h-16 w-16">
                            <AvatarImage src={match.avatar || "/default-avatar.png"} alt={match.name} />
                            <AvatarFallback>{match.name?.[0]}</AvatarFallback>
                          </Avatar>
                          <div className="flex-1">
                            <h4 className="text-lg font-semibold">{match.name}</h4>
                            <p className="text-sm text-muted-foreground">{match.bio}</p>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <Alert>
                    <AlertTitle>No potential matches found</AlertTitle>
                    <AlertDescription>
                      We couldn't find any potential matches at the moment. Please try again later.
                    </AlertDescription>
                  </Alert>
                )}
              </div>
            )}

            {step === 3 && selectedMatchId && currentMatch && (
              <div className="space-y-6">
                <h3 className="text-lg font-medium">Preview Your Match</h3>
                <div className="space-y-4">
                  <div className="flex items-center space-x-4">
                    <Avatar className="h-20 w-20">
                      <AvatarImage src={currentMatch.avatar || "/default-avatar.png"} alt={currentMatch.name} />
                      <AvatarFallback>{currentMatch.name?.[0]}</AvatarFallback>
                    </Avatar>
                    <div>
                      <h4 className="text-xl font-semibold">{currentMatch.name}</h4>
                      <p className="text-muted-foreground">{currentMatch.matchExplanation}</p>
                    </div>
                  </div>

                  <div className="bg-muted p-4 rounded-lg">
                    <h5 className="font-medium mb-2">Compatibility Score</h5>
                    <div className="flex items-center space-x-2">
                      <Progress value={currentMatch.compatibilityScore * 100} className="flex-1" />
                      <span className="text-sm font-medium">{Math.round(currentMatch.compatibilityScore * 100)}%</span>
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    {interestFields.map((trait) => (
                      <div key={trait} className="bg-muted p-3 rounded-lg">
                        <div className="text-sm font-medium mb-1">{formatTrait(trait)}</div>
                        <div className="flex items-center space-x-2">
                          <Progress 
                            value={currentMatch.personalityTraits[trait] * 100} 
                            className="flex-1" 
                          />
                          <span className="text-xs">
                            {Math.round(currentMatch.personalityTraits[trait] * 100)}%
                          </span>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}
          </CardContent>

          <CardFooter className="flex justify-between">
            <Button
              type="button"
              variant="outline"
              onClick={step === 1 ? onCancel : handleNavigateBack}
            >
              <ArrowLeft className="w-4 h-4 mr-2" />
              {step === 1 ? "Cancel" : "Back"}
            </Button>

            {step === totalSteps ? (
              <Button type="submit">
                <Heart className="w-4 h-4 mr-2" />
                Create Match
              </Button>
            ) : (
              <Button type="button" onClick={handleNavigateNext}>
                Next
                <ArrowRight className="w-4 h-4 ml-2" />
              </Button>
            )}
          </CardFooter>
        </form>
      </Form>
    </Card>
  );
}

function getStepDescription(step: number): string {
  switch (step) {
    case 1:
      return "Set Your Preferences";
    case 2:
      return "Choose Your Match";
    case 3:
      return "Confirm Connection";
    default:
      return "";
  }
}

function formatTrait(trait: InterestField): string {
  return trait.charAt(0).toUpperCase() + trait.slice(1);
}

function getTraitDescription(trait: InterestField, value: number): string {
  const descriptions: Record<InterestField, [string, string]> = {
    extraversion: ["Prefers quiet, intimate settings", "Enjoys social, energetic environments"],
    communication: ["Values actions over words", "Emphasizes verbal expression"],
    openness: ["Appreciates routine and tradition", "Seeks new experiences"],
    values: ["Flexible with principles", "Strong moral compass"],
    planning: ["Spontaneous and adaptable", "Organized and structured"],
    sociability: ["Values independence", "Thrives in group settings"],
  };

  const [low, high] = descriptions[trait];
  return value < 0.4 ? low : value > 0.6 ? high : "Balanced approach";
}
</file>

<file path="client/src/components/GraphControls.module.css">
.controls {
    position: absolute;
    bottom: 10px;
    right: 10px;
    display: flex;
    gap: 5px;
    padding: 5px;
    border-radius: 8px;
  }
  
  .controlButton {
    background: none;
    border: none;
    cursor: pointer;
    padding: 5px;
    border-radius: 4px;
    transition: all 0.2s ease;
  }
  
  .controlButton:hover {
    background: rgba(255, 255, 255, 0.1);
  }
</file>

<file path="client/src/components/GraphControls.tsx">
import React from 'react';
import { ZoomIn, ZoomOut, Maximize } from 'lucide-react';
import styles from './GraphControls.module.css';

interface GraphControlsProps {
  onZoomIn: () => void;
  onZoomOut: () => void;
  onCenter: () => void;
}

export const GraphControls: React.FC<GraphControlsProps> = ({ onZoomIn, onZoomOut, onCenter }) => {
  return (
    <div className={`${styles.controls} glass-effect`}>
      <button onClick={onZoomIn} className={styles.controlButton}>
        <ZoomIn size={18} />
      </button>
      <button onClick={onZoomOut} className={styles.controlButton}>
        <ZoomOut size={18} />
      </button>
      <button onClick={onCenter} className={styles.controlButton}>
        <Maximize size={18} />
      </button>
    </div>
  );
};
</file>

<file path="client/src/components/InterestTagger.tsx">
import { useState, useEffect } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Slider } from "@/components/ui/slider";
import {
  Select,
  SelectContent,
  SelectGroup,
  SelectItem,
  SelectLabel,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Plus, X, Tag } from "lucide-react";
import { useToast } from "@/hooks/use-toast";

interface Interest {
  id: number;
  name: string;
  categoryId: number;
  description?: string;
}

interface Category {
  id: number;
  name: string;
  description?: string;
}

interface UserInterest {
  id: number;
  interestId: number;
  score: number;
  interest: Interest;
}

export function InterestTagger() {
  const [selectedCategory, setSelectedCategory] = useState<string>("");
  const { toast } = useToast();
  const queryClient = useQueryClient();

  // Fetch categories
  const { data: categories = [] } = useQuery<Category[]>({
    queryKey: ['interest-categories'],
    queryFn: async () => {
      const response = await fetch('/api/interests/categories');
      if (!response.ok) throw new Error('Failed to fetch categories');
      return response.json();
    }
  });

  // Fetch available interests
  const { data: availableInterests = [] } = useQuery<Interest[]>({
    queryKey: ['interests', selectedCategory],
    queryFn: async () => {
      const url = selectedCategory 
        ? `/api/interests?categoryId=${selectedCategory}`
        : '/api/interests';
      const response = await fetch(url);
      if (!response.ok) throw new Error('Failed to fetch interests');
      return response.json();
    }
  });

  // Fetch user's interests
  const { data: userInterests = [] } = useQuery<UserInterest[]>({
    queryKey: ['user-interests'],
    queryFn: async () => {
      const response = await fetch('/api/user/interests');
      if (!response.ok) throw new Error('Failed to fetch user interests');
      return response.json();
    }
  });

  // Add interest mutation
  const addInterest = useMutation({
    mutationFn: async ({ interestId, score }: { interestId: number, score: number }) => {
      const response = await fetch('/api/user/interests', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ interestId, score }),
      });
      if (!response.ok) throw new Error('Failed to add interest');
      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['user-interests'] });
      toast({
        title: "Interest Added",
        description: "Your interest has been added successfully.",
      });
    },
    onError: (error) => {
      toast({
        title: "Error",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  // Remove interest mutation
  const removeInterest = useMutation({
    mutationFn: async (interestId: number) => {
      const response = await fetch(`/api/user/interests/${interestId}`, {
        method: 'DELETE',
      });
      if (!response.ok) throw new Error('Failed to remove interest');
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['user-interests'] });
      toast({
        title: "Interest Removed",
        description: "Your interest has been removed successfully.",
      });
    },
    onError: (error) => {
      toast({
        title: "Error",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  // Update interest score mutation
  const updateScore = useMutation({
    mutationFn: async ({ interestId, score }: { interestId: number, score: number }) => {
      const response = await fetch(`/api/user/interests/${interestId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ score }),
      });
      if (!response.ok) throw new Error('Failed to update interest score');
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['user-interests'] });
    },
    onError: (error) => {
      toast({
        title: "Error",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  return (
    <Card className="w-full max-w-2xl mx-auto">
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <Tag className="h-5 w-5" />
          Your Interests
        </CardTitle>
      </CardHeader>
      <CardContent>
        <div className="space-y-6">
          {/* Category Filter */}
          <div className="w-full max-w-xs">
            <Select
              value={selectedCategory}
              onValueChange={setSelectedCategory}
            >
              <SelectTrigger>
                <SelectValue placeholder="Filter by category" />
              </SelectTrigger>
              <SelectContent>
                <SelectGroup>
                  <SelectLabel>Categories</SelectLabel>
                  <SelectItem value="">All Categories</SelectItem>
                  {categories.map((category) => (
                    <SelectItem key={category.id} value={category.id.toString()}>
                      {category.name}
                    </SelectItem>
                  ))}
                </SelectGroup>
              </SelectContent>
            </Select>
          </div>

          {/* User's Current Interests */}
          <div className="space-y-4">
            <h3 className="text-sm font-medium">Your Interests</h3>
            <div className="grid gap-4">
              {userInterests.map((userInterest) => (
                <div
                  key={userInterest.id}
                  className="flex items-center gap-4 p-4 bg-muted rounded-lg"
                >
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center justify-between mb-2">
                      <h4 className="font-medium truncate">
                        {userInterest.interest.name}
                      </h4>
                      <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => removeInterest.mutate(userInterest.id)}
                      >
                        <X className="h-4 w-4" />
                      </Button>
                    </div>
                    <Slider
                      className="my-2"
                      value={[userInterest.score]}
                      max={100}
                      step={1}
                      onValueChange={([value]) => {
                        updateScore.mutate({
                          interestId: userInterest.id,
                          score: value
                        });
                      }}
                    />
                    <span className="text-sm text-muted-foreground">
                      Interest Level: {userInterest.score}%
                    </span>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Available Interests */}
          <div className="space-y-4">
            <h3 className="text-sm font-medium">Available Interests</h3>
            <div className="flex flex-wrap gap-2">
              {availableInterests
                .filter(interest => !userInterests.some(ui => ui.interestId === interest.id))
                .map((interest) => (
                  <Badge
                    key={interest.id}
                    variant="secondary"
                    className="cursor-pointer hover:bg-secondary/80"
                    onClick={() => addInterest.mutate({ interestId: interest.id, score: 50 })}
                  >
                    <Plus className="h-3 w-3 mr-1" />
                    {interest.name}
                  </Badge>
                ))}
            </div>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
</file>

<file path="client/src/components/MessageBubble.module.css">
.messageBubble {
    display: flex;
    align-items: flex-start;
    margin-bottom: 1rem;
    animation: fadeIn 0.3s ease;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .currentUser {
    flex-direction: row-reverse;
  }
  
  .avatarContainer {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    overflow: hidden;
    margin-right: 0.5rem;
  }
  
  .currentUser .avatarContainer {
    margin-right: 0;
    margin-left: 0.5rem;
  }
  
  .avatar {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .messageContent {
    background: var(--message-bg, #fff);
    padding: 0.75rem 1rem;
    border-radius: 18px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    max-width: 70%;
  }
  
  .currentUser .messageContent {
    background: var(--primary-color, #3498db);
    color: #fff;
  }
  
  .messageHeader {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.25rem;
  }
  
  .senderName {
    font-weight: bold;
    font-size: 0.9rem;
  }
  
  .timestamp {
    font-size: 0.75rem;
    color: var(--muted-color, #999);
  }
  
  .messageText {
    font-size: 1rem;
    line-height: 1.4;
  }
  
  .readIndicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: #2ecc71;
    margin-left: 0.5rem;
  }
</file>

<file path="client/src/components/MessageBubble.tsx">
import { motion } from "framer-motion";
import { formatDistanceToNow } from "date-fns";
import styles from "./MessageBubble.module.css";

interface MessageBubbleProps {
  message: {
    id: number;
    content: string;
    createdAt: string;
    sender: {
      id: number;
      username: string;
      name: string;
      avatar: string;
    };
  };
  currentUserId: number | undefined;
  isLastMessage: boolean;
}

export function MessageBubble({ message, currentUserId, isLastMessage }: MessageBubbleProps) {
  const isCurrentUser = message.sender.id === currentUserId;

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.3 }}
      className={`flex ${isCurrentUser ? "justify-end" : "justify-start"}`}
    >
      <div
        className={`max-w-[80%] rounded-lg p-3 ${
          isCurrentUser ? styles.currentUserMessage : styles.otherUserMessage
        } ${isLastMessage ? styles.lastMessage : ""}`}
      >
        <div className="flex items-center gap-2 mb-1">
          <span className="text-sm font-medium">
            {message.sender.name || message.sender.username}
          </span>
          <span className="text-xs opacity-70">
            {formatDistanceToNow(new Date(message.createdAt), { addSuffix: true })}
          </span>
        </div>
        <p className="text-sm whitespace-pre-wrap break-words">
          {message.content}
        </p>
      </div>
    </motion.div>
  );
}
</file>

<file path="client/src/components/Navigation.tsx">
import { Link, useLocation } from "wouter";
import { useUser } from "../hooks/use-user";
import { Button } from "@/components/ui/button";
import { ThemeToggle } from "./ThemeToggle";
import { Home, Users, MessageSquare, LogOut, User } from "lucide-react";

export default function Navigation() {
  const [location] = useLocation();
  const { user, logout } = useUser();

  return (
    <nav className="border-b bg-card">
      <div className="container mx-auto px-4">
        <div className="flex items-center justify-between h-16">
          <div className="flex items-center space-x-4">
            <Link href="/" className="text-xl font-bold text-primary">
            VybeChex
            </Link>
            
            <div className="hidden md:flex space-x-2">
              <ThemeToggle />
              {user ? (
                <>
                <Button
                  variant={location === "/" ? "default" : "ghost"}
                  size="sm"
                  asChild
                >
                  <Link href="/">
                    <Home className="h-4 w-4 mr-2" />
                    Home
                  </Link>
                </Button>

                <Button
                  variant={location === "/matches" ? "default" : "ghost"}
                  size="sm"
                  asChild
                >
                  <Link href="/matches">
                    <Users className="h-4 w-4 mr-2" />
                    Matches
                  </Link>
                </Button>
                </>
              ) : (
                <></>
              )}
            </div>
          </div>

          <div className="flex items-center space-x-4">
            <span className="text-sm text-muted-foreground">
              Welcome, {user?.username}
            </span>
            <Button
              variant={location === "/profile" ? "default" : "ghost"}
              size="sm"
              asChild
            >
              <Link href="/profile">
                <User className="h-4 w-4 mr-2" />
                Profile
              </Link>
            </Button>
            <Button
              variant="ghost"
              size="sm"
              onClick={() => logout()}
            >
              <LogOut className="h-4 w-4 mr-2" />
              Logout
            </Button>
          </div>
        </div>
      </div>
    </nav>
  );
}
</file>

<file path="client/src/components/NetworkGraph.module.css">
.graphCard {
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
  }
  
  .graphCard:hover {
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  }
  
  .errorCard,
  .loadingCard {
    height: 400px;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .glass-effect {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
</file>

<file path="client/src/components/NetworkGraph.tsx">
import { useRef, useEffect, useState, useMemo } from "react";
import ForceGraph2D, { ForceGraphMethods } from "react-force-graph-2d";
import * as d3 from "d3-force";
import type { Match } from "../hooks/use-matches";
import type { SelectUser } from "@db/schema";
import { AlertCircle, Loader2 } from 'lucide-react';
import { useUser } from "../hooks/use-user";
import { Card } from "@/components/ui/card";
import { motion, AnimatePresence } from "framer-motion";
import { NodeTooltip } from "./NodeTooltip";
import { GraphControls } from "./GraphControls";
import { getComputedColor, generateNodeColor } from "../utils/colorUtils";
import styles from "./NetworkGraph.module.css";

// Define custom types for force simulation
interface ForceSimulation {
  force: (name: string, force?: any) => any;
  alpha: (value: number) => any;
  restart: () => void;
}

interface Force {
  strength?: (value: number) => any;
  distance?: (value: number) => any;
  radius?: (value: number) => any;
}

// Define custom NodeObject interface
export interface CustomNodeObject {
  id: string;
  name: string;
  val: number;
  x?: number;
  y?: number;
  vx?: number;
  vy?: number;
  fx?: number | undefined;
  fy?: number | undefined;
  traits?: string[];
  interests?: string[];
  bio?: string;
  compatibilityScore?: number;
  lastActive?: string;
  [key: string]: any;  // Needed for force-graph internal properties
}

interface CustomLinkObject {
  source: CustomNodeObject;
  target: CustomNodeObject;
  value: number;
}

interface GraphData {
  nodes: CustomNodeObject[];
  links: CustomLinkObject[];
}

// Utility function to get computed color values
/*function getComputedColor(variable: string, opacity: number = 1): string {
  const style = getComputedStyle(document.documentElement);
  const primary = style.getPropertyValue('--primary');
  // Extract HSL values from the CSS variable
  const match = primary.match(/(\d+\.?\d*)\s+(\d+\.?\d*)%\s+(\d+\.?\d*)%/);
  if (!match) return `hsla(222.2, 47.4%, 11.2%, ${opacity})`; // Fallback
  const [_, h, s, l] = match;
  return `hsla(${h}, ${s}%, ${l}%, ${opacity})`;
}*/

interface NetworkGraphProps {
  matches: Match[];
  userId: number;
  visible: boolean;
}

export function NetworkGraph({ matches, userId, visible }: NetworkGraphProps) {
  const { user } = useUser();
  const [graphData, setGraphData] = useState<GraphData>({ nodes: [], links: [] });
  const [error, setError] = useState<string | null>(null);
  const [isInitialized, setIsInitialized] = useState(false);
  const [hoveredNode, setHoveredNode] = useState<CustomNodeObject | null>(null);
  const [selectedNode, setSelectedNode] = useState<CustomNodeObject | null>(null);
  const graphRef = useRef<ForceGraphMethods<CustomNodeObject, CustomLinkObject>>();
  const containerRef = useRef<HTMLDivElement>(null);
  const [dimensions, setDimensions] = useState({ width: 800, height: 400 });
  const [zoomLevel, setZoomLevel] = useState(1);

  // Handle resize
  useEffect(() => {
    if (!visible) return;

    const updateDimensions = () => {
      if (containerRef.current) {
        setDimensions({
          width: containerRef.current.offsetWidth,
          height: 400
        });
      }
    };

    window.addEventListener('resize', updateDimensions);
    // Delay initial dimension set to ensure container is rendered
    const timer = setTimeout(updateDimensions, 100);

    return () => {
      window.removeEventListener('resize', updateDimensions);
      clearTimeout(timer);
    };
  }, [visible]);

  // Initialize graph data and force simulation
  useEffect(() => {
    if (!visible || !user || isInitialized) return;

    try {
      if (!matches || matches.length === 0) {
        setError("No matches available to display");
        return;
      }

      // Create nodes for the current user and all matches
      const nodes: CustomNodeObject[] = [
        {
          id: user.id.toString(),
          name: user.name || user.username || 'You',
          val: 25,
          traits: user.personalityTraits ? Object.entries(user.personalityTraits)
            .filter(([_, value]) => value > 0.7)
            .map(([trait]) => trait) : [],
          lastActive: 'Now',
        }
      ];

      // Add match nodes and create links
      const links: CustomLinkObject[] = [];
      matches.forEach((match: Match) => {
        if (!match.id || (!match.name && !match.username)) return;

        const matchNode: CustomNodeObject = {
          id: match.id.toString(),
          name: match.name || match.username || `User ${match.id}`,
          val: 20,
          traits: match.personalityTraits ? Object.entries(match.personalityTraits)
            .filter(([_, value]) => value > 0.7)
            .map(([trait]) => trait) : [],
          interests: match.interests?.map(interest => interest.name) || [],
          compatibilityScore: match.compatibilityScore,
          lastActive: match.lastActivityAt ? new Date(match.lastActivityAt).toLocaleDateString() : undefined,
        };
        nodes.push(matchNode);

        links.push({
          source: nodes[0],
          target: matchNode,
          value: Math.max(0.1, Math.min(0.8, (match.compatibilityScore || 50) / 100))
        });
      });

      setGraphData({ nodes, links });
      setIsInitialized(true);
      setError(null);

      // Configure force simulation after a short delay to ensure the graph is rendered
      setTimeout(() => {
        if (graphRef.current) {
          const fg = graphRef.current;
          
          // Configure forces
          const simulation = fg.d3Force('simulation') as ForceSimulation | undefined;
          if (simulation) {
            // Get existing forces or create new ones
            const charge = (fg.d3Force('charge') || simulation.force('charge')) as Force;
            const link = (fg.d3Force('link') || simulation.force('link')) as Force;
            const center = (fg.d3Force('center') || simulation.force('center')) as Force;
            const collide = (fg.d3Force('collide') || simulation.force('collide')) as Force;

            // Apply force configurations with type safety
            // Maximum repulsion between nodes for extreme spacing
            if (charge?.strength) charge.strength(-4000); // Even more extreme repulsion
            
            // Extremely large link distance and minimal strength
            if (link?.distance && link?.strength) {
              link.distance(1500); // Even larger distance
              link.strength(0.03); // Even weaker links
            }
            
            // Minimal center force to allow maximum spread
            if (center?.strength) center.strength(0.003);
            
            // Very large collision radius with maximum enforcement
            if (collide?.radius && collide?.strength) {
              collide.radius(500); // Even larger collision radius
              collide.strength(3); // Stronger collision enforcement
            }

            // Restart simulation with minimal energy
            simulation.alpha(0.3).restart(); // Even lower initial energy
          }
        }
      }, 100);
    } catch (error) {
      console.error("Error building network graph:", error);
      setError("Failed to build network visualization");
    }
  }, [matches, user, visible, isInitialized]);

  // Add force simulation update on window resize
  useEffect(() => {
    if (!visible || !graphRef.current) return;

    const handleResize = () => {
      if (graphRef.current) {
        const fg = graphRef.current;
        const simulation = fg.d3Force('simulation');
        if (simulation) {
          simulation.alpha(0.3).restart();
        }
      }
    };

    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, [visible]);

  const memoizedGraphData = useMemo(() => graphData, [graphData]);

  const handleNodeHover = (node: CustomNodeObject | null) => {
    setHoveredNode(node);
    // Remove centering and zooming on hover
  };

  const handleNodeClick = (node: CustomNodeObject) => {
    setSelectedNode(node);
    if (graphRef.current) {
      graphRef.current.centerAt(node.x, node.y, 1000);
      graphRef.current.zoom(2.5, 1000);
    }
  };

  const handleBackgroundClick = () => {
    setSelectedNode(null);
    if (graphRef.current) {
      graphRef.current.centerAt(0, 0, 1000);
      graphRef.current.zoom(1, 1000);
    }
  };

  // Reset initialization when visibility changes to false
  useEffect(() => {
    if (!visible) {
      setIsInitialized(false);
    }
  }, [visible]);

  if (!visible) return null;

  if (error) {
    return (
      <Card className={`${styles.errorCard} glass-effect`}>
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5 }}
          className="flex flex-col items-center justify-center h-full gap-4"
        >
          <div className="flex items-center gap-2 text-destructive">
            <AlertCircle className="h-6 w-6" />
            <h3 className="font-semibold">Network Visualization Error</h3>
          </div>
          <p className="text-sm text-muted-foreground text-center max-w-md">
            {error}
          </p>
        </motion.div>
      </Card>
    );
  }

  if (!isInitialized) {
    return (
      <Card className={`${styles.loadingCard} glass-effect`}>
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ duration: 0.5 }}
          className="flex items-center justify-center h-full"
        >
          <Loader2 className="h-6 w-6 animate-spin" />
        </motion.div>
      </Card>
    );
  }

  return (
    <Card className={`${styles.graphCard} glass-effect`} ref={containerRef}>
      <ForceGraph2D<CustomNodeObject, CustomLinkObject>
        ref={graphRef}
        graphData={memoizedGraphData}
        nodeLabel="name"
        width={dimensions.width}
        height={Math.max(1200, dimensions.height)}
        nodeColor={(node) => generateNodeColor(node, user)}
        linkColor={(link) => getComputedColor('--primary', link.value * 0.08)}
        linkWidth={(link) => 0.3 + link.value * 0.3}
        nodeRelSize={16}
        d3AlphaDecay={0.05}
        d3VelocityDecay={0.9}
        cooldownTicks={30}
        linkDirectionalParticles={0}
        minZoom={0.15}
        maxZoom={3}
        onNodeDrag={(node, translate) => {
          if (graphRef.current) {
            const simulation = graphRef.current.d3Force('simulation');
            if (simulation) {
              simulation.alpha(0.03);
            }
          }
        }}
        onNodeDragEnd={(node) => {
          if (graphRef.current) {
            const simulation = graphRef.current.d3Force('simulation');
            if (simulation) {
              simulation.alphaTarget(0).alphaDecay(0.05);
            }
          }
        }}
        nodeCanvasObject={(node, ctx, globalScale) => {
          const label = node.name;
          const nodeSize = node.val * (1 + (node.id === hoveredNode?.id ? 0.05 : 0));
          const fontSize = 12;
          
          // Draw node with subtle shadow
          ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
          ctx.shadowBlur = 6;
          ctx.shadowOffsetX = 1;
          ctx.shadowOffsetY = 1;
          
          ctx.beginPath();
          ctx.arc(node.x!, node.y!, nodeSize / 2, 0, 2 * Math.PI);
          ctx.fillStyle = generateNodeColor(node, user);
          ctx.fill();
          
          // Reset shadow
          ctx.shadowColor = 'transparent';

          // Extremely subtle pulsating effect for hovered node
          if (node.id === hoveredNode?.id) {
            ctx.save();
            ctx.globalAlpha = 0.08 + Math.sin(Date.now() / 800) * 0.03;
            ctx.beginPath();
            ctx.arc(node.x!, node.y!, (nodeSize / 2) * 1.05, 0, 2 * Math.PI);
            ctx.fillStyle = generateNodeColor(node, user);
            ctx.fill();
            ctx.restore();
          }
          
          // Draw label with better contrast
          if (globalScale >= 0.5) {
            ctx.font = `${fontSize}px Inter`;
            const textWidth = ctx.measureText(label).width;
            const padding = 4;
            const textHeight = fontSize;
            
            // Draw label background with subtle shadow
            ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
            ctx.shadowBlur = 3;
            ctx.shadowOffsetX = 1;
            ctx.shadowOffsetY = 1;
            
            ctx.fillStyle = "rgba(0, 0, 0, 0.75)";
            ctx.fillRect(
              node.x! - textWidth / 2 - padding,
              node.y! + nodeSize / 2 + padding,
              textWidth + padding * 2,
              textHeight + padding * 2
            );
            
            // Reset shadow
            ctx.shadowColor = 'transparent';
            
            // Draw text
            ctx.fillStyle = "rgba(255, 255, 255, 0.9)";
            ctx.textAlign = "center";
            ctx.textBaseline = "top";
            ctx.fillText(label, node.x!, node.y! + nodeSize / 2 + padding * 1.5);
          }
        }}
        onNodeHover={handleNodeHover}
        onNodeClick={handleNodeClick}
        onBackgroundClick={handleBackgroundClick}
      />
      <AnimatePresence>
        {hoveredNode && (
          <NodeTooltip node={hoveredNode} />
        )}
      </AnimatePresence>
      <GraphControls
        onZoomIn={() => graphRef.current?.zoom(1.2, 400)}
        onZoomOut={() => graphRef.current?.zoom(0.8, 400)}
        onCenter={() => {
          graphRef.current?.centerAt(0, 0, 1000);
          graphRef.current?.zoom(1, 400);
        }}
      />
    </Card>
  );
}
</file>

<file path="client/src/components/NodeTooltip.module.css">
.tooltip {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 10px;
    border-radius: 8px;
    max-width: 200px;
    z-index: 10;
  }
  
  .tooltipTitle {
    font-size: 16px;
    font-weight: bold;
    margin-bottom: 5px;
  }
  
  .tooltipId {
    font-size: 12px;
    color: var(--muted-foreground);
  }
</file>

<file path="client/src/components/NodeTooltip.tsx">
import React from 'react';
import { motion } from 'framer-motion';
import styles from './NodeTooltip.module.css';
import type { CustomNodeObject } from './NetworkGraph';
import { Badge } from '@/components/ui/badge';
import { Card } from '@/components/ui/card';
import { formatDistanceToNow } from 'date-fns';

interface NodeTooltipProps {
  node: CustomNodeObject;
}

export const NodeTooltip: React.FC<NodeTooltipProps> = ({ node }) => {
  return (
    <motion.div
      initial={{ opacity: 0, y: 10 }}
      animate={{ opacity: 1, y: 0 }}
      exit={{ opacity: 0, y: 10 }}
      className={`${styles.tooltip} glass-effect`}
    >
      <Card className="p-4 shadow-lg backdrop-blur-lg bg-opacity-90">
        <div className="space-y-3">
          <div className="flex items-center justify-between">
            <h3 className="text-lg font-semibold">{node.name}</h3>
            {node.compatibilityScore && (
              <Badge variant="secondary" className="ml-2">
                {Math.round(node.compatibilityScore)}% Match
              </Badge>
            )}
          </div>

          {node.traits && node.traits.length > 0 && (
            <div className="space-y-1.5">
              <h4 className="text-sm font-medium">Key Traits</h4>
              <div className="flex flex-wrap gap-1.5">
                {node.traits.map((trait, index) => (
                  <Badge key={index} variant="outline" className="text-xs capitalize">
                    {trait.replace('_', ' ')}
                  </Badge>
                ))}
              </div>
            </div>
          )}

          {node.interests && node.interests.length > 0 && (
            <div className="space-y-1.5">
              <h4 className="text-sm font-medium">Interests</h4>
              <div className="flex flex-wrap gap-1.5">
                {node.interests.map((interest, index) => (
                  <Badge key={index} variant="outline" className="text-xs">
                    {interest}
                  </Badge>
                ))}
              </div>
            </div>
          )}

          {node.lastActive && (
            <p className="text-xs text-muted-foreground mt-2">
              Last active: {
                node.lastActive === 'Now' 
                  ? 'Now'
                  : formatDistanceToNow(new Date(node.lastActive), { addSuffix: true })
              }
            </p>
          )}
        </div>
      </Card>
    </motion.div>
  );
};
</file>

<file path="client/src/components/TypingIndicator.module.css">
.typingIndicator {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    background: rgba(0, 0, 0, 0.05);
    border-radius: 20px;
    width: fit-content;
    margin: 0.5rem 0;
  }
  
  .dot {
    width: 8px;
    height: 8px;
    background: var(--primary-color, #3498db);
    border-radius: 50%;
    margin: 0 2px;
  }
</file>

<file path="client/src/components/TypingIndicator.tsx">
import React from "react";
import { motion } from "framer-motion";
import styles from "./TypingIndicator.module.css";

export function TypingIndicator() {
  return (
    <div className={styles.typingIndicator}>
      <motion.div
        animate={{
          scale: [1, 1.2, 1],
          transition: { repeat: Infinity, duration: 0.75 }
        }}
        className={styles.dot}
      />
      <motion.div
        animate={{
          scale: [1, 1.2, 1],
          transition: { repeat: Infinity, duration: 0.75, delay: 0.25 }
        }}
        className={styles.dot}
      />
      <motion.div
        animate={{
          scale: [1, 1.2, 1],
          transition: { repeat: Infinity, duration: 0.75, delay: 0.5 }
        }}
        className={styles.dot}
      />
    </div>
  );
}
</file>

<file path="client/src/hooks/use-chat.ts">
// / client/src/hooks/use-chat.ts

import { useQuery, useMutation } from "@tanstack/react-query";
import { toast } from "./use-toast";

export interface Suggestion {
  text: string;
  confidence: number;
}

export interface SuggestionResponse {
  suggestions: Suggestion[];
}

export interface EventSuggestion {
  title: string;
  description: string;
  reasoning?: string;
  date?: string;
  location?: string;
}

export interface EventSuggestionResponse {
  success: boolean;
  suggestions: EventSuggestion[];
}

// API endpoints configuration
const API_ENDPOINTS = {
  suggestions: "/api/matches/suggestions",
  craftMessage: "/api/matches/messages/craft",
  eventSuggestions: "/api/matches/suggestions/events"
} as const;

// Detect if we're getting a Vite dev server response
function isViteDevServerResponse(text: string): boolean {
  return text.includes('data-vite-theme') || 
         text.includes('vite/client') || 
         text.includes('/@vite/client');
}

// Utility function for API calls
async function makeApiCall<T>(
  endpoint: string,
  data: any,
  errorMessage: string
): Promise<T> {
  // Add retry logic for network issues
  const maxRetries = 2;
  let lastError: Error | null = null;

  for (let attempt = 0; attempt <= maxRetries; attempt++) {
    try {
      const response = await fetch(endpoint, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "X-Requested-With": "XMLHttpRequest"
        },
        body: JSON.stringify(data),
        credentials: "include",
      });

      // Check if the response is a redirect
      if (response.redirected) {
        window.location.href = response.url;
        throw new Error("Session expired. Please log in again.");
      }

      const contentType = response.headers.get("content-type");
      
      // Special handling for 404 and 401
      if (response.status === 404) {
        console.error(`API endpoint not found: ${endpoint}`);
        throw new Error("API endpoint not found. Please check the server configuration.");
      }
      if (response.status === 401) {
        window.location.href = '/login';
        throw new Error("Session expired. Please log in again.");
      }

      // Handle non-JSON responses
      if (!contentType?.includes("application/json")) {
        const responseDetails = {
          contentType,
          status: response.status,
          statusText: response.statusText,
          url: response.url,
          attempt: attempt + 1,
          maxRetries
        };
        console.error("Invalid content type received:", responseDetails);

        const text = await response.text();
        console.debug("Response text preview:", text.substring(0, 200) + "...");

        if (text.includes("<!DOCTYPE html>")) {
          // Check if this is a Vite dev server response
          if (isViteDevServerResponse(text)) {
            console.error("Received Vite dev server response. API route may not be properly configured:", {
              endpoint,
              ...responseDetails
            });
            throw new Error("API route not configured. Check server implementation.");
          }

          if (text.toLowerCase().includes("unauthorized")) {
            window.location.href = '/login';
            throw new Error("Unauthorized. Please log in again.");
          }

          // If it's the last retry, throw a more specific error
          if (attempt === maxRetries) {
            throw new Error(`Server configuration error: API endpoint ${endpoint} not properly set up`);
          }
          // Otherwise, retry
          throw new Error("Received HTML instead of JSON");
        }

        throw new Error(`Server returned invalid content type: ${contentType}`);
      }

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({
          message: `Server error: ${response.status} ${response.statusText}`
        }));
        throw new Error(errorData.message || errorMessage);
      }

      const jsonData = await response.json();
      
      // Validate basic response structure
      if (!jsonData || typeof jsonData !== 'object') {
        throw new Error("Invalid JSON response structure");
      }

      return jsonData as T;
    } catch (error) {
      lastError = error instanceof Error ? error : new Error(String(error));
      
      // Only retry on network errors or HTML responses
      const errorMessage = lastError.message;
      const shouldRetry = errorMessage.includes("HTML") || 
                         errorMessage.includes("fetch") ||
                         errorMessage.includes("API route not configured");
      
      if (!shouldRetry) {
        throw lastError;
      }
      
      if (attempt < maxRetries) {
        const delay = Math.pow(2, attempt) * 1000;
        console.warn(`Retrying API call to ${endpoint} in ${delay}ms (attempt ${attempt + 1}/${maxRetries + 1})`);
        await new Promise(resolve => setTimeout(resolve, delay));
        continue;
      }
      throw lastError;
    }
  }

  // This should never be reached due to the throw in the loop
  throw lastError || new Error("Unknown error occurred");
}

interface CraftMessageParams {
  matchId: number;
  suggestion: string;
  eventDetails?: {
    title: string;
    description: string;
    reasoning?: string;
  };
}

export function useChat() {
  const getSuggestions = async (matchId: number): Promise<SuggestionResponse> => {
    try {
      const data = await makeApiCall<any>(
        API_ENDPOINTS.suggestions,
        { matchId },
        "Failed to get suggestions"
      );

      // Validate response structure
      if (!data?.success) {
        console.warn("Unexpected response structure:", data);
        return { suggestions: [] };
      }

      const suggestions = Array.isArray(data.suggestions) ? data.suggestions : [];
      
      return {
        suggestions: suggestions.map((suggestion: any) => ({
          text: typeof suggestion === 'string' ? suggestion : suggestion.text || '',
          confidence: suggestion.confidence || 1
        }))
      };
    } catch (error) {
      if (error instanceof Error && 
          !error.message.includes("Invalid response format") &&
          !error.message.includes("API endpoint not found")) {
        toast({
          title: "Error",
          description: error.message,
          variant: "destructive",
        });
      }
      return { suggestions: [] };
    }
  };

  const craftMessage = async ({ matchId, suggestion, eventDetails }: CraftMessageParams): Promise<{ message: string }> => {
    try {
      const data = await makeApiCall<any>(
        API_ENDPOINTS.craftMessage,
        { matchId, suggestion, eventDetails },
        "Failed to craft message"
      );

      if (!data?.success || typeof data.message !== 'string') {
        console.warn("Invalid message format:", data);
        return { message: suggestion };
      }

      return { message: data.message };
    } catch (error) {
      console.error("Error crafting message:", error);
      // Return original suggestion as fallback
      return { message: suggestion };
    }
  };

  const getEventSuggestions = async (matchId: number): Promise<EventSuggestionResponse> => {
    try {
      console.log('Fetching event suggestions for match:', matchId);
      const data = await makeApiCall<any>(
        API_ENDPOINTS.eventSuggestions,
        { matchId },
        "Failed to get event suggestions"
      );

      console.log('Raw event suggestions response:', data);

      if (!data?.success) {
        console.warn("Unexpected response structure:", data);
        return { success: false, suggestions: [] };
      }

      const suggestions = Array.isArray(data.suggestions) ? data.suggestions : [];
      console.log('Processed event suggestions:', suggestions);
      
      return {
        success: true,
        suggestions: suggestions.map((event: any) => ({
          title: event.title || '',
          description: event.description || '',
          reasoning: event.reasoning || '',
          date: event.date || undefined,
          location: event.location || undefined
        }))
      };
    } catch (error) {
      console.error("Error fetching event suggestions:", error);
      if (error instanceof Error && 
          !error.message.includes("Invalid response format") &&
          !error.message.includes("API endpoint not found")) {
        toast({
          title: "Error",
          description: error.message,
          variant: "destructive",
        });
      }
      return { success: false, suggestions: [] };
    }
  };

  const suggestionsMutation = useMutation({
    mutationFn: getSuggestions,
    onError: (error: Error) => {
      // Error already handled in the function
      console.error("Suggestions mutation error:", error);
    },
  });

  const craftMessageMutation = useMutation({
    mutationFn: async (params: CraftMessageParams) => {
      return craftMessage(params);
    },
    onError: (error: Error) => {
      console.error("Craft message mutation error:", error);
    },
  });

  const eventSuggestionsMutation = useMutation({
    mutationFn: getEventSuggestions,
    onError: (error: Error) => {
      // Error already handled in the function
      console.error("Event suggestions mutation error:", error);
    },
  });

  return {
    getSuggestions: suggestionsMutation.mutateAsync,
    craftMessage: craftMessageMutation.mutateAsync,
    getEventSuggestions: eventSuggestionsMutation.mutateAsync,
    isLoading: 
      suggestionsMutation.isPending || 
      craftMessageMutation.isPending || 
      eventSuggestionsMutation.isPending,
  };
}
</file>

<file path="client/src/pages/InterestsPage.tsx">
import { InterestTagger } from "@/components/InterestTagger";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";

export function InterestsPage() {
  return (
    <div className="container mx-auto py-8">
      <Card className="mb-8">
        <CardHeader>
          <CardTitle>Manage Your Interests</CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-muted-foreground">
            Add and manage your interests to help us find better matches for you. Rate each interest to indicate how important it is to you.
          </p>
        </CardContent>
      </Card>
      
      <InterestTagger />
    </div>
  );
}
</file>

<file path="client/src/pages/Quiz.tsx">
import { useState } from "react";
import { useLocation } from "wouter";
import { Card } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { useToast } from "@/hooks/use-toast";
import { useQueryClient } from "@tanstack/react-query";

const questions = [
  {
    id: 1,
    text: "When you spend time with others, how do you feel?",
    options: [
      "I feel happiest and excited in big, lively groups",
      "I feel good talking in small, close-knit groups",
      "I am okay with both small groups and one-on-one time",
      "I feel best when I am alone"
    ],
    trait: "extraversion"
  },
  {
    id: 2,
    text: "How do you usually share your ideas?",
    options: [
      "I say what I think clearly and simply",
      "I choose my words to keep things friendly",
      "I change how I talk depending on who Im with",
      "I mostly listen and speak only when I need to"
    ],
    trait: "communication"
  },
  {
    id: 3,
    text: "When you find something new or unfamiliar, how do you react?",
    options: [
      "I try it right away without waiting",
      "Im curious but I like to learn about it first",
      "I go along with new things at an easy pace",
      "I prefer to stick to what I already know"
    ],
    trait: "openness"
  },
  {
    id: 4,
    text: "What matters most to you in close friendships?",
    options: [
      "Having trust and knowing we can count on each other",
      "Doing fun and exciting things together",
      "Having deep talks and understanding each others feelings",
      "Sharing common hobbies and interests"
    ],
    trait: "values"
  },
  {
    id: 5,
    text: "How do you like to plan activities?",
    options: [
      "I like to decide on the spot",
      "I prefer to make a clear plan ahead of time",
      "Im flexible and can change plans if needed",
      "Im fine with whatever others choose"
    ],
    trait: "planning"
  },
  {
    id: 6,
    text: "What size group do you most enjoy being part of?",
    options: [
      "A large, busy group with many people",
      "A small group of close friends",
      "Just one other person, one-on-one",
      "It depends on what were doing"
    ],
    trait: "sociability"
  },
  {
    id: 7,
    text: "If your plans suddenly change, how do you feel?",
    options: [
      "I quickly go along with the new plan",
      "I talk it over with others before changing things",
      "I pause and think carefully about what to do next",
      "I feel uneasy and wish we stuck to the original plan"
    ],
    trait: "openness"
  },
  {
    id: 8,
    text: "Where do you feel most comfortable sharing your true thoughts?",
    options: [
      "In a lively group where everyone is talking",
      "In a quiet, private place with one other person",
      "Online or in writing, where I can think first",
      "After I watch and listen for a while"
    ],
    trait: "communication"
  },
  {
    id: 9,
    text: "How do you discover new hobbies or interests?",
    options: [
      "I jump right in and learn as I go",
      "I read and learn about it before starting",
      "I ask friends for their ideas",
      "I follow what interests me at the moment"
    ],
    trait: "openness"
  },
  {
    id: 10,
    text: "How do you choose what to do on a free weekend?",
    options: [
      "I plan my activities ahead of time",
      "I leave my schedule open and decide later",
      "I see what others want to do",
      "I stick to things I already like"
    ],
    trait: "planning"
  },
  {
    id: 11,
    text: "What matters most when choosing a social activity?",
    options: [
      "Feeling excited and having lots of energy",
      "Having good, meaningful talks",
      "Feeling safe and comfortable",
      "Trying something new and different"
    ],
    trait: "values"
  }
];

export default function Quiz() {
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [answers, setAnswers] = useState<Record<string, number>>({});
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [, navigate] = useLocation();
  const { toast } = useToast();
  const queryClient = useQueryClient();

  const handleAnswer = async (questionId: number, answerIndex: number) => {
    const question = questions.find(q => q.id === questionId);
    if (!question) return;

    // Calculate trait score based on answer index (0-3)
    const traitScore = (3 - answerIndex) / 3; // Normalize to 0-1 range
    const newAnswers = {
      ...answers,
      [question.trait]: traitScore
    };
    setAnswers(newAnswers);

    if (currentQuestion < questions.length - 1) {
      setCurrentQuestion(curr => curr + 1);
    } else {
      try {
        setIsSubmitting(true);

        // First verify that we're still authenticated
        const userResponse = await fetch("/api/user", {
          credentials: "include",
          headers: {
            'Accept': 'application/json',
            'Cache-Control': 'no-cache'
          }
        });
        
        if (userResponse.status === 401) {
          toast({
            title: "Session Expired",
            description: "Please log in again to continue.",
            variant: "destructive"
          });
          navigate("/login");
          return;
        }

        // Submit quiz
        const res = await fetch("/api/quiz", {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            'Accept': 'application/json'
          },
          body: JSON.stringify({ traits: newAnswers }),
          credentials: "include",
        });

        if (!res.ok) {
          const errorData = await res.json().catch(() => ({ message: "Failed to submit quiz" }));
          throw new Error(errorData.message || "Failed to submit quiz");
        }

        // Wait for the response data
        const responseData = await res.json();
        console.log("Quiz submission response:", responseData);

        // Force immediate refetch of user data
        await queryClient.refetchQueries({ 
          queryKey: ['/api/user'],
          type: 'active',
          exact: true
        });

        // Verify that the quiz completion was registered
        const updatedUserResponse = await fetch("/api/user", {
          credentials: "include",
          headers: {
            'Accept': 'application/json',
            'Cache-Control': 'no-cache'
          }
        });

        if (!updatedUserResponse.ok) {
          throw new Error("Failed to verify quiz completion");
        }

        const updatedUserData = await updatedUserResponse.json();
        console.log("Updated user data after quiz:", updatedUserData);

        if (!updatedUserData?.user?.quizCompleted) {
          throw new Error("Quiz completion was not registered properly");
        }

        toast({
          title: "Quiz completed!",
          description: "Great! Now let's find you some compatible friends!",
        });

        // Invalidate matches query after confirming quiz completion
        await queryClient.invalidateQueries({ queryKey: ['matches'] });

        navigate("/matches");
      } catch (error: any) {
        console.error("Quiz submission error:", error);
        toast({
          title: "Error",
          description: error.message || "Failed to submit quiz. Please try again.",
          variant: "destructive",
        });
      } finally {
        setIsSubmitting(false);
      }
    }
  };

  const question = questions[currentQuestion];

  return (
    <div className="max-w-2xl mx-auto">
      <h1 className="text-3xl font-bold text-center mb-8">Personality Quiz</h1>
      
      <div className="mb-4">
        <div className="w-full bg-secondary h-2 rounded-full">
          <div 
            className="bg-primary h-2 rounded-full transition-all"
            style={{ width: `${((currentQuestion + 1) / questions.length) * 100}%` }}
          />
        </div>
      </div>

      <Card className="p-6">
        <h2 className="text-xl font-semibold mb-6">{question.text}</h2>
        
        <div className="grid gap-4">
          {question.options.map((option, index) => (
            <Button
              key={index}
              variant="outline"
              className="justify-start h-auto py-4 px-6 text-left"
              onClick={() => handleAnswer(question.id, index)}
              disabled={isSubmitting}
            >
              {option}
            </Button>
          ))}
        </div>
      </Card>
    </div>
  );
}
</file>

<file path="client/src/styles/globals.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  :root {
    --background: 40 100% 98%;
    --foreground: 24 20% 20%;
    --card: 40 100% 99%;
    --card-foreground: 24 20% 20%;
    --popover: 40 100% 99%;
    --popover-foreground: 24 20% 20%;
    --primary: 176 68% 44%;
    --primary-foreground: 0 0% 100%;
    --secondary: 340 61% 85%;
    --secondary-foreground: 24 20% 20%;
    --muted: 40 30% 92%;
    --muted-foreground: 24 10% 40%;
    --accent: 52 100% 60%;
    --accent-foreground: 24 20% 20%;
    --destructive: 10 70% 50%;
    --destructive-foreground: 0 0% 100%;
    --border: 40 10% 90%;
    --input: 40 10% 90%;
    --ring: 176 68% 44%;
    --radius: 0.5rem;

    --primary-color: 204 70% 53%;
    --success-color: 145 63% 49%;
    --chat-bg: 210 30% 96%;
    --header-bg: 0 0% 100% 0.8;
    --input-bg: 0 0% 100% 0.9;
    --message-bg: 0 0% 100%;
  }

  .dark {
    --background: 210 40% 10%;
    --foreground: 210 25% 95%;
    --card: 210 40% 11%;
    --card-foreground: 210 25% 95%;
    --popover: 210 40% 11%;
    --popover-foreground: 210 25% 95%;
    --primary: 176 68% 44%;
    --primary-foreground: 0 0% 100%;
    --secondary: 270 30% 30%;
    --secondary-foreground: 210 25% 95%;
    --muted: 210 10% 20%;
    --muted-foreground: 210 10% 70%;
    --accent: 52 90% 50%;
    --accent-foreground: 210 25% 95%;
    --destructive: 10 70% 40%;
    --destructive-foreground: 210 25% 95%;
    --border: 210 20% 20%;
    --input: 210 20% 20%;
    --ring: 176 68% 44%;

    --primary-color: 204 70% 53%;
    --success-color: 145 63% 49%;
    --chat-bg: 220 26% 14%;
    --header-bg: 0 0% 0% 0.4;
    --input-bg: 0 0% 0% 0.3;
    --message-bg: 215 25% 27%;
  }
}

@layer base {
  * {
    @apply border-border;
  }

  body {
    @apply font-sans antialiased bg-background text-foreground;
  }
}

@layer utilities {
  .animate-gradient {
    background-size: 200%;
    animation: gradientShift 3s ease infinite;
  }

  @keyframes gradientShift {
    0% {
      background-position: 0% 50%;
    }
    50% {
      background-position: 100% 50%;
    }
    100% {
      background-position: 0% 50%;
    }
  }

  .animate-float {
    animation: float 6s ease-in-out infinite;
  }

  @keyframes float {
    0% {
      transform: translateY(0px);
    }
    50% {
      transform: translateY(-20px);
    }
    100% {
      transform: translateY(0px);
    }
  }

  .glass-effect {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .shimmer {
    position: relative;
    overflow: hidden;
  }

  .shimmer::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
      to bottom right,
      rgba(255, 255, 255, 0) 0%,
      rgba(255, 255, 255, 0.1) 50%,
      rgba(255, 255, 255, 0) 100%
    );
    transform: rotate(30deg);
    animation: shimmer 3s infinite;
  }

  @keyframes shimmer {
    0% {
      transform: translateX(-100%) rotate(30deg);
    }
    100% {
      transform: translateX(100%) rotate(30deg);
    }
  }

  .chat-window {
    @apply bg-gradient-to-br from-[hsl(var(--chat-bg))] to-[hsl(var(--chat-bg)_/_0.8)];
  }

  .chat-header {
    @apply bg-[hsl(var(--header-bg))] backdrop-blur-md;
  }

  .chat-input-area {
    @apply bg-[hsl(var(--input-bg))] backdrop-blur-md;
  }

  .message-bubble {
    @apply bg-[hsl(var(--message-bg))] shadow-lg transition-all duration-300 ease-in-out;
  }

  .message-bubble:hover {
    @apply transform -translate-y-1 shadow-xl;
  }

  .typing-indicator {
    @apply flex items-center space-x-1;
  }

  .typing-dot {
    @apply w-2 h-2 bg-[hsl(var(--primary-color))] rounded-full;
  }

  @keyframes typing-animation {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
  }

  @keyframes fade-in-up {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }

  .animate-typing {
    animation: typing-animation 0.6s infinite;
  }

  .animate-fade-in-up {
    animation: fade-in-up 0.3s ease-out;
  }

  .animate-pulse {
    animation: pulse 2s infinite;
  }
}
</file>

<file path="client/src/styles/theme.ts">
import { Theme } from "@theme-ui/core";

const theme: Theme = {
    colors: {
        primary: "#3498db",
        "primary-dark": "#2980b9",
        success: "#2ecc71",
        "success-foreground": "#ffffff",
        destructive: "#e74c3c",
        "destructive-foreground": "#ffffff",
        background: "#f5f5f5",
        foreground: "#333333",
        muted: "#e0e0e0",
        "muted-foreground": "#666666",
      },
};

export default theme;
</file>

<file path="client/src/utils/colorUtils.ts">
import { CustomNodeObject } from '../components/NetworkGraph';

export function getComputedColor(variable: string, opacity: number = 1): string {
  const style = getComputedStyle(document.documentElement);
  const primary = style.getPropertyValue(variable);
  const match = primary.match(/(\d+\.?\d*)\s+(\d+\.?\d*)%\s+(\d+\.?\d*)%/);
  if (!match) return `hsla(222.2, 47.4%, 11.2%, ${opacity})`;
  const [_, h, s, l] = match;
  return `hsla(${h}, ${s}%, ${l}%, ${opacity})`;
}

export function generateNodeColor(node: CustomNodeObject, currentUser: any): string {
  if (node.id === currentUser?.id?.toString()) {
    return getComputedColor('--primary', 1);
  }
  // Generate a unique color based on the node's id
  const hue = parseInt(node.id, 36) % 360;
  return `hsl(${hue}, 70%, 60%)`;
}
</file>

<file path="db/migrations/add_potential_status.ts">
import { sql } from 'drizzle-orm';
import { db } from '@db';

export async function up() {
  await db.execute(sql`
    ALTER TABLE matches
    DROP CONSTRAINT IF EXISTS matches_status_check;
    
    ALTER TABLE matches
    ADD CONSTRAINT matches_status_check
    CHECK (status IN ('requested', 'pending', 'accepted', 'rejected', 'potential'));
  `);
}

export async function down() {
  await db.execute(sql`
    ALTER TABLE matches
    DROP CONSTRAINT IF EXISTS matches_status_check;
    
    ALTER TABLE matches
    ADD CONSTRAINT matches_status_check
    CHECK (status IN ('requested', 'pending', 'accepted', 'rejected'));
  `);
}
</file>

<file path="server/utils/matching.ts">
import { PersonalityTraits, Interest } from "@/hooks/use-matches";

interface ScoreWeights {
  personality: number;
  interests: number;
  communication: number;
  social: number;
  activity: number;
}

const DEFAULT_WEIGHTS: ScoreWeights = {
  personality: 0.35,
  interests: 0.25,
  communication: 0.20,
  social: 0.10,
  activity: 0.10
};

// Personality trait importance weights
const TRAIT_WEIGHTS = {
  extraversion: 0.2,
  communication: 0.25,
  openness: 0.15,
  values: 0.20,
  planning: 0.10,
  sociability: 0.10
};

export function calculateTraitCompatibility(
  trait1: number,
  trait2: number,
  traitName: keyof typeof TRAIT_WEIGHTS
): number {
  const weight = TRAIT_WEIGHTS[traitName];
  const difference = Math.abs(trait1 - trait2);
  
  // Calculate base compatibility (0-1 scale)
  let compatibility = 1 - (difference / 1);
  
  // Apply diminishing returns curve
  compatibility = Math.pow(compatibility, 0.7);
  
  // Apply trait-specific weight
  return compatibility * weight;
}

export function calculatePersonalityScore(
  traits1: PersonalityTraits,
  traits2: PersonalityTraits
): number {
  let totalScore = 0;
  let totalWeight = 0;

  // Calculate weighted score for each trait
  for (const trait of Object.keys(TRAIT_WEIGHTS) as Array<keyof typeof TRAIT_WEIGHTS>) {
    if (traits1[trait] !== undefined && traits2[trait] !== undefined) {
      const traitScore = calculateTraitCompatibility(
        traits1[trait],
        traits2[trait],
        trait
      );
      totalScore += traitScore;
      totalWeight += TRAIT_WEIGHTS[trait];
    }
  }

  // Normalize score to 0-1 range
  return totalWeight > 0 ? totalScore / totalWeight : 0;
}

export function calculateInterestScore(
  interests1: Interest[],
  interests2: Interest[]
): number {
  if (!interests1.length || !interests2.length) return 0;

  // Create maps for faster lookup
  const map1 = new Map(interests1.map(i => [i.name, i]));
  const map2 = new Map(interests2.map(i => [i.name, i]));

  let totalScore = 0;
  let matchCount = 0;

  // Calculate score for matching interests
  for (const [name, interest1] of map1) {
    const interest2 = map2.get(name);
    if (interest2) {
      // Score based on how close their interest levels are (0-1)
      const scoreAlignment = 1 - Math.abs(interest1.score - interest2.score);
      totalScore += scoreAlignment;
      matchCount++;
    }
  }

  // Calculate shared interest ratio
  const sharedRatio = matchCount / Math.max(interests1.length, interests2.length);
  
  // Combine alignment score with shared ratio
  return matchCount > 0 
    ? (totalScore / matchCount) * 0.7 + sharedRatio * 0.3 
    : 0;
}

export function calculateComplexityScore(
  user1: {
    personalityTraits: PersonalityTraits;
    interests?: Interest[];
  },
  user2: {
    personalityTraits: PersonalityTraits;
    interests?: Interest[];
  },
  weights: Partial<ScoreWeights> = {}
): number {
  const finalWeights = { ...DEFAULT_WEIGHTS, ...weights };
  
  // Calculate individual component scores
  const personalityScore = calculatePersonalityScore(
    user1.personalityTraits,
    user2.personalityTraits
  );
  
  const interestScore = calculateInterestScore(
    user1.interests || [],
    user2.interests || []
  );

  // Calculate communication style compatibility (based on personality traits)
  const communicationScore = calculateTraitCompatibility(
    user1.personalityTraits.communication,
    user2.personalityTraits.communication,
    'communication'
  );

  // Calculate social preference compatibility
  const socialScore = calculateTraitCompatibility(
    user1.personalityTraits.sociability,
    user2.personalityTraits.sociability,
    'sociability'
  );

  // Calculate activity compatibility (based on extraversion and openness)
  const activityScore = (
    calculateTraitCompatibility(
      user1.personalityTraits.extraversion,
      user2.personalityTraits.extraversion,
      'extraversion'
    ) +
    calculateTraitCompatibility(
      user1.personalityTraits.openness,
      user2.personalityTraits.openness,
      'openness'
    )
  ) / 2;

  // Calculate weighted final score
  const finalScore =
    personalityScore * finalWeights.personality +
    interestScore * finalWeights.interests +
    communicationScore * finalWeights.communication +
    socialScore * finalWeights.social +
    activityScore * finalWeights.activity;

  // Convert to percentage and round to nearest integer
  return Math.round(finalScore * 100);
}

// Helper function to get detailed score breakdown
export function getScoreBreakdown(
  user1: {
    personalityTraits: PersonalityTraits;
    interests?: Interest[];
  },
  user2: {
    personalityTraits: PersonalityTraits;
    interests?: Interest[];
  }
): {
  overall: number;
  components: {
    personality: number;
    interests: number;
    communication: number;
    social: number;
    activity: number;
  };
  details: {
    personalityBreakdown: Record<string, number>;
  };
} {
  const personalityScore = calculatePersonalityScore(
    user1.personalityTraits,
    user2.personalityTraits
  );
  
  const interestScore = calculateInterestScore(
    user1.interests || [],
    user2.interests || []
  );

  const communicationScore = calculateTraitCompatibility(
    user1.personalityTraits.communication,
    user2.personalityTraits.communication,
    'communication'
  );

  const socialScore = calculateTraitCompatibility(
    user1.personalityTraits.sociability,
    user2.personalityTraits.sociability,
    'sociability'
  );

  const activityScore = (
    calculateTraitCompatibility(
      user1.personalityTraits.extraversion,
      user2.personalityTraits.extraversion,
      'extraversion'
    ) +
    calculateTraitCompatibility(
      user1.personalityTraits.openness,
      user2.personalityTraits.openness,
      'openness'
    )
  ) / 2;

  // Calculate personality breakdown for each trait
  const personalityBreakdown: Record<string, number> = {};
  for (const trait of Object.keys(TRAIT_WEIGHTS) as Array<keyof typeof TRAIT_WEIGHTS>) {
    personalityBreakdown[trait] = calculateTraitCompatibility(
      user1.personalityTraits[trait],
      user2.personalityTraits[trait],
      trait
    );
  }

  const overall = calculateComplexityScore(user1, user2);

  return {
    overall,
    components: {
      personality: Math.round(personalityScore * 100),
      interests: Math.round(interestScore * 100),
      communication: Math.round(communicationScore * 100),
      social: Math.round(socialScore * 100),
      activity: Math.round(activityScore * 100)
    },
    details: {
      personalityBreakdown: Object.fromEntries(
        Object.entries(personalityBreakdown).map(([k, v]) => [k, Math.round(v * 100)])
      )
    }
  };
}
</file>

<file path="server/utils/suggestions.ts">
// suggestions.ts

// Purpose: Provides suggestions for chat prompts and event ideas,
// using only our enhanced trait interactions and avoidance rules.

import type { Interest } from "@/hooks/use-matches";
import { generateEventSuggestions as generateAIEventSuggestions } from './openai';

// Personality traits interface
interface PersonalityTraits {
  extraversion: number;
  communication: number;
  openness: number;
  values: number;
  planning: number;
  sociability: number;
  agreeableness: number;
  conscientiousness: number;
  neuroticism: number;
  self_consciousness: number;
  introversion: number;
}

// New interfaces for trait interactions
interface TraitInteraction {
  traits: (keyof PersonalityTraits)[];
  effect: number;
}

interface Suggestion {
  text: string;
  weight: (traits: PersonalityTraits) => number;
}

interface EnhancedSuggestion extends Suggestion {
  traitInteractions?: TraitInteraction[];
  avoidanceTraits?: {
    [K in keyof PersonalityTraits]?: number;
  };
}

// Ensure a record has all required personality traits
function validatePersonalityTraits(
  traits: Record<string, number>
): PersonalityTraits {
  const requiredTraits = [    "extraversion",    "communication",    "openness",    "values",    "planning",    "sociability",    "agreeableness",    "conscientiousness",    "neuroticism",    "self_consciousness",    "introversion",  ];

  const validatedTraits = {} as PersonalityTraits;

  for (const trait of requiredTraits) {
    validatedTraits[trait as keyof PersonalityTraits] = traits[trait] ?? 0.5;
  }

  return validatedTraits;
}

// Weighted calculation function with trait interactions
function calculateWeight(
  traits: PersonalityTraits,
  suggestion: EnhancedSuggestion
): { weight: number; confidence: number } {
  let baseWeight = suggestion.weight(traits);
  let interactionBonus = 0;
  let confidenceScore = 0.7; // Base confidence

  // Calculate interaction effects
  if (suggestion.traitInteractions) {
    suggestion.traitInteractions.forEach((interaction) => {
      const interactionScore = interaction.traits.reduce(
        (acc, trait) => acc * traits[trait],
        1
      );
      interactionBonus += interactionScore * interaction.effect;
      // Boost confidence based on strong matches, up to a point
      confidenceScore += 0.1 * Math.min(interactionScore, 1);
    });
  }

  // Apply negative weights for traits to avoid
  if (suggestion.avoidanceTraits) {
    Object.entries(suggestion.avoidanceTraits).forEach(([trait, threshold]) => {
      if (traits[trait as keyof PersonalityTraits] > threshold) {
        baseWeight *= 0.5; // Reduce weight for undesirable trait combos
        confidenceScore -= 0.1; // Slightly reduce confidence
      }
    });
  }

  // Normalize final weight and confidence
  const finalWeight = Math.max(0, Math.min(1, baseWeight + interactionBonus));
  const finalConfidence = Math.max(0.3, Math.min(1, confidenceScore));

  return { weight: finalWeight, confidence: finalConfidence };
}

// Enhanced personality suggestions
export const enhancedPersonalitySuggestions: EnhancedSuggestion[] = [
  {
    text: "What's your favorite way to spend a weekend?",
    weight: (traits) =>
      (traits.extraversion + traits.sociability + traits.communication) / 3,
    traitInteractions: [
      {
        traits: ["extraversion", "sociability", "communication"],
        effect: 0.15,
      },
    ],
    avoidanceTraits: {
      neuroticism: 0.65,
      self_consciousness: 0.75,
      introversion: 0.7,
    },
  },
  {
    text: "What's a topic you'd like to learn more about?",
    weight: (traits) =>
      (traits.openness + traits.planning + traits.values) / 3,
    traitInteractions: [
      {
        traits: ["openness", "planning", "values"],
        effect: 0.2,
      },
    ],
    avoidanceTraits: {
      neuroticism: 0.75,
      self_consciousness: 0.8,
      introversion: 0.6,
    },
  },
  {
    text: "What's a mistake you've learned from?",
    weight: (traits) => (traits.planning + traits.conscientiousness) / 2,
    traitInteractions: [
      {
        traits: ["planning", "conscientiousness"],
        effect: 0.2,
      },
    ],
    avoidanceTraits: {
      neuroticism: 0.7,
      self_consciousness: 0.85,
    },
  },
  {
    text: "What's a small thing that brightens your day?",
    weight: (traits) =>
      (traits.extraversion + traits.communication + traits.agreeableness) / 3,
    traitInteractions: [
      {
        traits: ["extraversion", "communication", "agreeableness"],
        effect: 0.15,
      },
    ],
    avoidanceTraits: {
      neuroticism: 0.6,
      self_consciousness: 0.8,
      introversion: 0.65,
    },
  },
  {
    text: "What's an adventure you've always wanted to go on?",
    weight: (traits) =>
      (traits.planning + traits.extraversion + traits.openness) / 3,
    traitInteractions: [
      {
        traits: ["planning", "extraversion", "openness"],
        effect: 0.25,
      },
    ],
    avoidanceTraits: {
      neuroticism: 0.8,
      self_consciousness: 0.7,
      introversion: 0.75,
    },
  },
  {
    text: "What kind of volunteer work or community service do you find meaningful?",
    weight: (traits) =>
      (traits.values + traits.agreeableness + traits.communication) / 3,
    traitInteractions: [
      {
        traits: ["values", "agreeableness"],
        effect: 0.2,
      },
    ],
    avoidanceTraits: {
      neuroticism: 0.65,
      self_consciousness: 0.75,
      introversion: 0.7,
    },
  },
  {
    text: "How do you approach problem-solving in daily life?",
    weight: (traits) => (traits.conscientiousness + traits.planning) / 2,
    traitInteractions: [
      {
        traits: ["conscientiousness", "planning"],
        effect: 0.15,
      },
    ],
    avoidanceTraits: {
      neuroticism: 0.6,
      self_consciousness: 0.8,
      introversion: 0.8,
    },
  },
  {
    text: "What's your strategy for staying motivated when tasks get tough?",
    weight: (traits) =>
      (traits.values + traits.conscientiousness + traits.agreeableness) / 3,
    traitInteractions: [
      {
        traits: ["values", "conscientiousness"],
        effect: 0.2,
      },
    ],
    avoidanceTraits: {
      neuroticism: 0.8,
      self_consciousness: 0.7,
      introversion: 0.65,
    },
  },
  {
    text: "In what ways do you like to express creativity?",
    weight: (traits) => (traits.openness + traits.communication) / 2,
    traitInteractions: [
      {
        traits: ["openness", "communication"],
        effect: 0.25,
      },
    ],
    avoidanceTraits: {
      neuroticism: 0.7,
      self_consciousness: 0.75,
      introversion: 0.65,
    },
  },
  {
    text: "What does friendship mean to you?",
    weight: (traits) =>
      (traits.sociability + traits.values + traits.agreeableness) / 3,
    traitInteractions: [
      {
        traits: ["sociability", "values"],
        effect: 0.2,
      },
    ],
    avoidanceTraits: {
      neuroticism: 0.65,
      self_consciousness: 0.8,
      introversion: 0.7,
    },
  },
];

// Enhanced suggestion generator using trait interaction logic
export function generateEnhancedChatSuggestions(
  userTraits: Record<string, number>,
  otherTraits: Record<string, number>,
  userInterests: Interest[],
  otherInterests: Interest[]
): { text: string; confidence: number }[] {
  const validatedUserTraits = validatePersonalityTraits(userTraits);
  const validatedOtherTraits = validatePersonalityTraits(otherTraits);

  const weightedSuggestions = enhancedPersonalitySuggestions.map(
    (suggestion) => {
      const userScore = calculateWeight(validatedUserTraits, suggestion);
      const otherScore = calculateWeight(validatedOtherTraits, suggestion);

      return {
        text: suggestion.text,
        weight: (userScore.weight + otherScore.weight) / 2,
        confidence: (userScore.confidence + otherScore.confidence) / 2,
      };
    }
  );

  return weightedSuggestions
    .filter((s) => s.weight > 0)
    .sort((a, b) => b.weight - a.weight)
    .map(({ text, confidence }) => ({ text, confidence }))
    .slice(0, 10);
}

// Base event suggestions (optional, or you can remove if you don't need event generation)
const BASE_EVENT_SUGGESTIONS = [
  {
    title: "Coffee Chat",
    description: "Meet up for coffee and conversation",
    type: "casual" as const,
  },
  {
    title: "Nature Walk",
    description: "Take a relaxing walk in nature",
    type: "outdoor" as const,
  },
  {
    title: "Museum Visit",
    description: "Explore art and culture together",
    type: "cultural" as const,
  },
  {
    title: "Board Game Caf",
    description: "Play games and enjoy snacks",
    type: "entertainment" as const,
  },
  {
    title: "Local Market",
    description: "Explore local vendors and foods",
    type: "shopping" as const,
  },
  {
    title: "Cooking Class",
    description: "Learn to cook something new together",
    type: "learning" as const,
  },
  {
    title: "Art Gallery",
    description: "Appreciate art and discuss perspectives",
    type: "cultural" as const,
  },
  {
    title: "Fitness Class",
    description: "Try a new workout together",
    type: "active" as const,
  },
  {
    title: "Picnic in the Park",
    description: "Enjoy food and good company outdoors",
    type: "outdoor" as const,
  },
  {
    title: "Live Music Show",
    description: "Experience live music together",
    type: "entertainment" as const,
  },
  {
    title: "Volunteer Event",
    description: "Give back to the community together",
    type: "community" as const,
  },
  {
    title: "Book Club Meeting",
    description: "Discuss a book you've all read",
    type: "learning" as const,
  },
  {
    title: "Pottery Class",
    description: "Get creative with clay",
    type: "creative" as const,
  },
  {
    title: "Wine Tasting",
    description: "Sample different wines and socialize",
    type: "social" as const,
  },
  {
    title: "Brewery Tour",
    description: "Learn about beer making and sample craft brews",
    type: "social" as const,
  },
  {
    title: "Stargazing Night",
    description: "Observe the night sky and learn about astronomy",
    type: "outdoor" as const,
  },
  {
    title: "Movie Night",
    description: "Watch a movie together at home or in a theater",
    type: "entertainment" as const,
  },
  {
    title: "Karaoke Night",
    description: "Sing your favorite songs and have fun",
    type: "entertainment" as const,
  },
  {
    title: "Escape Room",
    description: "Test your teamwork and problem-solving skills",
    type: "challenge" as const,
  },
  {
    title: "Improv Show",
    description: "Enjoy spontaneous and comedic performances",
    type: "entertainment" as const,
  },
  {
    title: "Botanical Garden Visit",
    description: "Explore diverse plant life and beautiful gardens",
    type: "outdoor" as const,
  },
  {
    title: "Beach Day",
    description: "Relax by the water, swim, or play beach games",
    type: "outdoor" as const,
  },
  {
    title: "Language Exchange Meetup",
    description: "Practice different languages and meet new people",
    type: "learning" as const,
  },
  {
    title: "Coding Workshop",
    description: "Learn basic coding skills or work on a coding project",
    type: "learning" as const,
  },
  {
    title: "Photography Walk",
    description: "Explore the city or nature and capture beautiful photos",
    type: "creative" as const,
  },
  {
    title: "Game Night (Video Games)",
    description: "Play video games together, online or in person",
    type: "entertainment" as const,
  },
  {
    title: "Meditation Session",
    description: "Practice mindfulness and relaxation techniques",
    type: "wellness" as const,
  },
  {
    title: "Yoga Class",
    description: "Improve flexibility and find inner peace",
    type: "wellness" as const,
  },
  {
    title: "Local Festival",
    description: "Experience local culture and traditions",
    type: "community" as const,
  },
  {
    title: "Open Mic Night",
    description: "Showcase your talents or enjoy local performances",
    type: "entertainment" as const,
  },
] as const;

type EventType = typeof BASE_EVENT_SUGGESTIONS[number]["type"];
type EventSuggestion = {
  title: string;
  description: string;
  type: EventType;
  weight?: (traits: PersonalityTraits) => number;
};

// Example personality-based events
const personalityEventSuggestions: EventSuggestion[] = [
  {
    title: "Social Meetup",
    description: "Join a local group activity",
    type: "entertainment",
    weight: (traits) => traits.extraversion * traits.sociability,
  },
  {
    title: "Creative Workshop",
    description: "Create something unique together",
    type: "creative",
    weight: (traits) => traits.openness * traits.communication,
  },
  {
    title: "Puzzle Room",
    description: "Solve challenges together",
    type: "challenge",
    weight: (traits) => traits.planning,
  },
];

// Helper function to get personality-based events (optional)
function getPersonalityBasedEvents(traits: PersonalityTraits): EventSuggestion[] {
  return personalityEventSuggestions
    .map((event) => ({
      ...event,
      score: event.weight ? event.weight(traits) : 0,
    }))
    .filter((event) => event.score > 0)
    .sort((a, b) => b.score - a.score)
    .map((event) => ({
      title: event.title,
      description: event.description,
      type: event.type,
    }));
}

interface FormattedSuggestion {
  text: string;
  type: 'event' | 'conversation';
  rawTitle?: string;  // Store the original unformatted title
  context?: {
    eventType?: EventType;
    requiresArticle?: boolean;
    isFormatted?: boolean;  // Flag to prevent double formatting
  };
}

// Helper function to format event suggestions
function formatEventSuggestion(title: string, type: EventType): FormattedSuggestion {
  // Clean the title - remove parenthetical descriptions and extra spaces
  const cleanTitle = title
    .replace(/\s*\([^)]*\)/g, '')  // Remove parenthetical descriptions
    .replace(/\s+/g, ' ')          // Normalize spaces
    .trim();
  
  // Determine if the title needs an article
  const needsArticle = !cleanTitle.toLowerCase().startsWith('the') && 
                      !type.match(/^(outdoor|active)$/) &&
                      !cleanTitle.toLowerCase().match(/^(beach|park|local|online)/);
  
  return {
    text: cleanTitle,
    type: 'event',
    rawTitle: cleanTitle,
    context: {
      eventType: type,
      requiresArticle: needsArticle,
      isFormatted: false
    }
  };
}

// Enhanced event suggestions generator
export async function generateEventSuggestions(
  userTraits: Record<string, number>,
  otherTraits: Record<string, number>,
  userInterests: Interest[],
  otherInterests: Interest[]
): Promise<{ title: string; description: string; reasoning: string }[]> {
  console.log('Generating event suggestions with traits:', { userTraits, otherTraits });
  
  // Only use AI-generated suggestions, no fallbacks
  const aiSuggestions = await generateAIEventSuggestions(userTraits, otherTraits);
  console.log('AI generated suggestions:', aiSuggestions);
  
  if (!aiSuggestions || aiSuggestions.length === 0) {
    throw new Error('Failed to generate AI suggestions');
  }

  return aiSuggestions;
}

// Function to craft a personalized message
export function craftPersonalizedMessage(
  suggestion: FormattedSuggestion | string,
  userTraits: Record<string, number>,
  otherTraits: Record<string, number>
): string {
  const validatedUserTraits = validatePersonalityTraits(userTraits);
  
  // Handle string input for backward compatibility
  if (typeof suggestion === 'string') {
    suggestion = { 
      text: suggestion, 
      type: 'conversation',
      context: { isFormatted: false }
    };
  }

  // If the suggestion has already been formatted, return it as is
  if (suggestion.context?.isFormatted) {
    return suggestion.text;
  }

  let message = suggestion.text;

  if (suggestion.type === 'event') {
    // Clean up the title - remove parenthetical descriptions
    message = message.replace(/\s*\([^)]*\)/g, '').trim();
    
    // Handle event suggestions
    const needsArticle = suggestion.context?.requiresArticle ?? true;
    const article = needsArticle ? 
      (/^[aeiou]/i.test(message.toLowerCase()) ? 'an' : 'a') : 
      '';
    
    // Format based on event type and traits with proper grammar
    const introVariations = [
      "Would you like to go to",
      "How about we check out",
      "I was thinking we could visit",
      "Would you be interested in going to",
      "What do you think about going to"
    ];
    
    const randomIntro = introVariations[Math.floor(Math.random() * introVariations.length)];
    message = `${randomIntro} ${article ? `${article} ` : ''}${message.toLowerCase()}`;
  } else {
    // Handle conversation starters with more natural variations
    const shouldPersonalize = Math.random() > 0.7; // Only personalize 30% of the time
    
    if (shouldPersonalize) {
      if (validatedUserTraits.communication > 0.7) {
        const variations = [
          (msg: string) => msg,
          (msg: string) => msg.startsWith("What's") ? msg.replace(/^What's/, "I'd love to hear about") : msg,
          (msg: string) => msg.startsWith("How about") ? msg.replace(/^How about/, "I was thinking maybe") : msg
        ];
        const randomVariation = variations[Math.floor(Math.random() * variations.length)];
        message = randomVariation(message);
      }

      if (validatedUserTraits.openness > 0.7 && !message.startsWith("I") && Math.random() > 0.5) {
        if (!message.includes("curious") && !message.includes("Would you")) {
          message = "I'm curious - " + message.charAt(0).toLowerCase() + message.slice(1);
        }
      }

      if (validatedUserTraits.values > 0.7 && !message.includes("value") && Math.random() > 0.7) {
        if ((message.startsWith("What") || message.startsWith("How")) && !message.includes("Would you")) {
          message = "I value your perspective on " + message.charAt(0).toLowerCase() + message.slice(1);
        }
      }
    }
  }

  // Ensure proper punctuation and capitalization
  message = message.trim();
  message = message.charAt(0).toUpperCase() + message.slice(1);
  
  // Handle question marks
  if (!message.endsWith("?")) {
    message += "?";
  }

  // Clean up any formatting issues
  message = message
    .replace(/\s+/g, " ")           // Remove extra spaces
    .replace(/\?+/g, "?")           // Remove multiple question marks
    .replace(/\s+\?/g, "?")         // Remove space before question mark
    .replace(/\s+!/g, "!")          // Remove space before exclamation mark
    .replace(/[,.!?]+\?/g, "?")     // Clean up multiple punctuation
    .replace(/\s+(to|for|at)\s+to\s+/, " to ")  // Fix double prepositions
    .replace(/would you (?:like|be interested in) would you/i, "would you")  // Fix double "would you"
    .replace(/go to go to/i, "go to")  // Fix double "go to"
    .replace(/would you like to would you like to/i, "would you like to")  // Fix specific double phrase
    .replace(/would you be interested in would you be interested in/i, "would you be interested in")  // Fix another double phrase
    .replace(/would you like to would you be interested in/i, "would you like to")  // Fix mixed format
    .replace(/would you be interested in would you like to/i, "would you be interested in")  // Fix reverse mixed format
    .replace(/(?:would you like to|would you be interested in)\s+(?:would you like to|would you be interested in)/i, (match) => {
      // Keep the first occurrence of either phrase
      return match.toLowerCase().startsWith('would you like to') ? 'would you like to' : 'would you be interested in';
    })
    .trim();

  // Ensure proper capitalization after cleanup
  message = message.charAt(0).toUpperCase() + message.slice(1);

  // Mark as formatted to prevent double processing
  if (typeof suggestion === 'object') {
    suggestion.context = { ...suggestion.context, isFormatted: true };
  }

  return message;
}

export { generateEventConversationStarter } from './openai';
</file>

<file path="server/vite.ts">
import express, { type Express } from "express";
import fs from "fs";
import path, { dirname } from "path";
import { fileURLToPath } from "url";
import { createServer as createViteServer, createLogger } from "vite";
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
import { type Server } from "http";
import viteConfig from "../vite.config";

const viteLogger = createLogger();

export function log(message: string, source = "express") {
  const formattedTime = new Date().toLocaleTimeString("en-US", {
    hour: "numeric",
    minute: "2-digit",
    second: "2-digit",
    hour12: true,
  });

  console.log(`${formattedTime} [${source}] ${message}`);
}

export async function setupVite(app: Express, server: Server) {
  const vite = await createViteServer({
    ...viteConfig,
    configFile: false,
    customLogger: {
      ...viteLogger,
      error: (msg, options) => {
        if (
          msg.includes("[TypeScript] Found 0 errors. Watching for file changes")
        ) {
          log("no errors found", "tsc");
          return;
        }

        if (msg.includes("[TypeScript] ")) {
          const [errors, summary] = msg.split("[TypeScript] ", 2);
          log(`${summary} ${errors}\u001b[0m`, "tsc");
          return;
        } else {
          viteLogger.error(msg, options);
          process.exit(1);
        }
      },
    },
    server: {
      middlewareMode: true,
      hmr: { server },
    },
    appType: "custom",
  });

  app.use(vite.middlewares);
  app.use("*", async (req, res, next) => {
    const url = req.originalUrl;

    // Skip API routes
    if (url.startsWith('/api')) {
      return next();
    }

    try {
      const clientTemplate = path.resolve(
        __dirname,
        "..",
        "client",
        "index.html",
      );

      // always reload the index.html file from disk incase it changes
      const template = await fs.promises.readFile(clientTemplate, "utf-8");
      const page = await vite.transformIndexHtml(url, template);
      res.status(200).set({ "Content-Type": "text/html" }).end(page);
    } catch (e) {
      vite.ssrFixStacktrace(e as Error);
      next(e);
    }
  });
}

export function serveStatic(app: Express) {
  const distPath = path.resolve(__dirname, "public");

  if (!fs.existsSync(distPath)) {
    throw new Error(
      `Could not find the build directory: ${distPath}, make sure to build the client first`,
    );
  }

  app.use(express.static(distPath));

  // Skip API routes in static serving as well
  app.use("*", (req, res, next) => {
    if (req.originalUrl.startsWith('/api')) {
      return next();
    }
    res.sendFile(path.resolve(distPath, "index.html"));
  });
}
</file>

<file path="Pasted--vite-connecting-vite-connected-Fetching-user-data-User-not-authenticated-Login-succes-1734629553793.txt">
[vite] connecting...
[vite] connected.
Fetching user data...
User not authenticated
Login successful: 
Object {success: true, message: "Login successful", user: {}, ok: true}
Fetching user data...
User data fetched: 
Object {id: 1, username: "jmartens10@gmail.com", password: "f97f581dcb23d3cd9b98c1f24b2ed95fe4cad17a5e982f3fa234bb184e857e90d0222f28c9d34fd41ceae7471c8ca9f1a26", name: "Gadsdencode", bio: "dev", }
avatar: "/default-avatar.png"
bio: "dev"
createdAt: "2024-12-16T00:19:54.704Z"
id: 1
isGroupCreator: true
lastRewardClaimed: null
level: 1
name: "Gadsdencode"
password: "f97f581dcb23d3cd9b98c1f24b2ed95fe4cad17a5e982f3fa234bb184e857e90d0222f28c9d34fd41ceae7471c8ca9f1a26f432200c1b55b3c044b6cc8d11b64.28f0dffd3234bd76bec9172ef8e6181c"
personalityTraits: Object
quizCompleted: true
username: "jmartens10@gmail.com"
xp: 0
[[Prototype]]: Object
No auth token found
Matches response: 
(4) [{}, {}, {}, {}]
No auth token found when attempting to connect
at t.value (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:17465)
at new t (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:12630)
at t.value (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:32766)
at https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:34400
Match initiation error: 
Object {error: Error, id: "2", timestamp: "2024-12-19T17:31:59.430Z"}
error: Error
id: "2"
timestamp: "2024-12-19T17:31:59.430Z"
[[Prototype]]: Object

Connect error: 
Error {}
message: "Authentication required"
stack: "Error: Authentication required at connect (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/src/hooks/use-matches.ts:231:15) at handleConnect (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/src/components/MatchCard.tsx:68:30) at HTMLUnknownElement.callCallback2 (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/@fs/home/runner/workspace/node_modules/.vite/deps/chunk-RPCDYKBN.js?v=2128ad29:3674:22) at Object.invokeGuardedCallbackDev (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/@fs/home/runner/workspace/node_modules/.vite/deps/chunk-RPCDYKBN.js?v=2128ad29:3699:24) at invokeGuardedCallback (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/@fs/home/runner/workspace/node_modules/.vite/deps/chunk-RPCDYKBN.js?v=2128ad29:3733:39) at invokeGuardedCallbackAndCatchFirstError (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/@fs/home/runner/workspace/node_modules/.vite/deps/chunk-RPCDYKBN.js?v=2128ad29:3736:33) at executeDispatch (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/@fs/home/runner/workspace/node_modules/.vite/deps/chunk-RPCDYKBN.js?v=2128ad29:7014:11) at processDispatchQueueItemsInOrder (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/@fs/home/runner/workspace/node_modules/.vite/deps/chunk-RPCDYKBN.js?v=2128ad29:7034:15) at processDispatchQueue (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/@fs/home/runner/workspace/node_modules/.vite/deps/chunk-RPCDYKBN.js?v=2128ad29:7043:13) at dispatchEventsForPlugins (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/@fs/home/runner/workspace/node_modules/.vite/deps/chunk-RPCDYKBN.js?v=2128ad29:7051:11)"
get stack:  ()
set stack:  ()
[[Prototype]]: Object
</file>

<file path="Pasted-Match-connection-error-Error-at-t-value-https-7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29-1734627791561.txt">
Match connection error: 
Error {}

at t.value (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:17465)
at new t (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:12630)
at t.value (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:32766)
at https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:34400
Connect error: 
Error {}
message: "Authentication required"
stack: "Error: Authentication required at connect (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/src/hooks/use-matches.ts:230:15) at handleConnect (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/src/components/MatchCard.tsx:50:30) at HTMLUnknownElement.callCallback2 (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/@fs/home/runner/workspace/node_modules/.vite/deps/chunk-RPCDYKBN.js?v=2128ad29:3674:22) at Object.invokeGuardedCallbackDev (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/@fs/home/runner/workspace/node_modules/.vite/deps/chunk-RPCDYKBN.js?v=2128ad29:3699:24) at invokeGuardedCallback (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/@fs/home/runner/workspace/node_modules/.vite/deps/chunk-RPCDYKBN.js?v=2128ad29:3733:39) at invokeGuardedCallbackAndCatchFirstError (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/@fs/home/runner/workspace/node_modules/.vite/deps/chunk-RPCDYKBN.js?v=2128ad29:3736:33) at executeDispatch (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/@fs/home/runner/workspace/node_modules/.vite/deps/chunk-RPCDYKBN.js?v=2128ad29:7014:11) at processDispatchQueueItemsInOrder (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/@fs/home/runner/workspace/node_modules/.vite/deps/chunk-RPCDYKBN.js?v=2128ad29:7034:15) at processDispatchQueue (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/@fs/home/runner/workspace/node_modules/.vite/deps/chunk-RPCDYKBN.js?v=2128ad29:7043:13) at dispatchEventsForPlugins (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/@fs/home/runner/workspace/node_modules/.vite/deps/chunk-RPCDYKBN.js?v=2128ad29:7051:11)"
get stack:  ()
set stack:  ()
[[Prototype]]: Object

at t.value (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:17465)
at new t (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:12630)
at t.value (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:32766)
at https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:34400
Match connection error: 
Error {}
</file>

<file path="Pasted-No-auth-token-found-Matches-response-4-Match-connection-error-Object--1734628291230.txt">
No auth token found
Matches response: 
(4) [{}, {}, {}, {}]
Match connection error: 
Object {status: 400, data: {}, errorMessage: "Invalid request data"}
data: Object
details: Array(1)
message: "Invalid request data"
success: false
timestamp: "2024-12-19T17:11:08.137Z"
[[Prototype]]: Object
constructor:  Object()
hasOwnProperty:  hasOwnProperty()
isPrototypeOf:  isPrototypeOf()
propertyIsEnumerable:  propertyIsEnumerable()
toLocaleString:  toLocaleString()
toString:  toString()
valueOf:  valueOf()
__defineGetter__:  __defineGetter__()
__defineSetter__:  __defineSetter__()
__lookupGetter__:  __lookupGetter__()
__lookupSetter__:  __lookupSetter__()
__proto__: Object
get __proto__:  get __proto__()
set __proto__:  set __proto__()
errorMessage: "Invalid request data"
status: 400
[[Prototype]]: Object

at t.value (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:17465)
at new t (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:12630)
at t.value (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:32766)
at https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:34400
Match connection error: 
Error {}
message: "Invalid request data"
stack: "Error: Invalid request data at connect (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/src/hooks/use-matches.ts:259:15) at async handleConnect (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/src/components/MatchCard.tsx:58:24)"
get stack:  ()
set stack:  ()
[[Prototype]]: Object

Connect error: 
Error {}
message: "Invalid request data"
stack: "Error: Invalid request data at connect (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/src/hooks/use-matches.ts:259:15) at async handleConnect (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/src/components/MatchCard.tsx:58:24)"
get stack:  ()
set stack:  ()
[[Prototype]]: Object
</file>

<file path="Pasted-User-data-fetched-Object-id-1-username-jmartens10-gmail-com-password-f97f581dcb23d3cd9b9-1734628410219.txt">
User data fetched: 
Object {id: 1, username: "jmartens10@gmail.com", password: "f97f581dcb23d3cd9b98c1f24b2ed95fe4cad17a5e982f3fa234bb184e857e90d0222f28c9d34fd41ceae7471c8ca9f1a26", name: "Gadsdencode", bio: "dev", }
avatar: "/default-avatar.png"
bio: "dev"
createdAt: "2024-12-16T00:19:54.704Z"
id: 1
isGroupCreator: true
lastRewardClaimed: null
level: 1
name: "Gadsdencode"
password: "f97f581dcb23d3cd9b98c1f24b2ed95fe4cad17a5e982f3fa234bb184e857e90d0222f28c9d34fd41ceae7471c8ca9f1a26f432200c1b55b3c044b6cc8d11b64.28f0dffd3234bd76bec9172ef8e6181c"
personalityTraits: Object
quizCompleted: true
username: "jmartens10@gmail.com"
xp: 0
[[Prototype]]: Object
No auth token found
Matches response: 
(4) [{}, {}, {}, {}]
Match connection error: 
Object {status: 500, data: {}, errorMessage: "Failed to process match request"}
data: Object
errorMessage: "Failed to process match request"
status: 500
[[Prototype]]: Object

Database schema error: 
Object {length: 175, name: "error", severity: "ERROR", code: "42703", hint: "Perhaps you meant to reference the column "matches.created_at".", }
code: "42703"
file: "parse_relation.c"
hint: "Perhaps you meant to reference the column "matches.created_at"."
length: 175
line: "3729"
name: "error"
position: "73"
routine: "errorMissingColumn"
severity: "ERROR"
[[Prototype]]: Object

Match connection error: 
Error {}
message: "Server configuration error. Please try again later."
stack: "Error: Server configuration error. Please try again later. at connect (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/src/hooks/use-matches.ts:263:17) at async handleConnect (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/src/components/MatchCard.tsx:58:24)"
get stack:  ()
set stack:  ()
[[Prototype]]: Object

at t.value (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:17465)
at new t (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:12630)
at t.value (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:32766)
at https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:34400
Connect error: 
Error {}
</file>

<file path="Pasted-vite-connecting-vite-connected-Fetching-user-data-User-data-fetched-Object-id-1-u-1734653429020.txt">
vite] connecting...
[vite] connected.
Fetching user data...
User data fetched: 
Object {id: 1, username: "jmartens10@gmail.com", password: "f97f581dcb23d3cd9b98c1f24b2ed95fe4cad17a5e982f3fa234bb184e857e90d0222f28c9d34fd41ceae7471c8ca9f1a26", name: "Gadsdencode", bio: "dev", }
No auth token found
Matches response: 
(4) [{}, {}, {}, {}]
No auth token found when attempting to connect
at t.value (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:17465)
at new t (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:12630)
at t.value (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:32766)
at https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:34400
Match initiation error: 
Object {error: Error, id: "2", timestamp: "2024-12-20T00:09:56.297Z"}

at t.value (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:17465)
at new t (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:12630)
at t.value (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:32766)
at https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:34400
Connect error: 
Error {}

at t.value (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:17465)
at new t (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:12630)
at t.value (https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:32766)
at https://7975dfb1-a3db-4ca1-95e5-67899b0ac80d-00-29g2iqzdk1oys.riker.replit.dev/__replco/static/devtools/eruda/3.2.3/eruda.js:2:34400
</file>

<file path="client/src/components/match-requests.tsx">
import { Match } from '@/hooks/use-matches';
import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { formatDistanceToNow } from 'date-fns';
import { AlertCircle, Loader2, User } from 'lucide-react';
import { useState } from 'react';
import { toast } from '@/hooks/use-toast';

interface MatchRequestsProps {
  requests: Match[];
  isResponding: boolean;
  onRespond: ({ matchId, status }: { matchId: number; status: 'accepted' | 'rejected' }) => void;
}

export function MatchRequests({ requests, isResponding, onRespond }: MatchRequestsProps) {
  const [processedRequests, setProcessedRequests] = useState<Record<number, boolean>>({});
  const [processingId, setProcessingId] = useState<number | null>(null);

  const handleResponse = async (matchId: number, status: 'accepted' | 'rejected') => {
    if (processedRequests[matchId] || processingId !== null) {
      return; // Prevent duplicate responses or concurrent processing
    }

    try {
      setProcessingId(matchId);
      setProcessedRequests(prev => ({ ...prev, [matchId]: true }));
      
      await onRespond({ matchId, status });

      // Keep the processed state
      setProcessedRequests(prev => ({ ...prev, [matchId]: true }));
      
      toast({
        title: status === 'accepted' ? 'Match Accepted!' : 'Request Declined',
        description: status === 'accepted' 
          ? 'You can now start chatting with your new match!' 
          : 'The match request has been declined.',
        variant: status === 'accepted' ? 'default' : 'destructive'
      });
    } catch (error) {
      console.error('Failed to respond to match request:', error);
      // Reset the processed state only on error
      setProcessedRequests(prev => ({ ...prev, [matchId]: false }));

      // Show more specific error messages
      let errorMessage = 'An unexpected error occurred';
      if (error instanceof Error) {
        if (error.message.includes('Session expired')) {
          errorMessage = 'Your session has expired. Please log in again.';
        } else if (error.message.includes('no longer available')) {
          errorMessage = 'This match request is no longer available.';
        } else {
          errorMessage = error.message;
        }
      }

      toast({
        title: 'Failed to Process Request',
        description: errorMessage,
        variant: 'destructive'
      });
    } finally {
      setProcessingId(null);
    }
  };

  if (!Array.isArray(requests)) {
    console.error('Invalid requests prop:', requests);
    return (
      <div className="text-center text-muted-foreground p-8 bg-card rounded-lg border">
        <AlertCircle className="h-12 w-12 mx-auto mb-4 text-destructive" />
        <p className="text-lg font-medium">Error Loading Requests</p>
        <p className="text-sm text-muted-foreground mt-2">
          Please try refreshing the page
        </p>
      </div>
    );
  }

  if (requests.length === 0) {
    return (
      <div className="text-center text-muted-foreground p-8 bg-card rounded-lg border">
        <User className="h-12 w-12 mx-auto mb-4 opacity-50" />
        <p className="text-lg font-medium">No pending match requests</p>
        <p className="text-sm text-muted-foreground mt-2">
          When someone wants to connect, their request will appear here
        </p>
      </div>
    );
  }

  return (
    <div className="space-y-4">
      {requests.map((request) => {
        const isProcessing = processingId === request.id;
        const isDisabled = isResponding || processedRequests[request.id] || processingId !== null;

        return (
          <Card key={request.id} className="p-4">
            <div className="flex items-start gap-4">
              <Avatar>
                <AvatarImage
                  src={request.avatar}
                  alt={request.name || 'User avatar'}
                />
                <AvatarFallback>
                  <User className="h-6 w-6" />
                </AvatarFallback>
              </Avatar>
              <div className="flex-1">
                <div className="flex justify-between items-start">
                  <div>
                    <h4 className="font-semibold">{request.name}</h4>
                    <p className="text-sm text-muted-foreground">
                      @{request.username}
                    </p>
                  </div>
                  <div className="text-sm text-muted-foreground">
                    {formatDistanceToNow(new Date(request.createdAt), { addSuffix: true })}
                  </div>
                </div>

                <div className="mt-4 flex gap-2">
                  <Button
                    variant="default"
                    disabled={isDisabled}
                    onClick={() => handleResponse(request.id, 'accepted')}
                    className="relative"
                  >
                    {isProcessing && (
                      <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                    )}
                    Accept
                  </Button>
                  <Button
                    variant="outline"
                    disabled={isDisabled}
                    onClick={() => handleResponse(request.id, 'rejected')}
                    className="relative"
                  >
                    {isProcessing && (
                      <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                    )}
                    Decline
                  </Button>
                </div>
              </div>
            </div>
          </Card>
        );
      })}
    </div>
  );
}
</file>

<file path="client/src/hooks/use-achievements.ts">
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useToast } from '@/hooks/use-toast';
import type { 
  AchievementDefinition, 
  UserAchievementProgress, 
  AchievementCategory 
} from '@db/schema';

interface AchievementProgress {
  achievements: AchievementDefinition[];
  userAchievements: UserAchievementProgress[];
  progress: {
    level: number;
    totalPoints: number;
    sections: Record<string, boolean>;
  };
}

interface ProgressUpdate {
  section: string;
  value: boolean;
}

// XP calculation constants
const BASE_XP_REQUIREMENT = 1000;
const XP_SCALING_FACTOR = 1.5;

export function useAchievements() {
  const queryClient = useQueryClient();
  const { toast } = useToast();

  const { data, isLoading, error } = useQuery<AchievementProgress>({
    queryKey: ['/api/achievements'],
    queryFn: async () => {
      const response = await fetch('/api/achievements', {
        credentials: 'include',
      });

      if (!response.ok) {
        if (response.status === 401) {
          throw new Error('Please log in to view achievements');
        }
        throw new Error(await response.text());
      }

      return response.json();
    },
    retry: (failureCount, error) => {
      if (error.message.includes('Please log in')) {
        return false;
      }
      return failureCount < 3;
    },
    staleTime: 30000,
    refetchOnWindowFocus: false,
  });

  const updateProfileMutation = useMutation({
    mutationFn: async (update: ProgressUpdate) => {
      const response = await fetch('/api/profile/progress', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          section: update.section,
          completed: update.value
        }),
        credentials: 'include',
      });

      if (!response.ok) {
        throw new Error(await response.text());
      }

      const data = await response.json();
      
      if (data.newAchievements?.length > 0) {
        data.newAchievements.forEach((achievement: AchievementDefinition) => {
          toast({
            title: ` Achievement Unlocked: ${achievement.name}`,
            description: `${achievement.description} (+${achievement.points} XP)`,
            duration: 5000,
          });
        });
      }

      if (data.levelUp) {
        toast({
          title: ' Level Up!',
          description: `Congratulations! You've reached level ${data.newLevel}`,
          duration: 5000,
        });
      }

      return data;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['/api/achievements'] });
      queryClient.invalidateQueries({ queryKey: ['/api/user'] });
    },
    onError: (error: Error) => {
      toast({
        title: 'Error updating progress',
        description: error.message,
        variant: 'destructive',
      });
    },
  });

  const calculateXpForNextLevel = (currentLevel: number): number => {
    return Math.round(BASE_XP_REQUIREMENT * Math.pow(XP_SCALING_FACTOR, currentLevel - 1));
  };

  const calculateProgress = () => {
    if (!data?.progress?.sections) return 0;
    
    // Define weights for different section types
    const sectionWeights: Record<string, number> = {
      profileComplete: 1.5,  // Higher weight for profile completion
      bioAdded: 1.2,        // Moderate weight for bio
      avatarUploaded: 1.0,  // Standard weight for avatar
    };

    const sections = Object.entries(data.progress.sections);
    let totalWeight = 0;
    let completedWeight = 0;

    sections.forEach(([sectionKey, isComplete]) => {
      const weight = sectionWeights[sectionKey] || 1.0;
      totalWeight += weight;
      if (isComplete) {
        completedWeight += weight;
      }
    });

    return Math.round((completedWeight / totalWeight) * 100);
  };

  const getUnlockedAchievements = () => {
    return data?.userAchievements || [];
  };

  const getLockedAchievements = () => {
    if (!data?.achievements || !data?.userAchievements) return [];
    
    const unlockedIds = new Set(data.userAchievements.map(ua => ua.achievementId));
    return data.achievements.filter(a => !unlockedIds.has(a.id));
  };

  const getTotalPossibleXp = () => {
    if (!data?.achievements) return 0;
    return data.achievements.reduce((total, achievement) => total + achievement.points, 0);
  };

  const getAchievementsByCategory = (category: AchievementCategory) => {
    return data?.achievements.filter(a => a.category === category) || [];
  };

  return {
    achievements: data?.achievements || [],
    unlockedAchievements: getUnlockedAchievements(),
    lockedAchievements: getLockedAchievements(),
    progress: data?.progress,
    isLoading,
    error,
    totalProgress: calculateProgress(),
    updateProgress: updateProfileMutation.mutateAsync,
    calculateXpForNextLevel,
    totalPossibleXp: getTotalPossibleXp(),
    getAchievementsByCategory,
  };
}
</file>

<file path="client/src/pages/CreateMatch.tsx">
import { useEffect } from "react";
import { useLocation } from "wouter";
import { useMatches } from "@/hooks/use-matches";
import CreateMatchWizard from "@/components/CreateMatchWizard";
import { useToast } from "@/hooks/use-toast";
import { Loader2 } from "lucide-react";
import { useQuery } from "@tanstack/react-query";

export default function CreateMatchPage() {
  const [location, setLocation] = useLocation();
  const { toast } = useToast();
  const searchParams = new URLSearchParams(window.location.search);
  const matchId = searchParams.get('id');

  // Use React Query to handle the match existence check
  const { isLoading, error } = useQuery({
    queryKey: ['match', matchId],
    queryFn: async () => {
      if (!matchId) return null;
      
      try {
        const response = await fetch(`/api/matches/${matchId}`, {
          credentials: 'include'
        });
        
        if (response.status === 404) {
          return null;
        }
        
        if (!response.ok) {
          throw new Error('Failed to check match');
        }
        
        const match = await response.json();
        if (match) {
            // Handle different match statuses
            switch (match.status) {
              case 'accepted':
                setLocation(`/chat/${match.id}`);
                toast({
                  title: "Match Active",
                  description: "Redirecting to your chat...",
                });
                break;
              case 'requested':
              case 'pending':
                setLocation('/matches');
                toast({
                  title: "Match Request Pending",
                  description: "You already have a pending request with this user.",
                });
                break;
              default:
                setLocation('/matches');
            }
          }
          return match;
      } catch (err) {
        throw err;
      }
    },
    enabled: !!matchId, // Only run query if matchId exists
    retry: false,
    staleTime: 30000,
    refetchOnWindowFocus: false
  });

  if (error && !error.message?.includes('Match not found')) {
    toast({
      title: "Error",
      description: error.message,
      variant: "destructive",
    });
  }

  // Only show loading spinner if we're checking an existing match
  if (matchId && isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Loader2 className="h-8 w-8 animate-spin text-primary" />
      </div>
    );
  }

  return (
    <div className="container mx-auto p-4">
      <CreateMatchWizard
        initialMatchId={matchId}
        onComplete={() => setLocation("/matches")}
        onCancel={() => setLocation("/matches")}
      />
    </div>
  );
}
</file>

<file path="client/src/utils/auth.ts">
// Store user data in localStorage for persistence
const USER_ID_KEY = 'user_id';
const USER_DATA_KEY = 'user_data';

interface UserData {
  id: number;
  username: string;
  name: string | null;
  avatar?: string;
  isGroupCreator: boolean;
  quizCompleted: boolean;
}

// Get the user ID from localStorage
export function getUserId(): number | null {
  try {
    const userId = localStorage.getItem(USER_ID_KEY);
    return userId ? parseInt(userId, 10) : null;
  } catch (error) {
    console.error('Error accessing user ID:', error);
    return null;
  }
}

// Get the full user data from localStorage
export function getUserData(): UserData | null {
  try {
    const userData = localStorage.getItem(USER_DATA_KEY);
    return userData ? JSON.parse(userData) : null;
  } catch (error) {
    console.error('Error accessing user data:', error);
    return null;
  }
}

// Set the user ID
export function setUserId(id: number | undefined | null): void {
  try {
    if (id === undefined || id === null) {
      localStorage.removeItem(USER_ID_KEY);
      return;
    }
    localStorage.setItem(USER_ID_KEY, id.toString());
  } catch (error) {
    console.error('Error setting user ID:', error);
  }
}

// Set the full user data
export function setUserData(data: Partial<UserData> | null): void {
  try {
    if (!data) {
      localStorage.removeItem(USER_DATA_KEY);
      return;
    }
    const currentData = getUserData();
    const newData = {
      ...currentData,
      ...data,
      id: data.id || currentData?.id,
      username: data.username || currentData?.username,
      name: data.name || currentData?.name || data.username,
      isGroupCreator: data.isGroupCreator ?? currentData?.isGroupCreator ?? false,
      quizCompleted: data.quizCompleted ?? currentData?.quizCompleted ?? false
    };
    localStorage.setItem(USER_DATA_KEY, JSON.stringify(newData));
  } catch (error) {
    console.error('Error setting user data:', error);
  }
}

// Clear all auth data (for logout)
export function clearAuthData(): void {
  try {
    localStorage.removeItem(USER_ID_KEY);
    localStorage.removeItem(USER_DATA_KEY);
  } catch (error) {
    console.error('Error clearing auth data:', error);
  }
}
</file>

<file path="client/src/utils/stripe.ts">
import { loadStripe } from '@stripe/stripe-js';

let stripePromise: Promise<any>;

export const getStripe = () => {
  if (!stripePromise) {
    if (!process.env.STRIPE_PUBLIC_KEY) {
      throw new Error('STRIPE_PUBLIC_KEY must be set');
    }
    stripePromise = loadStripe(process.env.STRIPE_PUBLIC_KEY);
  }
  return stripePromise;
};

export const createSubscription = async () => {
  try {
    const response = await fetch('/api/create-subscription', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
    });

    if (!response.ok) {
      throw new Error('Subscription request failed');
    }

    const { url } = await response.json();
    window.location.href = url;
  } catch (error) {
    console.error('Subscription error:', error);
    throw error;
  }
};

export const checkSubscriptionStatus = async () => {
  try {
    const response = await fetch('/api/subscription-status');
    if (!response.ok) {
      throw new Error('Failed to check subscription status');
    }
    return response.json();
  } catch (error) {
    console.error('Subscription status check error:', error);
    throw error;
  }
};

export const createPayment = async (amount: number) => {
  try {
    const response = await fetch('/api/create-payment-intent', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ amount }),
    });

    if (!response.ok) {
      throw new Error('Payment request failed');
    }

    const { clientSecret } = await response.json();
    const stripe = await getStripe();
    
    const result = await stripe.confirmPayment({
      clientSecret,
      confirmParams: {
        return_url: `${window.location.origin}/payment-success`,
      },
    });

    if (result.error) {
      throw new Error(result.error.message);
    }

    return result;
  } catch (error) {
    console.error('Payment error:', error);
    throw error;
  }
};
</file>

<file path="server/middleware/auth.ts">
import type { Request, Response, NextFunction } from 'express';
import type { SelectUser } from '@db/schema';

interface AuthenticatedRequest extends Request {
  user: SelectUser;
}

// Middleware to validate user authentication
export function validateUser(req: Request, res: Response, next: NextFunction) {
  // Check if session exists
  if (!req.session) {
    console.error('No session found');
    return res.status(401).json({ error: 'Session expired' });
  }

  // Check if user is authenticated
  if (!req.isAuthenticated() || !req.user) {
    return res.status(401).json({ error: 'Unauthorized' });
  }

  // Ensure user has required properties
  const user = req.user as SelectUser;
  if (!user.id) {
    return res.status(401).json({ error: 'Invalid user session' });
  }

  // Touch the session to prevent expiration
  req.session.touch();
  
  next();
}
</file>

<file path="server/utils/openai.ts">
import OpenAI from "openai";
import { ChatCompletionMessageParam } from "openai/resources/chat/completions";

const openaiClient = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
});

export async function getChatCompletion(messages: ChatCompletionMessageParam[]) {
  if (!process.env.OPENAI_API_KEY) {
    throw new Error("OPENAI_API_KEY is not set");
  }

  try {
    console.log('Making OpenAI request with messages:', JSON.stringify(messages, null, 2));
    
    const completion = await openaiClient.chat.completions.create({
      model: "gpt-4",
      messages,
      temperature: 0.7,
      max_tokens: 1000,
      presence_penalty: 0.3,
      frequency_penalty: 0.3,
      response_format: { type: "text" }
    });

    console.log('OpenAI response:', completion.choices[0].message);
    return completion.choices[0].message.content;
  } catch (error) {
    console.error('Detailed OpenAI error:', error);
    throw error;
  }
}

export async function generateEventSuggestions(
  userPersonality: Record<string, number>,
  matchPersonality: Record<string, number>
): Promise<{ title: string; description: string; reasoning: string }[]> {
  console.log('Generating event suggestions with traits:', {
    userPersonality,
    matchPersonality
  });

  const messages = [
    {
      role: "system" as const,
      content: `You are an expert event matchmaker who creates highly personalized activity suggestions based on personality compatibility.

Generate exactly 3 event suggestions in the following strict format:

EVENT: <title>
DESCRIPTION: <description>
REASONING: Based on User 1's <trait1> (<X>%) and User 2's <trait2> (<Y>%), <reasoning>

===

Rules:
1. Generate EXACTLY 3 suggestions
2. Use EXACTLY the format shown above
3. Include EXACT percentage values from the provided traits
4. Each suggestion MUST have all three sections
5. Do not add any extra text or formatting
6. Keep titles concise and specific
7. Make each suggestion unique
8. Reference specific trait percentages in reasoning

Example of ONE valid suggestion:
EVENT: Coffee and Art Gallery Visit
DESCRIPTION: Explore local art while enjoying refreshments
REASONING: Based on User 1's openness (85%) and User 2's sociability (75%), this combines cultural exploration with casual conversation opportunities.`
    },
    {
      role: "user" as const,
      content: `Generate 3 personalized event suggestions for these users:

User 1 traits: ${Object.entries(userPersonality || {})
  .map(([trait, score]) => `${trait}: ${Math.round(score * 100)}%`)
  .join(", ")}

User 2 traits: ${Object.entries(matchPersonality || {})
  .map(([trait, score]) => `${trait}: ${Math.round(score * 100)}%`)
  .join(", ")}

Remember:
- Generate EXACTLY 3 suggestions
- Follow the EXACT format shown
- Include trait percentages in reasoning
- Make each suggestion unique
- Keep titles concise`
    }
  ];

  try {
    console.log('Sending request to OpenAI...');
    const completion = await getChatCompletion(messages);
    console.log('Raw OpenAI response:', completion);

    if (!completion) {
      throw new Error('No completion received from OpenAI');
    }

    // Split into individual suggestions and process
    const suggestions = completion
      .split(/(?=EVENT:)/)  // Look ahead for EVENT: to preserve the marker
      .filter(suggestion => suggestion.trim().startsWith('EVENT:'))  // Only take valid suggestions
      .map(suggestion => {
        // Extract each section using positive lookbehind
        const titleMatch = suggestion.match(/EVENT:\s*(.+?)(?=\n|$)/);
        const descriptionMatch = suggestion.match(/DESCRIPTION:\s*(.+?)(?=\n|$)/);
        const reasoningMatch = suggestion.match(/REASONING:\s*(.+?)(?=\n|$)/);

        if (!titleMatch?.[1] || !descriptionMatch?.[1] || !reasoningMatch?.[1]) {
          console.error('Invalid suggestion format:', suggestion);
          return null;
        }

        const title = titleMatch[1].trim();
        const description = descriptionMatch[1].trim();
        const reasoning = reasoningMatch[1].trim();

        // Validate reasoning format
        if (!reasoning.toLowerCase().includes('based on') || !reasoning.includes('%')) {
          console.error('Invalid reasoning format:', reasoning);
          return null;
        }

        return {
          title,
          description,
          reasoning
        };
      })
      .filter((s): s is NonNullable<typeof s> => s !== null);

    console.log('Processed suggestions:', suggestions);
    
    if (suggestions.length === 0) {
      throw new Error('Failed to generate valid suggestions. Please try again.');
    }
    
    // Take exactly 3 suggestions
    return suggestions.slice(0, 3);
  } catch (error) {
    console.error("Error generating event suggestions:", error);
    throw error;
  }
}

export async function generateEventConversationStarter(
  eventSuggestion: { title: string; description: string; reasoning: string },
  userPersonality: Record<string, number>,
  matchPersonality: Record<string, number>
): Promise<string> {
  console.log('Generating conversation starter for event:', {
    eventSuggestion,
    userPersonality,
    matchPersonality
  });

  const messages = [
    {
      role: "system" as const,
      content: `You are an expert conversation starter generator that creates engaging, natural-sounding messages for suggesting activities.
      Create a friendly, personalized message that suggests the event while incorporating personality traits.
      
      Rules:
      1. Keep the tone casual and friendly
      2. Reference specific personality traits when relevant
      3. Make it sound natural, not formulaic
      4. Include a brief mention of why this activity would be enjoyable
      5. Frame it as a suggestion, not a demand
      6. Keep it concise but engaging
      
      Example format:
      For an art gallery visit with someone who has high openness (85%) and sociability (75%):
      "Given your appreciation for creative experiences, would you be interested in exploring the local art gallery together? I think it could lead to some fascinating conversations!"`
    },
    {
      role: "user" as const,
      content: `Generate a conversation starter for this event suggestion:

Event: ${eventSuggestion.title}
Description: ${eventSuggestion.description}
Reasoning: ${eventSuggestion.reasoning}

User 1 traits: ${Object.entries(userPersonality || {})
  .map(([trait, score]) => `${trait}: ${Math.round(score * 100)}%`)
  .join(", ")}

User 2 traits: ${Object.entries(matchPersonality || {})
  .map(([trait, score]) => `${trait}: ${Math.round(score * 100)}%`)
  .join(", ")}

Create a natural, engaging message that suggests this activity while considering both users' personality traits.`
    }
  ];

  try {
    console.log('Sending request to OpenAI...');
    const completion = await getChatCompletion(messages);
    console.log('Raw OpenAI response:', completion);

    if (!completion) {
      throw new Error('No conversation starter generated');
    }

    // Clean up the response
    const message = completion
      .trim()
      .replace(/^["']|["']$/g, '')  // Remove quotes if present
      .replace(/\s+/g, ' ');        // Normalize spaces

    if (!message) {
      throw new Error('Empty conversation starter generated');
    }

    return message;
  } catch (error) {
    console.error("Error generating conversation starter:", error);
    throw error;
  }
}
</file>

<file path="client/src/components/ProfileProgress.tsx">
import { Progress } from "@/components/ui/progress";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { useAchievements } from "@/hooks/use-achievements";
import { Star, Trophy, XCircle, Loader2, CheckCircle2, ArrowRight, Medal, Users, Zap, Calendar } from "lucide-react";
import { cn } from "@/lib/utils";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { ScrollArea } from "@/components/ui/scroll-area";
import type { AchievementCategory } from "@db/schema";

const CATEGORY_ICONS: Record<AchievementCategory, React.ReactNode> = {
  profile: <Users className="h-4 w-4" />,
  engagement: <Zap className="h-4 w-4" />,
  social: <Users className="h-4 w-4" />,
  streak: <Calendar className="h-4 w-4" />,
  milestone: <Medal className="h-4 w-4" />,
};

const CATEGORY_NAMES: Record<AchievementCategory, string> = {
  profile: "Profile",
  engagement: "Engagement",
  social: "Social",
  streak: "Streaks",
  milestone: "Milestones",
};

export function ProfileProgress() {
  const { 
    achievements, 
    progress, 
    isLoading, 
    totalProgress, 
    unlockedAchievements, 
    lockedAchievements,
    calculateXpForNextLevel,
    totalPossibleXp,
    getAchievementsByCategory
  } = useAchievements();

  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-32">
        <Loader2 className="h-8 w-8 animate-spin" />
        <div className="text-sm text-white ml-2 border border-white rounded-md p-2 bg-muted">Loading achievements...</div>
      </div>
    );
  }

  if (!progress) {
    return (
      <div className="flex items-center justify-center h-32">
        <div className="text-sm text-white ml-2 border border-white rounded-md p-2 bg-muted">No achievements yet, complete your profile to start earning them!</div>
      </div>
    );
  }

  const nextLevelXp = calculateXpForNextLevel(progress.level);
  const xpProgress = (progress.totalPoints / nextLevelXp) * 100;
  const xpToNext = nextLevelXp - progress.totalPoints;
  const totalXpEarned = progress.totalPoints;
  const percentageOfTotalXp = Math.round((totalXpEarned / totalPossibleXp) * 100);

  // Find the next achievements to focus on (up to 3 locked achievements)
  const nextFocusAchievements = lockedAchievements
    .slice(0, 3)
    .map(achievement => ({
      ...achievement,
      points: achievement.points,
      percentageOfNextLevel: Math.round((achievement.points / xpToNext) * 100)
    }));

  // Calculate category completion percentages
  const categoryProgress = Object.keys(CATEGORY_NAMES).reduce((acc, category) => {
    const categoryAchievements = getAchievementsByCategory(category as AchievementCategory);
    const unlockedCount = unlockedAchievements.filter(ua => 
      categoryAchievements.some(ca => ca.id === ua.achievementId)
    ).length;
    const percentage = Math.round((unlockedCount / categoryAchievements.length) * 100) || 0;
    return { ...acc, [category]: percentage };
  }, {} as Record<string, number>);

  return (
    <div className="space-y-6">
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <Trophy className="h-5 w-5 text-yellow-500" />
              Level {progress.level}
            </div>
            <Badge variant="outline" className="ml-2">
              {percentageOfTotalXp}% of Total XP Earned
            </Badge>
          </CardTitle>
          <div className="mt-2 space-y-1 text-sm text-muted-foreground">
            <div className="flex justify-between items-center">
              <span>Current Progress: {progress.totalPoints.toLocaleString()} / {nextLevelXp.toLocaleString()} XP</span>
              <span>Need {xpToNext.toLocaleString()} XP for Level {progress.level + 1}</span>
            </div>
          </div>
        </CardHeader>
        <CardContent>
          <Progress value={xpProgress} className="h-2" />
          
          <div className="mt-6 space-y-4">
            <div>
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm font-medium">Profile Completion</span>
                <span className="text-sm text-muted-foreground">{totalProgress}%</span>
              </div>
              <Progress value={totalProgress} className="h-2" />
            </div>

            <div className="grid grid-cols-3 gap-4 pt-2">
              <div className="flex flex-col items-center p-3 bg-muted rounded-lg">
                <span className="text-2xl font-bold">{unlockedAchievements.length}</span>
                <span className="text-sm text-muted-foreground">Unlocked</span>
                <span className="text-xs text-muted-foreground">of {achievements.length} Total</span>
              </div>
              <div className="flex flex-col items-center p-3 bg-muted rounded-lg">
                <span className="text-2xl font-bold">{totalXpEarned.toLocaleString()}</span>
                <span className="text-sm text-muted-foreground">Current XP</span>
              </div>
              <div className="flex flex-col items-center p-3 bg-muted rounded-lg">
                <span className="text-2xl font-bold">{totalPossibleXp.toLocaleString()}</span>
                <span className="text-sm text-muted-foreground">Total Possible</span>
              </div>
            </div>

            <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
              {(Object.keys(CATEGORY_NAMES) as AchievementCategory[]).map((category) => (
                <div key={category} className="flex flex-col items-center p-3 bg-muted/50 rounded-lg">
                  <div className="mb-2 text-muted-foreground">
                    {CATEGORY_ICONS[category]}
                  </div>
                  <div className="text-center">
                    <div className="text-sm font-medium">{CATEGORY_NAMES[category]}</div>
                    <Progress value={categoryProgress[category]} className="h-1 w-16 mt-1" />
                    <span className="text-xs text-muted-foreground mt-1">
                      {categoryProgress[category]}%
                    </span>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </CardContent>
      </Card>

      {nextFocusAchievements.length > 0 && (
        <Card className="border-primary/20">
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <ArrowRight className="h-5 w-5 text-primary" />
              Next Steps
            </CardTitle>
            <div className="text-sm text-muted-foreground">
              Focus on these achievements to level up faster
            </div>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {nextFocusAchievements.map((achievement) => (
                <div key={achievement.id} className="flex items-center gap-3 p-3 bg-muted/50 rounded-lg">
                  <div className="text-2xl">{achievement.icon}</div>
                  <div className="flex-1 min-w-0">
                    <h4 className="font-medium leading-none">{achievement.name}</h4>
                    <p className="mt-1 text-sm text-muted-foreground">{achievement.description}</p>
                  </div>
                  <Badge variant="secondary">+{achievement.points} XP ({achievement.percentageOfNextLevel}% to next level)</Badge>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      )}

      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Star className="h-5 w-5 text-yellow-500" />
            Achievements
          </CardTitle>
          <div className="text-sm text-muted-foreground">
            Track your progress and unlock rewards
          </div>
        </CardHeader>
        <CardContent>
          <Tabs defaultValue="all" className="w-full">
            <TabsList className="w-full justify-start mb-4">
              <TabsTrigger value="all" className="flex items-center gap-2">
                <Trophy className="h-4 w-4" />
                All
              </TabsTrigger>
              {(Object.keys(CATEGORY_NAMES) as AchievementCategory[]).map((category) => (
                <TabsTrigger 
                  key={category} 
                  value={category}
                  className="flex items-center gap-2"
                >
                  {CATEGORY_ICONS[category]}
                  {CATEGORY_NAMES[category]}
                </TabsTrigger>
              ))}
            </TabsList>

            <ScrollArea className="h-[400px] pr-4">
              <TabsContent value="all" className="m-0">
                <div className="grid gap-4">
                  {achievements.map((achievement) => (
                    <AchievementCard
                      key={achievement.id}
                      achievement={achievement}
                      isUnlocked={unlockedAchievements.some(ua => ua.achievementId === achievement.id)}
                    />
                  ))}
                </div>
              </TabsContent>

              {(Object.keys(CATEGORY_NAMES) as AchievementCategory[]).map((category) => (
                <TabsContent key={category} value={category} className="m-0">
                  <div className="grid gap-4">
                    {getAchievementsByCategory(category).map((achievement) => (
                      <AchievementCard
                        key={achievement.id}
                        achievement={achievement}
                        isUnlocked={unlockedAchievements.some(ua => ua.achievementId === achievement.id)}
                      />
                    ))}
                  </div>
                </TabsContent>
              ))}
            </ScrollArea>
          </Tabs>
        </CardContent>
      </Card>
    </div>
  );
}

interface AchievementCardProps {
  achievement: any;
  isUnlocked: boolean;
}

function AchievementCard({ achievement, isUnlocked }: AchievementCardProps) {
  return (
    <div
      className={cn(
        "flex items-start gap-3 p-3 rounded-lg transition-all duration-200",
        isUnlocked 
          ? "bg-primary/10 border border-primary/20" 
          : "bg-muted/50 opacity-80 hover:opacity-100"
      )}
    >
      <div className="text-2xl">{achievement.icon}</div>
      <div className="flex-1 min-w-0">
        <div className="flex items-center gap-2">
          <h4 className="font-medium leading-none">
            {achievement.name}
          </h4>
          <Badge 
            variant={isUnlocked ? "default" : "secondary"} 
            className={cn(
              "ml-auto",
              isUnlocked && "bg-primary/20 text-primary hover:bg-primary/30"
            )}
          >
            {achievement.points} XP
          </Badge>
        </div>
        <p className="mt-1 text-sm text-muted-foreground">
          {achievement.description}
        </p>
      </div>
      {isUnlocked ? (
        <CheckCircle2 className="h-5 w-5 text-primary flex-shrink-0" />
      ) : (
        <XCircle className="h-5 w-5 text-muted-foreground/50 flex-shrink-0" />
      )}
    </div>
  );
}
</file>

<file path="client/src/pages/AuthPage.tsx">
import { useState } from "react";
import { zodResolver } from "@hookform/resolvers/zod";
import { useForm } from "react-hook-form";
import { z } from "zod";
import { useLocation } from "wouter";
import { Button } from "@/components/ui/button";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { useUser } from "../hooks/use-user";
import { useToast } from "@/hooks/use-toast";

const authSchema = z.object({
  username: z.string().min(3, "Username must be at least 3 characters"),
  password: z.string().min(6, "Password must be at least 6 characters"),
});

type AuthFormData = z.infer<typeof authSchema>;

export default function AuthPage() {
  const [isLogin, setIsLogin] = useState(true);
  const { login, register } = useUser();
  const { toast } = useToast();

  const form = useForm<AuthFormData>({
    resolver: zodResolver(authSchema),
    defaultValues: {
      username: "",
      password: "",
    },
  });

  const [, setLocation] = useLocation();

  const onSubmit = async (data: AuthFormData) => {
    try {
      if (isLogin) {
        const response = await login(data);
        if (response.ok) {
          setLocation("/");
        }
      } else {
        const response = await register(data);
        if (response.ok) {
          // Redirect to Stripe payment
          const subscriptionResponse = await fetch('/api/create-subscription', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include'
          });
          
          if (!subscriptionResponse.ok) {
            throw new Error('Failed to create subscription');
          }
          
          const { url } = await subscriptionResponse.json();
          window.location.href = url;
        }
      }
    } catch (error: any) {
      toast({
        title: "Error",
        description: error.message,
        variant: "destructive",
      });
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-background p-4">
      <Card className="w-full max-w-md">
        <CardHeader className="space-y-1">
          <CardTitle className="text-2xl font-bold">
            {isLogin ? "Welcome back!" : "Create an account"}
          </CardTitle>
          <CardDescription>
            {isLogin
              ? "Enter your credentials to sign in"
              : "Sign up to start finding friends"}
          </CardDescription>
        </CardHeader>
        <CardContent>
          <Form {...form}>
            <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
              <FormField
                control={form.control}
                name="username"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Username</FormLabel>
                    <FormControl>
                      <Input 
                        {...field}
                        autoComplete={isLogin ? "username" : "new-username"}
                      />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              <FormField
                control={form.control}
                name="password"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Password</FormLabel>
                    <FormControl>
                      <Input 
                        type="password" 
                        autoComplete={isLogin ? "current-password" : "new-password"}
                        {...field} 
                      />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              <Button type="submit" className="w-full">
                {isLogin ? "Sign In" : "Sign Up"}
              </Button>
            </form>
          </Form>

          <div className="mt-4 text-center">
            <Button
              variant="link"
              className="text-sm"
              onClick={() => setIsLogin(!isLogin)}
            >
              {isLogin
                ? "Don't have an account? Sign up"
                : "Already have an account? Sign in"}
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
</file>

<file path="client/src/pages/Chat.tsx">
import { useRoute, useLocation } from "wouter";
import { useState, useEffect, useRef } from "react";
import type { Message, User } from "@db/schema";
import { useMatches, type Match, type MatchStatus } from "../hooks/use-matches";
import { useChat, EventSuggestion } from "../hooks/use-chat";
import type { SuggestionResponse, EventSuggestionResponse, Suggestion } from "../hooks/use-chat";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Card } from "@/components/ui/card";
import { Loader2, Send, Lightbulb, Calendar } from "lucide-react";
import { useUser } from "../hooks/use-user";
import { useQuery, useMutation, useQueryClient, Query } from "@tanstack/react-query";
import type { QueryKey } from "@tanstack/react-query";
import { useToast } from "@/hooks/use-toast";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";

export default function Chat() {
  const [, params] = useRoute<{ id: string }>("/chat/:id");
  const matchId = params?.id ? parseInt(params.id) : null;
  const { user } = useUser();
  const { useMatchMessages, getMatch, useSendMessage } = useMatches();
  const { getSuggestions, craftMessage, getEventSuggestions } = useChat();
  const { mutate: sendMessage } = useSendMessage();
  const [newMessage, setNewMessage] = useState("");
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const { toast } = useToast();
  const queryClient = useQueryClient();
  const [, setLocation] = useLocation();

  // All useQuery hooks at the top level
  const { data: match, isLoading: isLoadingMatch } = useQuery({
    queryKey: ['match', matchId] as const,
    queryFn: () => getMatch(matchId as number),
    enabled: !!matchId && !!user?.id
  });

  // Fetch messages
  const { data: messages = [], isLoading: isLoadingMessages } = useMatchMessages(matchId!);

  // Chat suggestions query
  const { data: chatSuggestions, isLoading: isLoadingSuggestions } = useQuery<SuggestionResponse>({
    queryKey: ['suggest', matchId] as QueryKey,
    queryFn: () => getSuggestions(matchId!),
    enabled: !!matchId && match?.status === 'accepted',
    staleTime: 60000,
    gcTime: 1000 * 60 * 5,
    retry: (failureCount, error: Error) => {
      if (error.message.includes('Unauthorized') || error.message.includes('Session expired')) {
        return false;
      }
      return failureCount < 3;
    },
    refetchOnWindowFocus: false,
  });

  // Event suggestions query
  const { data: eventSuggestionsData = { suggestions: [] }, isLoading: isLoadingEvents } = useQuery<EventSuggestionResponse>({
    queryKey: ['events/suggest', matchId] as QueryKey,
    queryFn: () => getEventSuggestions(matchId!),
    staleTime: 60000,
    retry: false,
    enabled: !!matchId && match?.status === 'accepted',
  });

  const eventSuggestions = eventSuggestionsData.suggestions;

  // Scroll to bottom when new messages arrive
  useEffect(() => {
    if (messages?.length && messagesEndRef.current) {
      messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });
    }
  }, [messages]);

  // Handle errors
  useEffect(() => {
    if (match instanceof Error) {
      console.error('Match error:', match);
      toast({
        title: "Error",
        description: match.message,
        variant: "destructive"
      });

      // Redirect back to matches after a short delay
      const timer = setTimeout(() => {
        setLocation('/matches');
      }, 2000);

      return () => clearTimeout(timer);
    }
  }, [match, setLocation]);

  const isLoading = isLoadingMatch || isLoadingMessages;

  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-[50vh]">
        <Loader2 className="h-8 w-8 animate-spin text-primary" />
      </div>
    );
  }

  if (!match) {
    return (
      <div className="flex flex-col items-center justify-center min-h-[50vh] gap-4">
        <p>Match not found</p>
        <Button onClick={() => setLocation('/matches')}>Return to Matches</Button>
      </div>
    );
  }

  // Handle different match statuses
  if (!match.status) {
    return (
      <div className="flex flex-col items-center justify-center min-h-[50vh] gap-4">
        <p>Match data is incomplete</p>
        <Button onClick={() => setLocation('/matches')}>Return to Matches</Button>
      </div>
    );
  }

  switch (match.status) {
    case 'accepted':
      break; // Continue to chat UI
    case 'requested':
      return (
        <div className="flex flex-col items-center justify-center min-h-[50vh] gap-4">
          <p>This match request is pending acceptance</p>
          <Button onClick={() => setLocation('/matches')}>Return to Matches</Button>
        </div>
      );
    case 'pending':
      return (
        <div className="flex flex-col items-center justify-center min-h-[50vh] gap-4">
          <p>This match request is being processed</p>
          <Button onClick={() => setLocation('/matches')}>Return to Matches</Button>
        </div>
      );
    case 'rejected':
      return (
        <div className="flex flex-col items-center justify-center min-h-[50vh] gap-4">
          <p>This match request was declined</p>
          <Button onClick={() => setLocation('/matches')}>Return to Matches</Button>
        </div>
      );
    case 'potential':
      return (
        <div className="flex flex-col items-center justify-center min-h-[50vh] gap-4">
          <p>This is a potential match. Send a match request first!</p>
          <Button onClick={() => setLocation('/matches')}>Return to Matches</Button>
        </div>
      );
    case 'none':
      return (
        <div className="flex flex-col items-center justify-center min-h-[50vh] gap-4">
          <p>No match exists between you and this user</p>
          <Button onClick={() => setLocation('/matches')}>Return to Matches</Button>
        </div>
      );
    default:
      return (
        <div className="flex flex-col items-center justify-center min-h-[50vh] gap-4">
          <p>Invalid match status: {match.status}</p>
          <Button onClick={() => setLocation('/matches')}>Return to Matches</Button>
        </div>
      );
  }

  const handleSend = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!newMessage.trim()) return;

    try {
      console.log('Sending message:', { matchId, content: newMessage.trim() });
      
      // Optimistically update UI
      const optimisticMessage = {
        id: Date.now(), // temporary ID
        matchId: matchId!,
        senderId: user?.id!,
        content: newMessage.trim(),
        createdAt: new Date(),
        analyzed: null,
        sentiment: null
      };

      // Add to messages immediately
      queryClient.setQueryData<Message[]>(
        ['matches', matchId, 'messages'],
        (old = []) => [...old, optimisticMessage]
      );

      // Clear input immediately for better UX
      setNewMessage("");

      // Actually send the message
      await sendMessage({ matchId: matchId!, content: newMessage.trim() });

      // Scroll to bottom after sending
      messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    } catch (error: any) {
      console.error('Error sending message:', error);
      
      // Revert optimistic update on error
      queryClient.invalidateQueries({ 
        queryKey: ['matches', matchId, 'messages']
      });

      toast({
        title: "Error sending message",
        description: error.message || 'Failed to send message',
        variant: "destructive",
      });
    }
  };

  // Only show full loading state on initial load with no messages
  if (isLoading && (!messages || messages.length === 0)) {
    return (
      <div className="flex items-center justify-center min-h-[50vh]">
        <Loader2 className="h-8 w-8 animate-spin text-primary" />
      </div>
    );
  }

  // Show a subtle loading indicator during background refreshes
  const LoadingIndicator = () => (
    isLoading ? (
      <div className="absolute top-2 right-2">
        <Loader2 className="h-4 w-4 animate-spin text-muted-foreground opacity-50" />
      </div>
    ) : null
  );

  // Debug messages
  console.log('Current messages:', messages);

  return (
    <div className="max-w-2xl bg-gray-500/50 mx-auto border border-white rounded-lg p-10 m-10">
      <div className="relative flex flex-col-reverse mb-6 h-[60vh] overflow-y-auto p-4 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-transparent">
        <LoadingIndicator key="loading-indicator" />
        <div key="messages-end-ref" ref={messagesEndRef} />
        {Array.isArray(messages) && messages.map((message) => {
          if (!message?.id || !message?.content) {
            console.warn('Invalid message format:', message);
            return null;
          }

          const isCurrentUser = message.senderId === (user as { id: number })?.id;
          const messageKey = `message-${message.id}-${message.senderId}`;
          
          return (
            <div
              key={messageKey}
              className={`flex ${isCurrentUser ? 'justify-end' : 'justify-start'} w-full mb-4 last:mb-0`}
            >
              <Card
                className={`p-4 max-w-[80%] ${
                  isCurrentUser
                    ? "bg-primary text-primary-foreground shadow-md"
                    : "bg-card shadow"
                }`}
              >
                <div className="whitespace-pre-wrap break-words">
                  {message.content || ''}
                </div>
              </Card>
            </div>
          );
        })}
      </div>

      <form onSubmit={handleSend} className="flex gap-4">
        <Input
          value={newMessage}
          onChange={(e) => setNewMessage(e.target.value)}
          placeholder="Type a message..."
          className="flex-1"
        />

        <div className="flex gap-2">
          <Popover>
            <PopoverTrigger asChild>
              <Button 
                variant="outline" 
                size="icon"
                disabled={isLoadingSuggestions || !chatSuggestions?.suggestions?.length}
              >
                <Lightbulb className="h-4 w-4" />
              </Button>
            </PopoverTrigger>
            <PopoverContent className="w-96">
              <div className="p-2">
                <h4 className="font-medium mb-3">Conversation Starters</h4>
                <div className="space-y-2 max-h-[300px] overflow-y-auto pr-2">
                  {isLoadingSuggestions ? (
                    <div className="flex justify-center py-4">
                      <Loader2 className="h-4 w-4 animate-spin" />
                    </div>
                  ) : chatSuggestions?.suggestions?.length ? (
                    chatSuggestions.suggestions.map((suggestion: Suggestion, i: number) => (
                      <Button
                        key={i}
                        variant="ghost"
                        className="w-full justify-start whitespace-normal text-left h-auto py-3 px-4"
                        onClick={async (e) => {
                          e.preventDefault();
                          const popoverTrigger = e.currentTarget.closest('.popover-content')?.previousElementSibling as HTMLElement;
                          popoverTrigger?.click(); // Close the popover
                          try {
                            const { message } = await craftMessage({ 
                              matchId: matchId!, 
                              suggestion: suggestion.text 
                            });
                            setNewMessage(message);
                          } catch (error) {
                            console.error("Failed to craft message:", error);
                            setNewMessage(suggestion.text);
                          }
                        }}
                      >
                        {suggestion.text}
                      </Button>
                    ))
                  ) : (
                    <p className="text-center text-muted-foreground py-4">
                      No suggestions available
                    </p>
                  )}
                </div>
              </div>
            </PopoverContent>
          </Popover>

          <Popover>
            <PopoverTrigger asChild>
              <Button variant="outline" size="icon">
                <Calendar className="h-4 w-4" />
              </Button>
            </PopoverTrigger>
            <PopoverContent className="w-96 h-96">
              <div className="p-2">
                <h4 className="font-medium mb-3">Suggested Activities</h4>
                <div className="space-y-2 max-h-[300px] overflow-y-auto pr-2">
                  {isLoadingEvents ? (
                    <div className="flex justify-center py-4">
                      <Loader2 className="h-4 w-4 animate-spin" />
                    </div>
                  ) : eventSuggestionsData.suggestions?.length ? (
                    eventSuggestionsData.suggestions.map((event: EventSuggestion, i: number) => (
                      <Button
                        key={i}
                        variant="ghost"
                        className="w-full justify-start whitespace-normal text-left h-auto py-3 px-4"
                        onClick={async (e) => {
                          e.preventDefault();
                          const popoverTrigger = e.currentTarget.closest('.popover-content')?.previousElementSibling as HTMLElement;
                          popoverTrigger?.click(); // Close the popover
                          try {
                            const { message } = await craftMessage({ 
                              matchId: matchId!,
                              suggestion: event.title,
                              eventDetails: {
                                title: event.title,
                                description: event.description,
                                reasoning: event.reasoning
                              }
                            });
                            setNewMessage(message);
                          } catch (error) {
                            console.error("Failed to craft message:", error);
                            setNewMessage(event.title);
                          }
                        }}
                      >
                        <div className="flex flex-col gap-1">
                          <span className="font-medium">{event.title}</span>
                          {event.description && (
                            <span className="text-sm text-muted-foreground">
                              {event.description}
                            </span>
                          )}
                          {event.reasoning && (
                            <span className="text-xs text-muted-foreground mt-1 italic">
                              {event.reasoning}
                            </span>
                          )}
                        </div>
                      </Button>
                    ))
                  ) : (
                    <p className="text-center text-muted-foreground py-4">
                      No event suggestions available
                    </p>
                  )}
                </div>
              </div>
            </PopoverContent>
          </Popover>
        </div>

        <Button type="submit" size="icon">
          <Send className="h-4 w-4" />
        </Button>
      </form>
    </div>
  );
}
</file>

<file path="client/src/pages/Matches.tsx">
'use client'

import { useEffect, useRef, useState } from "react";
import { useMatches } from "@/hooks/use-matches";
import { useUser } from "@/hooks/use-user";
import { Loader2, Users } from 'lucide-react';
import { Link } from "wouter";
import { Button } from "@/components/ui/button";
import { MatchCard } from "@/components/MatchCard";
import { NetworkGraph } from "@/components/NetworkGraph";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { MatchRequests } from "@/components/match-requests";
import gsap from "gsap";
import { ScrollTrigger } from "gsap/ScrollTrigger";
import { Heart, Zap } from 'lucide-react';

gsap.registerPlugin(ScrollTrigger);

export default function Matches() {
  const { matches, requests, isLoading, respondToMatch, isResponding } = useMatches();
  const { user, isLoading: isLoadingUser } = useUser();

  console.log('User data:', user);
  console.log('Raw matches data:', matches);
  console.log('Raw requests data:', requests);

  // Ensure we have arrays even if matches is undefined
  const acceptedMatches = matches?.filter(match => match.status === 'accepted') || [];
  const potentialMatches = matches?.filter(match => match.status === 'potential') || [];

  console.log('Filtered accepted matches:', acceptedMatches);
  console.log('Filtered potential matches:', potentialMatches);

  // Show loading state while either matches or user data is loading
  if (isLoading || isLoadingUser) {
    return (
      <div className="flex items-center justify-center min-h-[50vh]">
        <Loader2 className="h-8 w-8 animate-spin text-primary" />
      </div>
    );
  }

  // Show login prompt if no user
  if (!user) {
    return (
      <div className="flex items-center justify-center min-h-[50vh] flex-col gap-4">
        <p className="text-muted-foreground">Please log in to view matches</p>
        <Button asChild>
          <Link href="/login">Log In</Link>
        </Button>
      </div>
    );
  }

  // Show profile completion prompt if quiz not completed
  if (!user.quizCompleted) {
    return (
      <div className="flex items-center justify-center min-h-[50vh] flex-col gap-4">
        <p className="text-muted-foreground">Complete your profile to start matching!</p>
        <Button asChild>
          <Link href="/profile">Complete Profile</Link>
        </Button>
      </div>
    );
  }

  // Show empty state if no matches
  if (!matches || matches.length === 0) {
    return (
      <div className="container mx-auto px-4 py-8">
        <div className="flex justify-between items-center mb-8">
          <div>
            <h1 className="text-3xl font-bold mb-2">Your Matches</h1>
            <p className="text-muted-foreground">
              Find and connect with compatible friends
            </p>
          </div>
          <Button asChild className="flex items-center gap-2">
            <Link href="/matches/create">
              <Heart className="h-4 w-4" />
              Create Match
            </Link>
          </Button>
        </div>

        <div className="text-center py-12">
          <Users className="h-12 w-12 text-muted-foreground mx-auto mb-4" />
          <h3 className="text-lg font-semibold mb-2">Start Your Matching Journey</h3>
          <p className="text-muted-foreground mb-4">
            Create your first match to start connecting with compatible friends!
          </p>
          <Button asChild>
            <Link href="/matches/create">Create Your First Match</Link>
          </Button>
        </div>
      </div>
    );
  }

  return (
    <div className="container mx-auto px-4 py-8">
      <div className="flex justify-between items-center mb-8">
        <div>
          <h1 className="text-3xl font-bold mb-2">Your Matches</h1>
          <p className="text-muted-foreground">
            Find and connect with compatible friends
          </p>
        </div>
        <Button asChild className="flex items-center gap-2">
          <Link href="/matches/create">
            <Heart className="h-4 w-4" />
            Create Match
          </Link>
        </Button>
      </div>

      {requests && requests.length > 0 && (
        <div className="mb-8">
          <MatchRequests
            requests={requests}
            onRespond={respondToMatch}
            isResponding={isResponding}
          />
        </div>
      )}

      <Tabs defaultValue="matches" className="w-full">
        <TabsList className="mb-4">
          <TabsTrigger value="matches">
            Current Matches ({acceptedMatches.length})
          </TabsTrigger>
          <TabsTrigger value="potential">
            Potential Matches ({potentialMatches.length})
          </TabsTrigger>
        </TabsList>

        <TabsContent value="matches">
          {acceptedMatches.length === 0 ? (
            <div className="text-center py-12">
              <Heart className="h-12 w-12 text-muted-foreground mx-auto mb-4" />
              <h3 className="text-lg font-semibold mb-2">No Matches Yet</h3>
              <p className="text-muted-foreground mb-4">
                Start by exploring potential matches or create a new match!
              </p>
              <Button asChild>
                <Link href="/matches/create">Create Match</Link>
              </Button>
            </div>
          ) : (
            <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
              {acceptedMatches.map((match) => (
                <MatchCard 
                  key={match.id} 
                  match={match} 
                />
              ))}
            </div>
          )}
        </TabsContent>

        <TabsContent value="potential">
          {potentialMatches.length === 0 ? (
            <div className="text-center py-12">
              <Users className="h-12 w-12 text-muted-foreground mx-auto mb-4" />
              <h3 className="text-lg font-semibold mb-2">No Potential Matches</h3>
              <p className="text-muted-foreground mb-4">
                Create a new match to find compatible friends!
              </p>
              <Button asChild>
                <Link href="/matches/create">Create Match</Link>
              </Button>
            </div>
          ) : (
            <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
              {potentialMatches.map((match) => (
                <MatchCard 
                  key={match.id} 
                  match={match} 
                  isPotential={true}
                />
              ))}
            </div>
          )}
        </TabsContent>
      </Tabs>

      {(acceptedMatches.length > 0 || potentialMatches.length > 0) && (
        <div className="mt-12 w-full">
          <NetworkGraph
            matches={[...acceptedMatches, ...potentialMatches]}
            userId={user?.id || 0}
            visible={true}
          />
        </div>
      )}
    </div>
  );
}
</file>

<file path="client/src/main.tsx">
import { StrictMode, ReactNode } from "react";
import { createRoot } from "react-dom/client";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { queryClient } from "./lib/queryClient";
import { Toaster } from "@/components/ui/toaster";
import { ThemeProvider } from "@/components/theme-provider";
import App from './App';
import { CopilotKit } from "@copilotkit/react-core";
import { CopilotPopup } from "@copilotkit/react-ui";
// import "./index.css";
import "./styles/globals.css"
import "@copilotkit/react-ui/styles.css";

createRoot(document.getElementById("root")!).render(
  <StrictMode>
    <QueryClientProvider client={queryClient}>
      <ThemeProvider defaultTheme="system" storageKey="vibe-ui-theme">
      <CopilotKit runtimeUrl="/copilotkit"> 
        <App />
        <CopilotPopup
        instructions={"As VybeAI, the intelligent assistant within VybeChex, you embody the persona of a world-class expert in male-female relationships and interpersonal dynamics. Your deep understanding encompasses emotional intelligence, effective communication strategies, conflict resolution, and building meaningful connections. You communicate using natural, conversational language, ensuring that your interactions feel personal, engaging, and easily understandable. Your responses are warm, empathetic, and insightful, drawing from the latest research, psychological principles, and real-world experiences. Your mission is to help users foster better understanding and harmony in their relationships through tailored, thoughtful advice that addresses their unique needs and contexts."}
        labels={{
          title: "Vybe AI",
          initial: "Need any help?",
        }}
      />
        </CopilotKit>
        <Toaster />
      </ThemeProvider>
    </QueryClientProvider>
  </StrictMode>,
);
</file>

<file path="server/websocket.ts">
import { WebSocket, WebSocketServer } from 'ws';
import { parse } from 'url';
import type { Server } from 'http';
import type { SelectUser } from '@db/schema';
import { db } from '@db';
import { messages, matches } from '@db/schema';
import { eq, and, or } from 'drizzle-orm';

interface ChatMessage {
  type: 'message';
  matchId: number;
  content: string;
}

interface ExtendedWebSocket extends WebSocket {
  userId?: number;
  matchId?: number;
  isAlive: boolean;
  sessionId?: string;
}

// Store active connections with session tracking
const connections = new Map<number, ExtendedWebSocket[]>();
const sessionConnections = new Map<string, ExtendedWebSocket>();

export function setupWebSocketServer(server: Server) {
  const wss = new WebSocketServer({ noServer: true });

  // Handle WebSocket upgrade with session verification
  server.on('upgrade', async (request, socket, head) => {
    try {
      // Skip Vite HMR connections
      const protocol = request.headers['sec-websocket-protocol'];
      if (protocol === 'vite-hmr') {
        return;
      }

      const { pathname, query } = parse(request.url || '', true);
      if (pathname === '/ws/chat') {
        const userId = parseInt(query.userId as string);
        const matchId = parseInt(query.matchId as string);
        const sessionId = query.sessionId as string;

        if (isNaN(userId) || isNaN(matchId) || !sessionId) {
          socket.write('HTTP/1.1 401 Unauthorized\r\n\r\n');
          socket.destroy();
          return;
        }

        // Verify match exists and user has access
        try {
          const [match] = await db
            .select()
            .from(matches)
            .where(
              and(
                eq(matches.id, matchId),
                or(
                  eq(matches.userId1, userId),
                  eq(matches.userId2, userId)
                ),
                eq(matches.status, 'accepted')
              )
            )
            .limit(1);

          if (!match) {
            socket.write('HTTP/1.1 403 Forbidden\r\n\r\n');
            socket.destroy();
            return;
          }

          // Close existing connection for this session if it exists
          const existingConnection = sessionConnections.get(sessionId);
          if (existingConnection) {
            existingConnection.close(1000, 'New connection established');
          }

          wss.handleUpgrade(request, socket, head, (ws) => {
            const extWs = ws as ExtendedWebSocket;
            extWs.userId = userId;
            extWs.matchId = matchId;
            extWs.sessionId = sessionId;
            extWs.isAlive = true;

            // Store connection with session tracking
            sessionConnections.set(sessionId, extWs);
            if (!connections.has(matchId)) {
              connections.set(matchId, []);
            }
            connections.get(matchId)?.push(extWs);

            wss.emit('connection', extWs);
          });
        } catch (error) {
          console.error('WebSocket upgrade error:', error);
          socket.write('HTTP/1.1 500 Internal Server Error\r\n\r\n');
          socket.destroy();
        }
      }
    } catch (error) {
      console.error('WebSocket upgrade error:', error);
      socket.write('HTTP/1.1 500 Internal Server Error\r\n\r\n');
      socket.destroy();
    }
  });

  // Setup heartbeat
  const interval = setInterval(() => {
    const clients = Array.from(wss.clients) as ExtendedWebSocket[];
    clients.forEach((ws) => {
      if (!ws.isAlive) {
        if (ws.sessionId) {
          sessionConnections.delete(ws.sessionId);
        }
        return ws.terminate();
      }
      ws.isAlive = false;
      ws.ping();
    });
  }, 30000);

  wss.on('close', () => {
    clearInterval(interval);
  });

  // Handle new connections
  wss.on('connection', (ws: ExtendedWebSocket) => {
    const { userId, matchId, sessionId } = ws;
    if (!userId || !matchId || !sessionId) {
      ws.close(1008, 'Missing session information');
      return;
    }

    // Setup pong handler for heartbeat
    ws.on('pong', () => {
      ws.isAlive = true;
    });

    // Handle incoming messages
    ws.on('message', async (data) => {
      try {
        const message = JSON.parse(data.toString()) as ChatMessage;
        if (message.type !== 'message') return;

        // Verify the message is for the correct match
        if (message.matchId !== matchId) {
          ws.send(JSON.stringify({
            type: 'error',
            message: 'Invalid match ID',
            timestamp: new Date().toISOString()
          }));
          return;
        }

        // Store message in database
        const [savedMessage] = await db
          .insert(messages)
          .values({
            matchId: message.matchId,
            senderId: userId,
            content: message.content,
          })
          .returning();

        // Broadcast to all users in the match
        const matchConnections = connections.get(message.matchId) || [];
        const outgoingMessage = JSON.stringify({
          type: 'message',
          message: savedMessage,
        });

        matchConnections.forEach((client) => {
          if (client.readyState === WebSocket.OPEN) {
            client.send(outgoingMessage);
          }
        });
      } catch (error) {
        console.error('Error processing message:', error);
        ws.send(JSON.stringify({ 
          type: 'error', 
          message: 'Failed to process message',
          timestamp: new Date().toISOString()
        }));
      }
    });

    // Handle client disconnect
    ws.on('close', () => {
      ws.isAlive = false;
      if (sessionId) {
        sessionConnections.delete(sessionId);
      }
      const matchConnections = connections.get(matchId);
      if (matchConnections) {
        const index = matchConnections.indexOf(ws);
        if (index !== -1) {
          matchConnections.splice(index, 1);
        }
        if (matchConnections.length === 0) {
          connections.delete(matchId);
        }
      }
    });

    // Send initial connection success
    ws.send(JSON.stringify({ 
      type: 'connected', 
      message: 'Successfully connected to chat',
      timestamp: new Date().toISOString()
    }));
  });

  return wss;
}
</file>

<file path=".replit">
modules = ["nodejs-20", "web", "postgresql-16"]
run = "npm run dev"
hidden = [".config", ".git", "generated-icon.png", "node_modules", "dist"]

[nix]
channel = "stable-24_05"

[deployment]
deploymentTarget = "cloudrun"
build = ["npm", "run", "build"]
run = ["npm", "run", "start"]

[[ports]]
localPort = 5000
externalPort = 80

[[ports]]
localPort = 33613
externalPort = 3003

[[ports]]
localPort = 36993
externalPort = 3001

[[ports]]
localPort = 37519
externalPort = 3000

[workflows]
runButton = "Project"

[[workflows.workflow]]
name = "Project"
mode = "parallel"
author = "agent"

[[workflows.workflow.tasks]]
task = "workflow.run"
args = "Start application"

[[workflows.workflow]]
name = "Start application"
author = "agent"

[workflows.workflow.metadata]
agentRequireRestartOnSave = false

[[workflows.workflow.tasks]]
task = "packager.installForAll"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "npm run dev"
waitForPort = 5000

[objectStorage]
defaultBucketID = "replit-objstore-42ba1808-b6bc-4955-a490-87bc85fa3955"
</file>

<file path="client/src/components/MatchInsightTooltip.tsx">
import { Button } from "@/components/ui/button";
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip";
import { Info } from "lucide-react";

interface MatchInsightProps {
  personalityTraits?: Record<string, number>;
  compatibilityScore: number;
  scoreBreakdown?: {
    components: {
      personality: number;
      interests: number;
      communication: number;
      social: number;
      activity: number;
    };
    details: {
      personalityBreakdown: Record<string, number>;
    };
  };
}

export function MatchInsightTooltip({
  personalityTraits,
  compatibilityScore,
  scoreBreakdown
}: MatchInsightProps) {
  // Generate insights based on personality traits and scores
  const getTopTraits = () => {
    if (!personalityTraits) return [];
    return Object.entries(personalityTraits)
      .sort(([, a], [, b]) => b - a)
      .slice(0, 2)
      .map(([trait]) => trait);
  };

  const getCompatibilityInsight = () => {
    if (compatibilityScore >= 80) {
      return "Exceptional match! You share remarkable compatibility.";
    } else if (compatibilityScore >= 60) {
      return "Strong potential for a great connection!";
    } else if (compatibilityScore >= 40) {
      return "Moderate compatibility with room for growth.";
    } else {
      return "Different perspectives could lead to interesting conversations.";
    }
  };

  const topTraits = getTopTraits();

  return (
    <TooltipProvider>
      <Tooltip>
        <TooltipTrigger asChild>
          <Button variant="ghost" size="icon" className="h-8 w-8">
            <Info className="h-4 w-4" />
          </Button>
        </TooltipTrigger>
        <TooltipContent className="w-80 p-4 max-h-[300px] overflow-y-auto z-[9999]">
          <div className="space-y-2">
            <h4 className="font-semibold">{getCompatibilityInsight()}</h4>
            
            {topTraits.length > 0 && (
              <p className="text-sm text-muted-foreground">
                Strongest traits: {topTraits.join(", ")}
              </p>
            )}
            
            {scoreBreakdown && (
              <div className="mt-2">
                <p className="text-sm font-medium">Compatibility Breakdown:</p>
                <div className="max-h-[200px] overflow-y-auto pr-2">
                  <ul className="text-sm text-muted-foreground mt-1 space-y-1">
                    <li className="flex justify-between">
                      <span>Personality:</span>
                      <span>{scoreBreakdown.components.personality}%</span>
                    </li>
                    <li className="flex justify-between">
                      <span>Communication:</span>
                      <span>{scoreBreakdown.components.communication}%</span>
                    </li>
                    <li className="flex justify-between">
                      <span>Social:</span>
                      <span>{scoreBreakdown.components.social}%</span>
                    </li>
                    <li className="flex justify-between">
                      <span>Activity:</span>
                      <span>{scoreBreakdown.components.activity}%</span>
                    </li>
                  </ul>
                </div>
              </div>
            )}
          </div>
        </TooltipContent>
      </Tooltip>
    </TooltipProvider>
  );
}
</file>

<file path="client/src/App.tsx">
import { Switch, Route, useLocation } from "wouter";
import { useUser } from "./hooks/use-user";
import { Loader2, AlertCircle } from "lucide-react";
import { Card, CardContent } from "@/components/ui/card";
import Home from "./pages/Home";
import Quiz from "./pages/Quiz";
import Matches from "./pages/Matches";
import CreateMatch from "./pages/CreateMatch";
import Chat from "./pages/Chat";
import { InterestsPage } from "./pages/InterestsPage";
import Navigation from "./components/Navigation";
import AuthPage from "./pages/AuthPage";
import Profile from "./pages/Profile";

function App() {
  const { user, isLoading } = useUser();
  const [location, setLocation] = useLocation();

  // Show loading spinner while checking authentication
  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Loader2 className="h-8 w-8 animate-spin text-primary" />
      </div>
    );
  }

  // Redirect to auth page if not logged in
  if (!user && location !== '/login' && location !== '/register') {
    return <AuthPage />;
  }

  // Main app layout for authenticated users
  return (
    <div className="min-h-screen bg-background">
      {user && <Navigation />}
      <main className="container mx-auto px-4 py-8">
        <Switch>
          <Route path="/" component={Home} />
          <Route path="/quiz" component={Quiz} />
          <Route path="/matches" component={Matches} />
          <Route path="/matches/create" component={CreateMatch} />
          <Route path="/chat/:id" component={Chat} />
          <Route path="/interests" component={InterestsPage} />
          <Route path="/profile" component={Profile} />
          <Route path="/matches/create/:id">
            {(params) => {
              if (user) {
                setLocation(`/chat/${params.id}`);
              }
              return null;
            }}
          </Route>
          <Route>
            <div className="flex items-center justify-center min-h-[60vh]">
              <Card className="w-full max-w-md">
                <CardContent className="pt-6">
                  <div className="flex mb-4 gap-2">
                    <AlertCircle className="h-8 w-8 text-red-500" />
                    <h1 className="text-2xl font-bold text-gray-900">404 Page Not Found</h1>
                  </div>
                  <p className="mt-4 text-sm text-gray-600">
                    The page you're looking for doesn't exist.
                  </p>
                </CardContent>
              </Card>
            </div>
          </Route>
        </Switch>
      </main>
    </div>
  );
}

export default App;
</file>

<file path="server/stripe.ts">
import Stripe from 'stripe';
import { Router } from 'express';
import { validateUser } from './middleware/auth';

if (!process.env.STRIPE_SECRET_KEY) {
  throw new Error('STRIPE_SECRET_KEY must be set');
}

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, {
  apiVersion: '2023-10-16'
});

const SUBSCRIPTION_PRICE_ID = process.env.STRIPE_PRICE_ID;

const router = Router();

router.post('/create-subscription', validateUser, async (req, res) => {
  try {
    if (!process.env.STRIPE_PRICE_ID) {
      throw new Error('STRIPE_PRICE_ID is not configured');
    }

    if (!req.user?.stripeCustomerId) {
      throw new Error('User has no Stripe customer ID');
    }

    const session = await stripe.checkout.sessions.create({
      customer: req.user.stripeCustomerId,
      mode: 'subscription',
      payment_method_types: ['card'],
      line_items: [{
        price: SUBSCRIPTION_PRICE_ID,
        quantity: 1,
      }],
      success_url: `${req.headers.origin}/payment-success?session_id={CHECKOUT_SESSION_ID}`,
      cancel_url: `${req.headers.origin}/payment-cancelled`,
    });

    res.json({ 
      success: true,
      sessionId: session.id,
      url: session.url 
    });
  } catch (error) {
    console.error('Subscription creation error:', error);
    res.status(500).json({
      success: false,
      message: error instanceof Error ? error.message : 'Failed to create subscription'
    });
  }
});

router.get('/subscription-status', validateUser, async (req, res) => {
  try {
    const subscriptions = await stripe.subscriptions.list({
      customer: req.user.stripeCustomerId,
      status: 'active',
      limit: 1,
    });

    res.json({
      success: true,
      hasActiveSubscription: subscriptions.data.length > 0
    });
  } catch (error) {
    console.error('Subscription status error:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to check subscription status'
    });
  }
});

router.post('/create-payment-intent', validateUser, async (req, res) => {
  try {
    const { amount } = req.body;

    const paymentIntent = await stripe.paymentIntents.create({
      amount: amount * 100, // Convert to cents
      currency: 'usd',
      automatic_payment_methods: {
        enabled: true,
      },
    });

    res.json({
      success: true,
      clientSecret: paymentIntent.client_secret
    });
  } catch (error) {
    console.error('Payment intent creation error:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to create payment intent'
    });
  }
});

export { router as stripeRouter };
</file>

<file path="client/src/components/ChatWindow.tsx">
import React, { useEffect, useRef, useState } from "react";
import { useQuery, useQueryClient } from "@tanstack/react-query";
import { useToast } from "@/hooks/use-toast";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Card } from "@/components/ui/card";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Send, AlertCircle, Loader2, Moon, Sun } from 'lucide-react';
import { formatDistanceToNow } from "date-fns";
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";
import { useUser } from "@/hooks/use-user";
import { motion, AnimatePresence } from "framer-motion";
import { useTheme } from "next-themes";
import { MessageBubble } from "./MessageBubble";
import { ConnectionStatus } from "./ConnectionStatus";
import { TypingIndicator } from "./TypingIndicator";
import styles from "./ChatWindow.module.css";

interface Message {
  id: number;
  content: string;
  createdAt: string;
  sender: {
    id: number;
    username: string;
    name: string;
    avatar: string;
  };
}

interface ChatWindowProps {
  matchId: number;
}

export function ChatWindow({ matchId }: ChatWindowProps) {
  const [theme, setTheme] = useState<'light' | 'dark'>('light');
  const [isTyping, setIsTyping] = useState(false);
  const [message, setMessage] = useState("");
  const [socket, setSocket] = useState<WebSocket | null>(null);
  const [isConnecting, setIsConnecting] = useState(true);
  const [connectionError, setConnectionError] = useState<string | null>(null);
  const { toast } = useToast();
  const queryClient = useQueryClient();
  const scrollRef = useRef<HTMLDivElement>(null);
  const reconnectTimeoutRef = useRef<NodeJS.Timeout>();
  const maxReconnectAttempts = 5;
  const [reconnectAttempts, setReconnectAttempts] = useState(0);
  const { user } = useUser();
  const sessionIdRef = useRef<string>(crypto.randomUUID());

  const toggleTheme = () => {
    setTheme(prevTheme => prevTheme === 'light' ? 'dark' : 'light');
  };

  // Fetch existing messages
  const { data: messages = [], isLoading: isLoadingMessages } = useQuery<Message[]>({
    queryKey: [`/api/matches/${matchId}/messages`],
    enabled: !!user, // Only fetch when user is authenticated
  });

  // Connect to WebSocket with reconnection logic
  const connectWebSocket = () => {
    if (!user || reconnectAttempts >= maxReconnectAttempts) {
      setConnectionError(
        !user 
          ? "Authentication required" 
          : "Unable to connect to chat server after multiple attempts"
      );
      return;
    }

    const ws = new WebSocket(
      `${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws/chat?userId=${user.id}&matchId=${matchId}&sessionId=${sessionIdRef.current}`
    );

    ws.onopen = () => {
      setIsConnecting(false);
      setConnectionError(null);
      setReconnectAttempts(0);
      console.log('Connected to chat server');
    };

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.type === 'message') {
        queryClient.invalidateQueries({ queryKey: [`/api/matches/${matchId}/messages`] });
      } else if (data.type === 'error') {
        toast({
          title: "Error",
          description: data.message,
          variant: "destructive",
        });
      } else if (data.type === 'connected') {
        toast({
          title: "Connected",
          description: data.message,
        });
      }
    };

    ws.onerror = (error) => {
      console.error('WebSocket error:', error);
      setConnectionError("Connection error occurred");
    };

    ws.onclose = (event) => {
      setIsConnecting(true);
      // Attempt to reconnect after a delay with exponential backoff
      if (reconnectAttempts < maxReconnectAttempts && event.code !== 1000) {
        reconnectTimeoutRef.current = setTimeout(() => {
          setReconnectAttempts(prev => prev + 1);
          connectWebSocket();
        }, 2000 * Math.pow(2, reconnectAttempts));
      }
    };

    setSocket(ws);
  };

  useEffect(() => {
    if (user) {
      connectWebSocket();
    }

    return () => {
      if (socket) {
        socket.close(1000, "Component unmounting");
      }
      if (reconnectTimeoutRef.current) {
        clearTimeout(reconnectTimeoutRef.current);
      }
    };
  }, [matchId, user]);

  // Auto-scroll to bottom when new messages arrive
  useEffect(() => {
    if (scrollRef.current) {
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
    }
  }, [messages]);

  const handleSendMessage = () => {
    if (!message.trim() || !socket || socket.readyState !== WebSocket.OPEN || !user) {
      return;
    }

    try {
      socket.send(JSON.stringify({
        type: 'message',
        matchId,
        content: message.trim(),
      }));
      setMessage("");
    } catch (error) {
      toast({
        title: "Error",
        description: "Failed to send message",
        variant: "destructive",
      });
    }
  };

  if (!user) {
    return (
      <Card className="p-4">
        <Alert variant="destructive">
          <AlertCircle className="h-4 w-4" />
          <AlertTitle>Authentication Required</AlertTitle>
          <AlertDescription>
            Please log in to access the chat.
          </AlertDescription>
        </Alert>
      </Card>
    );
  }

  if (connectionError) {
    return (
      <Card className="p-4">
        <Alert variant="destructive">
          <AlertCircle className="h-4 w-4" />
          <AlertTitle>Connection Error</AlertTitle>
          <AlertDescription>
            {connectionError}
          </AlertDescription>
        </Alert>
      </Card>
    );
  }

  return (
    <Card className={`${styles.chatWindow} ${styles[theme]}`}>
      <div className={styles.header}>
        <h2 className={styles.title}>Chat</h2>
        <ConnectionStatus isConnected={!isConnecting && !connectionError} />
        <Button onClick={toggleTheme} variant="ghost" size="icon" className={styles.themeToggle}>
          {theme === 'light' ? <Moon className="h-4 w-4" /> : <Sun className="h-4 w-4" />}
        </Button>
      </div>

      <AnimatePresence>
        {(isConnecting || isLoadingMessages) && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className={styles.loadingOverlay}
          >
            <Loader2 className={styles.loadingSpinner} />
            <p className={styles.loadingText}>
              {isConnecting ? "Connecting to chat..." : "Loading messages..."}
            </p>
          </motion.div>
        )}
      </AnimatePresence>

      <ScrollArea className={styles.messageArea}>
        <motion.div layout className={styles.messageList}>
          {messages.map((msg, index) => (
            <MessageBubble 
              key={msg.id} 
              message={msg} 
              currentUserId={user.id}
              isLastMessage={index === messages.length - 1}
            />
          ))}
        </motion.div>
        {isTyping && <TypingIndicator />}
      </ScrollArea>

      <div className={styles.inputArea}>
        <Input
          value={message}
          onChange={(e) => {
            setMessage(e.target.value);
            // Simulate typing indicator
            setIsTyping(true);
            setTimeout(() => setIsTyping(false), 1000);
          }}
          placeholder="Type your message..."
          disabled={!socket || socket.readyState !== WebSocket.OPEN}
          onKeyDown={(e) => {
            if (e.key === "Enter" && !e.shiftKey) {
              e.preventDefault();
              handleSendMessage();
            }
          }}
          className={styles.messageInput}
        />
        <Button 
          onClick={handleSendMessage} 
          disabled={!socket || socket.readyState !== WebSocket.OPEN}
          className={styles.sendButton}
        >
          <Send className="h-4 w-4" />
        </Button>
      </div>
    </Card>
  );
}
</file>

<file path="package.json">
{
  "name": "rest-express",
  "version": "1.0.0",
  "type": "module",
  "license": "MIT",
  "scripts": {
    "dev": "tsx server/index.ts",
    "build": "vite build && esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outdir=dist",
    "start": "NODE_ENV=production node dist/index.js",
    "check": "tsc",
    "db:push": "drizzle-kit push",
    "db:migrate": "tsx db/migrate.ts"
  },
  "dependencies": {
    "@anthropic-ai/sdk": "^0.33.1",
    "@copilotkit/react-core": "^1.4.7",
    "@copilotkit/react-textarea": "^1.4.7",
    "@copilotkit/react-ui": "^1.4.7",
    "@copilotkit/runtime": "^1.4.7",
    "@copilotkit/shared": "^1.4.7",
    "@hookform/resolvers": "^3.9.1",
    "@jridgewell/trace-mapping": "^0.3.25",
    "@neondatabase/serverless": "^0.10.4",
    "@radix-ui/react-accordion": "^1.2.1",
    "@radix-ui/react-alert-dialog": "^1.1.2",
    "@radix-ui/react-aspect-ratio": "^1.1.0",
    "@radix-ui/react-avatar": "^1.1.1",
    "@radix-ui/react-checkbox": "^1.1.2",
    "@radix-ui/react-collapsible": "^1.1.1",
    "@radix-ui/react-context-menu": "^2.2.2",
    "@radix-ui/react-dialog": "^1.1.2",
    "@radix-ui/react-dropdown-menu": "^2.1.2",
    "@radix-ui/react-hover-card": "^1.1.2",
    "@radix-ui/react-label": "^2.1.0",
    "@radix-ui/react-menubar": "^1.1.2",
    "@radix-ui/react-navigation-menu": "^1.2.1",
    "@radix-ui/react-popover": "^1.1.2",
    "@radix-ui/react-progress": "^1.1.0",
    "@radix-ui/react-radio-group": "^1.2.1",
    "@radix-ui/react-scroll-area": "^1.2.0",
    "@radix-ui/react-select": "^2.1.2",
    "@radix-ui/react-separator": "^1.1.0",
    "@radix-ui/react-slider": "^1.2.1",
    "@radix-ui/react-slot": "^1.1.0",
    "@radix-ui/react-switch": "^1.1.1",
    "@radix-ui/react-tabs": "^1.1.1",
    "@radix-ui/react-toast": "^1.2.2",
    "@radix-ui/react-toggle": "^1.1.0",
    "@radix-ui/react-toggle-group": "^1.1.0",
    "@radix-ui/react-tooltip": "^1.1.3",
    "@replit/object-storage": "^1.0.0",
    "@replit/vite-plugin-shadcn-theme-json": "^0.0.4",
    "@stripe/stripe-js": "^5.4.0",
    "@tanstack/react-query": "^5.60.5",
    "@theme-ui/core": "^0.17.1",
    "@types/cors": "^2.8.17",
    "@types/multer": "^1.4.12",
    "@types/pg": "^8.11.10",
    "class-variance-authority": "^0.7.0",
    "clsx": "^2.1.1",
    "cmdk": "^1.0.0",
    "cors": "^2.8.5",
    "d3": "^7.9.0",
    "date-fns": "^3.6.0",
    "dotenv": "^16.4.7",
    "drizzle-orm": "^0.38.2",
    "drizzle-zod": "^0.6.0",
    "embla-carousel-react": "^8.3.0",
    "express": "^4.21.2",
    "express-session": "^1.18.1",
    "framer-motion": "^11.13.1",
    "gsap": "^3.12.5",
    "input-otp": "^1.2.4",
    "lucide-react": "^0.453.0",
    "memorystore": "^1.6.7",
    "multer": "^1.4.5-lts.1",
    "next-themes": "^0.4.4",
    "openai": "^4.77.0",
    "passport": "^0.7.0",
    "passport-local": "^1.0.0",
    "pg": "^8.13.1",
    "postgres": "^3.4.5",
    "react": "^18.3.1",
    "react-day-picker": "^8.10.1",
    "react-dom": "^18.3.1",
    "react-force-graph": "^1.45.4",
    "react-force-graph-2d": "^1.26.1",
    "react-hook-form": "^7.53.1",
    "react-icons": "^5.4.0",
    "react-query": "^3.39.3",
    "react-resizable-panels": "^2.1.4",
    "react-router-dom": "^7.0.2",
    "recharts": "^2.13.0",
    "repomix": "^0.3.1",
    "stripe": "^17.5.0",
    "tailwind-merge": "^2.5.4",
    "tailwindcss-animate": "^1.0.7",
    "vaul": "^1.1.0",
    "wouter": "^3.3.5",
    "ws": "^8.18.0",
    "zod": "^3.23.8"
  },
  "devDependencies": {
    "@replit/vite-plugin-runtime-error-modal": "^0.0.3",
    "@tailwindcss/typography": "^0.5.15",
    "@types/d3-force": "^3.0.10",
    "@types/express": "4.17.21",
    "@types/express-session": "^1.18.0",
    "@types/node": "20.16.11",
    "@types/passport": "^1.0.16",
    "@types/passport-local": "^1.0.38",
    "@types/react": "^18.3.11",
    "@types/react-dom": "^18.3.1",
    "@types/ws": "^8.5.13",
    "@vitejs/plugin-react": "^4.3.2",
    "autoprefixer": "^10.4.20",
    "drizzle-kit": "^0.27.2",
    "esbuild": "^0.24.0",
    "postcss": "^8.4.47",
    "tailwindcss": "^3.4.14",
    "tsx": "^4.19.1",
    "typescript": "5.6.3",
    "vite": "^5.4.9"
  },
  "optionalDependencies": {
    "bufferutil": "^4.0.8"
  }
}
</file>

<file path="db/schema.ts">
import { pgTable, text, serial, integer, boolean, timestamp, jsonb, real } from "drizzle-orm/pg-core";
import { createInsertSchema, createSelectSchema } from "drizzle-zod";
import { relations } from "drizzle-orm";
import { z } from "zod";

// Achievements table to track available badges/rewards
export const achievements = pgTable("achievements", {
  id: serial("id").primaryKey(),
  name: text("name").notNull(),
  description: text("description").notNull(),
  category: text("category").notNull(), // profile, social, quiz, etc.
  points: integer("points").notNull(),
  icon: text("icon").notNull(), // Icon/badge image path
  criteria: jsonb("criteria").$type<{
    type: string;
    target: number;
    condition?: string;
  }>().notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
});

// User achievements junction table to track earned achievements
export const userAchievements = pgTable("user_achievements", {
  id: serial("id").primaryKey(),
  userId: integer("user_id").references(() => users.id, { onDelete: 'cascade' }).notNull(),
  achievementId: integer("achievement_id").references(() => achievements.id, { onDelete: 'cascade' }).notNull(),
  earnedAt: timestamp("earned_at").defaultNow().notNull(),
});

// Profile completion tracking
export const profileProgress = pgTable("profile_progress", {
  id: serial("id").primaryKey(),
  userId: integer("user_id").references(() => users.id, { onDelete: 'cascade' }).notNull(),
  totalPoints: integer("total_points").default(0).notNull(),
  level: integer("level").default(1).notNull(),
  completionPercentage: real("completion_percentage").default(0).notNull(),
  lastUpdated: timestamp("last_updated").defaultNow().notNull(),
  sections: jsonb("sections").$type<{
    basicInfo: boolean;
    avatar: boolean;
    interests: boolean;
    quiz: boolean;
    bio: boolean;
    connections: boolean;
  }>().notNull(),
});

// Interest categories table
export const interestCategories = pgTable("interest_categories", {
  id: serial("id").primaryKey(),
  name: text("name").unique().notNull(),
  description: text("description"),
  createdAt: timestamp("created_at").defaultNow().notNull(),
});

// Interests table
export const interests = pgTable("interests", {
  id: serial("id").primaryKey(),
  name: text("name").unique().notNull(),
  categoryId: integer("category_id").references(() => interestCategories.id, { onDelete: 'cascade' }).notNull(),
  description: text("description"),
  createdAt: timestamp("created_at").defaultNow().notNull(),
});

export const users = pgTable("users", {
  id: serial("id").primaryKey(),
  username: text("username").unique().notNull(),
  password: text("password").notNull(),
  name: text("name").default("").notNull(),
  bio: text("bio").default("").notNull(),
  quizCompleted: boolean("quiz_completed").default(false).notNull(),
  personalityTraits: jsonb("personality_traits").$type<Record<string, number>>().default({}).notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  isGroupCreator: boolean("is_group_creator").default(false).notNull(),
  avatar: text("avatar").default("/default-avatar.png").notNull(),
  level: integer("level").default(1).notNull(),
  xp: integer("xp").default(0).notNull(),
  lastRewardClaimed: timestamp("last_reward_claimed"),
});

// Add relations for achievements and profile progress
export const achievementRelations = relations(achievements, ({ many }) => ({
  userAchievements: many(userAchievements),
}));

export const userAchievementRelations = relations(userAchievements, ({ one }) => ({
  user: one(users, {
    fields: [userAchievements.userId],
    references: [users.id],
  }),
  achievement: one(achievements, {
    fields: [userAchievements.achievementId],
    references: [achievements.id],
  }),
}));

export const profileProgressRelations = relations(profileProgress, ({ one }) => ({
  user: one(users, {
    fields: [profileProgress.userId],
    references: [users.id],
  }),
}));

export const matches = pgTable("matches", {
  id: serial("id").primaryKey(),
  userId1: integer("user_id_1").notNull().references(() => users.id, { onDelete: 'cascade' }),
  userId2: integer("user_id_2").notNull().references(() => users.id, { onDelete: 'cascade' }),
  score: integer("score").default(0).notNull(),
  status: text("status", { enum: ['requested', 'pending', 'accepted', 'rejected', 'potential'] })
    .notNull()
    .default("requested"),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  lastActivityAt: timestamp("last_activity_at").defaultNow().notNull(),
  verifiedAt: timestamp("verified_at"),
  verificationCode: text("verification_code"),
  matchType: text("match_type", { enum: ['request', 'direct'] }).default('request').notNull(),
});

export const messages = pgTable("messages", {
  id: serial("id").primaryKey(),
  matchId: integer("match_id").notNull().references(() => matches.id, { onDelete: 'cascade' }),
  senderId: integer("sender_id").notNull().references(() => users.id, { onDelete: 'cascade' }),
  content: text("content").notNull(),
  createdAt: timestamp("created_at").defaultNow(),
  analyzed: boolean("analyzed").default(false),
  sentiment: jsonb("sentiment").$type<{
    score: number;
    magnitude: number;
    labels: string[];
  }>(),
});

export const matchesRelations = relations(matches, ({ one }) => ({
  user1: one(users, {
    fields: [matches.userId1],
    references: [users.id],
  }),
  user2: one(users, {
    fields: [matches.userId2],
    references: [users.id],
  }),
}));

export const messagesRelations = relations(messages, ({ one }) => ({
  match: one(matches, {
    fields: [messages.matchId],
    references: [matches.id],
  }),
  sender: one(users, {
    fields: [messages.senderId],
    references: [users.id],
  }),
}));

// User interests junction table
export const userInterests = pgTable("user_interests", {
  id: serial("id").primaryKey(),
  userId: integer("user_id").references(() => users.id, { onDelete: 'cascade' }).notNull(),
  interestId: integer("interest_id").references(() => interests.id, { onDelete: 'cascade' }).notNull(),
  score: integer("score").default(0).notNull(), // Interest level/score from 0-100
  createdAt: timestamp("created_at").defaultNow().notNull(),
});

// Add relations for interests
export const interestRelations = relations(interests, ({ one, many }) => ({
  category: one(interestCategories, {
    fields: [interests.categoryId],
    references: [interestCategories.id],
  }),
  users: many(userInterests),
}));

// Add relations for users with interests
export const userInterestRelations = relations(userInterests, ({ one }) => ({
  user: one(users, {
    fields: [userInterests.userId],
    references: [users.id],
  }),
  interest: one(interests, {
    fields: [userInterests.interestId],
    references: [interests.id],
  }),
}));

// Create schemas for validation
export const insertUserSchema = createInsertSchema(users);
export const selectUserSchema = createSelectSchema(users);
export const insertMessageSchema = createInsertSchema(messages);
export const selectMessageSchema = createSelectSchema(messages);
export const insertMatchSchema = createInsertSchema(matches);
export const selectMatchSchema = createSelectSchema(matches);

// Create schemas for validation
export const insertInterestCategorySchema = createInsertSchema(interestCategories);
export const selectInterestCategorySchema = createSelectSchema(interestCategories);
export const insertInterestSchema = createInsertSchema(interests);
export const selectInterestSchema = createSelectSchema(interests);
export const insertUserInterestSchema = createInsertSchema(userInterests);
export const selectUserInterestSchema = createSelectSchema(userInterests);

// Export types
export type User = typeof users.$inferSelect;
export type NewUser = typeof users.$inferInsert;
export type Match = typeof matches.$inferSelect;
export type NewMatch = typeof matches.$inferInsert;
export type Message = typeof messages.$inferSelect;
export type NewMessage = typeof messages.$inferInsert;
export type Interest = typeof interests.$inferSelect;
export type NewInterest = typeof interests.$inferInsert;
export type InterestCategory = typeof interestCategories.$inferSelect;
export type NewInterestCategory = typeof interestCategories.$inferInsert;
export type UserInterest = typeof userInterests.$inferSelect;
export type NewUserInterest = typeof userInterests.$inferInsert;

// Create schemas for achievements and progress
export const insertAchievementSchema = createInsertSchema(achievements);
export const selectAchievementSchema = createSelectSchema(achievements);
export const insertUserAchievementSchema = createInsertSchema(userAchievements);
export const selectUserAchievementSchema = createSelectSchema(userAchievements);
export const insertProfileProgressSchema = createInsertSchema(profileProgress);
export const selectProfileProgressSchema = createSelectSchema(profileProgress);

// Export types for new tables
export type Achievement = typeof achievements.$inferSelect;
export type NewAchievement = typeof achievements.$inferInsert;
export type UserAchievement = typeof userAchievements.$inferSelect;
export type NewUserAchievement = typeof userAchievements.$inferInsert;
export type ProfileProgress = typeof profileProgress.$inferSelect;
export type NewProfileProgress = typeof profileProgress.$inferInsert;

// Export schema types for auth
export type SelectUser = User;
export type InsertUser = NewUser;

export type AchievementCategory = 
  | 'profile'
  | 'engagement'
  | 'social'
  | 'streak'
  | 'milestone';

export type AchievementCriteriaType = 
  | 'profile' 
  | 'login' 
  | 'streak' 
  | 'count' 
  | 'milestone';

export type TimeFrame = 'daily' | 'weekly' | 'monthly' | 'all_time';

export interface AchievementCriteria {
  type: AchievementCriteriaType;
  condition: string;
  threshold?: number;
  timeframe?: TimeFrame;
}

export interface AchievementDefinition {
  id: string;
  name: string;
  description: string;
  icon: string;
  points: number;
  category: AchievementCategory;
  criteria: AchievementCriteria;
}

export interface UserAchievementProgress {
  userId: string;
  achievementId: string;
  unlockedAt: Date;
  progress?: number;
}

export interface UserStreakData {
  userId: string;
  currentStreak: number;
  longestStreak: number;
  lastLoginDate: Date;
  loginCount: {
    daily: number;
    weekly: number;
    monthly: number;
    allTime: number;
  };
  lastReset: {
    daily: Date;
    weekly: Date;
    monthly: Date;
  };
}

export const ACHIEVEMENTS: AchievementDefinition[] = [
  // Profile Achievements
  {
    id: 'profile_created',
    name: 'Welcome Aboard!',
    description: 'Create your account and join the community',
    icon: '',
    points: 100,
    category: 'profile',
    criteria: { type: 'profile', condition: 'registration' }
  },
  {
    id: 'profile_complete',
    name: 'Identity Established',
    description: 'Complete your profile with all information',
    icon: '',
    points: 200,
    category: 'profile',
    criteria: { type: 'profile', condition: 'profileComplete' }
  },
  {
    id: 'avatar_uploaded',
    name: 'Face in the Crowd',
    description: 'Upload your first profile picture',
    icon: '',
    points: 150,
    category: 'profile',
    criteria: { type: 'profile', condition: 'avatarUploaded' }
  },
  {
    id: 'bio_master',
    name: 'Wordsmith',
    description: 'Write a bio that truly captures who you are',
    icon: '',
    points: 100,
    category: 'profile',
    criteria: { type: 'profile', condition: 'bioAdded' }
  },
  {
    id: 'interests_added',
    name: 'Passion Finder',
    description: 'Add at least 5 interests to your profile',
    icon: '',
    points: 150,
    category: 'profile',
    criteria: { type: 'profile', condition: 'interestsAdded', threshold: 5 }
  },

  // Login Streaks
  {
    id: 'first_login',
    name: 'First Steps',
    description: 'Log in for the first time',
    icon: '',
    points: 50,
    category: 'streak',
    criteria: { type: 'login', condition: 'first_login' }
  },
  {
    id: 'daily_login_3',
    name: 'Regular Visitor',
    description: 'Log in 3 days in a row',
    icon: '',
    points: 150,
    category: 'streak',
    criteria: { type: 'streak', condition: 'daily', threshold: 3 }
  },
  {
    id: 'daily_login_7',
    name: 'Week Warrior',
    description: 'Log in 7 days in a row',
    icon: '',
    points: 300,
    category: 'streak',
    criteria: { type: 'streak', condition: 'daily', threshold: 7 }
  },
  {
    id: 'daily_login_30',
    name: 'Monthly Master',
    description: 'Log in 30 days in a row',
    icon: '',
    points: 1000,
    category: 'streak',
    criteria: { type: 'streak', condition: 'daily', threshold: 30 }
  },
  {
    id: 'daily_login_100',
    name: 'Centurion',
    description: 'Maintain a 100-day login streak',
    icon: '',
    points: 5000,
    category: 'streak',
    criteria: { type: 'streak', condition: 'daily', threshold: 100 }
  },
  {
    id: 'weekly_regular',
    name: 'Weekend Warrior',
    description: 'Log in every weekend for a month',
    icon: '',
    points: 500,
    category: 'streak',
    criteria: { type: 'streak', condition: 'weekly_weekend', threshold: 4 }
  },

  // Engagement Frequency
  {
    id: 'daily_visits_3',
    name: 'Triple Dipper',
    description: 'Visit 3 times in one day',
    icon: '',
    points: 100,
    category: 'engagement',
    criteria: { type: 'count', condition: 'login', threshold: 3, timeframe: 'daily' }
  },
  {
    id: 'daily_visits_5',
    name: 'High Five',
    description: 'Visit 5 times in one day',
    icon: '',
    points: 200,
    category: 'engagement',
    criteria: { type: 'count', condition: 'login', threshold: 5, timeframe: 'daily' }
  },
  {
    id: 'weekly_visits_20',
    name: 'Weekly Wonder',
    description: 'Visit 20 times in one week',
    icon: '',
    points: 400,
    category: 'engagement',
    criteria: { type: 'count', condition: 'login', threshold: 20, timeframe: 'weekly' }
  },
  {
    id: 'active_hours_5',
    name: 'Time Well Spent',
    description: 'Spend 5 hours actively using the app',
    icon: '',
    points: 300,
    category: 'engagement',
    criteria: { type: 'count', condition: 'active_time', threshold: 5, timeframe: 'all_time' }
  },
  {
    id: 'night_owl',
    name: 'Night Owl',
    description: 'Log in after midnight 5 times',
    icon: '',
    points: 250,
    category: 'engagement',
    criteria: { type: 'count', condition: 'night_login', threshold: 5, timeframe: 'all_time' }
  },
  {
    id: 'early_bird',
    name: 'Early Bird',
    description: 'Log in before 7 AM 5 times',
    icon: '',
    points: 250,
    category: 'engagement',
    criteria: { type: 'count', condition: 'morning_login', threshold: 5, timeframe: 'all_time' }
  },

  // Milestones
  {
    id: 'visits_100',
    name: 'Century Club',
    description: 'Visit the app 100 times total',
    icon: '',
    points: 500,
    category: 'milestone',
    criteria: { type: 'milestone', condition: 'login', threshold: 100 }
  },
  {
    id: 'visits_500',
    name: 'Dedicated Fan',
    description: 'Visit the app 500 times total',
    icon: '',
    points: 1500,
    category: 'milestone',
    criteria: { type: 'milestone', condition: 'login', threshold: 500 }
  },
  {
    id: 'visits_1000',
    name: 'True Devotee',
    description: 'Visit the app 1,000 times total',
    icon: '',
    points: 3000,
    category: 'milestone',
    criteria: { type: 'milestone', condition: 'login', threshold: 1000 }
  },
  {
    id: 'level_5',
    name: 'Rising Star',
    description: 'Reach level 5',
    icon: '',
    points: 500,
    category: 'milestone',
    criteria: { type: 'milestone', condition: 'level', threshold: 5 }
  },
  {
    id: 'level_10',
    name: 'Power Player',
    description: 'Reach level 10',
    icon: '',
    points: 1000,
    category: 'milestone',
    criteria: { type: 'milestone', condition: 'level', threshold: 10 }
  },
  {
    id: 'level_20',
    name: 'Elite Status',
    description: 'Reach level 20',
    icon: '',
    points: 2000,
    category: 'milestone',
    criteria: { type: 'milestone', condition: 'level', threshold: 20 }
  },

  // Social Achievements
  {
    id: 'first_message',
    name: 'Ice Breaker',
    description: 'Send your first message',
    icon: '',
    points: 100,
    category: 'social',
    criteria: { type: 'milestone', condition: 'first_message' }
  },
  {
    id: 'messages_100',
    name: 'Chatty Cathy',
    description: 'Send 100 messages',
    icon: '',
    points: 300,
    category: 'social',
    criteria: { type: 'milestone', condition: 'messages', threshold: 100 }
  },
  {
    id: 'messages_1000',
    name: 'Message Master',
    description: 'Send 1,000 messages',
    icon: '',
    points: 1000,
    category: 'social',
    criteria: { type: 'milestone', condition: 'messages', threshold: 1000 }
  },
  {
    id: 'first_match',
    name: 'Perfect Match',
    description: 'Get your first connection match',
    icon: '',
    points: 200,
    category: 'social',
    criteria: { type: 'milestone', condition: 'first_match' }
  },
  {
    id: 'matches_5',
    name: 'Social Butterfly',
    description: 'Connect with 5 different people',
    icon: '',
    points: 500,
    category: 'social',
    criteria: { type: 'milestone', condition: 'matches', threshold: 5 }
  },
  {
    id: 'matches_20',
    name: 'Networking Pro',
    description: 'Connect with 20 different people',
    icon: '',
    points: 1000,
    category: 'social',
    criteria: { type: 'milestone', condition: 'matches', threshold: 20 }
  },
  {
    id: 'conversation_starter',
    name: 'Conversation Starter',
    description: 'Start 10 conversations in one day',
    icon: '',
    points: 300,
    category: 'social',
    criteria: { type: 'count', condition: 'conversations_started', threshold: 10, timeframe: 'daily' }
  },
  {
    id: 'quick_responder',
    name: 'Quick Draw',
    description: 'Respond to 5 messages within 5 minutes',
    icon: '',
    points: 250,
    category: 'social',
    criteria: { type: 'count', condition: 'quick_responses', threshold: 5, timeframe: 'all_time' }
  },
  {
    id: 'conversation_marathon',
    name: 'Marathon Runner',
    description: 'Maintain a conversation for over an hour',
    icon: '',
    points: 400,
    category: 'social',
    criteria: { type: 'milestone', condition: 'long_conversation', threshold: 60 }
  }
] as const;
</file>

<file path="server/copilotkit.ts">
import {
  CopilotRuntime,
  OpenAIAdapter,
  copilotRuntimeNodeHttpEndpoint,
} from '@copilotkit/runtime';

if (!process.env.OPENAI_API_KEY) {
  throw new Error('OPENAI_API_KEY environment variable is required');
}

export function setupCopilotKit(app: any) {
  const runtime = new CopilotRuntime();
  const serviceAdapter = new OpenAIAdapter();
  const handler = copilotRuntimeNodeHttpEndpoint({
    endpoint: '/copilotkit',
    runtime,
    serviceAdapter,
  });

  app.all('/copilotkit*', (req: any, res: any) => {
    return handler(req, res);
  });
}
</file>

<file path="server/index.ts">
import express, { type Request, Response, NextFunction } from "express";
import { registerRoutes } from "./routes";
import { setupVite, serveStatic, log } from "./vite";
import { setupAuth } from "./auth";
import { setupCopilotKit } from "./copilotkit";
import { stripeRouter } from "./stripe";
import path from 'path';
import { fileURLToPath } from 'url';

const app = express();

// Basic middleware setup - before auth to ensure body parsing is available
app.use(express.json());
app.use(express.urlencoded({ extended: false }));
app.use('/api', stripeRouter);

// Serve static files from public directory
app.use(express.static(path.join(path.dirname(fileURLToPath(import.meta.url)), '../client/public')));

app.use("/copilotkit", express.static(path.join(path.dirname(fileURLToPath(import.meta.url)), './copilotkit')));

// Request logging middleware
app.use((req, res, next) => {
  const start = Date.now();
  const path = req.path;
  let capturedJsonResponse: Record<string, any> | undefined = undefined;

  const originalResJson = res.json;
  res.json = function (bodyJson, ...args) {
    capturedJsonResponse = bodyJson;
    return originalResJson.apply(res, [bodyJson, ...args]);
  };

  res.on("finish", () => {
    const duration = Date.now() - start;
    if (path.startsWith("/api")) {
      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;
      if (capturedJsonResponse) {
        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;
      }
      if (logLine.length > 80) {
        logLine = logLine.slice(0, 79) + "";
      }
      log(logLine);
    }
  });

  next();
});

// Start the server with proper error handling
(async () => {
  try {
    // Initialize authentication first
    await setupAuth(app);
    console.log("Authentication system initialized");

    // Setup CopilotKit
    setupCopilotKit(app);
    console.log("CopilotKit initialized");

    // Register API routes before Vite/static middleware
    const server = registerRoutes(app);

    // Global error handler
    app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {
      console.error('Error:', {
        status: err.status || err.statusCode || 500,
        message: err.message,
        stack: err.stack,
        timestamp: new Date().toISOString()
      });

      // Don't send error stack in production
      const status = err.status || err.statusCode || 500;
      const message = err.message || "Internal Server Error";

      // Send JSON response for API routes, HTML for others
      if (_req.path.startsWith('/api')) {
        res.status(status).json({
          success: false,
          message: app.get('env') === 'development' ? message : 'Internal Server Error',
          ...(app.get('env') === 'development' && { stack: err.stack })
        });
      } else {
        res.status(status).send(message);
      }
    });

    // Setup Vite or static serving AFTER API routes
    if (app.get("env") === "development") {
      await setupVite(app, server);
    } else {
      serveStatic(app);
    }

    // Start listening
    const PORT = 5000;
    server.listen(PORT, "0.0.0.0", () => {
      log(`Server running on port ${PORT}`);
    });
  } catch (error) {
    console.error('Failed to start server:', error);
    process.exit(1);
  }
})();

// Handle uncaught errors
process.on('uncaughtException', (error) => {
  console.error('Uncaught Exception:', error);
  process.exit(1);
});

process.on('unhandledRejection', (reason, promise) => {
  console.error('Unhandled Rejection at:', promise, 'reason:', reason);
  process.exit(1);
});
</file>

<file path="client/src/hooks/use-user.ts">
import { setUserData, setUserId, clearAuthData } from '@/utils/auth';
import { useMutation, useQuery, useQueryClient } from "@tanstack/react-query";
import type { SelectUser } from "@db/schema";
import { useToast } from "@/hooks/use-toast";

interface AuthCredentials {
  username: string;
  password: string;
}

interface AuthResponse {
  success: boolean;
  message: string;
  user: {
    id: number;
    username: string;
    name?: string;
    quizCompleted?: boolean;
    isGroupCreator?: boolean;
    avatar?: string;
  };
}

async function handleAuthRequest(
  url: string,
  credentials: AuthCredentials
): Promise<AuthResponse> {
  try {
    const response = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(credentials),
      credentials: "include",
    });

    let parsedData;
    const responseData = await response.text();

    try {
      parsedData = JSON.parse(responseData);
      console.log('Auth response:', parsedData);
    } catch (e) {
      console.error('Failed to parse response:', responseData);
      throw new Error(responseData || "Invalid server response");
    }

    if (!response.ok) {
      const errorMessage = parsedData?.message || parsedData?.error || "Authentication failed";
      console.error(`Auth request failed (${response.status}):`, errorMessage);
      throw new Error(errorMessage);
    }

    if (!parsedData.success || !parsedData.user) {
      throw new Error("Invalid response format from server");
    }

    return parsedData;
  } catch (error) {
    console.error("Auth request error:", error);
    throw error instanceof Error ? error : new Error("Authentication failed");
  }
}

export function useUser() {
  const queryClient = useQueryClient();
  const { toast } = useToast();

  const { data: user, isLoading } = useQuery<SelectUser | null>({
    queryKey: ['/api/user'],
    queryFn: async () => {
      try {
        console.log('Fetching user data...');
        const response = await fetch("/api/user", {
          credentials: "include",
          headers: {
            'Accept': 'application/json',
            'Cache-Control': 'no-cache'
          }
        });

        if (response.status === 401) {
          console.log("User not authenticated");
          return null;
        }

        if (!response.ok) {
          console.error("Failed to fetch user:", response.status, response.statusText);
          const errorText = await response.text();
          throw new Error(`Failed to fetch user: ${errorText}`);
        }

        const userData = await response.json();
        console.log("User data fetched:", userData);

        if (userData?.user) {
          const user = userData.user;
          setUserId(user.id);
          setUserData({
            id: user.id,
            username: user.username,
            name: user.name || user.username,
            // Handle avatar URL properly
            avatar: user.avatar ? (user.avatar.startsWith('http') ? user.avatar : `/api/avatars/${user.avatar}`) : '/default-avatar.png',
            isGroupCreator: user.isGroupCreator || false,
            quizCompleted: user.quizCompleted || false
          });
          return user;
        }

        return null;
      } catch (error) {
        console.error("Error in user fetch:", error);
        return null;
      }
    },
    staleTime: 1000 * 60,
    gcTime: 1000 * 60 * 5,
    refetchOnWindowFocus: true,
    retry: (failureCount, error) => {
      if (error instanceof Error && error.message.includes('401')) {
        return false;
      }
      return failureCount < 3;
    },
  });

  const loginMutation = useMutation({
    mutationFn: async (credentials: AuthCredentials) => {
      try {
        const response = await handleAuthRequest("/api/login", credentials);
        console.log("Login successful:", response);

        if (response.success) {
          const { user } = response;

          setUserId(user.id);
          setUserData({
            id: user.id,
            username: user.username,
            name: user.name || user.username,
            avatar: user.avatar,
            isGroupCreator: user.isGroupCreator || false
          });

          // Invalidate and refetch relevant queries
          queryClient.invalidateQueries({ queryKey: ['/api/user'] });
          queryClient.invalidateQueries({ queryKey: ['/api/matches'] });

          return { ok: true, user };
        }

        throw new Error(response.message || "Login failed");
      } catch (error) {
        console.error("Login error:", error);
        clearAuthData();
        throw error;
      }
    },
    onSuccess: (data) => {
      console.log("Login successful:", data);
      toast({
        title: "Welcome back!",
        description: "You have been successfully logged in.",
      });
    },
    onError: (error: Error) => {
      console.error("Login error:", error);
      clearAuthData();
      toast({
        title: "Login failed",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  const registerMutation = useMutation({
    mutationFn: async (credentials: AuthCredentials) => {
      const response = await handleAuthRequest("/api/register", credentials);
      return { ...response, ok: true };
    },
    onSuccess: (data) => {
      console.log("Registration successful:", data);
      queryClient.setQueryData(["/api/user"], data.user);
      queryClient.invalidateQueries({ queryKey: ["/api/user"] });
      toast({
        title: "Registration successful",
        description: "Your account has been created.",
      });
    },
    onError: (error: Error) => {
      console.error("Registration error:", error);
      toast({
        title: "Registration failed",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  const logoutMutation = useMutation({
    mutationFn: async () => {
      const response = await fetch("/api/logout", {
        method: "POST",
        credentials: "include",
      });

      if (!response.ok) {
        const errorText = await response.text();
        console.error("Logout failed:", response.status, errorText);
        throw new Error(errorText || "Logout failed");
      }

      clearAuthData();
      return response.json();
    },
    onSuccess: () => {
      queryClient.setQueryData(["/api/user"], null);
      queryClient.invalidateQueries({ queryKey: ["/api/user"] });
      toast({
        title: "Logged out",
        description: "You have been successfully logged out.",
      });
    },
    onError: (error: Error) => {
      console.error("Logout error:", error);
      toast({
        title: "Logout failed",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  return {
    user,
    isLoading,
    login: loginMutation.mutateAsync,
    register: registerMutation.mutateAsync,
    logout: logoutMutation.mutateAsync,
  };
}
</file>

<file path="client/src/pages/Profile.tsx">
import { ProfileProgress } from "@/components/ProfileProgress";
import { Button } from "@/components/ui/button";
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from "@/components/ui/card";
import { Form, FormControl, FormDescription, FormField, FormItem, FormLabel, FormMessage } from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { useUser } from "@/hooks/use-user";
import { Loader2, User, Upload } from 'lucide-react';
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { useToast } from "@/hooks/use-toast";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { useCallback, useState } from "react";

const profileSchema = z.object({
  name: z.string().min(2, "Name must be at least 2 characters").max(50, "Name must be less than 50 characters").nullable(),
  bio: z.string().max(500, "Bio must be less than 500 characters").nullable(),
});

type ProfileFormValues = z.infer<typeof profileSchema>;

const DEFAULT_AVATAR = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBjbGFzcz0ibHVjaWRlIGx1Y2lkZS11c2VyIj48cGF0aCBkPSJNMjAgMjF2LTJhNCA0IDAgMCAwLTQtNEg4YTQgNCAwIDAgMC00IDR2MiIvPjxjaXJjbGUgY3g9IjEyIiBjeT0iNyIgcj0iNCIvPjwvc3ZnPg==';

const getAvatarUrl = (avatarPath: string): string => {
  if (!avatarPath || avatarPath === '/default-avatar.png') {
    return DEFAULT_AVATAR;
  }

  // Handle full URLs (including replit-objstore URLs)
  if (avatarPath.startsWith('http')) {
    return avatarPath;
  }

  // Handle relative API paths
  if (avatarPath.startsWith('/api/')) {
    return avatarPath;
  }

  // Ensure avatars/ prefix is present
  const path = avatarPath.startsWith('avatars/') ? avatarPath : `avatars/${avatarPath}`;
  return `/api/avatars/${path}`;
};

export default function ProfilePage() {
  const { user, isLoading } = useUser();
  const { toast } = useToast();
  const queryClient = useQueryClient();
  const [avatarLoadError, setAvatarLoadError] = useState<boolean>(false);

  const form = useForm<ProfileFormValues>({
    resolver: zodResolver(profileSchema),
    defaultValues: {
      name: user?.name || "",
      bio: user?.bio || "",
    },
  });

  const updateProfile = useMutation({
    mutationFn: async (values: ProfileFormValues) => {
      const response = await fetch("/api/user/profile", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(values),
        credentials: "include",
      });

      if (!response.ok) {
        throw new Error(await response.text());
      }

      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["user"] });
      toast({
        title: "Profile updated",
        description: "Your profile has been successfully updated.",
      });
    },
    onError: (error: Error) => {
      toast({
        title: "Error",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  const uploadImage = useMutation({
    mutationFn: async (file: File) => {
      const formData = new FormData();
      formData.append('image', file);

      const response = await fetch("/api/user/profile/image", {
        method: "POST",
        body: formData,
        credentials: "include",
      });

      if (!response.ok) {
        throw new Error(await response.text());
      }

      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["user"] });
      toast({
        title: "Image uploaded",
        description: "Your profile image has been successfully updated.",
      });
    },
    onError: (error: Error) => {
      toast({
        title: "Error",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  const handleImageUpload = useCallback(async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    // Validate file type
    if (!file.type.startsWith('image/')) {
      toast({
        title: "Invalid file type",
        description: "Please upload an image file.",
        variant: "destructive",
      });
      return;
    }

    // Validate file size (5MB limit)
    if (file.size > 5 * 1024 * 1024) {
      toast({
        title: "File too large",
        description: "Please upload an image smaller than 5MB.",
        variant: "destructive",
      });
      return;
    }

    await uploadImage.mutateAsync(file);
  }, [uploadImage, toast]);

  async function onSubmit(values: ProfileFormValues) {
    await updateProfile.mutateAsync(values);
  }

  const renderAvatar = (showUpload: boolean = true) => (
    <div className="relative group">
      <div className="h-20 w-20 rounded-full bg-muted flex items-center justify-center overflow-hidden">
        {user?.avatar && !avatarLoadError ? (
          <img 
            src={getAvatarUrl(user.avatar)}
            alt={user?.name || 'Profile'} 
            className="h-full w-full object-cover"
            onError={(e) => {
              const target = e.target as HTMLImageElement;
              target.onerror = null;
              console.error('Failed to load avatar:', target.src);
              setAvatarLoadError(true);
            }}
          />
        ) : (
          <User className="h-10 w-10 text-muted-foreground" />
        )}
      </div>
      {showUpload && (
        <>
          <label 
            htmlFor="avatar-upload" 
            className="absolute inset-0 flex items-center justify-center bg-black/50 text-white opacity-0 group-hover:opacity-100 rounded-full cursor-pointer transition-opacity"
          >
            <Upload className="h-6 w-6" />
            <input
              type="file"
              id="avatar-upload"
              className="hidden"
              accept="image/*"
              onChange={handleImageUpload}
              disabled={uploadImage.isPending}
            />
          </label>
          {uploadImage.isPending && (
            <div className="absolute inset-0 flex items-center justify-center bg-black/50 text-white rounded-full">
              <Loader2 className="h-6 w-6 animate-spin" />
            </div>
          )}
        </>
      )}
    </div>
  );

  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Loader2 className="h-8 w-8 animate-spin text-primary" />
      </div>
    );
  }

  if (!user) {
    return null;
  }

  return (
    <div className="container mx-auto py-8 px-4">
      <div className="max-w-4xl mx-auto space-y-8">
        <div className="grid md:grid-cols-2 gap-8">
          <Card>
            <CardHeader className="space-y-1">
              <div className="flex items-center gap-4">
                {renderAvatar(false)}
                <div>
                  <CardTitle>Live Profile</CardTitle>
                  <CardDescription>
                    This is how others see your profile
                  </CardDescription>
                </div>
              </div>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                <div>
                  <h3 className="text-sm font-medium text-muted-foreground">Display Name</h3>
                  <p className="mt-1 text-lg font-semibold">{user.name || "Not set"}</p>
                </div>
                <div>
                  <h3 className="text-sm font-medium text-muted-foreground">Bio</h3>
                  <p className="mt-1">{user.bio || "No bio set"}</p>
                </div>
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="space-y-1">
              <div className="flex items-center gap-4">
                {renderAvatar(true)}
                <div>
                  <CardTitle>Edit Profile</CardTitle>
                  <CardDescription>
                    Update your profile information
                  </CardDescription>
                </div>
              </div>
            </CardHeader>
            <CardContent>
              <Form {...form}>
                <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
                  <FormField
                    control={form.control}
                    name="name"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Display Name</FormLabel>
                        <FormControl>
                          <Input placeholder="Enter your display name" {...field} value={field.value || ""} />
                        </FormControl>
                        <FormDescription>
                          This is your public display name.
                        </FormDescription>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={form.control}
                    name="bio"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Bio</FormLabel>
                        <FormControl>
                          <Textarea
                            placeholder="Tell us a bit about yourself"
                            className="resize-none"
                            {...field}
                            value={field.value || ""}
                          />
                        </FormControl>
                        <FormDescription>
                          Write a short bio to help others get to know you better.
                        </FormDescription>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  <Button variant="default" type="submit" disabled={updateProfile.isPending}>
                    {updateProfile.isPending ? (
                      <>
                        <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                        Syncing profile...
                      </>
                    ) : (
                      "Update Profile"
                    )}
                  </Button>
                </form>
              </Form>
            </CardContent>
          </Card>
        </div>

        <ProfileProgress />
      </div>
    </div>
  );
}
</file>

<file path="server/auth.ts">
import passport from "passport";
import { IVerifyOptions, Strategy as LocalStrategy } from "passport-local";
import { type Express, Request, Response, NextFunction } from "express";
import session from "express-session";
import createMemoryStore from "memorystore";
import { scrypt, randomBytes, timingSafeEqual } from "crypto";
import { promisify } from "util";
import { users, matches, insertUserSchema, type SelectUser } from "@db/schema";
import { db } from "@db";
import { eq, or, and } from "drizzle-orm";
import { z } from "zod";
import Stripe from 'stripe';

const scryptAsync = promisify(scrypt);

// Initialize Stripe with proper error handling
let stripe: Stripe | null = null;
if (process.env.STRIPE_SECRET_KEY) {
  try {
    stripe = new Stripe(process.env.STRIPE_SECRET_KEY, {
      apiVersion: '2024-12-18.acacia',
      typescript: true
    });
    console.log('Stripe initialized successfully');
  } catch (error) {
    console.error('Failed to initialize Stripe:', error);
    // Continue without Stripe - application can still function
  }
} else {
  console.warn('STRIPE_SECRET_KEY not set - Stripe features will be disabled');
}

const loginSchema = z.object({
  username: z.string().min(1, "Username is required"),
  password: z.string().min(1, "Password is required"),
});

export const crypto = {
  hash: async (password: string) => {
    const salt = randomBytes(16).toString("hex");
    const buf = (await scryptAsync(password, salt, 64)) as Buffer;
    return `${buf.toString("hex")}.${salt}`;
  },
  compare: async (suppliedPassword: string, storedPassword: string) => {
    const [hashedPassword, salt] = storedPassword.split(".");
    const hashedPasswordBuf = Buffer.from(hashedPassword, "hex");
    const suppliedPasswordBuf = (await scryptAsync(
      suppliedPassword,
      salt,
      64
    )) as Buffer;
    return timingSafeEqual(hashedPasswordBuf, suppliedPasswordBuf);
  },
};

declare global {
  namespace Express {
    interface User extends SelectUser {}
    interface Request {
      matchData?: typeof matches.$inferSelect;
    }
  }
}

// Extend express-session to include passport
declare module 'express-session' {
  interface SessionData {
    passport: {
      user: number;
    };
  }
}

// Rate limiting for match requests
const matchRequestLimits = new Map<number, { count: number; resetTime: number }>();
const MAX_REQUESTS_PER_HOUR = 20;
const HOUR_IN_MS = 3600000;

const checkMatchRequestLimit = (userId: number): boolean => {
  const now = Date.now();
  const userLimit = matchRequestLimits.get(userId);

  if (!userLimit || now > userLimit.resetTime) {
    matchRequestLimits.set(userId, { count: 1, resetTime: now + HOUR_IN_MS });
    return true;
  }

  if (userLimit.count >= MAX_REQUESTS_PER_HOUR) {
    return false;
  }

  userLimit.count++;
  return true;
};

export const verifyMatchAccess = async (req: Request, res: Response, next: NextFunction) => {
  try {
    if (!req.isAuthenticated()) {
      return res.status(401).json({ 
        success: false, 
        message: "Authentication required",
        timestamp: new Date().toISOString()
      });
    }

    const user = req.user as SelectUser;
    const matchId = parseInt(req.params.matchId);

    if (isNaN(matchId)) {
      return res.status(400).json({ 
        success: false, 
        message: "Invalid match ID",
        timestamp: new Date().toISOString()
      });
    }

    // Verify match exists and user has access
    const [match] = await db
      .select()
      .from(matches)
      .where(
        and(
          eq(matches.id, matchId),
          or(
            eq(matches.userId1, user.id),
            eq(matches.userId2, user.id)
          ),
          or(
            eq(matches.status, 'accepted'),
            eq(matches.status, 'requested'),
            eq(matches.status, 'pending')
          )
        )
      )
      .limit(1);

    if (!match) {
      return res.status(404).json({ 
        success: false, 
        message: "Match not found or invalid status",
        timestamp: new Date().toISOString()
      });
    }

    // Check if the match is in a valid state for the requested operation
    if (req.path.includes('/messages')) {
      // For message-related endpoints, only allow if match is accepted
      if (match.status !== 'accepted') {
        return res.status(403).json({
          success: false,
          message: "Match must be accepted to access messages",
          timestamp: new Date().toISOString()
        });
      }
    }

    // Store match data in request for route handlers
    req.matchData = match;
    next();
  } catch (error) {
    console.error('Match verification error:', error);
    return res.status(500).json({ 
      success: false, 
      message: "Failed to verify match access",
      timestamp: new Date().toISOString()
    });
  }
};

export async function setupAuth(app: Express) {
  if (!process.env.DATABASE_URL) {
    throw new Error("DATABASE_URL must be set for auth to work");
  }

  try {
    const [testUser] = await db
      .select({ id: users.id })
      .from(users)
      .limit(1);
    console.log("Database connection verified");
  } catch (error) {
    console.error("Database connection failed:", error);
    throw new Error("Failed to connect to database");
  }

  const MemoryStore = createMemoryStore(session);
  const sessionStore = new MemoryStore({
    checkPeriod: 86400000, // 24 hours
    ttl: 604800000, // 7 days
    noDisposeOnSet: true, // Prevent disposal on session updates
    dispose: (key: string, sess: session.SessionData) => {
      // Only log in development and only for actual expirations
      if (process.env.NODE_ENV === 'development' && !sess.cookie?.expires) {
        console.debug(`Session ${key} expired naturally`);
      }
    }
  });

  const sessionSettings: session.SessionOptions = {
    secret: process.env.REPL_ID || "porygon-supremacy",
    resave: true, // Enable session updates
    saveUninitialized: false,
    rolling: true, // Reset expiration on each request
    cookie: {
      maxAge: 604800000, // 7 days
      secure: app.get("env") === "production",
      sameSite: "lax",
      httpOnly: true,
      path: '/'
    },
    store: sessionStore,
    name: 'sid',
    proxy: app.get("env") === "production" // Trust proxy in production
  };

  if (app.get("env") === "production") {
    app.set("trust proxy", 1);
    if (sessionSettings.cookie) {
      sessionSettings.cookie.secure = true;
    }
  }

  app.use(session(sessionSettings));
  app.use(passport.initialize());
  app.use(passport.session());

  // Cleanup handler for graceful shutdown
  process.on('SIGTERM', () => {
    sessionStore.stopInterval();
  });

  // Serialize the entire user object
  passport.serializeUser((user: Express.User, done) => {
    done(null, user.id);
  });

  // Deserialize with full user data
  passport.deserializeUser(async (id: number, done) => {
    try {
      const [user] = await db
        .select()
        .from(users)
        .where(eq(users.id, id))
        .limit(1);
      
      if (!user) {
        return done(null, false);
      }
      
      done(null, user);
    } catch (error) {
      done(error, false);
    }
  });

  passport.use(
    new LocalStrategy(async (username, password, done) => {
      try {
        const [user] = await db
          .select()
          .from(users)
          .where(eq(users.username, username))
          .limit(1);

        if (!user) {
          return done(null, false, { message: "Incorrect username." });
        }
        const isMatch = await crypto.compare(password, user.password);
        if (!isMatch) {
          return done(null, false, { message: "Incorrect password." });
        }
        return done(null, user);
      } catch (err) {
        console.error('Auth error:', err);
        return done(err);
      }
    })
  );

  app.post("/api/register", async (req, res, next) => {
    try {
      const result = insertUserSchema.safeParse(req.body);
      if (!result.success) {
        return res.status(400).json({ 
          success: false, 
          message: "Invalid input: " + result.error.issues.map(i => i.message).join(", ")
        });
      }

      const { username, password } = result.data;

      const [existingUser] = await db
        .select()
        .from(users)
        .where(eq(users.username, username))
        .limit(1);

      if (existingUser) {
        return res.status(400).json({ 
          success: false, 
          message: "Username already exists" 
        });
      }

      const hashedPassword = await crypto.hash(password);
      
      let stripeCustomerId = null;
      
      try {
        // Only attempt to create Stripe customer if stripe is initialized
        if (stripe) {
          const customer = await stripe.customers.create({
            email: username,
            metadata: {
              username: username
            }
          });
          stripeCustomerId = customer.id;
        }
      } catch (stripeError) {
        console.error('Stripe customer creation failed:', stripeError);
        // Continue with user creation even if Stripe fails
      }

      const [newUser] = await db
        .insert(users)
        .values({
          username,
          password: hashedPassword,
          name: '',
          bio: '',
          quizCompleted: false,
          personalityTraits: {},
          avatar: '/default-avatar.png',
          level: 1,
          xp: 0,
          lastRewardClaimed: new Date()
        })
        .returning();

      req.login(newUser, (err) => {
        if (err) {
          return next(err);
        }
        return res.json({
          success: true,
          message: "Registration successful",
          user: { 
            id: newUser.id, 
            username: newUser.username 
          },
        });
      });
    } catch (error) {
      next(error);
    }
  });

  app.post("/api/login", (req, res, next) => {
    const result = loginSchema.safeParse(req.body);
    if (!result.success) {
      return res.status(400).json({ 
        success: false,
        message: "Invalid input", 
        errors: result.error.issues.map(i => i.message)
      });
    }

    passport.authenticate("local", (err: any, user: Express.User | false, info: IVerifyOptions) => {
      if (err) {
        console.error("Login error:", err);
        return res.status(500).json({ 
          success: false,
          message: "Internal server error during login"
        });
      }

      if (!user) {
        return res.status(401).json({ 
          success: false,
          message: info?.message || "Invalid username or password"
        });
      }

      req.logIn(user, (err) => {
        if (err) {
          console.error("Session error:", err);
          return res.status(500).json({ 
            success: false,
            message: "Failed to create session"
          });
        }

        return res.json({
          success: true,
          message: "Login successful",
          user: {
            id: user.id,
            username: user.username
          }
        });
      });
    })(req, res, next);
  });

  app.post("/api/logout", (req, res) => {
    req.logout((err) => {
      if (err) {
        return res.status(500).json({
          success: false,
          message: "Logout failed"
        });
      }

      res.json({ 
        success: true,
        message: "Logout successful" 
      });
    });
  });

  app.get("/api/user", async (req, res) => {
    if (req.isAuthenticated() && req.user?.id) {
      try {
        // Fetch fresh user data from the database
        const [userData] = await db
          .select()
          .from(users)
          .where(eq(users.id, req.user.id))
          .limit(1);

        if (!userData) {
          return res.status(401).json({
            success: false,
            message: "User not found"
          });
        }

        return res.json({
          success: true,
          user: userData
        });
      } catch (error) {
        console.error("Error fetching user data:", error);
        return res.status(500).json({
          success: false,
          message: "Failed to fetch user data"
        });
      }
    }

    res.status(401).json({
      success: false,
      message: "Not logged in"
    });
  });
}
</file>

<file path="client/src/components/MatchCard.tsx">
import { FC, useState } from 'react';
import { Card, CardContent, CardHeader } from "@/components/ui/card";
import { Avatar, AvatarImage, AvatarFallback } from "@/components/ui/avatar";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { MessageCircle, UserPlus, Zap, Loader2, User, Heart, Star, ChevronDown, ChevronUp, Users } from 'lucide-react';
import { useMatches } from '@/hooks/use-matches';
import { useLocation } from "wouter";
import { toast } from "@/hooks/use-toast";
import { useQueryClient } from "@tanstack/react-query";
import type { Match } from '@/hooks/use-matches';
import { Link } from 'react-router-dom'

interface MatchCardProps {
  match: Match;
  isPotential?: boolean;
  compatibilityScore?: number;
  matchExplanation?: string;
  onAccept?: () => void;
  onReject?: () => void;
  onConnect?: () => void;
  isResponding?: boolean;
}

export const MatchCard: FC<MatchCardProps> = ({
  match,
  isPotential,
  compatibilityScore,
  matchExplanation,
  onAccept,
  onReject,
  onConnect,
  isResponding
}) => {
  const { connect } = useMatches();
  const [isConnecting, setIsConnecting] = useState(false);
  const [isExpanded, setIsExpanded] = useState(false);
  const [, setLocation] = useLocation();
  const queryClient = useQueryClient();

  // Type guard to check if object is a full Match type
  const isFullMatch = (match: Match | { id: number; username: string; name: string; avatar?: string }): match is Match => {
    return 'personalityTraits' in match && 'user' in match;
  };

  // Get the correct user data based on match type
  const userData = isFullMatch(match) ? match : match;
  const displayName = userData?.name || userData?.username || 'Anonymous User';
  const avatarUrl = userData?.avatar || '/default-avatar.png';

  // Access personality traits from the match data with type guard
  const personalityTraits: Record<string, number> = isFullMatch(match) && match.personalityTraits ? match.personalityTraits : {};

  const handleConnect = async () => {
    if (!userData?.id) {
      toast({
        title: "Connection Failed",
        description: "Invalid match data",
        variant: "destructive"
      });
      return;
    }

    try {
      setIsConnecting(true);
      await connect({ id: userData.id.toString() });
      
      toast({
        title: "Connection Request Sent!",
        description: `We'll notify you when ${displayName} responds.`
      });

      // Refresh matches data
      queryClient.invalidateQueries({ queryKey: ['matches'] });
    } catch (error) {
      toast({
        title: "Connection Failed",
        description: error instanceof Error ? error.message : "Failed to send connection request",
        variant: "destructive"
      });
    } finally {
      setIsConnecting(false);
    }
  };

  const handleChat = async () => {
    if (!match.id || typeof match.id !== 'number') {
      toast({
        title: "Error",
        description: "Invalid match ID",
        variant: "destructive"
      });
      return;
    }

    if (match.status !== 'accepted') {
      toast({
        title: "Cannot Access Chat",
        description: "This match is not yet accepted",
        variant: "destructive"
      });
      return;
    }

    try {
      // Verify match exists and is accessible before navigation
      const response = await fetch(`/api/matches/${match.id}`, {
        credentials: 'include',
        headers: {
          'Accept': 'application/json',
          'Cache-Control': 'no-cache'
        }
      });

      if (!response.ok) {
        throw new Error(response.status === 404 
          ? 'Match not found' 
          : 'Failed to verify match access'
        );
      }

      const data = await response.json();
      if (!data.success || data.data?.status !== 'accepted') {
        throw new Error('Match is not accessible');
      }

      // Only navigate if match is verified
      setLocation(`/chat/${match.id}`);
    } catch (error) {
      console.error('Chat navigation error:', error);
      toast({
        title: "Cannot Access Chat",
        description: error instanceof Error ? error.message : "Failed to access chat",
        variant: "destructive"
      });
    }
  };

  return (
    <Card className="relative overflow-hidden transition-all duration-200">
      <CardHeader className="flex flex-row items-center gap-4 pb-2">
        <Avatar className="h-12 w-12">
          <AvatarImage src={avatarUrl} alt={displayName} />
          <AvatarFallback><User /></AvatarFallback>
        </Avatar>
        <div className="flex-1">
          <div className="flex items-center gap-2">
            <h3 className="font-semibold">{displayName}</h3>
            {match.status === 'accepted' && (
              <Badge variant="default" className="bg-green-500">
                <Heart className="h-3 w-3 mr-1" />
                Connected
              </Badge>
            )}
            {match.status === 'potential' && match.compatibilityScore && (
              <Badge variant="secondary" className="bg-blue-500">
                <Star className="h-3 w-3 mr-1" />
                {Math.round(match.compatibilityScore * 100)}% Match
              </Badge>
            )}
          </div>
        </div>
      </CardHeader>

      <CardContent>
        {match.status === 'potential' && match.matchExplanation && (
          <p className="text-sm text-muted-foreground mb-4">{match.matchExplanation}</p>
        )}
        
        <div className="flex flex-wrap gap-2 mb-4">
          {Object.entries(personalityTraits).map(([trait, value]) => (
            <Badge key={trait} variant="outline" className="capitalize">
              {trait}: {Math.round(value * 100)}%
            </Badge>
          ))}
        </div>

        <div className="flex gap-2 mt-4">
          {match.status === 'accepted' ? (
            <Button
              className="flex-1"
              onClick={handleChat}
              size="sm"
              disabled={!match.id || typeof match.id !== 'number'}
            >
              <MessageCircle className="h-4 w-4 mr-2" />
              Chat
            </Button>
          ) : (
            <Button
              className="flex-1"
              onClick={handleConnect}
              disabled={isConnecting}
              size="sm"
            >
              {isConnecting ? (
                <Loader2 className="h-4 w-4 mr-2 animate-spin" />
              ) : (
                <UserPlus className="h-4 w-4 mr-2" />
              )}
              Connect
            </Button>
          )}
        </div>
      </CardContent>
    </Card>
  );
};
</file>

<file path="client/src/hooks/use-matches.ts">
import { useQuery, useMutation, useQueryClient, type UseQueryResult, type UseMutationResult } from "@tanstack/react-query";
import type { SelectUser } from "@db/schema";
import { useToast } from "@/hooks/use-toast";
import { getUserId } from '@/utils/auth';

export interface TraitInteraction {
  traits: (keyof PersonalityTraits)[];
  effect: number;
}

export interface Interest {
  name: string;
  score: number;
  category: 'personality' | 'hobby' | 'value';
  traitInteractions?: TraitInteraction[];
  avoidanceTraits?: {
    [K in keyof PersonalityTraits]?: number;
  };
}

export interface PersonalityTraits {
  extraversion: number;
  communication: number;
  openness: number;
  values: number;
  planning: number;
  sociability: number;
  agreeableness: number;
  conscientiousness: number;
  neuroticism: number;
  self_consciousness: number;
  introversion: number;
}

export type MatchStatus = 'none' | 'requested' | 'pending' | 'accepted' | 'rejected' | 'potential';

export interface Match {
  id: number;
  status: MatchStatus;
  createdAt: string;
  lastActivityAt: string;
  username?: string;
  name?: string;
  avatar?: string;
  personalityTraits?: Record<string, number>;
  interests?: Interest[];
  user: {
    id: number;
    personalityTraits: Record<string, number>;
    interests: Interest[];
  };
  score?: number;
  compatibilityScore?: number;
  matchExplanation?: string;
}

interface Message {
  id: number;
  matchId: number;
  senderId: number;
  content: string;
  createdAt: Date;
  analyzed: boolean | null;
  sentiment: {
    score: number;
    magnitude: number;
    labels: string[];
  } | null;
}

interface MatchesResponse {
  success: boolean;
  matches: {
    accepted: Match[];
    pending: Match[];
    requested: Match[];
    rejected: Match[];
  };
  totalMatches: number;
  acceptedMatches: number;
  potentialMatches: number;
}

interface MatchActionResponse {
  success: boolean;
  message?: string;
  match?: Match;
}

interface UseMatchesReturn {
  matches: Match[];
  requests: Match[];
  isLoading: boolean;
  isResponding: boolean;
  connect: (targetUserId: number) => Promise<Match>;
  respondToMatch: ({ matchId, status }: { matchId: number; status: 'accepted' | 'rejected' }) => void;
  getMatch: (id: string | number) => Promise<Match>;
  initiateMatch: (targetId: number) => Promise<Match>;
  useMatchMessages: (matchId: number) => UseQueryResult<Message[], Error>;
  useSendMessage: () => UseMutationResult<Message, Error, { matchId: number; content: string }, { previousMessages: Message[] }>;
}

export function useMatches(): UseMatchesReturn {
  const queryClient = useQueryClient();
  const { toast } = useToast();
  const userId = getUserId();

  const { data: matchData = { matches: [], requests: [] }, isLoading: isLoadingMatches } = useQuery<
    { matches: Match[]; requests: Match[] },
    Error
  >({
    queryKey: ['matches', userId],
    queryFn: async () => {
      try {
        if (!userId) {
          console.log('No user ID found, skipping matches fetch');
          return { matches: [], requests: [] };
        }

        console.log('Fetching matches for user:', userId);
        const response = await fetch('/api/matches', {
          credentials: 'include',
          headers: {
            'Accept': 'application/json',
            'Cache-Control': 'no-cache',
            'X-User-ID': userId.toString()
          }
        });

        if (!response.ok) {
          if (response.status === 401) {
            console.log('User not authenticated, invalidating user query');
            queryClient.invalidateQueries({ queryKey: ['user'] });
            window.location.href = '/login';
            return { matches: [], requests: [] };
          }
          const errorText = await response.text();
          throw new Error(`Failed to fetch matches: ${errorText}`);
        }

        const data = await response.json();
        console.log('Raw matches data:', data);

        if (!data.success) {
          throw new Error('Failed to fetch matches');
        }

        // Normalize match data
        const normalizeMatch = (match: any): Match => ({
          id: match.id,
          status: match.status,
          createdAt: match.createdAt,
          lastActivityAt: match.lastActivityAt || match.createdAt,
          username: match.user?.username || match.username || '',
          name: match.user?.name || match.name || '',
          avatar: match.user?.avatar || match.avatar || '',
          personalityTraits: match.user?.personalityTraits || match.personalityTraits || {},
          interests: match.user?.interests || match.interests || [],
          user: {
            id: match.user?.id || match.userId || 0,
            personalityTraits: match.user?.personalityTraits || match.personalityTraits || {},
            interests: match.user?.interests || match.interests || []
          },
          score: match.score || 0,
          compatibilityScore: match.compatibilityScore || 0,
          matchExplanation: match.matchExplanation || ''
        });

        // Handle the grouped matches format
        const allMatches = [
          ...(data.matches?.accepted || []),
          ...(data.matches?.potential || [])
        ].map(match => normalizeMatch({
          ...match,
          status: match.status || (data.matches?.accepted?.includes(match) ? 'accepted' : 'potential')
        }));

        // Handle requests (pending and requested matches)
        const allRequests = [
          ...(data.matches?.pending || []),
          ...(data.matches?.requested || [])
        ].map(match => normalizeMatch({
          ...match,
          status: match.status || (data.matches?.pending?.includes(match) ? 'pending' : 'requested')
        }));

        console.log('Processed matches:', allMatches);
        console.log('Processed requests:', allRequests);
        console.log('API response data:', data);

        return { 
          matches: allMatches, 
          requests: allRequests 
        };
      } catch (error) {
        console.error('Error fetching matches:', error);
        toast({
          title: 'Error fetching matches',
          description: error instanceof Error ? error.message : 'An unexpected error occurred',
          variant: 'destructive'
        });
        throw error;
      }
    },
    enabled: !!userId,
    staleTime: 1000 * 30,
    retry: (failureCount, error) => {
      if (error instanceof Error && (
        error.message.includes('401') || 
        error.message.includes('Session expired')
      )) {
        window.location.href = '/login';
        return false;
      }
      return failureCount < 3;
    },
  });

  const { mutate: respondToMatch, isPending: isResponding } = useMutation<
    MatchActionResponse,
    Error,
    { matchId: number; status: 'accepted' | 'rejected' }
  >({
    mutationFn: async ({ matchId, status }) => {
      if (!matchId) throw new Error('Match ID is required');
      if (isNaN(matchId) || matchId <= 0) throw new Error('Invalid match ID');
      if (!userId) throw new Error('User must be logged in');

      // First verify the match still exists and is valid
      const verifyResponse = await fetch(`/api/matches/${matchId}`, {
        credentials: 'include',
        headers: {
          'Accept': 'application/json',
          'Cache-Control': 'no-cache',
          'X-User-ID': userId.toString()
        }
      });

      if (!verifyResponse.ok) {
        if (verifyResponse.status === 404) {
          throw new Error('Match request no longer available');
        }
        throw new Error('Failed to verify match request');
      }

      // Then process the response
      const response = await fetch(`/api/matches/${matchId}`, {
        method: 'POST',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'Cache-Control': 'no-cache',
          'X-User-ID': userId.toString()
        },
        body: JSON.stringify({ status, userId })
      });

      if (response.status === 401) {
        queryClient.invalidateQueries({ queryKey: ['user'] });
        window.location.href = '/login';
        throw new Error('Session expired. Please log in again.');
      }

      if (response.status === 404) {
        queryClient.invalidateQueries({ queryKey: ['matches'] });
        throw new Error('Match request no longer available');
      }

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.message || 'Failed to respond to match request');
      }

      const data = await response.json() as MatchActionResponse;
      if (!data.success) {
        throw new Error(data.message || 'Failed to process match request');
      }

      return data;
    },
    onSuccess: (data, variables) => {
      queryClient.invalidateQueries({ queryKey: ['matches'] });

      const messages = {
        accepted: {
          title: "Match Accepted!",
          description: "You can now start chatting with your new match!"
        },
        rejected: {
          title: "Request Declined",
          description: "The match request has been declined."
        }
      } as const;

      const message = messages[variables.status];

      toast({
        title: message.title,
        description: message.description
      });
    },
    onError: (error) => {
      toast({
        title: "Error",
        description: error.message,
        variant: "destructive"
      });
    }
  });

  const connect = async (targetUserId: number): Promise<Match> => {
    if (!targetUserId) throw new Error('Target user ID is required');
    if (isNaN(targetUserId) || targetUserId <= 0) throw new Error('Invalid target user ID');
    if (!userId) throw new Error('User must be logged in');

    try {
      console.log('Creating match with target user:', targetUserId);
      
      const response = await fetch('/api/matches', {
        method: 'POST',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'Cache-Control': 'no-cache',
          'X-User-ID': userId.toString()
        },
        body: JSON.stringify({ targetUserId })
      });

      if (response.status === 401) {
        console.error('Authentication error creating match');
        throw new Error('Please log in to create a match');
      }

      if (response.status === 404) {
        console.error('Target user not found');
        throw new Error('Selected user is no longer available');
      }

      if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        console.error('Error response from server:', error);
        throw new Error(error.message || 'Failed to create match');
      }

      const data = await response.json();
      console.log('Match creation response:', data);

      if (!data.success) {
        throw new Error(data.message || 'Failed to create match');
      }

      if (!data.match) {
        throw new Error('No match data received from server');
      }

      // Transform the response to match the Match interface
      const match: Match = {
        id: data.match.id,
        status: data.match.status,
        createdAt: data.match.createdAt,
        lastActivityAt: data.match.lastActivityAt || data.match.createdAt,
        username: data.match.user?.username || '',
        name: data.match.user?.name || '',
        avatar: data.match.user?.avatar || '',
        personalityTraits: data.match.user?.personalityTraits || {},
        interests: data.match.user?.interests || [],
        user: {
          id: data.match.user?.id || 0,
          personalityTraits: data.match.user?.personalityTraits || {},
          interests: data.match.user?.interests || []
        }
      };

      // Invalidate matches query to refetch the updated list
      await queryClient.invalidateQueries({ queryKey: ['matches'] });

      return match;
    } catch (error) {
      console.error('Error in connect function:', error);
      throw error;
    }
  };

  const getMatch = async (id: string | number): Promise<Match> => {
    try {
      if (!id) throw new Error('Match ID is required');
      if (!userId) throw new Error('User must be logged in');

      const matchId = typeof id === 'string' ? parseInt(id) : id;
      if (isNaN(matchId) || matchId <= 0) {
        throw new Error('Invalid match ID format');
      }

      const response = await fetch(`/api/matches/${matchId}`, {
        credentials: 'include',
        headers: {
          'Accept': 'application/json',
          'Cache-Control': 'no-cache',
          'X-User-ID': userId.toString()
        }
      });

      if (response.status === 401) {
        queryClient.invalidateQueries({ queryKey: ['user'] });
        window.location.href = '/login';
        throw new Error('Session expired. Please log in again.');
      }

      if (response.status === 404) {
        throw new Error('Match not found');
      }

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.message || 'Failed to fetch match profile');
      }

      const data = await response.json();
      if (!data.success) {
        throw new Error(data.message || 'Failed to fetch match');
      }

      // Transform the response to match the Match interface
      const match = data.data;
      return {
        id: match.id,
        status: match.status,
        createdAt: match.createdAt,
        lastActivityAt: match.lastActivityAt || match.createdAt,
        user: {
          id: match.userId1 === userId ? match.userId2 : match.userId1,
          personalityTraits: match.personalityTraits || {},
          interests: match.interests || []
        }
      };
    } catch (error) {
      console.error('Error fetching match:', error);
      throw error;
    }
  };

  const useMatchMessages = (matchId: number) => {
    return useQuery<Message[], Error>({
      queryKey: ["matches", matchId, "messages"],
      queryFn: async () => {
        if (!userId) throw new Error('User must be logged in');
        if (!matchId) throw new Error('Match ID is required');

        const response = await fetch(`/api/matches/${matchId}/messages`, {
          credentials: 'include',
          headers: {
            'Accept': 'application/json',
            'Cache-Control': 'no-cache',
            'X-User-ID': userId.toString()
          }
        });

        if (response.status === 401) {
          queryClient.invalidateQueries({ queryKey: ['user'] });
          window.location.href = '/login';
          throw new Error('Session expired. Please log in again.');
        }

        if (response.status === 404) {
          throw new Error('Match not found');
        }

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ message: "Failed to fetch messages" }));
          throw new Error(errorData.message);
        }

        const data = await response.json();
        console.log('Fetched messages response:', data);

        if (!data.success) {
          throw new Error(data.message || 'Failed to fetch messages');
        }

        // Messages are under the 'messages' key in the response
        if (!Array.isArray(data.messages)) {
          console.error('Invalid messages format:', data);
          return [];
        }

        // Transform messages to ensure consistent format
        const messages = data.messages.map((msg: any) => ({
          id: msg.id,
          matchId: msg.matchId,
          senderId: msg.senderId,
          content: msg.content,
          createdAt: new Date(msg.createdAt),
          analyzed: msg.analyzed || null,
          sentiment: msg.sentiment || null
        }));

        console.log('Transformed messages:', messages);
        return messages;
      },
      enabled: !!matchId && !!userId,
      refetchInterval: 3000,
      refetchIntervalInBackground: true,
      staleTime: 0, // Consider all data immediately stale
      gcTime: 1000 * 60 * 5, // Keep cache for 5 minutes
      retry: (failureCount, error) => {
        if (error.message.includes('Session expired') || 
            error.message.includes('Match not found')) {
          return false;
        }
        return failureCount < 3;
      }
    });
  };

  const useSendMessage = () => {
    type MutationContext = {
      previousMessages: Message[];
    };

    return useMutation<Message, Error, { matchId: number; content: string }, MutationContext>({
      mutationFn: async ({ matchId, content }) => {
        if (!userId) throw new Error('User must be logged in');
        if (!matchId) throw new Error('Match ID is required');
        if (!content.trim()) throw new Error('Message content is required');

        const response = await fetch(`/api/matches/${matchId}/messages`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json",
            "X-User-ID": userId.toString()
          },
          credentials: 'include',
          body: JSON.stringify({ content: content.trim() }),
        });

        if (response.status === 401) {
          queryClient.invalidateQueries({ queryKey: ['user'] });
          window.location.href = '/login';
          throw new Error('Session expired. Please log in again.');
        }

        if (response.status === 404) {
          throw new Error('Match not found');
        }

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ message: "Failed to send message" }));
          throw new Error(errorData.message || "Failed to send message");
        }

        const data = await response.json();
        console.log('Message response:', data);

        if (!data.success) {
          throw new Error(data.message || 'Failed to send message');
        }

        // The message can be under either 'message' or 'data' key
        const messageData = data.message || data.data;
        
        // Ensure the response has the required message fields
        if (!messageData?.id || !messageData?.content) {
          console.error('Invalid message response:', data);
          throw new Error('Invalid message format received from server');
        }

        // Transform the message data to match the Message interface
        const message: Message = {
          id: messageData.id,
          matchId: messageData.matchId || matchId,
          senderId: messageData.senderId || userId,
          content: messageData.content,
          createdAt: new Date(messageData.createdAt),
          analyzed: messageData.analyzed || null,
          sentiment: messageData.sentiment || null
        };

        console.log('Transformed sent message:', message);
        return message;
      },
      onMutate: async ({ matchId, content }): Promise<MutationContext> => {
        // Cancel any outgoing refetches
        await queryClient.cancelQueries({ queryKey: ["matches", matchId, "messages"] });

        // Snapshot the previous value
        const previousMessages = queryClient.getQueryData<Message[]>(["matches", matchId, "messages"]) || [];
        console.log('Previous messages before mutation:', previousMessages);

        // Create optimistic message
        const optimisticMessage: Message = {
          id: -Date.now(), // temporary negative ID to distinguish from real messages
          matchId,
          senderId: userId!,
          content,
          createdAt: new Date(),
          analyzed: null,
          sentiment: null
        };

        // Optimistically update the cache
        const updatedMessages = [...previousMessages, optimisticMessage];
        console.log('Optimistically updated messages:', updatedMessages);
        
        queryClient.setQueryData<Message[]>(
          ["matches", matchId, "messages"],
          updatedMessages
        );

        return { previousMessages };
      },
      onError: (err, { matchId }, context) => {
        console.error('Error sending message:', err);
        // Revert to previous messages on error
        if (context) {
          console.log('Reverting to previous messages:', context.previousMessages);
          queryClient.setQueryData(["matches", matchId, "messages"], context.previousMessages);
        }
        toast({
          title: "Error sending message",
          description: err.message || "Failed to send message",
          variant: "destructive"
        });
      },
      onSuccess: (newMessage, { matchId }) => {
        // Update cache with the confirmed message
        queryClient.setQueryData<Message[]>(
          ["matches", matchId, "messages"],
          old => {
            const messages = old || [];
            console.log('Updating cache with new message:', { old: messages, new: newMessage });
            // Remove any optimistic updates for this message
            const filteredMessages = messages.filter(msg => 
              msg.id > 0 // Keep only real messages (positive IDs)
            );
            return [...filteredMessages, newMessage];
          }
        );
      },
      onSettled: (_, __, { matchId }) => {
        // Always refetch after settling to ensure consistency
        queryClient.invalidateQueries({
          queryKey: ["matches", matchId, "messages"],
          exact: true,
          refetchType: 'all'
        });
      }
    });
  };

  const initiateMatch = async (targetId: number): Promise<Match> => {
    try {
      return await connect(targetId);
    } catch (error) {
      console.error('Match initiation error:', {
        error,
        targetId,
        timestamp: new Date().toISOString()
      });

      toast({
        title: "Match Request Failed",
        description: error instanceof Error ? error.message : 'An unexpected error occurred',
        variant: "destructive",
        duration: 5000
      });

      throw error;
    }
  };

  return {
    matches: matchData.matches,
    requests: matchData.requests,
    isLoading: isLoadingMatches,
    isResponding,
    connect,
    respondToMatch,
    getMatch,
    initiateMatch,
    useMatchMessages,
    useSendMessage
  };
}
</file>

<file path="server/routes.ts">
import express, { type Express } from 'express';
import { createServer, type Server } from 'http';
import cors from 'cors';
import { db } from '@db';
import type { Request, Response, NextFunction } from 'express';
import type { SelectUser } from '@db/schema';
import { sql } from 'drizzle-orm';
import { and, eq, or, desc } from 'drizzle-orm';
import multer, { FileFilterCallback } from 'multer';
import { Client } from '@replit/object-storage';
import { randomUUID } from 'crypto';
import { 
  interestCategories, 
  interests, 
  matches, 
  users,
  profileProgress,
  userInterests,
  messages,
  type UserInterest,
  type Interest as DBInterest,
  type InterestCategory as DBInterestCategory,
  type User,
  type Match,
  type Message,
  achievements,
  userAchievements,
  type Achievement,
  type UserAchievement,
  type ProfileProgress 
} from '@db/schema';
import { generateEnhancedChatSuggestions, generateEventSuggestions, craftPersonalizedMessage, generateEventConversationStarter } from './utils/suggestions';
import { validateUser } from './middleware/auth';
import path from 'path';

type MatchStatus = 'none' | 'requested' | 'pending' | 'accepted' | 'rejected' | 'potential';
type InterestCategory = 'value' | 'personality' | 'hobby';

interface Interest {
  id: number;
  name: string;
  score: number;
  category: InterestCategory;
}

interface AuthenticatedRequest extends Request {
  user: SelectUser;
}

interface UserWithInterests {
  id: number;
  username?: string;
  name?: string;
  bio?: string;
  avatar?: string;
  quizCompleted: boolean;
  personalityTraits: Record<string, number>;
  interests: Interest[];
}

interface FormattedMatch {
  id: number;
  status: MatchStatus;
  createdAt: Date;
  lastActivityAt: Date;
  username: string;
  name: string;
  bio: string;
  avatar: string;
  quizCompleted: boolean;
  personalityTraits: Record<string, number>;
  interests: Interest[];
  user: {
    id: number;
    personalityTraits: Record<string, number>;
    interests: Interest[];
  };
}

interface PersonalityTraits {
  extraversion: number;
  communication: number;
  openness: number;
  values: number;
  planning: number;
  sociability: number;
}

interface UserInterestResult {
  id: number;
  score: number;
  interest: {
    id: number;
    name: string;
    categoryId: number;
  } | null;
}

// Extend Request type to include file from multer
interface AuthenticatedFileRequest extends Request {
  user: SelectUser;
  file?: Express.Multer.File;
}

// Helper function to get category from categoryId
function getCategoryFromId(categoryId: number): InterestCategory {
  switch (categoryId) {
    case 1:
      return 'value';
    case 2:
      return 'personality';
    case 3:
      return 'hobby';
    default:
      return 'personality';
  }
}

// Helper function to get user data with interests
async function getUserWithInterests(userId: number): Promise<UserWithInterests | null> {
  try {
    console.log('Getting user with interests:', userId);

    if (!userId || isNaN(userId) || userId <= 0) {
      console.log('Invalid user ID:', userId);
      return null;
    }

    const [user] = await db
      .select({
        id: users.id,
        username: users.username,
        name: users.name,
        personalityTraits: users.personalityTraits,
        bio: users.bio,
        avatar: users.avatar,
        quizCompleted: users.quizCompleted
      })
      .from(users)
      .where(eq(users.id, userId))
      .limit(1);

    if (!user) {
      console.log('User not found:', userId);
      return null;
    }

    if (!user.personalityTraits || typeof user.personalityTraits !== 'object') {
      console.log('Invalid personality traits for user:', userId);
      user.personalityTraits = {};
    }

    console.log('Found user:', user);

    // Get user interests from the junction table
    const userInterestResults = await db
      .select({
        id: userInterests.id,
        score: userInterests.score,
        interest: {
          id: interests.id,
          name: interests.name,
          categoryId: interests.categoryId
        }
      })
      .from(userInterests)
      .where(eq(userInterests.userId, userId))
      .leftJoin(interests, eq(interests.id, userInterests.interestId));

    console.log('Found user interests:', userInterestResults);

    // Transform interests into the expected format
    const formattedInterests: Interest[] = userInterestResults
      .filter((ui): ui is (UserInterestResult & { interest: NonNullable<UserInterestResult['interest']> }) => 
        ui !== null && 
        ui.interest !== null && 
        typeof ui.interest.name === 'string' &&
        typeof ui.interest.categoryId === 'number'
      )
      .map((ui) => ({
        id: ui.id,
        name: ui.interest.name,
        score: ui.score,
        category: getCategoryFromId(ui.interest.categoryId)
      }));

    return {
      id: user.id,
      username: user.username || '',
      name: user.name || '',
      bio: user.bio || '',
      avatar: user.avatar || '/default-avatar.png',
      quizCompleted: user.quizCompleted,
      personalityTraits: user.personalityTraits as Record<string, number>,
      interests: formattedInterests
    };
  } catch (error) {
    console.error('Error getting user with interests:', error);
    throw new Error('Failed to get user details');
  }
}

// Helper function to get match data
async function getMatchById(matchId: number) {
  const [match] = await db
    .select({
      id: matches.id,
      status: matches.status,
      user1Id: matches.userId1,
      user2Id: matches.userId2,
    })
    .from(matches)
    .where(eq(matches.id, matchId))
    .limit(1);

  return match;
}

// Type guard to ensure request is authenticated
function isAuthenticated(req: Request): req is AuthenticatedRequest {
  return req.user !== undefined && 'id' in req.user;
}

// Middleware to ensure request is authenticated
function ensureAuthenticated(req: Request, res: Response, next: NextFunction) {
  if (!isAuthenticated(req)) {
    return res.status(401).json({ error: 'Unauthorized' });
  }
  next();
}

// Error handler middleware
function errorHandler(err: Error, req: Request, res: Response, next: NextFunction) {
  console.error('API Error:', err);
  res.status(500).json({
    error: err.message || 'Internal Server Error',
    ...(process.env.NODE_ENV === 'development' && { stack: err.stack })
  });
}

// Helper function to calculate compatibility score
function calculateCompatibilityScore(
  userTraits: Partial<PersonalityTraits>,
  matchTraits: Partial<PersonalityTraits>
): number {
  const requiredTraits = [
    'extraversion',
    'communication',
    'openness',
    'values',
    'planning',
    'sociability'
  ] as const;

  let score = 0;
  let count = 0;

  // Validate and normalize traits
  const normalizedUserTraits: Record<string, number> = {};
  const normalizedMatchTraits: Record<string, number> = {};

  for (const trait of requiredTraits) {
    const userValue = userTraits[trait];
    const matchValue = matchTraits[trait];

    // Skip if either value is missing or invalid
    if (typeof userValue !== 'number' || typeof matchValue !== 'number' ||
        isNaN(userValue) || isNaN(matchValue)) {
      continue;
    }

    // Normalize values to be between 0 and 1
    normalizedUserTraits[trait] = Math.max(0, Math.min(1, userValue));
    normalizedMatchTraits[trait] = Math.max(0, Math.min(1, matchValue));

    // Calculate similarity (1 - absolute difference)
    const similarity = 1 - Math.abs(normalizedUserTraits[trait] - normalizedMatchTraits[trait]);
    score += similarity;
    count++;
  }

  // Return average similarity score, defaulting to 0 if no valid traits
  return count > 0 ? score / count : 0;
}

// Add interfaces for suggestion types
interface ChatSuggestion {
  text: string;
  confidence: number;
}

interface EventSuggestion {
  title: string;
  description: string;
  reasoning: string;
  date?: string;
  location?: string;
}

interface SuggestionContext {
  personalityTraits: Record<string, number>;
  interests: Interest[];
  sharedInterests?: string[];
  compatibilityScore?: number;
}

// Helper function to calculate user level based on points
function calculateLevel(points: number): number {
  return Math.floor(points / 1000) + 1;
}

export function registerRoutes(app: Express): Server {
  const httpServer = createServer(app);

  // Enable CORS
  app.use(cors({
    origin: true,
    credentials: true
  }));

  // Add health check endpoint
  app.get('/health', (req: Request, res: Response) => {
    res.json({ status: 'ok', timestamp: new Date().toISOString() });
  });

  // Configure multer for memory storage
  const upload = multer({ 
    storage: multer.memoryStorage(),
    limits: {
      fileSize: 5 * 1024 * 1024, // 5MB limit
    },
    fileFilter: (req: Request, file: Express.Multer.File, cb: FileFilterCallback) => {
      if (!file.mimetype.startsWith('image/')) {
        cb(new Error('Only image files are allowed'));
        return;
      }
      cb(null, true);
    }
  });

  // Initialize Replit Object Storage client
  const storage = new Client();

  // Get chat suggestions for a match
  app.post('/api/matches/suggestions', validateUser, ensureAuthenticated, async (req: Request, res: Response, next: NextFunction) => {
    try {
      if (!isAuthenticated(req)) {
        return res.status(401).json({ 
          success: false, 
          message: 'Unauthorized' 
        });
      }

      const userId = req.user.id;
      const matchId = parseInt(req.body.matchId as string);

      if (isNaN(matchId) || matchId <= 0) {
        return res.status(400).json({
          success: false,
          message: 'Invalid match ID. Please provide a valid positive number.'
        });
      }

      // Verify match exists and user is part of it
      const match = await getMatchById(matchId);
      if (!match || (match.user1Id !== userId && match.user2Id !== userId)) {
        return res.status(404).json({
          success: false,
          message: 'Match not found'
        });
      }

      // Get matched user details
      const matchedUserId = match.user1Id === userId ? match.user2Id : match.user1Id;
      const [currentUser, matchedUser] = await Promise.all([
        getUserWithInterests(userId),
        getUserWithInterests(matchedUserId)
      ]);

      if (!currentUser || !matchedUser) {
        return res.status(404).json({
          success: false,
          message: 'User details not found'
        });
      }

      // Generate chat suggestions based on user profiles
      const suggestions = generateEnhancedChatSuggestions(
        currentUser.personalityTraits,
        matchedUser.personalityTraits,
        currentUser.interests,
        matchedUser.interests
      );

      res.json({
        success: true,
        suggestions: suggestions.map(suggestion => ({
          text: suggestion.text,
          confidence: suggestion.confidence
        }))
      });
    } catch (error) {
      console.error('Error getting chat suggestions:', error);
      next(error);
    }
  });

  // Get event suggestions for a match
  app.post('/api/matches/suggestions/events', validateUser, ensureAuthenticated, async (req: Request, res: Response, next: NextFunction) => {
    try {
      if (!isAuthenticated(req)) {
        return res.status(401).json({ 
          success: false, 
          message: 'Unauthorized' 
        });
      }

      const userId = req.user.id;
      const matchId = parseInt(req.body.matchId as string);

      if (isNaN(matchId) || matchId <= 0) {
        return res.status(400).json({
          success: false,
          message: 'Invalid match ID. Please provide a valid positive number.'
        });
      }

      // Verify match exists and user is part of it
      const match = await getMatchById(matchId);
      if (!match || (match.user1Id !== userId && match.user2Id !== userId)) {
        return res.status(404).json({
          success: false,
          message: 'Match not found'
        });
      }

      // Get matched user details
      const matchedUserId = match.user1Id === userId ? match.user2Id : match.user1Id;
      const [currentUser, matchedUser] = await Promise.all([
        getUserWithInterests(userId),
        getUserWithInterests(matchedUserId)
      ]);

      if (!currentUser || !matchedUser) {
        return res.status(404).json({
          success: false,
          message: 'User details not found'
        });
      }

      // Generate event suggestions based on user profiles
      const suggestions = await generateEventSuggestions(
        currentUser.personalityTraits,
        matchedUser.personalityTraits,
        currentUser.interests,
        matchedUser.interests
      );

      // Return the suggestions with all required fields
      res.json({
        success: true,
        suggestions: suggestions.map(suggestion => ({
          title: suggestion.title,
          description: suggestion.description,
          reasoning: suggestion.reasoning
        }))
      });
    } catch (error) {
      console.error('Error getting event suggestions:', error);
      // Send a more detailed error response
      res.status(500).json({
        success: false,
        message: error instanceof Error ? error.message : 'Failed to generate event suggestions',
        suggestions: []
      });
    }
  });

  // Craft a personalized message
  app.post('/api/matches/messages/craft', validateUser, ensureAuthenticated, async (req: Request, res: Response, next: NextFunction) => {
    try {
      if (!isAuthenticated(req)) {
        return res.status(401).json({ 
          success: false, 
          message: 'Unauthorized' 
        });
      }

      const userId = req.user.id;
      const { matchId, suggestion, eventDetails } = req.body;

      if (!suggestion || typeof suggestion !== 'string') {
        return res.status(400).json({
          success: false,
          message: 'Invalid suggestion text'
        });
      }

      if (isNaN(matchId) || matchId <= 0) {
        return res.status(400).json({
          success: false,
          message: 'Invalid match ID'
        });
      }

      // Verify match exists and user is part of it
      const match = await getMatchById(matchId);
      if (!match || (match.user1Id !== userId && match.user2Id !== userId)) {
        return res.status(404).json({
          success: false,
          message: 'Match not found'
        });
      }

      // Get matched user details
      const matchedUserId = match.user1Id === userId ? match.user2Id : match.user1Id;
      const [currentUser, matchedUser] = await Promise.all([
        getUserWithInterests(userId),
        getUserWithInterests(matchedUserId)
      ]);

      if (!currentUser || !matchedUser) {
        return res.status(404).json({
          success: false,
          message: 'User details not found'
        });
      }

      let message: string;
      
      // If this is an event suggestion, generate a conversation starter for it
      if (eventDetails) {
        message = await generateEventConversationStarter(
          eventDetails,
          currentUser.personalityTraits,
          matchedUser.personalityTraits
        );
      } else {
        // Otherwise use the regular message crafting
        message = craftPersonalizedMessage(
          suggestion,
          currentUser.personalityTraits,
          matchedUser.personalityTraits
        );
      }

      res.json({
        success: true,
        message
      });
    } catch (error) {
      console.error('Error crafting message:', error);
      res.status(500).json({
        success: false,
        message: error instanceof Error ? error.message : 'Failed to craft message'
      });
    }
  });

  // Get match messages
  app.get('/api/matches/:matchId/messages', validateUser, ensureAuthenticated, async (req: Request, res: Response, next: NextFunction) => {
    try {
      if (!isAuthenticated(req)) {
        return res.status(401).json({ 
          success: false, 
          message: 'Unauthorized' 
        });
      }

      const userId = req.user.id;
      const matchId = parseInt(req.params.matchId);

      if (isNaN(matchId) || matchId <= 0) {
        return res.status(400).json({
          success: false,
          message: 'Invalid match ID. Please provide a valid positive number.'
        });
      }

      // Verify match exists and user is part of it
      const match = await getMatchById(matchId);
      if (!match || (match.user1Id !== userId && match.user2Id !== userId)) {
        return res.status(404).json({
          success: false,
          message: 'Match not found'
        });
      }

      // Get messages for the match
      const matchMessages = await db
        .select({
          id: messages.id,
          content: messages.content,
          senderId: messages.senderId,
          createdAt: messages.createdAt,
          sender: {
            id: users.id,
            username: users.username,
            name: users.name,
            avatar: users.avatar
          }
        })
        .from(messages)
        .where(eq(messages.matchId, matchId))
        .leftJoin(users, eq(messages.senderId, users.id))
        .orderBy(desc(messages.createdAt));

      res.json({
        success: true,
        messages: matchMessages
      });
    } catch (error) {
      console.error('Error getting match messages:', error);
      next(error);
    }
  });

  // Quiz submission endpoint
  app.post("/api/quiz", validateUser, ensureAuthenticated, async (req: Request, res: Response, next: NextFunction) => {
    try {
      if (!isAuthenticated(req)) {
        return res.status(401).json({ error: 'Unauthorized' });
      }

      const userId = req.user.id;
      const { traits } = req.body;

      if (!traits || typeof traits !== 'object') {
        return res.status(400).json({
          success: false,
          message: 'Invalid quiz data format'
        });
      }

      // Update user's personality traits and mark quiz as completed
      const [updatedUser] = await db
        .update(users)
        .set({
          personalityTraits: traits,
          quizCompleted: true,
          createdAt: new Date()
        })
        .where(eq(users.id, userId))
        .returning();

      if (!updatedUser) {
        throw new Error('Failed to update user data');
      }

      res.json({
        success: true,
        message: 'Quiz completed successfully',
        user: updatedUser
      });
    } catch (error) {
      console.error('Error in quiz submission:', error);
      next(error);
    }
  });

  // Create a new match
  app.post('/api/matches', validateUser, ensureAuthenticated, async (req: Request, res: Response, next: NextFunction) => {
    try {
      if (!isAuthenticated(req)) {
        return res.status(401).json({ 
          success: false, 
          message: 'Unauthorized' 
        });
      }

      const userId = req.user.id;
      const { targetUserId } = req.body;

      console.log('Creating match:', { userId, targetUserId });

      if (!targetUserId || isNaN(Number(targetUserId)) || Number(targetUserId) <= 0) {
        return res.status(400).json({
          success: false,
          message: 'Invalid target user ID. Please provide a valid positive number.'
        });
      }

      // Ensure users are not the same
      if (userId === Number(targetUserId)) {
        return res.status(400).json({
          success: false,
          message: 'Cannot create a match with yourself'
        });
      }

      // Get both users with their interests
      const [currentUser, targetUser] = await Promise.all([
        getUserWithInterests(userId),
        getUserWithInterests(Number(targetUserId))
      ]);

      if (!currentUser || !targetUser) {
        return res.status(404).json({
          success: false,
          message: 'One or both users not found'
        });
      }

      // Verify both users have completed their quizzes
      if (!currentUser.quizCompleted || !targetUser.quizCompleted) {
        return res.status(400).json({
          success: false,
          message: 'Both users must complete their personality quizzes before matching'
        });
      }

      // Verify both users have personality traits
      if (!currentUser.personalityTraits || !targetUser.personalityTraits || 
          Object.keys(currentUser.personalityTraits).length === 0 || 
          Object.keys(targetUser.personalityTraits).length === 0) {
        return res.status(400).json({
          success: false,
          message: 'Both users must have personality traits data'
        });
      }

      // Check if match already exists
      const existingMatch = await db
        .select()
        .from(matches)
        .where(
          or(
            and(
              eq(matches.userId1, userId),
              eq(matches.userId2, Number(targetUserId))
            ),
            and(
              eq(matches.userId1, Number(targetUserId)),
              eq(matches.userId2, userId)
            )
          )
        )
        .limit(1);

      if (existingMatch.length > 0) {
        return res.status(400).json({
          success: false,
          message: 'Match already exists between these users'
        });
      }

      // Calculate compatibility score
      const compatibilityScore = calculateCompatibilityScore(
        currentUser.personalityTraits,
        targetUser.personalityTraits
      );
      const matchScore = Math.max(0, Math.min(100, Math.round(compatibilityScore * 100))); // Ensure score is between 0-100

      console.log('Calculated match score:', {
        user1Id: userId,
        user2Id: targetUserId,
        user1Traits: currentUser.personalityTraits,
        user2Traits: targetUser.personalityTraits,
        compatibilityScore,
        matchScore
      });

      // Create new match
      const [newMatch] = await db
        .insert(matches)
        .values({
          userId1: userId,
          userId2: Number(targetUserId),
          status: 'requested',
          createdAt: new Date(),
          lastActivityAt: new Date(),
          score: matchScore
        })
        .returning();

      if (!newMatch) {
        throw new Error('Failed to create match record');
      }

      const response = {
        success: true,
        message: 'Match request sent successfully',
        match: {
          id: newMatch.id,
          status: newMatch.status,
          createdAt: newMatch.createdAt,
          lastActivityAt: newMatch.lastActivityAt,
          score: newMatch.score,
          user: targetUser
        }
      };

      console.log('Created match:', response);
      res.json(response);
    } catch (error) {
      console.error('Error creating match:', error);
      next(error);
    }
  });

  // Get potential matches
  app.get('/api/matches/potential', validateUser, ensureAuthenticated, async (req: Request, res: Response, next: NextFunction) => {
    try {
      if (!isAuthenticated(req)) {
        return res.status(401).json({ 
          success: false,
          message: 'Unauthorized' 
        });
      }

      const userId = req.user.id;
      console.log('Fetching potential matches for user:', userId);

      // Check if user has completed the quiz
      const [user] = await db
        .select({
          quizCompleted: users.quizCompleted,
          personalityTraits: users.personalityTraits
        })
        .from(users)
        .where(eq(users.id, userId))
        .limit(1);

      if (!user?.quizCompleted) {
        return res.status(400).json({
          success: false,
          message: 'Please complete your personality quiz before viewing potential matches'
        });
      }

      // Get all users except the current user and those already matched
      const existingMatches = await db
        .select({
          otherUserId: sql<number>`CASE 
            WHEN "user_id_1" = ${userId} THEN "user_id_2"
            ELSE "user_id_1"
          END`
        })
        .from(matches)
        .where(
          or(
            eq(matches.userId1, userId),
            eq(matches.userId2, userId)
          )
        );

      console.log('Existing matches:', existingMatches);

      const existingMatchIds = existingMatches.map(m => m.otherUserId);
      console.log('Existing match IDs:', existingMatchIds);

      // Get potential matches using raw SQL for complex conditions
      const potentialUsers = await db.execute<{
        id: number;
        username: string;
        name: string;
        bio: string;
        personalityTraits: Record<string, number>;
        avatar: string;
        quizCompleted: boolean;
      }>(sql`
        SELECT 
          id,
          username,
          name,
          bio,
          personality_traits as "personalityTraits",
          avatar,
          quiz_completed as "quizCompleted"
        FROM users
        WHERE 
          id != ${userId}
          AND quiz_completed = true
          ${existingMatchIds.length > 0 
            ? sql`AND id NOT IN (${sql.join(existingMatchIds.map(id => sql`${id}`), sql`, `)})`
            : sql``}
        LIMIT 10
      `);

      console.log('Found potential matches:', potentialUsers.rows.length);

      // Calculate compatibility scores
      const potentialMatches = potentialUsers.rows.map(potentialUser => {
        // Ensure personalityTraits is properly typed
        const userTraits = user.personalityTraits as Record<string, number>;
        const matchTraits = potentialUser.personalityTraits as Record<string, number>;
        
        const compatibilityScore = calculateCompatibilityScore(
          userTraits,
          matchTraits
        );

        return {
          ...potentialUser,
          compatibilityScore
        };
      }).sort((a, b) => b.compatibilityScore - a.compatibilityScore);

      res.json({
        success: true,
        matches: potentialMatches
      });
    } catch (error) {
      console.error('Error fetching potential matches:', error);
      next(error);
    }
  });

  // Get match by ID
  app.get('/api/matches/:id', validateUser, ensureAuthenticated, async (req: Request, res: Response, next: NextFunction) => {
    try {
      if (!isAuthenticated(req)) {
        return res.status(401).json({ 
          success: false, 
          message: 'Unauthorized' 
        });
      }

      const userId = req.user.id;
      const matchId = parseInt(req.params.id);

      if (isNaN(matchId) || matchId <= 0) {
        return res.status(400).json({
          success: false,
          message: 'Invalid match ID. Please provide a valid positive number.'
        });
      }

      // Get match data
      const [match] = await db
        .select()
        .from(matches)
        .where(
          and(
            eq(matches.id, matchId),
            or(
              eq(matches.userId1, userId),
              eq(matches.userId2, userId)
            )
          )
        )
        .limit(1);

      if (!match) {
        return res.status(404).json({
          success: false,
          message: 'Match not found'
        });
      }

      // Get matched user details
      const matchedUserId = match.userId1 === userId ? match.userId2 : match.userId1;
      const matchedUser = await getUserWithInterests(matchedUserId);

      if (!matchedUser) {
        return res.status(404).json({
          success: false,
          message: 'Matched user not found'
        });
      }

      res.json({
        success: true,
        data: {
          id: match.id,
          status: match.status,
          createdAt: match.createdAt,
          lastActivityAt: match.lastActivityAt,
          score: match.score,
          user: matchedUser
        }
      });
    } catch (error) {
      console.error('Error getting match:', error);
      next(error);
    }
  });

  // Send a message in a match
  app.post('/api/matches/:matchId/messages', validateUser, ensureAuthenticated, async (req: Request, res: Response, next: NextFunction) => {
    try {
      if (!isAuthenticated(req)) {
        return res.status(401).json({ 
          success: false, 
          message: 'Unauthorized' 
        });
      }

      const userId = req.user.id;
      const matchId = parseInt(req.params.matchId);
      const { content } = req.body;

      if (isNaN(matchId) || matchId <= 0) {
        return res.status(400).json({
          success: false,
          message: 'Invalid match ID. Please provide a valid positive number.'
        });
      }

      if (!content || typeof content !== 'string' || content.trim().length === 0) {
        return res.status(400).json({
          success: false,
          message: 'Message content is required'
        });
      }

      // Verify match exists and user is part of it
      const match = await getMatchById(matchId);
      if (!match || (match.user1Id !== userId && match.user2Id !== userId)) {
        return res.status(404).json({
          success: false,
          message: 'Match not found'
        });
      }

      // Create new message
      const [newMessage] = await db
        .insert(messages)
        .values({
          matchId,
          senderId: userId,
          content: content.trim(),
          createdAt: new Date(),
          analyzed: false
        })
        .returning();

      if (!newMessage) {
        throw new Error('Failed to create message');
      }

      // Update match last activity
      await db
        .update(matches)
        .set({
          lastActivityAt: new Date()
        })
        .where(eq(matches.id, matchId));

      // Get sender details
      const [sender] = await db
        .select({
          id: users.id,
          username: users.username,
          name: users.name,
          avatar: users.avatar
        })
        .from(users)
        .where(eq(users.id, userId))
        .limit(1);

      res.json({
        success: true,
        message: {
          ...newMessage,
          sender
        }
      });
    } catch (error) {
      console.error('Error sending message:', error);
      next(error);
    }
  });

  // Respond to a match request
  app.post('/api/matches/:id', validateUser, ensureAuthenticated, async (req: Request, res: Response, next: NextFunction) => {
    try {
      if (!isAuthenticated(req)) {
        return res.status(401).json({ 
          success: false, 
          message: 'Unauthorized' 
        });
      }

      const userId = req.user.id;
      const matchId = parseInt(req.params.id);
      const { status } = req.body;

      if (isNaN(matchId) || matchId <= 0) {
        return res.status(400).json({
          success: false,
          message: 'Invalid match ID. Please provide a valid positive number.'
        });
      }

      if (!status || !['accepted', 'rejected'].includes(status)) {
        return res.status(400).json({
          success: false,
          message: 'Invalid status. Must be either "accepted" or "rejected".'
        });
      }

      // Get match data
      const [match] = await db
        .select()
        .from(matches)
        .where(
          and(
            eq(matches.id, matchId),
            or(
              eq(matches.userId1, userId),
              eq(matches.userId2, userId)
            )
          )
        )
        .limit(1);

      if (!match) {
        return res.status(404).json({
          success: false,
          message: 'Match not found'
        });
      }

      // Only allow responding to pending matches
      if (match.status !== 'requested') {
        return res.status(400).json({
          success: false,
          message: 'Can only respond to requested match requests'
        });
      }

      // Update match status
      const [updatedMatch] = await db
        .update(matches)
        .set({
          status: status as 'accepted' | 'rejected',
          lastActivityAt: new Date()
        })
        .where(eq(matches.id, matchId))
        .returning();

      if (!updatedMatch) {
        throw new Error('Failed to update match status');
      }

      // Get matched user details
      const matchedUserId = match.userId1 === userId ? match.userId2 : match.userId1;
      const matchedUser = await getUserWithInterests(matchedUserId);

      if (!matchedUser) {
        return res.status(404).json({
          success: false,
          message: 'Matched user not found'
        });
      }

      res.json({
        success: true,
        message: `Match ${status}`,
        match: {
          ...updatedMatch,
          user: matchedUser
        }
      });
    } catch (error) {
      console.error('Error responding to match:', error);
      next(error);
    }
  });

  // Get all matches for a user
  app.get('/api/matches', validateUser, ensureAuthenticated, async (req: Request, res: Response, next: NextFunction) => {
    try {
      if (!isAuthenticated(req)) {
        return res.status(401).json({ 
          success: false, 
          message: 'Unauthorized' 
        });
      }

      const userId = req.user.id;

      // Get all matches for the user
      const userMatches = await db
        .select({
          id: matches.id,
          status: matches.status,
          user1Id: matches.userId1,
          user2Id: matches.userId2,
          createdAt: matches.createdAt,
          lastActivityAt: matches.lastActivityAt,
          score: matches.score
        })
        .from(matches)
        .where(
          or(
            eq(matches.userId1, userId),
            eq(matches.userId2, userId)
          )
        )
        .orderBy(desc(matches.lastActivityAt));

      // Get all user IDs from matches
      const userIds = new Set(
        userMatches.map(m => m.user1Id === userId ? m.user2Id : m.user1Id)
      );

      // Get user details for all matched users
      const matchedUsers = await Promise.all(
        Array.from(userIds).map(id => getUserWithInterests(id))
      );

      // Create a map of user details
      const userMap = new Map(
        matchedUsers.filter(Boolean).map(user => [user!.id, user])
      );

      // Format matches with user details
      const formattedMatches = userMatches.map(match => {
        const otherUserId = match.user1Id === userId ? match.user2Id : match.user1Id;
        const otherUser = userMap.get(otherUserId);

        if (!otherUser) return null;

        return {
          id: match.id,
          status: match.status,
          createdAt: match.createdAt,
          lastActivityAt: match.lastActivityAt,
          score: match.score,
          username: otherUser.username,
          name: otherUser.name,
          avatar: otherUser.avatar,
          personalityTraits: otherUser.personalityTraits,
          interests: otherUser.interests,
          user: {
            id: otherUserId,
            personalityTraits: otherUser.personalityTraits,
            interests: otherUser.interests
          }
        };
      }).filter((m): m is NonNullable<typeof m> => m !== null);

      // Group matches by status
      const groupedMatches = {
        accepted: formattedMatches.filter(m => m.status === 'accepted'),
        pending: formattedMatches.filter(m => m.status === 'pending'),
        requested: formattedMatches.filter(m => m.status === 'requested'),
        rejected: formattedMatches.filter(m => m.status === 'rejected'),
        potential: formattedMatches.filter(m => m.status === 'potential')
      };

      res.json({
        success: true,
        matches: groupedMatches,
        totalMatches: formattedMatches.length,
        acceptedMatches: groupedMatches.accepted.length,
        potentialMatches: groupedMatches.potential.length,
        requests: groupedMatches.requested.length + groupedMatches.pending.length
      });
    } catch (error) {
      console.error('Error getting matches:', error);
      next(error);
    }
  });

  // Update user profile
  app.post('/api/user/profile', validateUser, ensureAuthenticated, async (req: Request, res: Response, next: NextFunction) => {
    try {
      if (!isAuthenticated(req)) {
        return res.status(401).json({ 
          success: false, 
          message: 'Unauthorized' 
        });
      }

      const userId = req.user.id;
      const { name, bio } = req.body;

      // Update user profile
      const [updatedUser] = await db
        .update(users)
        .set({
          name: name || '',
          bio: bio || ''
        })
        .where(eq(users.id, userId))
        .returning();

      if (!updatedUser) {
        throw new Error('Failed to update user profile');
      }

      res.json({
        success: true,
        message: 'Profile updated successfully',
        user: updatedUser
      });
    } catch (error) {
      console.error('Error updating profile:', error);
      next(error);
    }
  });

  // Upload profile image
  app.post('/api/user/profile/image', validateUser, ensureAuthenticated, upload.single('image'), (async (req: Request, res: Response, next: NextFunction) => {
    try {
      if (!isAuthenticated(req)) {
        return res.status(401).json({ 
          success: false, 
          message: 'Unauthorized' 
        });
      }

      if (!req.file) {
        return res.status(400).json({
          success: false,
          message: 'No image file provided'
        });
      }

      const userId = req.user!.id;
      const file = req.file;
      const fileExtension = file.mimetype.split('/')[1];
      const fileName = `avatars/${userId}-${randomUUID()}.${fileExtension}`;

      // Upload to Replit Object Storage
      const { ok, error } = await storage.uploadFromBytes(
        fileName,
        file.buffer
      );

      if (!ok) {
        console.error('Error uploading to object storage:', error);
        return res.status(500).json({
          success: false,
          message: 'Failed to upload image'
        });
      }

      // Store just the filename in the database
      const avatarUrl = fileName;  // Just store avatars/userid-uuid.ext

      // Update user's avatar in database
      const [updatedUser] = await db
        .update(users)
        .set({
          avatar: avatarUrl
        })
        .where(eq(users.id, userId))
        .returning();

      if (!updatedUser) {
        throw new Error('Failed to update user avatar');
      }

      // Update profile progress
      await db
        .update(profileProgress)
        .set({
          sections: sql`jsonb_set(sections, '{avatar}', 'true'::jsonb)`,
          lastUpdated: new Date()
        })
        .where(eq(profileProgress.userId, userId));

      res.json({
        success: true,
        message: 'Profile image updated successfully',
        user: updatedUser
      });
    } catch (error) {
      console.error('Error uploading profile image:', error);
      next(error);
    }
  }) as express.RequestHandler);

  // Get achievements and progress
  app.get('/api/achievements', validateUser, ensureAuthenticated, async (req: Request, res: Response, next: NextFunction) => {
    try {
      if (!isAuthenticated(req)) {
        return res.status(401).json({ 
          success: false, 
          message: 'Unauthorized' 
        });
      }

      const userId = req.user.id;

      // Get all achievements
      const allAchievements = await db
        .select()
        .from(achievements);

      // Get user's unlocked achievements
      const unlockedAchievements = await db
        .select()
        .from(userAchievements)
        .where(eq(userAchievements.userId, userId));

      // Get user's profile progress
      const [userProgress] = await db
        .select()
        .from(profileProgress)
        .where(eq(profileProgress.userId, userId))
        .limit(1);

      // If no progress record exists, create one
      if (!userProgress) {
        const [newProgress] = await db
          .insert(profileProgress)
          .values({
            userId,
            sections: {
              basicInfo: false,
              avatar: false,
              interests: false,
              quiz: false,
              bio: false,
              connections: false
            } as const,
            totalPoints: 0,
            level: 1,
            lastUpdated: new Date()
          })
          .returning();

        res.json({
          achievements: allAchievements,
          userAchievements: [],
          progress: newProgress
        });
        return;
      }

      res.json({
        achievements: allAchievements,
        userAchievements: unlockedAchievements,
        progress: userProgress
      });
    } catch (error) {
      console.error('Error fetching achievements:', error);
      next(error);
    }
  });

  // Update profile progress
  app.post('/api/profile/progress', validateUser, ensureAuthenticated, async (req: Request, res: Response, next: NextFunction) => {
    try {
      if (!isAuthenticated(req)) {
        return res.status(401).json({ 
          success: false, 
          message: 'Unauthorized' 
        });
      }

      const userId = req.user.id;
      const { section, completed } = req.body;

      if (!section || typeof completed !== 'boolean') {
        return res.status(400).json({
          success: false,
          message: 'Invalid request body'
        });
      }

      // Get current progress
      const [currentProgress] = await db
        .select()
        .from(profileProgress)
        .where(eq(profileProgress.userId, userId))
        .limit(1);

      if (!currentProgress) {
        return res.status(404).json({
          success: false,
          message: 'Progress record not found'
        });
      }

      // Update the specified section
      const updatedSections = {
        ...currentProgress.sections,
        [section]: completed
      };

      // Get all achievements that might be unlocked by this update
      const potentialAchievements = await db
        .select()
        .from(achievements)
        .where(sql`criteria->>'condition' = ${section}`);

      // Get already unlocked achievements
      const unlockedAchievementIds = (await db
        .select()
        .from(userAchievements)
        .where(eq(userAchievements.userId, userId)))
        .map(ua => ua.achievementId);

      // Filter achievements that should be unlocked
      const newAchievements = potentialAchievements.filter(achievement => 
        completed && // Only if the section was completed
        !unlockedAchievementIds.includes(achievement.id) // And achievement wasn't already unlocked
      );

      // Calculate new points
      const additionalPoints = newAchievements.reduce((sum, achievement) => sum + achievement.points, 0);
      const newTotalPoints = currentProgress.totalPoints + additionalPoints;

      // Calculate new level
      const newLevel = calculateLevel(newTotalPoints);
      const leveledUp = newLevel > currentProgress.level;

      // Update progress and unlock achievements in a transaction
      await db.transaction(async (tx) => {
        // Update progress
        await tx
          .update(profileProgress)
          .set({
            sections: updatedSections,
            totalPoints: newTotalPoints,
            level: newLevel,
            lastUpdated: new Date()
          })
          .where(eq(profileProgress.userId, userId));

        // Insert new achievements
        if (newAchievements.length > 0) {
          await tx
            .insert(userAchievements)
            .values(
              newAchievements.map(achievement => ({
                userId,
                achievementId: achievement.id,
                unlockedAt: new Date()
              }))
            );
        }
      });

      res.json({
        success: true,
        newAchievements,
        levelUp: leveledUp,
        newLevel: newLevel
      });
    } catch (error) {
      console.error('Error updating progress:', error);
      next(error);
    }
  });

  // Register error handler
  app.use(errorHandler);

  // Add storage route handler
  app.get('/api/avatars/:filename(*)', async (req, res) => {
    try {
      const fileName = req.params.filename;
      
      // Validate filename
      if (!fileName || fileName.includes('..')) {
        console.error('Invalid filename requested:', fileName);
        return res.status(400).json({
          success: false,
          message: 'Invalid filename'
        });
      }

      // Handle the case where the full replit-objstore URL is passed
      if (fileName.includes('replit-objstore')) {
        return res.redirect(fileName);
      }

      // Ensure the avatars/ prefix is present
      const filePath = fileName.startsWith('avatars/') ? fileName : `avatars/${fileName}`;
      
      console.log('Attempting to serve file:', filePath);
      
      try {
        const result = await storage.downloadAsBytes(filePath);
        
        if (!result?.ok) {
          console.error('File not found in storage:', filePath);
          throw new Error('File not found');
        }

        const buffer = result.value[0];

        // Determine content type
        const contentType = fileName.toLowerCase().endsWith('.jpg') || fileName.toLowerCase().endsWith('.jpeg')
          ? 'image/jpeg'
          : fileName.toLowerCase().endsWith('.png')
          ? 'image/png'
          : fileName.toLowerCase().endsWith('.gif')
          ? 'image/gif'
          : 'application/octet-stream';

        // Set appropriate headers
        res.setHeader('Content-Type', contentType);
        res.setHeader('Cache-Control', 'public, max-age=31536000');
        res.setHeader('Content-Length', buffer.length.toString());
        
        console.log('Successfully serving file:', filePath, 'Content-Type:', contentType);
        res.send(buffer);
      } catch (error) {
        console.error('Error serving file from storage:', filePath, error);
        
        // Always try to serve default avatar as fallback for avatar requests
        const defaultAvatarPath = path.join(process.cwd(), 'public', 'default-avatar.png');
        if (require('fs').existsSync(defaultAvatarPath)) {
          res.setHeader('Content-Type', 'image/png');
          res.setHeader('Cache-Control', 'public, max-age=31536000');
          return res.sendFile(defaultAvatarPath);
        }
        
        res.status(404).json({
          success: false,
          message: 'File not found',
          path: filePath
        });
      }
    } catch (error: any) {
      console.error('Error in storage route:', error);
      res.status(500).json({ 
        success: false, 
        message: 'Internal server error',
        error: process.env.NODE_ENV === 'development' ? error.message : undefined
      });
    }
  });

  return httpServer;
}
</file>

</files>
